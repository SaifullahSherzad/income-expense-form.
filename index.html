<!DOCTYPE html>
<html lang="ps" dir="rtl">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="شېرزاد حسابونه - Premium Edition">
        <title>شېرزاد حسابونه</title>

        <!-- Favicon for browser tab - Icon file -->
        <link rel="icon" type="image/x-icon" href="favicon.ico">

        <!-- iOS home screen icon - PNG file -->
        <link rel="apple-touch-icon" href="favicon.png">

        <!-- iOS web app configuration -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="شېرزاد حسابونه">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">

        <!-- Chart.js Library -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <!-- QR Library -->
        <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

        <style>
                * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                }

                html,
                body {
                        width: 100%;
                        height: 100%;
                }

                body {
                        font-family: 'Inter', 'Noto Naskh Arabic', system-ui, -apple-system, sans-serif;
                        background: linear-gradient(135deg, #0a0515 0%, #020203 40%, #030712 100%);
                        color: #f8fafc;
                        direction: rtl;
                        display: flex;
                        align-items: flex-start;
                        justify-content: center;
                        padding: 0;
                        position: fixed;
                        width: 100%;
                        height: 100%;
                        overflow: hidden;
                }

                @media (min-width: 768px) {
                        body {
                                align-items: center;
                        }
                }

                .bg-orbs {
                        position: fixed;
                        inset: 0;
                        width: 100%;
                        height: 100%;
                        pointer-events: none;
                        z-index: 0;
                        overflow: hidden;
                }

                .orb {
                        position: absolute;
                        border-radius: 50%;
                        filter: blur(80px);
                        opacity: 0.4;
                        animation: float-orb 20s ease-in-out infinite;
                }

                .orb-1 {
                        width: 400px;
                        height: 400px;
                        background: linear-gradient(135deg, #8b5cf6, #3b82f6);
                        top: -200px;
                        right: -200px;
                        animation-duration: 20s;
                }

                .orb-2 {
                        width: 300px;
                        height: 300px;
                        background: linear-gradient(135deg, #ec4899, #f59e0b);
                        bottom: -150px;
                        left: -150px;
                        animation-duration: 25s;
                        animation-delay: -5s;
                }

                .orb-3 {
                        width: 350px;
                        height: 350px;
                        background: linear-gradient(135deg, #06b6d4, #8b5cf6);
                        top: 50%;
                        right: 10%;
                        animation-duration: 30s;
                        animation-delay: -10s;
                }

                @keyframes float-orb {

                        0%,
                        100% {
                                transform: translate(0, 0);
                        }

                        25% {
                                transform: translate(30px, -40px);
                        }

                        50% {
                                transform: translate(-20px, 30px);
                        }

                        75% {
                                transform: translate(40px, 20px);
                        }
                }

                .glass {
                        background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04));
                        border: 1px solid rgba(255, 255, 255, 0.15);
                        backdrop-filter: blur(30px);
                        -webkit-backdrop-filter: blur(30px);
                        border-radius: 24px;
                        position: relative;
                        overflow: hidden;
                }

                .glass::before {
                        content: '';
                        position: absolute;
                        inset: 0;
                        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05), transparent);
                        pointer-events: none;
                }

                .glass-card {
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 0 80px rgba(139, 92, 246, 0.1);
                        position: relative;
                        z-index: 1;
                        padding: 14px 20px 24px 20px;
                }

                @media (min-width: 768px) and (max-width: 1023px) {
                        .glass-card {
                                padding: 10px 14px 16px 14px;
                        }
                }

                @media (min-width: 1024px) {
                        .glass-card {
                                padding: 40px;
                        }
                }

                @keyframes slideInDown {
                        from {
                                opacity: 0;
                                transform: translateY(-40px);
                                filter: blur(20px);
                        }

                        to {
                                opacity: 1;
                                transform: translateY(0);
                                filter: blur(0);
                        }
                }

                @keyframes fadeInUp {
                        from {
                                opacity: 0;
                                transform: translateY(30px);
                        }

                        to {
                                opacity: 1;
                                transform: translateY(0);
                        }
                }

                @keyframes modalPop {
                        0% {
                                opacity: 0;
                                transform: scale(0.7) translateY(40px) rotateX(15deg);
                                filter: blur(20px);
                        }

                        100% {
                                opacity: 1;
                                transform: scale(1) translateY(0) rotateX(0);
                                filter: blur(0);
                        }
                }

                @keyframes shake {

                        0%,
                        100% {
                                transform: translateX(0);
                        }

                        25% {
                                transform: translateX(-5px);
                        }

                        75% {
                                transform: translateX(5px);
                        }
                }

                @keyframes shine {
                        0% {
                                transform: translateX(-100%);
                        }

                        100% {
                                transform: translateX(100%);
                        }
                }

                @keyframes pulseIcon {

                        0%,
                        100% {
                                transform: scale(1);
                                box-shadow: 0 15px 40px rgba(245, 158, 11, 0.5);
                        }

                        50% {
                                transform: scale(1.05);
                                box-shadow: 0 20px 50px rgba(245, 158, 11, 0.7);
                        }
                }

                @keyframes floatLogo {

                        0%,
                        100% {
                                transform: translateY(0) rotateZ(0deg);
                                box-shadow: 0 20px 50px rgba(139, 92, 246, 0.5);
                        }

                        50% {
                                transform: translateY(-10px) rotateZ(2deg);
                                box-shadow: 0 25px 60px rgba(139, 92, 246, 0.7);
                        }
                }

                @keyframes float {

                        0%,
                        100% {
                                transform: translateY(0);
                        }

                        50% {
                                transform: translateY(-8px);
                        }
                }

                .container {
                        width: 100%;
                        max-width: 750px;
                        padding: 10px 16px 16px 16px;
                        z-index: 10;
                        animation: slideInDown 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
                        position: relative;
                        height: 100%;
                        max-height: 100%;
                        overflow-y: auto;
                        overflow-x: hidden;
                        -webkit-overflow-scrolling: touch;
                }

                @media (min-width: 768px) {
                        .container {
                                padding: 10px 16px 16px 16px;
                                height: 100%;
                                max-height: 100%;
                                overflow-y: auto;
                                overflow-x: hidden;
                        }
                }

                @media (min-width: 768px) and (max-height: 900px) {
                        .container {
                                padding: 10px 16px 16px 16px;
                                height: 100%;
                                max-height: 100%;
                                overflow-y: auto;
                                overflow-x: hidden;
                        }
                }

                @media (min-width: 1024px) and (min-height: 900px) {
                        .container {
                                padding: 30px 50px;
                                max-height: none;
                                overflow-y: visible;
                        }
                }

                .logo {
                        width: 80px;
                        height: 80px;
                        background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 50%, #ec4899 100%);
                        border-radius: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 36px;
                        font-weight: 900;
                        color: white;
                        box-shadow: 0 20px 50px rgba(139, 92, 246, 0.5), inset -1px -1px 30px rgba(255, 255, 255, 0.3), inset 1px 1px 20px rgba(0, 0, 0, 0.2);
                        position: relative;
                        overflow: hidden;
                        animation: floatLogo 4s ease-in-out infinite;
                        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
                        flex-shrink: 0;
                }

                @media (min-width: 768px) and (max-width: 1023px) {
                        .logo {
                                width: 60px;
                                height: 60px;
                                font-size: 28px;
                                border-radius: 12px;
                        }
                }

                @media (min-width: 1024px) {
                        .logo {
                                width: 100px;
                                height: 100px;
                                font-size: 48px;
                                border-radius: 20px;
                        }
                }

                .btn-close-fancy {
                        position: absolute;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        color: #fff;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        backdrop-filter: blur(5px);
                        z-index: 100;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                }

                .btn-close-fancy:hover {
                        background: rgba(239, 68, 68, 0.8);
                        border-color: rgba(239, 68, 68, 1);
                        transform: rotate(90deg) scale(1.1);
                        box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
                }

                .logo::before {
                        content: '';
                        position: absolute;
                        inset: 0;
                        background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
                        animation: shine 3s infinite;
                        z-index: 2;
                }

                .header {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 12px;
                        animation: fadeInUp 0.8s ease-out 0.2s both;
                }

                @media (min-width: 768px) {
                        .header {
                                gap: 12px;
                                margin-bottom: 12px;
                        }
                }

                @media (min-width: 1024px) {
                        .header {
                                gap: 20px;
                                margin-bottom: 28px;
                        }
                }

                h1 {
                        font-size: 22px;
                        font-weight: 800;
                        background: linear-gradient(to left, #c084fc, #60a5fa, #f472b6);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        letter-spacing: -1px;
                        line-height: 1.1;
                }

                @media (min-width: 768px) and (max-width: 1023px) {
                        h1 {
                                font-size: 18px;
                        }
                }

                @media (min-width: 1024px) {
                        h1 {
                                font-size: 32px;
                        }
                }

                .subtitle {
                        color: #7dd3fc;
                        font-size: 11px;
                        margin-top: 2px;
                        font-weight: 500;
                        letter-spacing: 0.5px;
                }

                @media (min-width: 768px) and (max-width: 1023px) {
                        .subtitle {
                                font-size: 9px;
                                margin-top: 0px;
                        }
                }

                @media (min-width: 1024px) {
                        .subtitle {
                                font-size: 13px;
                                margin-top: 8px;
                        }
                }

                #jobSelectionScreen {
                        position: fixed;
                        inset: 0;
                        background: rgba(10, 5, 21, 0.98);
                        backdrop-filter: blur(30px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 9999;
                        padding: 16px;
                        flex-direction: column;
                        gap: 30px;
                        overflow-y: auto;
                }

                #jobSelectionScreen.hidden {
                        display: none;
                }

                .job-selection-card {
                        max-width: 550px;
                        width: 100%;
                        animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
                        max-height: 85vh;
                        overflow-y: auto;
                        overflow-x: hidden;
                }

                .job-header {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 16px;
                        margin-bottom: 32px;
                        animation: fadeInUp 0.8s ease-out 0.2s both;
                }

                .job-header h2 {
                        font-size: 32px;
                        font-weight: 800;
                        background: linear-gradient(to left, #c084fc, #f472b6);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        text-align: center;
                }

                .job-header-subtitle {
                        color: #7dd3fc;
                        font-size: 13px;
                        font-weight: 600;
                        text-align: center;
                        letter-spacing: 0.5px;
                }

                .job-grid {
                        display: grid;
                        grid-template-columns: 1fr;
                        gap: 14px;
                        animation: fadeInUp 0.8s ease-out 0.4s both;
                }

                @media (min-width: 768px) {
                        .job-grid {
                                grid-template-columns: 1fr 1fr;
                                gap: 16px;
                        }
                }

                .job-card {
                        padding: 20px;
                        background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(59, 130, 246, 0.06));
                        border: 2px solid rgba(139, 92, 246, 0.25);
                        border-radius: 16px;
                        cursor: pointer;
                        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                        text-align: right;
                        position: relative;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                }

                @media (min-width: 768px) {
                        .job-card {
                                padding: 24px;
                                border-radius: 18px;
                                gap: 12px;
                        }
                }

                .job-card::before {
                        content: '';
                        position: absolute;
                        inset: 0;
                        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05), transparent);
                        pointer-events: none;
                }

                .job-card:hover {
                        border-color: rgba(139, 92, 246, 0.6);
                        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.12));
                        box-shadow: 0 15px 40px rgba(139, 92, 246, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                        transform: translateY(-6px);
                }

                .job-card:active {
                        transform: translateY(-2px);
                }

                .job-icon {
                        font-size: 28px;
                        display: inline-block;
                        animation: float 3s ease-in-out infinite;
                }

                @media (min-width: 768px) {
                        .job-icon {
                                font-size: 32px;
                        }
                }

                .job-card:nth-child(1) .job-icon {
                        animation-delay: 0s;
                }

                .job-card:nth-child(2) .job-icon {
                        animation-delay: 0.2s;
                }

                .job-card:nth-child(3) .job-icon {
                        animation-delay: 0.4s;
                }

                .job-card:nth-child(4) .job-icon {
                        animation-delay: 0.6s;
                }

                .job-name {
                        font-size: 16px;
                        font-weight: 800;
                        background: linear-gradient(to left, #c084fc, #60a5fa);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                        letter-spacing: -0.5px;
                }

                @media (min-width: 768px) {
                        .job-name {
                                font-size: 18px;
                        }
                }

                .job-desc {
                        font-size: 12px;
                        color: #a78bfa;
                        font-weight: 500;
                        opacity: 0.9;
                }

                @media (min-width: 768px) {
                        .job-desc {
                                font-size: 13px;
                        }
                }

                /* Style for trailer images */
                .job-image {
                        width: 100%;
                        height: 150px;
                        object-fit: cover;
                        border-radius: 12px;
                        animation: float 3s ease-in-out infinite;
                        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                }

                .job-card:nth-child(1) .job-image {
                        animation-delay: 0s;
                }

                .job-card:nth-child(2) .job-image {
                        animation-delay: 0.2s;
                }

                .job-image-error {
                        display: none;
                        font-size: 48px;
                }

                #saudiSubAccountScreen {
                        position: fixed;
                        inset: 0;
                        background: rgba(10, 5, 21, 0.98);
                        backdrop-filter: blur(30px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 9999;
                        padding: 16px;
                        flex-direction: column;
                        gap: 30px;
                        overflow-y: auto;
                }

                #saudiSubAccountScreen.hidden {
                        display: none;
                }

                /* Home Sub-Account Screen Styles */
                #homeSubAccountScreen {
                        position: fixed;
                        inset: 0;
                        background: rgba(10, 5, 21, 0.98);
                        backdrop-filter: blur(30px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 9999;
                        padding: 16px;
                        flex-direction: column;
                        gap: 30px;
                        overflow-y: auto;
                }

                #homeSubAccountScreen.hidden {
                        display: none;
                }

                /* Home sub-account card styles with different gradients */
                .home-card-lalak {
                        background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(34, 211, 238, 0.08)) !important;
                        border-color: rgba(6, 182, 212, 0.35) !important;
                }

                .home-card-lalak:hover {
                        border-color: rgba(6, 182, 212, 0.7) !important;
                        background: linear-gradient(135deg, rgba(6, 182, 212, 0.25), rgba(34, 211, 238, 0.15)) !important;
                        box-shadow: 0 15px 40px rgba(6, 182, 212, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
                }

                .home-card-lalak .job-name {
                        background: linear-gradient(to left, #22d3ee, #06b6d4) !important;
                        -webkit-background-clip: text !important;
                        -webkit-text-fill-color: transparent !important;
                        background-clip: text !important;
                }

                .home-card-saifullah {
                        background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(192, 132, 252, 0.08)) !important;
                        border-color: rgba(168, 85, 247, 0.35) !important;
                }

                .home-card-saifullah:hover {
                        border-color: rgba(168, 85, 247, 0.7) !important;
                        background: linear-gradient(135deg, rgba(168, 85, 247, 0.25), rgba(192, 132, 252, 0.15)) !important;
                        box-shadow: 0 15px 40px rgba(168, 85, 247, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
                }

                .home-card-saifullah .job-name {
                        background: linear-gradient(to left, #c084fc, #a855f7) !important;
                        -webkit-background-clip: text !important;
                        -webkit-text-fill-color: transparent !important;
                        background-clip: text !important;
                }

                .home-card-saeedullah {
                        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.08)) !important;
                        border-color: rgba(59, 130, 246, 0.35) !important;
                }

                .home-card-saeedullah:hover {
                        border-color: rgba(59, 130, 246, 0.7) !important;
                        background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(96, 165, 250, 0.15)) !important;
                        box-shadow: 0 15px 40px rgba(59, 130, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
                }

                .home-card-saeedullah .job-name {
                        background: linear-gradient(to left, #60a5fa, #3b82f6) !important;
                        -webkit-background-clip: text !important;
                        -webkit-text-fill-color: transparent !important;
                        background-clip: text !important;
                }

                .home-card-siddiqullah {
                        background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(244, 114, 182, 0.08)) !important;
                        border-color: rgba(236, 72, 153, 0.35) !important;
                }

                .home-card-siddiqullah:hover {
                        border-color: rgba(236, 72, 153, 0.7) !important;
                        background: linear-gradient(135deg, rgba(236, 72, 153, 0.25), rgba(244, 114, 182, 0.15)) !important;
                        box-shadow: 0 15px 40px rgba(236, 72, 153, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
                }

                .home-card-siddiqullah .job-name {
                        background: linear-gradient(to left, #f472b6, #ec4899) !important;
                        -webkit-background-clip: text !important;
                        -webkit-text-fill-color: transparent !important;
                        background-clip: text !important;
                }

                .home-card-joint {
                        background: linear-gradient(135deg, rgba(251, 146, 60, 0.15), rgba(253, 186, 116, 0.08)) !important;
                        border-color: rgba(251, 146, 60, 0.35) !important;
                }

                .home-card-joint:hover {
                        border-color: rgba(251, 146, 60, 0.7) !important;
                        background: linear-gradient(135deg, rgba(251, 146, 60, 0.25), rgba(253, 186, 116, 0.15)) !important;
                        box-shadow: 0 15px 40px rgba(251, 146, 60, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
                }

                .home-card-joint .job-name {
                        background: linear-gradient(to left, #fb923c, #f97316) !important;
                        -webkit-background-clip: text !important;
                        -webkit-text-fill-color: transparent !important;
                        background-clip: text !important;
                }

                .home-card-investment {
                        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.08)) !important;
                        border-color: rgba(16, 185, 129, 0.35) !important;
                }

                .home-card-investment:hover {
                        border-color: rgba(16, 185, 129, 0.7) !important;
                        background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(52, 211, 153, 0.15)) !important;
                        box-shadow: 0 15px 40px rgba(16, 185, 129, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
                }

                .home-card-investment .job-name {
                        background: linear-gradient(to left, #34d399, #10b981) !important;
                        -webkit-background-clip: text !important;
                        -webkit-text-fill-color: transparent !important;
                        background-clip: text !important;
                }

                #newAccountScreen .modal-icon {
                        animation: pulse-green 2s infinite;
                }

                @keyframes pulse-green {
                        0% {
                                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
                        }

                        70% {
                                box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
                        }

                        100% {
                                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
                        }
                }

                #passwordScreen {
                        position: fixed;
                        inset: 0;
                        background: rgba(10, 5, 21, 0.98);
                        backdrop-filter: blur(30px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 9999;
                        padding: 16px;
                        flex-direction: column;
                        gap: 30px;
                        overflow-y: auto;
                }

                #passwordScreen.hidden {
                        display: none;
                }

                .password-card {
                        max-width: 500px;
                        width: 100%;
                        animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
                        max-height: 85vh;
                        overflow-y: auto;
                        overflow-x: hidden;
                }

                .password-header {
                        display: flex;
                        align-items: center;
                        gap: 16px;
                        margin-bottom: 28px;
                        animation: fadeInUp 0.8s ease-out 0.2s both;
                }

                .lock-icon {
                        width: 70px;
                        height: 70px;
                        border-radius: 16px;
                        background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 36px;
                        box-shadow: 0 15px 40px rgba(245, 158, 11, 0.5);
                        animation: pulseIcon 2s ease-in-out infinite;
                        flex-shrink: 0;
                }

                @media (min-width: 768px) {
                        .lock-icon {
                                width: 80px;
                                height: 80px;
                                font-size: 42px;
                        }
                }

                .password-title {
                        font-size: 28px;
                        font-weight: 800;
                        background: linear-gradient(to left, #c084fc, #f472b6);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                }

                .password-subtitle {
                        color: #7dd3fc;
                        font-size: 13px;
                        margin-top: 8px;
                        font-weight: 600;
                }

                .password-input-group {
                        margin-bottom: 20px;
                        animation: fadeInUp 0.8s ease-out 0.4s both;
                }

                .password-input-label {
                        display: block;
                        margin-bottom: 8px;
                        font-size: 13px;
                        font-weight: 700;
                        color: #c084fc;
                        text-transform: uppercase;
                }

                .password-input {
                        width: 100%;
                        padding: 16px 20px;
                        background: rgba(255, 255, 255, 0.08);
                        border: 2px solid rgba(139, 92, 246, 0.3);
                        border-radius: 16px;
                        color: white;
                        font-size: 18px;
                        font-family: inherit;
                        transition: all 0.3s ease;
                        text-align: center;
                        letter-spacing: 2px;
                }

                .password-input:focus {
                        outline: none;
                        border-color: #a855f7;
                        background: rgba(255, 255, 255, 0.12);
                        box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
                        transform: translateY(-2px);
                }

                .password-error {
                        color: #ef4444;
                        font-size: 13px;
                        margin-top: 10px;
                        text-align: center;
                        font-weight: 600;
                        display: none;
                        animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
                        padding: 8px;
                        background: rgba(239, 68, 68, 0.1);
                        border-radius: 8px;
                        border: 1px solid rgba(239, 68, 68, 0.2);
                }

                .password-buttons {
                        display: flex;
                        gap: 12px;
                        margin-top: 24px;
                        animation: fadeInUp 0.8s ease-out 0.6s both;
                }

                .password-button {
                        flex: 1;
                        padding: 16px;
                        border-radius: 16px;
                        border: none;
                        font-size: 14px;
                        font-weight: 800;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-family: inherit;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                }

                .password-button:active {
                        transform: scale(0.98);
                }

                .btn-primary {
                        background: linear-gradient(135deg, #8b5cf6, #3b82f6);
                        color: white;
                        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
                }

                .btn-primary:hover {
                        box-shadow: 0 15px 40px rgba(139, 92, 246, 0.5);
                        transform: translateY(-2px);
                }

                .btn-back {
                        background: rgba(255, 255, 255, 0.1);
                        color: #cbd5e1;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                }

                .btn-back:hover {
                        background: rgba(255, 255, 255, 0.15);
                        color: white;
                        transform: translateY(-2px);
                }

                .form-grid {
                        display: grid;
                        gap: 16px;
                        animation: fadeInUp 0.8s ease-out 0.4s both;
                }

                @media (min-width: 768px) {
                        .form-grid {
                                grid-template-columns: 1fr 1fr;
                        }
                }

                .input-group {
                        display: flex;
                        flex-direction: column;
                }

                .input-group.full-width {
                        grid-column: 1 / -1;
                }

                label {
                        margin-bottom: 8px;
                        font-size: 13px;
                        font-weight: 700;
                        color: #c084fc;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                }

                input,
                select,
                textarea {
                        width: 100%;
                        padding: 14px 16px;
                        background: rgba(10, 5, 21, 0.6);
                        border: 2px solid rgba(139, 92, 246, 0.2);
                        border-radius: 14px;
                        color: #f8fafc;
                        font-size: 15px;
                        transition: all 0.3s ease;
                        font-family: inherit;
                }

                input:focus,
                select:focus,
                textarea:focus {
                        outline: none;
                        border-color: #a855f7;
                        background: rgba(10, 5, 21, 0.8);
                        box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15);
                }

                textarea {
                        resize: vertical;
                        min-height: 100px;
                }

                .hint {
                        font-size: 11px;
                        color: #94a3b8;
                        margin-top: 6px;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                }

                .error-message {
                        font-size: 11px;
                        color: #ef4444;
                        margin-top: 6px;
                        display: none;
                        align-items: center;
                        gap: 4px;
                        font-weight: 600;
                        padding: 6px 10px;
                        background: rgba(239, 68, 68, 0.1);
                        border-radius: 8px;
                }

                .error-message.show {
                        display: flex;
                        animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
                }

                .submit-btn {
                        width: 100%;
                        padding: 16px;
                        border-radius: 16px;
                        border: none;
                        background: linear-gradient(135deg, #8b5cf6, #3b82f6);
                        color: white;
                        font-size: 16px;
                        font-weight: 800;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
                        font-family: inherit;
                        position: relative;
                        overflow: hidden;
                        letter-spacing: 0.5px;
                }

                .submit-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 15px 40px rgba(139, 92, 246, 0.5);
                }

                .submit-btn:active {
                        transform: scale(0.98);
                }

                .submit-btn-wrapper {
                        margin-top: 10px;
                        display: flex;
                        gap: 12px;
                }

                .btn-secondary {
                        padding: 16px;
                        border-radius: 16px;
                        border: none;
                        background: rgba(255, 255, 255, 0.1);
                        color: #e2e8f0;
                        font-size: 14px;
                        font-weight: 700;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-family: inherit;
                }

                .btn-secondary:hover {
                        background: rgba(255, 255, 255, 0.15);
                        color: white;
                        transform: translateY(-2px);
                }

                /* NEW STYLES FOR BALANCE */
                .balance-section {
                        grid-column: 1 / -1;
                        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.05));
                        border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 16px;
                        padding: 20px;
                        text-align: center;
                        margin-bottom: 24px;
                        position: relative;
                        overflow: hidden;
                        animation: fadeInUp 0.8s ease-out 0.3s both;
                        display: none;
                        /* Hidden by default */
                }

                .balance-label {
                        font-size: 12px;
                        color: #6ee7b7;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        margin-bottom: 5px;
                }

                .balance-value {
                        font-size: 32px;
                        font-weight: 900;
                        color: #fff;
                        text-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                }

                .balance-currency {
                        font-size: 14px;
                        color: rgba(255, 255, 255, 0.6);
                        font-weight: 500;
                        margin-top: 8px;
                }

                .balance-edit-btn {
                        position: absolute;
                        top: 10px;
                        left: 10px;
                        background: rgba(255, 255, 255, 0.1);
                        border: none;
                        color: #fff;
                        padding: 6px 12px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s;
                        display: none;
                        /* Only for admin */
                }

                .balance-edit-btn:hover {
                        background: rgba(255, 255, 255, 0.2);
                        transform: scale(1.05);
                }

                .modal-overlay {
                        position: fixed;
                        inset: 0;
                        background: rgba(10, 5, 21, 0.95);
                        backdrop-filter: blur(25px);
                        z-index: 10000;
                        display: none;
                        align-items: center;
                        justify-content: center;
                        padding: 16px;
                        overflow-y: auto;
                }

                .modal-overlay.active {
                        display: flex;
                }

                .modal {
                        max-width: 550px;
                        width: 100%;
                        animation: modalPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
                        max-height: 90vh;
                        overflow-y: auto;
                }

                .modal-header {
                        display: flex;
                        align-items: center;
                        gap: 16px;
                        margin-bottom: 24px;
                }

                .modal-icon {
                        width: 60px;
                        height: 60px;
                        border-radius: 14px;
                        background: linear-gradient(135deg, #10b981, #059669);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 28px;
                        box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
                        flex-shrink: 0;
                }

                .modal-title {
                        font-size: 24px;
                        font-weight: 800;
                        background: linear-gradient(to left, #6ee7b7, #34d399);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                }

                .modal-subtitle {
                        color: #7dd3fc;
                        font-size: 12px;
                        margin-top: 6px;
                        font-weight: 600;
                }

                .modal-body {
                        margin-bottom: 24px;
                }

                .data-row {
                        padding: 16px;
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 12px;
                        margin-bottom: 12px;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                }

                .data-row-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 16px;
                }

                @media (max-width: 400px) {
                        .data-row-grid {
                                grid-template-columns: 1fr;
                        }
                }

                .data-field {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                }

                .data-label {
                        font-size: 11px;
                        color: #94a3b8;
                        font-weight: 600;
                        text-transform: uppercase;
                }

                .data-value {
                        font-size: 15px;
                        color: #f1f5f9;
                        font-weight: 700;
                }

                .modal-actions {
                        display: flex;
                        gap: 12px;
                }

                .btn-success {
                        flex: 1;
                        padding: 14px 24px;
                        border: none;
                        border-radius: 14px;
                        font-size: 13px;
                        font-weight: 800;
                        cursor: pointer;
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
                        transition: all 0.3s ease;
                        font-family: inherit;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                }

                .btn-success:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 18px 40px rgba(16, 185, 129, 0.5);
                }

                .btn-success:disabled {
                        opacity: 0.7;
                        cursor: not-allowed;
                        transform: none;
                }

                .last-save-section {
                        margin-bottom: 20px;
                        padding: 16px;
                        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.05));
                        border: 1px solid rgba(245, 158, 11, 0.3);
                        border-radius: 12px;
                }

                .last-save-title {
                        font-size: 13px;
                        font-weight: 700;
                        color: #fbbf24;
                        margin-bottom: 12px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                }

                /* Toast Notification */
                .toast {
                        position: fixed !important;
                        bottom: 30px !important;
                        right: 30px !important;
                        padding: 20px 30px !important;
                        border-radius: 16px !important;
                        background: #1e1b4b !important;
                        border: 2px solid rgba(255, 255, 255, 0.2) !important;
                        color: white !important;
                        z-index: 2147483647 !important;
                        opacity: 0 !important;
                        visibility: hidden !important;
                        transform: translateY(20px) !important;
                        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
                        direction: rtl !important;
                        min-width: 320px !important;
                        pointer-events: none !important;
                        display: block !important;
                }

                .toast.show {
                        opacity: 1 !important;
                        visibility: visible !important;
                        transform: translateY(0) !important;
                }

                .toast-title {
                        font-size: 18px !important;
                        font-weight: 900 !important;
                        margin-bottom: 6px !important;
                        display: block !important;
                        color: #ffffff !important;
                }

                .toast-description {
                        font-size: 15px !important;
                        color: rgba(255, 255, 255, 0.9) !important;
                        font-weight: 600 !important;
                        display: block !important;
                }

                .back-button-container {
                        position: absolute;
                        top: 16px;
                        left: 16px;
                        z-index: 10;
                }

                @media (max-width: 767px) {
                        .back-button-container {
                                position: relative;
                                top: 0;
                                left: 0;
                                margin-bottom: 16px;
                        }
                }

                @media (min-width: 768px) {
                        .back-button-container {
                                top: 16px;
                        }
                }

                /* CATEGORY ICONS STYLES */
                .category-grid {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 12px;
                        margin-top: 8px;
                }

                @media (max-width: 480px) {
                        .category-grid {
                                grid-template-columns: repeat(3, 1fr);
                        }
                }

                .category-btn {
                        background: rgba(10, 5, 21, 0.6);
                        border: 2px solid rgba(139, 92, 246, 0.2);
                        border-radius: 12px;
                        padding: 12px 8px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        color: #f8fafc;
                        font-family: inherit;
                }

                .category-btn:hover {
                        border-color: #a855f7;
                        background: rgba(139, 92, 246, 0.1);
                        transform: translateY(-2px);
                }

                .category-btn.active {
                        border-color: #a855f7;
                        background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.2));
                        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
                }

                .category-btn-icon {
                        font-size: 24px;
                }

                .category-btn-label {
                        font-size: 11px;
                        font-weight: 600;
                }

                #customCategoryInput {
                        margin-top: 12px;
                        display: none;
                        animation: fadeInUp 0.4s ease-out;
                }

                /* Checkbox for Document Mode */
                .checkbox-wrapper {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-top: 10px;
                        justify-content: center;
                        background: rgba(255, 255, 255, 0.05);
                        padding: 10px;
                        border-radius: 10px;
                        cursor: pointer;
                        transition: background 0.2s;
                }

                .checkbox-wrapper:hover {
                        background: rgba(255, 255, 255, 0.1);
                }

                .checkbox-wrapper input[type="checkbox"] {
                        width: 18px;
                        height: 18px;
                        accent-color: #8b5cf6;
                        margin: 0;
                        cursor: pointer;
                }

                .checkbox-label {
                        font-size: 13px;
                        color: #e2e8f0;
                        font-weight: 600;
                        cursor: pointer;
                }

                .camera-options-bar {
                        display: flex;
                        gap: 15px;
                        margin-bottom: 20px;
                        background: rgba(0, 0, 0, 0.5);
                        padding: 10px 15px;
                        border-radius: 12px;
                        justify-content: center;
                }

                .camera-option-toggle {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        color: #ccc;
                        font-size: 12px;
                        cursor: pointer;
                }

                .camera-option-toggle input {
                        width: 16px;
                        height: 16px;
                        accent-color: #8b5cf6;
                        margin: 0;
                        cursor: pointer;
                        padding: 0;
                        /* Override global input padding */
                }

                /* Override global input styles for these checkboxes */
                .camera-option-toggle input[type="checkbox"] {
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        border-radius: 4px;
                }

                /* Camera Modal Styles */
                #cameraModal {
                        position: fixed;
                        inset: 0;
                        background: #000;
                        z-index: 20000;
                        display: none;
                        flex-direction: column;
                }

                #cameraView {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                }

                .camera-overlay {
                        position: absolute;
                        inset: 0;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        padding: 20px;
                        pointer-events: none;
                }

                .camera-controls-top {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        pointer-events: auto;
                }

                .camera-controls-bottom {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 20px;
                        pointer-events: auto;
                        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
                        padding-bottom: 20px;
                }

                .camera-btn {
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        color: white;
                        border-radius: 50%;
                        width: 44px;
                        height: 44px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 20px;
                        cursor: pointer;
                        backdrop-filter: blur(5px);
                }

                .shutter-btn {
                        width: 70px;
                        height: 70px;
                        border-radius: 50%;
                        background: white;
                        border: 4px solid rgba(255, 255, 255, 0.5);
                        cursor: pointer;
                        transition: transform 0.1s;
                }

                .shutter-btn:active {
                        transform: scale(0.9);
                }

                .camera-mode-selector {
                        display: flex;
                        gap: 20px;
                        background: rgba(0, 0, 0, 0.5);
                        padding: 8px 16px;
                        border-radius: 20px;
                        margin-bottom: 10px;
                }

                .camera-mode {
                        color: #ccc;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                        text-transform: uppercase;
                }

                .camera-mode.active {
                        color: #fbbf24;
                        /* Warning yellow */
                        text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
                }

                #qr-reader {
                        width: 100%;
                        height: 100%;
                        display: none;
                }

                /* Loading Overlay for OCR */
                .loading-overlay {
                        position: absolute;
                        inset: 0;
                        background: rgba(0, 0, 0, 0.7);
                        display: none;
                        align-items: center;
                        justify-content: center;
                        flex-direction: column;
                        z-index: 20001;
                        color: white;
                }

                .spinner {
                        width: 40px;
                        height: 40px;
                        border: 4px solid rgba(255, 255, 255, 0.3);
                        border-top: 4px solid #fff;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin-bottom: 15px;
                }

                @keyframes spin {
                        0% {
                                transform: rotate(0deg);
                        }

                        100% {
                                transform: rotate(360deg);
                        }
                }

                /* DASHBOARD STYLES */
                @media (min-width: 768px) {
                        .dashboard-container {
                                flex-direction: row !important;
                        }

                        .dashboard-sidebar {
                                width: 280px;
                                border-left: 1px solid rgba(255, 255, 255, 0.1);
                                border-bottom: none;
                                height: 100vh;
                        }
                }

                @media (max-width: 767px) {
                        .dashboard-sidebar {
                                width: 100%;
                                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                                border-left: none;
                                flex-direction: row !important;
                                align-items: center;
                                justify-content: space-between;
                                padding: 10px 16px !important;
                                gap: 10px !important;
                        }

                        .nav-menu {
                                display: none !important;
                                /* Hide menu items on mobile for simplicity or use hamburger */
                        }
                }

                .saudi-asset-row {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 10px 0;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                }

                .saudi-asset-row:last-child {
                        border-bottom: none;
                }

                /* Ensure default hidden state */
                .hidden {
                        display: none !important;
                }

                .saudi-asset-row {
                        background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(59, 130, 246, 0.03));
                        border: 1px solid rgba(139, 92, 246, 0.15);
                        border-radius: 12px;
                        padding: 16px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                }

                /* Report Screen Mobile Fixes */
                .report-inputs {
                        display: flex;
                        gap: 15px;
                        flex-wrap: wrap;
                        align-items: flex-end;
                }

                .input-wrapper {
                        flex: 1;
                        min-width: 150px;
                }

                .btn-download {
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #8b5cf6, #3b82f6);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-weight: bold;
                        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
                        transition: all 0.3s;
                        width: 100%;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        gap: 8px;
                }

                .btn-download:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
                }

                .download-dropdown {
                        flex: 1;
                        min-width: 150px;
                }

                .download-menu {
                        display: flex;
                        flex-direction: column;
                        gap: 5px;
                        animation: fadeInUp 0.2s ease-out;
                }

                .download-menu.hidden {
                        display: none;
                }

                .download-menu button:hover {
                        background: rgba(255, 255, 255, 0.1) !important;
                }

                @media (max-width: 768px) {
                        .report-inputs {
                                flex-direction: column;
                                align-items: stretch;
                        }

                        .input-wrapper {
                                width: 100%;
                                min-width: auto;
                        }

                        .download-dropdown {
                                width: 100%;
                        }
                }

                /* Report Screen Mobile Fixes */
                .report-inputs {
                        display: flex;
                        gap: 15px;
                        flex-wrap: wrap;
                        align-items: flex-end;
                }

                .input-wrapper {
                        flex: 1;
                        min-width: 150px;
                }

                .btn-download {
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #8b5cf6, #3b82f6);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-weight: bold;
                        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
                        transition: all 0.3s;
                        width: 100%;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        gap: 8px;
                }

                .btn-download:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
                }

                .download-dropdown {
                        flex: 1;
                        min-width: 150px;
                }

                .download-menu {
                        display: flex;
                        flex-direction: column;
                        gap: 5px;
                        animation: fadeInUp 0.2s ease-out;
                }

                .download-menu.hidden {
                        display: none;
                }

                .download-menu button:hover {
                        background: rgba(255, 255, 255, 0.1) !important;
                }

                @media (max-width: 768px) {
                        .report-inputs {
                                flex-direction: column;
                                align-items: stretch;
                        }

                        .input-wrapper {
                                width: 100%;
                                min-width: auto;
                        }

                        .download-dropdown {
                                width: 100%;
                        }
                }
        </style>
</head>

<body>
        <div class="bg-orbs">
                <div class="orb orb-1"></div>
                <div class="orb orb-2"></div>
                <div class="orb orb-3"></div>
        </div>

        <!-- Main Job Selection Screen -->
        <div id="jobSelectionScreen">
                <div class="glass-card job-selection-card">
                        <div class="job-header">
                                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                                <div>
                                        <h2>ورځني حسابونه</h2>
                                        <p class="job-header-subtitle">حساب انتخاب کړئ</p>
                                </div>
                        </div>

                        <div class="job-grid" id="jobGrid"></div>

                        <div style="margin-top: 25px; border-top: none; padding-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                                <button onclick="openGeneralDashboardAuth()" style="width: 100%; padding: 14px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: #94a3b8; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                        📊 عمومي مالي ډشبورډ
                                </button>
                                <button onclick="openInvestmentAuth()" style="width: 100%; padding: 14px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px; color: #6ee7b7; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                        💼 پانګونه
                                </button>
                                <button onclick="openLoanBookAuth()" style="width: 100%; padding: 14px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; color: #60a5fa; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                        📔 د قرضونو کتابچه
                                </button>
                        </div>
                </div>
        </div>

        <!-- New Account Screen (Investment) -->
        <div id="newAccountScreen" class="hidden" style="position: fixed; inset: 0; background: rgba(10, 5, 21, 0.98); backdrop-filter: blur(30px); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 16px;">
                <div class="glass-card job-selection-card" style="max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative;">
                        <button type="button" class="btn-close-fancy" onclick="closeNewAccountScreen()" style="position: absolute; top: 20px; left: 20px; z-index: 100;">✕</button>

                        <div class="job-header" style="margin-bottom: 24px;">
                                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                                <div style="text-align: center;">
                                        <h2 style="font-size: 28px; margin-bottom: 4px;">د پانګونې فورم</h2>
                                        <p class="job-header-subtitle">د نوې پانګونې معلومات ثبت کړئ</p>
                                </div>
                        </div>

                        <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(52, 211, 153, 0.06)); border: 2px solid rgba(16, 185, 129, 0.25); border-radius: 16px; margin-bottom: 24px;">
                                <div style="font-size: 28px; margin-bottom: 8px;">💼</div>
                                <div class="job-name" style="color: #6ee7b7;">پانګونه (Investment)</div>
                        </div>

                        <div class="form-grid" style="display: flex; flex-direction: column; gap: 16px;">
                                <div class="input-group">
                                        <label>📅 نېټه</label>
                                        <input type="date" id="newAccDate" style="width: 93%;">
                                </div>

                                <div class="input-group">
                                        <label>💰 پانکونه (افغانۍ)</label>
                                        <input type="number" id="newAccPoints" placeholder="0">
                                </div>

                                <div class="input-group">
                                        <label>📝 تفصیل</label>
                                        <textarea id="newAccDesc" placeholder="تفصیل ولیکي..." rows="3"></textarea>
                                </div>

                                <div class="input-group">
                                        <label>📷 د بیل تصویر</label>
                                        <div style="background: rgba(255, 255, 255, 0.05); border: 2px dashed rgba(139, 92, 246, 0.3); border-radius: 14px; padding: 15px;">
                                                <input type="file" id="newAccImage" accept="image/*" style="width: 100%; padding: 10px; background: transparent; color: #cbd5e1; border: none; cursor: pointer;">
                                        </div>
                                </div>

                                <button onclick="submitNewAccount()" id="btnSubmitNewAccount" class="submit-btn" style="margin-top: 10px; background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);">
                                        ✓ ذخیره کول
                                </button>
                        </div>
                </div>
        </div>

        <!-- Loan Book Menu Screen -->
        <div id="loanBookMenuScreen" class="hidden" style="position: fixed; inset: 0; background: rgba(10, 5, 21, 0.98); backdrop-filter: blur(30px); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 16px;">
                <div class="glass-card job-selection-card" style="max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative;">
                        <button type="button" class="btn-close-fancy" onclick="closeLoanBookMenu()" style="position: absolute; top: 20px; left: 20px; z-index: 100;">✕</button>

                        <div class="job-header" style="margin-bottom: 24px;">
                                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                                <div style="text-align: center;">
                                        <h2 style="font-size: 28px; margin-bottom: 4px;">د قرضونو کتابچه</h2>
                                        <p class="job-header-subtitle">انتخاب وکړئ</p>
                                </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 16px;">
                                <button onclick="openLoanReceivables()" style="padding: 20px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 16px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: all 0.3s;">
                                        <span style="font-size: 24px;">📈</span>
                                        <div style="text-align: right;">
                                                <h3 style="color: #6ee7b7; font-size: 18px; margin-bottom: 4px;">په خلګو زمونږ قرضونه</h3>
                                                <p style="color: #94a3b8; font-size: 13px;">Receivables</p>
                                        </div>
                                </button>

                                <button onclick="openLoanPayables()" style="padding: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 16px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: all 0.3s;">
                                        <span style="font-size: 24px;">📉</span>
                                        <div style="text-align: right;">
                                                <h3 style="color: #fca5a5; font-size: 18px; margin-bottom: 4px;">په مونږ د خلکو قرضونه</h3>
                                                <p style="color: #94a3b8; font-size: 13px;">Payables</p>
                                        </div>
                                </button>
                        </div>
                </div>
        </div>

        <!-- Loan Receivables Screen (Green) -->
        <div id="loanReceivablesScreen" class="hidden" style="position: fixed; inset: 0; background: rgba(10, 5, 21, 0.98); backdrop-filter: blur(30px); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 16px;">
                <div class="glass-card job-selection-card" style="max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative;">
                        <button type="button" class="btn-close-fancy" onclick="closeLoanReceivables()" style="position: absolute; top: 20px; left: 20px; z-index: 100;">✕</button>

                        <div class="job-header" style="margin-bottom: 24px;">
                                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                                <div style="text-align: center;">
                                        <h2 style="font-size: 28px; margin-bottom: 4px;">په خلګو زمونږ قرضونه</h2>
                                        <p class="job-header-subtitle">نوی ریکارډ ثبت کړئ</p>
                                </div>
                        </div>

                        <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(52, 211, 153, 0.06)); border: 2px solid rgba(16, 185, 129, 0.25); border-radius: 16px; margin-bottom: 24px;">
                                <div style="font-size: 28px; margin-bottom: 8px;">📈</div>
                                <div class="job-name" style="color: #6ee7b7;">Receivables</div>
                        </div>

                        <div class="form-grid" style="display: flex; flex-direction: column; gap: 16px;">
                                <div class="input-group">
                                        <label>📅 نېټه</label>
                                        <input type="date" id="loanRecDate" style="width: 93%;">
                                </div>

                                <div class="input-group">
                                        <label>👤 نوم</label>
                                        <input type="text" id="loanRecName" placeholder="د شخص نوم...">
                                </div>

                                <div class="input-group">
                                        <label>💰 د قرض اندازه (افغانۍ)</label>
                                        <input type="number" id="loanRecAmount" placeholder="0">
                                </div>

                                <div class="input-group">
                                        <label>📝 تفصیل</label>
                                        <textarea id="loanRecDesc" placeholder="تفصیل ولیکي..." rows="3"></textarea>
                                </div>

                                <div class="input-group">
                                        <label>📷 د بیل تصویر</label>
                                        <div style="background: rgba(255, 255, 255, 0.05); border: 2px dashed rgba(16, 185, 129, 0.3); border-radius: 14px; padding: 15px;">
                                                <input type="file" id="loanRecImage" accept="image/*" style="width: 100%; padding: 10px; background: transparent; color: #cbd5e1; border: none; cursor: pointer;">
                                        </div>
                                </div>

                                <button onclick="submitLoanReceivable()" class="submit-btn" style="margin-top: 10px; background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);">
                                        ✓ ذخیره کول
                                </button>
                        </div>
                </div>
        </div>

        <!-- Loan Payables Screen (Red) -->
        <div id="loanPayablesScreen" class="hidden" style="position: fixed; inset: 0; background: rgba(10, 5, 21, 0.98); backdrop-filter: blur(30px); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 16px;">
                <div class="glass-card job-selection-card" style="max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative;">
                        <button type="button" class="btn-close-fancy" onclick="closeLoanPayables()" style="position: absolute; top: 20px; left: 20px; z-index: 100;">✕</button>

                        <div class="job-header" style="margin-bottom: 24px;">
                                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                                <div style="text-align: center;">
                                        <h2 style="font-size: 28px; margin-bottom: 4px;">په مونږ د خلکو قرضونه</h2>
                                        <p class="job-header-subtitle">نوی ریکارډ ثبت کړئ</p>
                                </div>
                        </div>

                        <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(248, 113, 113, 0.06)); border: 2px solid rgba(239, 68, 68, 0.25); border-radius: 16px; margin-bottom: 24px;">
                                <div style="font-size: 28px; margin-bottom: 8px;">📉</div>
                                <div class="job-name" style="color: #fca5a5;">Payables</div>
                        </div>

                        <div class="form-grid" style="display: flex; flex-direction: column; gap: 16px;">
                                <div class="input-group">
                                        <label>📅 نېټه</label>
                                        <input type="date" id="loanPayDate" style="width: 93%;">
                                </div>

                                <div class="input-group">
                                        <label>👤 نوم</label>
                                        <input type="text" id="loanPayName" placeholder="د شخص نوم...">
                                </div>

                                <div class="input-group">
                                        <label>💰 د قرض اندازه (افغانۍ)</label>
                                        <input type="number" id="loanPayAmount" placeholder="0">
                                </div>

                                <div class="input-group">
                                        <label>📝 تفصیل</label>
                                        <textarea id="loanPayDesc" placeholder="تفصیل ولیکي..." rows="3"></textarea>
                                </div>

                                <div class="input-group">
                                        <label>📷 د بیل تصویر</label>
                                        <div style="background: rgba(255, 255, 255, 0.05); border: 2px dashed rgba(239, 68, 68, 0.3); border-radius: 14px; padding: 15px;">
                                                <input type="file" id="loanPayImage" accept="image/*" style="width: 100%; padding: 10px; background: transparent; color: #cbd5e1; border: none; cursor: pointer;">
                                        </div>
                                </div>

                                <button onclick="submitLoanPayable()" class="submit-btn" style="margin-top: 10px; background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);">
                                        ✓ ذخیره کول
                                </button>
                        </div>
                </div>
        </div>

        <!-- General Dashboard Screen -->
        <div id="generalDashboardScreen" class="hidden" style="position: fixed; inset: 0; background: rgba(10, 5, 21, 0.98); backdrop-filter: blur(30px); display: flex; align-items: flex-start; justify-content: center; z-index: 9999; padding: 60px 10px 20px 10px; overflow: auto;">
                <div class="glass-card job-selection-card" style="max-width: 1400px; width: 98%; max-height: 98vh; height: auto; overflow-y: auto; display: flex; flex-direction: column; padding: 20px;">
                        <button type="button" onclick="closeGeneralDashboard()" class="btn-close-fancy" style="top: 15px; left: 15px;">✕</button>

                        <div class="job-header" style="flex-direction: row; margin-bottom: 25px; gap: 20px; flex-shrink: 0; align-items: center; padding-top: 20px;">
                                <div class="logo" style="width: 100px; height: 100px; font-size: 40px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.1);"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 20px;"></div>
                                <div style="text-align: right; flex-grow: 1;">
                                        <h2 style="font-size: 28px; margin-bottom: 5px;">شېرزاد حسابونه</h2>
                                        <p class="job-header-subtitle" style="font-size: 16px;">عمومي مالي ډشبورډ</p>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="updateGeneralDashboard()" style="width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" title="تازه کول">
                                        🔄
                                    </button>
                                </div>
                        </div>

                        <div class="job-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; flex-grow: 1; align-content: start; padding-bottom: 20px;">

                                <!-- COLUMN 1: Assets & Income (Left/Top in Mobile) -->
                                <div style="display: flex; flex-direction: column; gap: 16px; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 20px; border: 1px solid rgba(16, 185, 129, 0.1);">
                                        <h3 style="color: #6ee7b7; font-size: 18px; margin-bottom: 5px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                                <span>عاید او سرمایه</span>
                                                <span style="font-size: 20px;">💰</span>
                                        </h3>

                                        <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                                                <div class="job-icon" style="font-size: 28px;">🏛️</div>
                                                <div class="job-name" style="font-size: 14px; color: #94a3b8;">ټوله پانګه</div>
                                                <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #6ee7b7;"><span id="dashTotalCapital">0</span> <span style="font-size: 12px; font-weight: 400;">افغانۍ</span></div>
                                        </div>

                                        <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                                                <div class="job-icon" style="font-size: 28px;">💵</div>
                                                <div class="job-name" style="font-size: 14px; color: #94a3b8;">ټول عاید</div>
                                                <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #6ee7b7;"><span id="dashTotalIncome">0</span> <span style="font-size: 12px; font-weight: 400;">افغانۍ</span></div>
                                        </div>

                                        <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                                                <div class="job-icon" style="font-size: 28px;">📈</div>
                                                <div class="job-name" style="font-size: 14px; color: #94a3b8;">خالصه ګټه</div>
                                                <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #6ee7b7;"><span id="dashNetProfit">0</span> <span style="font-size: 12px; font-weight: 400;">افغانۍ</span></div>
                                        </div>

                                        <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                                                <div class="job-icon" style="font-size: 28px;">💰</div>
                                                <div class="job-name" style="font-size: 14px; color: #94a3b8;">خالصه پاتی پیسې</div>
                                                <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #6ee7b7;"><span id="dashNetRemaining">0</span> <span style="font-size: 12px; font-weight: 400;">افغانۍ</span></div>
                                        </div>

                                </div>

                                <!-- COLUMN 2: Expenses & Liabilities (Right/Bottom in Mobile) -->
                                <div style="display: flex; flex-direction: column; gap: 16px; padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 20px; border: 1px solid rgba(239, 68, 68, 0.1);">
                                        <h3 style="color: #fca5a5; font-size: 18px; margin-bottom: 5px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                                <span>لګښت او قرضونه</span>
                                                <span style="font-size: 20px;">💸</span>
                                        </h3>

                                        <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
                                                <div class="job-icon" style="font-size: 28px;">📉</div>
                                                <div class="job-name" style="font-size: 14px; color: #94a3b8;">ټول لګښت</div>
                                                <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #fca5a5;"><span id="dashTotalExpense">0</span> <span style="font-size: 12px; font-weight: 400;">افغانۍ</span></div>
                                        </div>


                                        <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
                                                <div class="job-icon" style="font-size: 28px;">🏠</div>
                                                <div class="job-name" style="font-size: 14px; color: #94a3b8;">ټول کورني لګښتونه</div>
                                                <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #60a5fa;"><span id="dashTotalHouseholdExpense">0</span> <span style="font-size: 12px; font-weight: 400;">افغانۍ</span></div>
                                        </div>

                                        <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2);">
                                                <div class="job-icon" style="font-size: 28px;">💼</div>
                                                <div class="job-name" style="font-size: 14px; color: #94a3b8;">ټوله پانګونه</div>
                                                <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #c084fc;"><span id="dashTotalInvestment">0</span> <span style="font-size: 12px; font-weight: 400;">افغانۍ</span></div>
                                        </div>
                                </div>

                                <!-- COLUMN 3: Loans (New Group) -->
                                <div style="display: flex; flex-direction: column; gap: 16px; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 20px; border: 1px solid rgba(59, 130, 246, 0.1);">
                                        <h3 style="color: #60a5fa; font-size: 18px; margin-bottom: 5px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                                <span>قرضونه</span>
                                                <span style="font-size: 20px;">🤝</span>
                                        </h3>

                                        <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                                                <div class="job-icon" style="font-size: 28px;">📤</div>
                                                <div class="job-name" style="font-size: 14px; color: #94a3b8;">په خلکو زمونږ قرضونه</div>
                                                <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #10b981;"><span id="dashLoansToPeople">0</span> <span style="font-size: 12px; font-weight: 400;">افغانۍ</span></div>
                                        </div>

                                        <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
                                                <div class="job-icon" style="font-size: 28px;">📥</div>
                                                <div class="job-name" style="font-size: 14px; color: #94a3b8;">په مونږ د خلکو قرضونه</div>
                                                <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #ef4444;"><span id="dashLoansFromPeople">0</span> <span style="font-size: 12px; font-weight: 400;">افغانۍ</span></div>
                                        </div>
                                </div>
                        </div>

                </div>
        </div>

        <!-- Saudi Sub-Account Selection Screen -->
        <div id="saudiSubAccountScreen" class="hidden">
                <div class="glass-card job-selection-card">
                        <button type="button" onclick="backFromSaudiSubAccount()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1)';">✕</button>
                        <div class="job-header">
                                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                                <div>
                                        <h2>سعودي حسابونه</h2>
                                        <p class="job-header-subtitle">حساب انتخاب کړئ</p>
                                </div>
                        </div>
                        <div class="job-grid" id="saudiSubAccountGrid"></div>
                </div>
        </div>

        <!-- Home Sub-Account Selection Screen -->
        <div id="homeSubAccountScreen" class="hidden">
                <div class="glass-card job-selection-card">
                        <button type="button" onclick="backFromHomeSubAccount()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1)';">✕</button>
                        <div class="job-header">
                                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                                <div>
                                        <h2>د کور لګښتونه</h2>
                                        <p class="job-header-subtitle">فرعي حساب انتخاب کړئ</p>
                                </div>
                        </div>
                        <div class="job-grid" id="homeSubAccountGrid"></div>
                </div>
        </div>

        <!-- Password Screen -->
        <div id="passwordScreen" class="hidden">
                <div class="glass-card password-card">
                        <button type="button" onclick="backToJobs()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1)';">✕</button>
                        <div class="password-header">
                                <div class="lock-icon">🔒</div>
                                <div>
                                        <div class="password-title">د 2026 کال فورم</div>
                                        <p class="password-subtitle">✨ پاسورډ داخل کړئ</p>
                                </div>
                        </div>

                        <div class="password-input-group">
                                <label class="password-input-label" for="passwordInput">🔐 پاسورډ</label>
                                <input type="password" id="passwordInput" class="password-input" placeholder="پاسورډ ولیکئ..." autocomplete="off">
                        </div>

                        <div class="password-error" id="passwordError">❌ پاسورډ غلط دئ</div>

                        <div class="password-buttons">
                                <button type="button" class="password-button btn-primary" style="width: 100%;" onclick="checkPassword()">دخول</button>
                        </div>
                </div>
        </div>

        <!-- Report Screen -->
        <div id="reportScreen" class="hidden">
                <div class="glass-card" style="max-width: 1000px; margin: 20px auto; padding: 25px; position: relative; max-height: 90vh; display: flex; flex-direction: column;">
                        <button type="button" onclick="closeReport()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer;">✕</button>

                        <div class="header" style="margin-bottom: 20px; flex-shrink: 0;">
                                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                                <div>
                                        <h2 id="reportTitle">حسابي راپور</h2>
                                        <p class="subtitle" id="reportSubtitle">د معاملو لیست او جزئیات</p>
                                </div>
                        </div>

                        <!-- Search & Stats Container -->
                        <div style="flex-shrink: 0;">
                                <!-- Download Section -->
                                <!-- Compact Combined Report Toolbar -->
                                <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 15px; margin-bottom: 20px; backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.2);">

                                        <!-- Top Row: Tabs & Main Controls -->
                                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                                                <!-- Report Type Tabs -->
                                                <div style="display: flex; gap: 5px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 10px; flex: 1; min-width: 280px;">
                                                        <button onclick="setReportType('daily')" class="report-tab active-tab" id="tab-daily" style="flex: 1; padding: 8px; border-radius: 8px; border: none; color: white; background: rgba(255,255,255,0.1); cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">ورځنی</button>
                                                        <button onclick="setReportType('monthly')" class="report-tab" id="tab-monthly" style="flex: 1; padding: 8px; border-radius: 8px; border: none; color: #94a3b8; background: transparent; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">میاشتنی</button>
                                                        <button onclick="setReportType('yearly')" class="report-tab" id="tab-yearly" style="flex: 1; padding: 8px; border-radius: 8px; border: none; color: #94a3b8; background: transparent; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">کلنی</button>
                                                        <button onclick="setReportType('custom')" class="report-tab" id="tab-custom" style="flex: 1; padding: 8px; border-radius: 8px; border: none; color: #94a3b8; background: transparent; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">انتخابي</button>
                                                </div>

                                                <!-- Hidden Select -->
                                                <select id="reportType" onchange="toggleReportInputs()" style="display: none;">
                                                        <option value="daily">ورځنی (Daily)</option>
                                                        <option value="monthly">میاشتنی (Monthly)</option>
                                                        <option value="yearly">کلنی (Yearly)</option>
                                                        <option value="custom">نېټه وټاکئ</option>
                                                </select>

                                                <!-- Download Buttons (Compact) -->
                                                <div style="display: flex; gap: 8px;">
                                                        <button onclick="downloadReport('pdf')" title="PDF ډاونلوډ" style="width: 40px; height: 40px; border: none; border-radius: 10px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); transition: transform 0.2s;">
                                                                <span style="font-size: 20px;">📄</span>
                                                        </button>
                                                        <button onclick="downloadReport('csv')" title="Excel ډاونلوډ" style="width: 40px; height: 40px; border: none; border-radius: 10px; background: linear-gradient(135deg, #10b981, #059669); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); transition: transform 0.2s;">
                                                                <span style="font-size: 20px;">📊</span>
                                                        </button>
                                                </div>
                                        </div>

                                        <!-- Bottom Row: Filters & Inputs -->
                                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">

                                                <!-- Date Inputs (Dynamic) -->
                                                <div style="flex: 1; min-width: 150px;">
                                                        <div id="dateInputGroup" style="display: block;">
                                                                <input type="date" id="reportDateInput" class="compact-input" style="width: 100%; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 13px; outline: none;">
                                                        </div>
                                                        <div id="monthInputGroup" style="display: none;">
                                                                <input type="month" id="reportMonthInput" class="compact-input" style="width: 100%; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 13px; outline: none;">
                                                        </div>
                                                        <div id="yearInputGroup" style="display: none;">
                                                                <select id="reportYearInput" class="compact-input" style="width: 100%; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 13px; outline: none;">
                                                                        <option value="2026">2026</option>
                                                                </select>
                                                        </div>
                                                </div>

                                                <!-- Search Filter -->
                                                <div style="flex: 2; min-width: 200px; position: relative;">
                                                        <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8;">🔍</span>
                                                        <input type="text" id="tableFilterSearch" oninput="applyTableFilter()" placeholder="د راپورونو لټون..." style="width: 100%; padding: 8px 35px 8px 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 13px; outline: none;">
                                                </div>

                                                <!-- Date Range Filter (Hidden by default, shown if needed or for custom) -->
                                                <div id="customDateRange" style="display: none; gap: 5px; flex: 2;">
                                                        <input type="date" id="tableFilterStart" onchange="applyTableFilter()" style="flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 12px;">
                                                        <input type="date" id="tableFilterEnd" onchange="applyTableFilter()" style="flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 12px;">
                                                </div>
                                        </div>
                                </div>

                                <script>
                                        function setReportType(type) {
                                                const select = document.getElementById('reportType');
                                                if (select) {
                                                        select.value = type;
                                                        toggleReportInputs();

                                                        // Tab Styling
                                                        document.querySelectorAll('.report-tab').forEach(tab => {
                                                                tab.style.background = 'transparent';
                                                                tab.style.color = '#94a3b8';
                                                                tab.classList.remove('active-tab');
                                                        });
                                                        const activeTab = document.getElementById('tab-' + type);
                                                        if (activeTab) {
                                                                activeTab.style.background = 'rgba(255,255,255,0.1)';
                                                                activeTab.style.color = 'white';
                                                                activeTab.classList.add('active-tab');
                                                        }
                                                }
                                        }
                                </script>
                        </div>

                        <!-- Table Container -->
                        <div style="flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                                <table style="width: 100%; border-collapse: collapse; direction: rtl; text-align: right; position: relative;">
                                        <thead style="position: sticky; top: 0; background: #0a0515; z-index: 10;">
                                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                                        <th style="padding: 15px; color: #94a3b8; font-weight: 600;">نېټه</th>
                                                        <th style="padding: 15px; color: #94a3b8; font-weight: 600;">تفصیل</th>
                                                        <th style="padding: 15px; color: #94a3b8; font-weight: 600;">عائد</th>
                                                        <th style="padding: 15px; color: #94a3b8; font-weight: 600;">لګښت</th>
                                                        <th style="padding: 15px; color: #94a3b8; font-weight: 600;">حذف</th>
                                                </tr>
                                        </thead>
                                        <tbody id="reportTableBody">
                                                <!-- Data will be populated here -->
                                        </tbody>
                                </table>
                        </div>
                </div>
        </div>

        <!-- Main Form Container -->
        <div class="container hidden" id="formContainer">
                <div class="glass-card" style="position: relative;">
                        <button type="button" id="homeLogoutBtn" onclick="logout()" style="position: absolute; top: 20px; left: 20px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 36px; height: 36px; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; z-index: 10;">✕</button>

                        <div class="header">
                                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                                <div>
                                        <h1>د ورځني حساب فورم</h1>
                                        <p class="subtitle">✨ مهرباني وکړئ معلومات په دقیقه توګه ډک کړئ</p>
                                </div>
                        </div>

                        <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(59, 130, 246, 0.06)); border: 2px solid rgba(139, 92, 246, 0.25); border-radius: 16px; margin-bottom: 24px;">
                                <div style="font-size: 28px; margin-bottom: 8px;" id="currentJobIcon"></div>
                                <div style="font-size: 16px; font-weight: 800; background: linear-gradient(to left, #c084fc, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="currentJobName"></div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-bottom: 24px;" id="navButtonsRow">
                                <button type="button" id="dashboardBtn" class="btn-secondary" style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); color: #c084fc; font-weight: 700; flex: 1; padding: 12px; border-radius: 12px;" onclick="openDashboard()">
                                        📊 ډشبورډ
                                </button>
                                <button type="button" id="reportNavBtn" class="btn-secondary" style="background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; font-weight: 700; flex: 1; padding: 12px; border-radius: 12px; display: none;" onclick="openReport()">
                                        📋 راپور
                                </button>
                        </div>

                        <!-- Balance Section (Only for Home Accounts) -->
                        <div id="balanceSection" class="balance-section" style="display: flex; justify-content: space-between; align-items: center; width: 100%; box-sizing: border-box; padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 16px; margin-bottom: 24px; border: 1px solid rgba(139, 92, 246, 0.2);">
                                <div style="flex: 1;">
                                        <div class="balance-label" style="font-size: 14px; color: #94a3b8; margin-bottom: 4px;">موجوده ګډ بیلانس</div>
                                        <div class="balance-value" style="font-size: 24px; font-weight: 800; color: #c084fc;">
                                                <span id="balanceValue">0</span>
                                                <span class="balance-currency">AFN</span>
                                        </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                        <button type="button" id="refreshBalanceBtn" class="balance-edit-btn" onclick="fetchHomeData()" style="width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; font-size: 20px;">🔄</button>
                                </div>
                        </div>

                        <form id="trailerForm" class="form-grid" style="width: 100%; display: flex; flex-direction: column; gap: 0;">
                                <!-- New Home Fields - Grid Layout -->
                                <!-- Home Month Selection (New) -->
                                <div id="homeMonthGroup" style="width: 100%; margin-bottom: 15px; display: none; direction: rtl;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">📅 د میاشتې انتخاب</label>
                                    <select id="homeMonthSelect" onchange="fetchHomeData()" style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px; outline: none;">
                                        <option value="جنوري">جنوري</option>
                                        <option value="فبروري">فبروري</option>
                                        <option value="مارچ">مارچ</option>
                                        <option value="اپریل">اپریل</option>
                                        <option value="می">می</option>
                                        <option value="جون">جون</option>
                                        <option value="جولای">جولای</option>
                                        <option value="اگست">اگست</option>
                                        <option value="سپتمبر">سپتمبر</option>
                                        <option value="اکتوبر">اکتوبر</option>
                                        <option value="نومبر">نومبر</option>
                                        <option value="دیسمبر">دیسمبر</option>
                                    </select>
                                </div>

                                <div id="homeFields" style="width: 100%; display: flex; flex-direction: column; gap: 15px; margin-bottom: 24px; direction: rtl;">
                                        <!-- Row 1: 50% / 50% -->
                                        <div style="display: flex; gap: 12px; width: 100%;">
                                                <div class="input-group" style="flex: 1;">
                                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">👨‍👩‍👧‍👦 د کورنۍ افرادو تعداد</label>
                                                        <input type="number" id="familyMembers" placeholder="-" class="data-input" readonly style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                                                </div>
                                                <div class="input-group" style="flex: 1;">
                                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">💰 فردي مالي حق</label>
                                                        <input type="number" id="individualRight" placeholder="-" class="data-input" readonly style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                                                </div>
                                        </div>

                                        <!-- Row 2: 100% -->
                                        <div class="input-group" style="width: 100%;">
                                                <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">💵 حقیقي ورکړه</label>
                                                <input type="number" id="actualPayment" placeholder="-" class="data-input" readonly style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                                        </div>

                                        <!-- Row 3: 50% / 50% -->
                                        <div style="display: flex; gap: 12px; width: 100%;">
                                                <div class="input-group" style="flex: 1;">
                                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">📊 توپیر</label>
                                                        <input type="number" id="difference" placeholder="-" readonly class="data-input" style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                                                </div>
                                                <div class="input-group" style="flex: 1;">
                                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">🔄 حالت</label>
                                                        <input type="text" id="status" placeholder="-" readonly class="data-input" style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                                                </div>
                                        </div>

                                        <!-- Row 4: 100% -->
                                        <div class="input-group" style="width: 100%;">
                                                <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">📉 پاتې نغدیه</label>
                                                <input type="number" id="remainingCash" placeholder="-" readonly class="data-input" style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                                        </div>
                                </div>

                                <div class="input-group full-width" id="dateGroup">
                                        <label for="date">📅 نېټه (2026)</label>
                                        <input type="date" id="date" name="date" min="2026-01-01" max="2026-12-31" required style="width: 95%; box-sizing: border-box;">
                                        <p class="hint">⭐ یوازې د 2026 کال نیټې منل کیږي</p>
                                </div>

                                <!-- Income Field (Hidden for Home Accounts, Visible for others) -->
                                <div class="input-group full-width" id="incomeGroup" style="display: none;">
                                        <label for="income">💰 عائد</label>
                                        <input type="number" id="income" name="income" min="0" placeholder="عائد ولیکئ">
                                        <p class="error-message" id="incomeError">❌ عائد لیکل لازم دی (صفر یا لوړ عدد ولیکئ)</p>
                                </div>

                                <div class="input-group full-width" id="expenseGroup">
                                        <label for="expense">💸 لګښت</label>
                                        <div style="display: flex; gap: 8px;">
                                                <input type="number" id="expense" name="expense" min="0" placeholder="مصارف ولیکئ" style="flex: 1;">
                                                <input type="hidden" id="currency" name="currency" value="AFN">
                                        </div>
                                        <p class="error-message" id="expenseError">❌ لګښت لیکل لازم دی (صفر یا لوړ عدد ولیکئ)</p>
                                </div>

                                <!-- New Field 1: Sent to Home Expense -->
                                <div class="input-group full-width" id="sentToHomeGroup" style="display: none;">
                                        <label for="sentToHome" style="color: #60a5fa;">🏠 کور ته لېږل شوی خرڅه</label>
                                        <div style="display: flex; gap: 8px;">
                                                <input type="number" id="sentToHome" name="sentToHome" min="0" placeholder="اندازه ولیکئ" style="flex: 1;">
                                        </div>
                                </div>

                                <!-- New Field 2: Driver Salary -->
                                <div class="input-group full-width" id="driverSalaryGroup" style="display: none;">
                                        <label for="driverSalary" style="color: #34d399;">🚗 د ډرېور تنخوا</label>
                                        <div style="display: flex; gap: 8px;">
                                                <input type="number" id="driverSalary" name="driverSalary" min="0" placeholder="اندازه ولیکئ" style="flex: 1;">
                                        </div>
                                </div>

                                <!-- Saudi/Brooklyn Detail & Note (Restored) -->
                                <div class="input-group full-width" id="detailSaudiGroup" style="display: none;">
                                        <label for="detailSaudi">📝 تفصیل</label>
                                        <textarea id="detailSaudi" name="detailSaudi" placeholder="تفصیل ولیکئ..." rows="2"></textarea>
                                </div>
                                <div class="input-group full-width" id="noteSaudiGroup" style="display: none;">
                                        <label for="noteSaudi">📌 یاداښت</label>
                                        <input type="text" id="noteSaudi" name="noteSaudi" placeholder="یاداښت ولیکئ...">
                                </div>

                                <!-- New Field 3: Sent to Home (Mobile) -->
                                <div class="input-group full-width" id="sentToHomeMobileGroup" style="display: none;">
                                        <label for="sentToHomeMobile" style="color: #60a5fa;">🏠 کور ته ورکړل شوی خرڅه</label>
                                        <div style="display: flex; gap: 8px;">
                                                <input type="number" id="sentToHomeMobile" name="sentToHomeMobile" min="0" placeholder="اندازه ولیکئ" style="flex: 1;">
                                        </div>

                                </div>
                                <!-- New Field 4: Shop Rent (Mobile) -->
                                <div class="input-group full-width" id="shopRentGroup" style="display: none;">
                                        <label for="shopRent" style="color: #fbbf24;">🏪 دکان کرایه</label>
                                        <div style="display: flex; gap: 8px;">
                                                <input type="number" id="shopRent" name="shopRent" min="0" placeholder="اندازه ولیکئ" style="flex: 1;">
                                        </div>

                                        <!-- New Field 3.1: Details (Mobile) -->
                                        <div class="input-group full-width" id="detailMobileGroup" style="display: none;">
                                                <label for="detailMobile">📝 د کار تفصیل</label>
                                                <textarea id="detailMobile" name="detailMobile" placeholder="د کار تفصیل ولیکئ..."></textarea>
                                        </div>

                                        <!-- New Field 3.2: Note (Mobile) -->
                                        <div class="input-group full-width" id="noteMobileGroup" style="display: none;">
                                                <label for="noteMobile">📌 یاداښت</label>
                                                <input type="text" id="noteMobile" name="noteMobile" placeholder="یاداښت ولیکئ...">
                                        </div>
                                </div>

                                <!-- Added Detail Field for Joint Home Expenses -->
                                <div class="input-group full-width" id="homeJointDetailGroup" style="display: none;">
                                        <label for="detailHomeJoint">📝 تفصیل</label>
                                        <textarea id="detailHomeJoint" name="detailHomeJoint" placeholder="د لګښت تفصیل ولیکئ..." rows="2"></textarea>
                                </div>

                                <div class="input-group full-width" id="imageGroup">
                                        <label>📷 د بیل/فاتورې تصویر</label>
                                        <!-- Main Container Box -->
                                        <div id="billImageArea" style="background: rgba(255, 255, 255, 0.05); border: 2px dashed rgba(139, 92, 246, 0.3); border-radius: 14px; padding: 15px; transition: all 0.3s;">

                                                <!-- Inner Flex Container (Grid Option) -->
                                                <div style="display: flex; justify-content: space-around; align-items: center; gap: 10px; flex-wrap: wrap;">

                                                        <!-- Option 1: Gallery (Standard Image) -->
                                                        <div onclick="document.getElementById('billImageGallery').click()" style="text-align: center; cursor: pointer; flex: 1; min-width: 80px; padding: 10px; border-radius: 10px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                                                <div style="font-size: 24px; margin-bottom: 4px;">📂</div>
                                                                <div style="font-size: 11px; color: #a78bfa; font-weight: 600;">فایل/ګالري</div>
                                                        </div>

                                                </div>
                                        </div>

                                        <!-- Hidden Inputs -->
                                        <input type="file" id="billImageGallery" name="billImageGallery" accept="image/*" style="display: none;" onchange="handleImageSelect(this)">

                                        <!-- Preview Area -->
                                        <div id="imagePreview" style="display: none; margin-top: 12px; position: relative; text-align: center;">
                                                <img id="previewImg" src="" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                                <div id="compressionInfo" style="font-size: 11px; color: #6ee7b7; margin-top: 5px;"></div>
                                                <button type="button" onclick="removeImage()" style="position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold;">✕</button>
                                        </div>
                                </div>

                                <div class="submit-btn-wrapper full-width" id="submitBtnWrapper">
                                        <button type="button" class="btn-secondary" onclick="logout()">وتل</button>
                                        <button type="submit" class="submit-btn">✓ ذخیره کول</button>
                                </div>
                        </form>
                </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="modalOverlay" class="modal-overlay">
                <div class="glass-card modal">
                        <div class="modal-header">
                                <div class="modal-icon">✓</div>
                                <div>
                                        <div class="modal-title">تایید</div>
                                        <p class="modal-subtitle">مهرباني وکړئ معلومات وګورئ</p>
                                </div>
                        </div>

                        <div class="modal-body">
                                <div class="last-save-section" id="lastSaveRow" style="display: none;">
                                        <div class="last-save-title">📋 وروستی ذخیره شوی</div>
                                        <div class="data-row-grid">
                                                <div class="data-field">
                                                        <span class="data-label">📅 نېټه</span>
                                                        <span class="data-value" id="lastSaveDate">-</span>
                                                </div>
                                                <div class="data-field">
                                                        <span class="data-label">💸 لګښت</span>
                                                        <span class="data-value" id="lastSaveExpense">-</span>
                                                </div>
                                                <div class="data-field">
                                                        <span class="data-label">📝 تفصیل</span>
                                                        <span class="data-value" id="lastSaveDetail">-</span>
                                                </div>
                                        </div>
                                        <div class="data-field" id="lastSaveNoteRow" style="margin-top: 12px; display: none;">
                                                <span class="data-label">📌 یاداښت</span>
                                                <span class="data-value" id="lastSaveNote">-</span>
                                        </div>
                                </div>

                                <div class="last-save-title" style="margin-top: 20px; margin-bottom: 10px; color: #c084fc; font-weight: 700;">📝 نوي معلومات</div>
                                <div class="data-row">
                                        <div class="data-row-grid">
                                                <div class="data-field" style="grid-column: 1 / -1;">
                                                        <span class="data-value" id="confirmDetail">-</span>
                                                </div>
                                        </div>
                                </div>

                                <!-- Added Category to Modal -->
                                <div class="data-row" id="categoryRow" style="display: none;">
                                        <div class="data-field">
                                                <span class="data-label">📂 کټګوري</span>
                                                <span class="data-value" id="confirmCategory">-</span>
                                        </div>
                                </div>

                                <div class="data-row" id="sentToHomeRow" style="display: none;">
                                        <div class="data-field">
                                                <span class="data-label" style="color: #60a5fa;">🏠 کور ته لېږل شوی خرڅه</span>
                                                <span class="data-value" id="confirmSentToHome">-</span>
                                        </div>
                                </div>
                                <div class="data-row" id="driverSalaryRow" style="display: none;">
                                        <div class="data-field">
                                                <span class="data-label" style="color: #34d399;">🚗 د ډرېور تنخوا</span>
                                                <span class="data-value" id="confirmDriverSalary">-</span>
                                        </div>
                                </div>

                                <div class="data-row" id="sentToHomeMobileRow" style="display: none;">
                                        <div class="data-field">
                                                <span class="data-label" style="color: #60a5fa;">🏠 کور ته ورکړل شوی خرڅه</span>
                                                <span class="data-value" id="confirmSentToHomeMobile">-</span>
                                        </div>
                                </div>
                                <div class="data-row" id="shopRentRow" style="display: none;">
                                        <div class="data-field">
                                                <span class="data-label" style="color: #fbbf24;">🏪 دکان کرایه</span>
                                                <span class="data-value" id="confirmShopRent">-</span>
                                        </div>
                                </div>

                                <div class="data-row" id="imageRow" style="display: none;">
                                        <div class="data-field">
                                                <span class="data-label">📷 بیل تصویر</span>
                                                <span class="data-value" style="color: #6ee7b7;">✓ تصویر انتخاب شو (Compressed)</span>
                                        </div>
                                </div>

                                <div class="data-row" id="noteRow" style="display: none;">
                                        <div class="data-field">
                                                <span class="data-label">📌 یاداښت</span>
                                                <span class="data-value" id="confirmNote">-</span>
                                        </div>
                                </div>
                        </div>

                        <div class="modal-actions">
                                <button type="button" class="btn-secondary" onclick="closeModal()">✏️ سمول</button>
                                <button type="button" class="btn-success" id="confirmButton" onclick="confirmSubmit()">✓ معلومات تایید او ذخیره کړئ </button>
                        </div>
                </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="modal-overlay">
                <div class="glass-card modal" style="max-width: 700px; height: 90vh; display: flex; flex-direction: column;">
                        <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                                <div class="modal-icon" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); box-shadow: 0 12px 30px rgba(99, 102, 241, 0.4);">📊</div>
                                <div>
                                        <div class="modal-title" id="dashboardTitle">ډشبورډ</div>
                                        <p class="modal-subtitle" id="dashboardSubtitle">د حساب عمومي معلومات</p>
                                </div>
                                <button type="button" id="dashboardDeleteBtn" class="btn-secondary" style="margin-right: auto; background: rgba(239, 68, 68, 0.2); color: #fca5a5; margin-left: 10px; font-size: 12px; display: none;" onclick="clearAllData()">🗑️ ړنګول</button>
                                <button type="button" class="btn-close-fancy" onclick="closeDashboard()" style="position: absolute; top: 15px; left: 15px;">✕</button>
                        </div>

                        <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">

                                <!-- Joint Expenses Form (Hidden by default) -->
                                <div id="jointExpensesContent" style="display:none !important;" style="display: none;">
                                        <form onsubmit="handleJointExpenseSubmit(event)" style="display: flex; flex-direction: column; gap: 15px;">

                                                <!-- Date -->
                                                <div class="input-group full-width">
                                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">📅 نېټه</label>
                                                        <input type="date" id="jointDate" required style="width: 95%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; box-sizing: border-box;">
                                                </div>

                                                <!-- Expenses -->
                                                <div class="input-group full-width">
                                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">💸 لګښت </label>
                                                        <input type="number" id="jointExpense" required min="0" placeholder="لګښت ولیکئ" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; box-sizing: border-box;">
                                                </div>

                                                <!-- Details -->
                                                <div class="input-group full-width">
                                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">📝 تفصیل</label>
                                                        <textarea id="jointDetail" required placeholder="د لګښتونو تفصیل ولیکئ..." rows="3" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; resize: none; box-sizing: border-box;"></textarea>
                                                </div>

                                                <!-- Image Upload (Same system as others) -->
                                                <div class="input-group full-width">
                                                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">📷 د بیل تصویرونه</label>
                                                        <div style="background: rgba(255, 255, 255, 0.05); border: 2px dashed rgba(139, 92, 246, 0.3); border-radius: 14px; padding: 15px;">
                                                                <div style="display: flex; justify-content: space-around; align-items: center; gap: 10px;">
                                                                        <div onclick="document.getElementById('jointImageInput').click()" style="text-align: center; cursor: pointer; flex: 1; padding: 10px; border-radius: 10px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                                                                <div style="font-size: 24px; margin-bottom: 4px;">📂</div>
                                                                                <div style="font-size: 11px; color: #a78bfa;">ګالري</div>
                                                                        </div>
                                                                        <div onclick="openCamera('photo', 'joint')" style="text-align: center; cursor: pointer; flex: 1; padding: 10px; border-radius: 10px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                                                                <div style="font-size: 24px; margin-bottom: 4px;">📸</div>
                                                                                <div style="font-size: 11px; color: #6ee7b7;">کېمره</div>
                                                                        </div>
                                                                </div>
                                                        </div>
                                                        <input type="file" id="jointImageInput" accept="image/*" style="display: none;" onchange="handleJointImageSelect(this)">

                                                        <!-- Preview -->
                                                        <div id="jointImagePreview" style="display: none; margin-top: 12px; position: relative; text-align: center;">
                                                                <img id="jointPreviewImg" src="" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                                                <button type="button" onclick="removeJointImage()" style="position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer;">✕</button>
                                                        </div>
                                                </div>

                                                <button type="submit" class="submit-btn" style="margin-top: 10px;">✓ ذخیره کول</button>
                                        </form>

                                        <!-- Toast Notification -->
                                        <div id="toast" class="toast">
                                                <div class="toast-title" id="toastTitle"></div>
                                                <div class="toast-description" id="toastDescription"></div>
                                        </div>

                                        <script>
                                                const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwlUV9eI2fQhQ3v_D4K6bVoZOiVbRR24eQfD26NrnAx25BU_b2BAU_E7YTftTyiumiLZg/exec';
                                                // Note: DRIVE_FOLDER_URL is usually handled by the Google Script, not frontend directly unless using Google Picker API,
                                                // but keeping it here as it was in the original code.
                                                const DRIVE_FOLDER_URL = 'https://drive.google.com/drive/folders/1I5FZzH-exwNCoFTMsfMnjS31ep8MX8RX';

                                                const JOBS = [
                                                        { id: 'saudi', name: 'سعودي حساب', password: 'saudi123', icon: '🕌', desc: 'د سعودي کار' },
                                                        { id: 'boklyn', name: 'بوکلین حساب', password: 'boklyn123', icon: '🏗️', desc: 'د بوکلین کار' },
                                                        { id: 'mobile', name: 'موبایل حساب', password: 'mobile123', icon: '📱', desc: 'د موبایلونو کار' },
                                                        { id: 'home', name: 'کور لګښتونه', password: 'home123', icon: '🏠', desc: ' د کور ورځنی لګښتونه' }
                                                ];

                                                // Saudi Sub-Accounts Data
                                                const SAUDI_SUB_ACCOUNTS = [
                                                        { id: 'saudi_12module', name: '12 ماډل ترېله 3125 نمبر', password: 'saudi123', icon: '🚛', image: './trailer_3125.jpg', desc: '12 ماډل ترېله' },
                                                        { id: 'saudi_14module', name: '14 ماډل ترېله 6437 نمبر', password: 'saudi123', icon: '🚚', image: './trailer_6437.jpg', desc: '14 ماډل ترېله' }
                                                ];

                                                // Home Sub-Accounts Data
                                                const HOME_SUB_ACCOUNTS = [
                                                        { id: 'home_lalak', name: 'للک', password: 'home123', icon: '👨‍👧‍👦', desc: 'د للک لګښت', cardClass: 'home-card-lalak' },
                                                        { id: 'home_saifullah', name: 'سیف الله', password: 'home123', icon: '👤', desc: 'د سیف الله لګښت', cardClass: 'home-card-saifullah' },
                                                        { id: 'home_saeedullah', name: 'سعید الله', password: 'home123', icon: '👤', desc: 'د سعید الله لګښت', cardClass: 'home-card-saeedullah' },
                                                        { id: 'home_siddiqullah', name: 'صدیق الله', password: 'home123', icon: '👤', desc: 'د صدیق الله لګښت', cardClass: 'home-card-siddiqullah' },
                                                        { id: 'home_adil', name: 'عادل', password: 'home123', icon: '👤', desc: 'د عادل لګښت', cardClass: 'home-card-adil' },
                                                        { id: 'home_joint', name: 'مشترک لګښتونه', password: 'home123', icon: '🤝', desc: 'د کور ګډ لګښتونه', cardClass: 'home-card-joint' }
                                                ];

                                                let currentJob = null;
                                                let currentPassword = null;
                                                let formDataToSubmit = null;
                                                let originalImageFile = null; // Store the original file
                                                let compressedImageBlob = null; // Store the compressed blob

                                                // Camera Variables
                                                let videoStream = null;
                                                let currentMode = 'photo';
                                                let html5QrCode = null;

                                                /* Currency Helper Functions */
                                                function openOpExpScreen() {
                                                        document.getElementById('opExpScreen').classList.add('active');
                                                        renderExpList('opExp');
                                                }

                                                function closeOpExpScreen() {
                                                        document.getElementById('opExpScreen').classList.remove('active');
                                                }

                                                function openCapExpScreen() {
                                                        document.getElementById('capExpScreen').classList.add('active');
                                                        renderExpList('capExp');
                                                }

                                                function closeCapExpScreen() {
                                                        document.getElementById('capExpScreen').classList.remove('active');
                                                }

                                                function handleOpExpSubmit(e) {
                                                        e.preventDefault();
                                                        saveExp('opExp');
                                                }

                                                function handleCapExpSubmit(e) {
                                                        e.preventDefault();
                                                        saveExp('capExp');
                                                }

                                                function saveExp(type) {
                                                        const amount = document.getElementById(type + 'Amount').value;
                                                        const date = document.getElementById(type + 'Date').value;
                                                        const desc = document.getElementById(type + 'Desc').value;
                                                        if (!amount || !date || !desc) return;

                                                        const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
                                                        list.push({ amount, date, desc, timestamp: Date.now() });
                                                        localStorage.setItem(type + '_list', JSON.stringify(list));

                                                        document.getElementById(type + 'Amount').value = '';
                                                        document.getElementById(type + 'Desc').value = '';
                                                        renderExpList(type);
                                                        updateGeneralDashboard();
                                                        showToast('success', 'ریکارډ ذخیره شو');
                                                }

                                                function renderExpList(type) {
                                                        const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
                                                        const container = document.getElementById(type + 'List');
                                                        container.innerHTML = list.reverse().map(item => `
                <div class="data-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <div>
                        <div style="font-weight: bold;">${item.desc}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${item.date}</div>
                    </div>
                    <div style="font-weight: bold; color: ${type === 'opExp' ? '#f87171' : '#fb923c'}">${parseFloat(item.amount).toLocaleString()} ؋</div>
                </div>
            `).join('');
                                                }

                                                /* Expenses Helpers */
                                                function openOpExpScreen() {
                                                        document.getElementById('opExpScreen').classList.add('active');
                                                        renderExpList('opExp');
                                                }

                                                function closeOpExpScreen() {
                                                        document.getElementById('opExpScreen').classList.remove('active');
                                                }

                                                function openCapExpScreen() {
                                                        document.getElementById('capExpScreen').classList.add('active');
                                                        renderExpList('capExp');
                                                }

                                                function closeCapExpScreen() {
                                                        document.getElementById('capExpScreen').classList.remove('active');
                                                }

                                                function handleOpExpSubmit(e) {
                                                        e.preventDefault();
                                                        saveExp('opExp');
                                                }

                                                function handleCapExpSubmit(e) {
                                                        e.preventDefault();
                                                        saveExp('capExp');
                                                }

                                                function saveExp(type) {
                                                        const amount = document.getElementById(type + 'Amount').value;
                                                        const date = document.getElementById(type + 'Date').value;
                                                        const desc = document.getElementById(type + 'Desc').value;
                                                        if (!amount || !date || !desc) return;

                                                        const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
                                                        list.push({ amount, date, desc, timestamp: Date.now() });
                                                        localStorage.setItem(type + '_list', JSON.stringify(list));

                                                        document.getElementById(type + 'Amount').value = '';
                                                        document.getElementById(type + 'Desc').value = '';
                                                        renderExpList(type);
                                                        updateGeneralDashboard();
                                                        showToast('success', 'ریکارډ ذخیره شو');
                                                }

                                                function renderExpList(type) {
                                                        const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
                                                        const container = document.getElementById(type + 'List');
                                                        container.innerHTML = list.reverse().map(item => `
                <div class="data-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 5px;">
                    <div>
                        <div style="font-weight: bold;">${item.desc}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${item.date}</div>
                    </div>
                    <div style="font-weight: bold; color: ${type === 'opExp' ? '#f87171' : '#fb923c'}">${parseFloat(item.amount).toLocaleString()} ؋</div>
                </div>
            `).join('');
                                                }

                                                function getCurrencyLabel() {
                                                        if (currentJob && (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_'))) {
                                                                return 'ر.س';
                                                        }
                                                        return '؋';
                                                }

                                                function getCurrencyCode() {
                                                        if (currentJob && (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_'))) {
                                                                return 'SAR';
                                                        }
                                                        return 'AFN';
                                                }

                                                // --- DELETION LOGIC ---
                                                function deleteTransaction(timestamp) {
                                                        if (!confirm('آیا غواړئ دا ریکارډ حذف کړئ؟')) return;

                                                        let targetAccountId = currentJob.id;
                                                        const accountSelector = document.getElementById('reportAccountSelector');
                                                        const adminSelectContainer = document.getElementById('adminAccountSelectContainer');

                                                        if (adminSelectContainer && adminSelectContainer.style.display !== 'none' && accountSelector && accountSelector.value !== 'current') {
                                                                targetAccountId = accountSelector.value;
                                                        }

                                                        let history = JSON.parse(localStorage.getItem('history_' + targetAccountId) || '[]');
                                                        const initialLength = history.length;

                                                        // Filter out the item with the matching timestamp
                                                        // Note: Old data might not have timestamp, but new ones do.
                                                        // If no timestamp, we might need another strategy, but for now assuming timestamp exists as per line 2569
                                                        history = history.filter(item => {
                                                                // Handle legacy data without timestamp if necessary (though difficult without unique ID)
                                                                if (item.timestamp) {
                                                                        return item.timestamp != timestamp;
                                                                }
                                                                return true; // Keep items without timestamp to be safe or delete by index? Timestamp is safer.
                                                        });

                                                        if (history.length < initialLength) {
                                                                localStorage.setItem('history_' + targetAccountId, JSON.stringify(history));

                                                                // Recalculate Stats from scratch
                                                                recalculateStats(targetAccountId);

                                                                showToast('success', 'ریکارډ حذف شو');
                                                                filterReportByDuration(); // Refresh list

                                                                // If dashboard is open, update it too
                                                                if (document.getElementById('dashboardScreen').classList.contains('active')) {
                                                                        updateDashboardStats(targetAccountId);
                                                                }
                                                        } else {
                                                                showToast('error', 'تېروتنه', 'ریکارډ ونه موندل شو');
                                                        }
                                                }

                                                function clearAllData() {
                                                        if (!confirm('⚠️ خطر: آیا تاسو ډاډه یاست چې د دې حساب ټول ریکارډونه حذف کول غواړئ؟\n\nدا عمل د بېرته راګرځولو وړ نه دی!')) return;

                                                        const userInput = prompt('د تایید لپاره "delete" ولیکئ:');
                                                        if (userInput !== 'delete') {
                                                                if (userInput !== null) showToast('error', 'تېروتنه', 'تایید ناکام شو');
                                                                return;
                                                        }

                                                        let targetAccountId = currentJob.id;
                                                        const accountSelector = document.getElementById('reportAccountSelector');
                                                        const adminSelectContainer = document.getElementById('adminAccountSelectContainer');

                                                        if (adminSelectContainer && adminSelectContainer.style.display !== 'none' && accountSelector && accountSelector.value !== 'current') {
                                                                targetAccountId = accountSelector.value;
                                                        }

                                                        // Clear History
                                                        localStorage.setItem('history_' + targetAccountId, '[]');

                                                        // Reset Stats
                                                        localStorage.setItem('stats_' + targetAccountId, JSON.stringify({ income: 0, expense: 0 }));

                                                        // Reset Balance (Only for Home Accounts if needed, or generally)
                                                        if (targetAccountId.startsWith('home_')) {
                                                                // For shared balance, we might want to keep it or reset it? 
                                                                // User asked to delete "written data". Usually implies transactions history.
                                                                // Balance is separate in localStorage 'home_shared_balance'.
                                                                // I will leave shared balance alone as it is "Shared".
                                                        }

                                                        showToast('success', '✨ ټول ریکارډونه پاک شول');
                                                        filterReportByDuration();

                                                        if (document.getElementById('dashboardScreen').classList.contains('active')) {
                                                                updateDashboardStats(targetAccountId);
                                                        }
                                                }

                                                function recalculateStats(accountId) {
                                                        let history = JSON.parse(localStorage.getItem('history_' + accountId) || '[]');
                                                        let income = 0;
                                                        let expense = 0;

                                                        const isSaudiOrBoklyn = accountId === 'saudi' || accountId.startsWith('saudi_') || accountId === 'boklyn';
                                                        const isMobile = accountId === 'mobile';

                                                        history.forEach(item => {
                                                                income += parseFloat(item.income || 0);

                                                                let rowExpense = parseFloat(item.expense || 0);
                                                                if (isSaudiOrBoklyn) {
                                                                        rowExpense += parseFloat(item.sentToHome || 0);
                                                                        rowExpense += parseFloat(item.driverSalary || 0);
                                                                } else if (isMobile) {
                                                                        rowExpense += parseFloat(item.sentToHomeMobile || 0);
                                                                        rowExpense += parseFloat(item.shopRent || 0);
                                                                }
                                                                expense += rowExpense;
                                                        });

                                                        localStorage.setItem('stats_' + accountId, JSON.stringify({ income, expense }));
                                                }

                                                // --- GENERAL DASHBOARD LOGIC ---

                                                function openInvestmentAuth() {
                                                        // Set a special job context for Investment
                                                        currentJob = {
                                                                id: 'investment',
                                                                name: 'پانګونه',
                                                                icon: '💼'
                                                        };
                                                        currentPassword = 'invest123';

                                                        document.getElementById('jobSelectionScreen').classList.add('hidden');

                                                        // Show account name in password screen header
                                                        const titleEl = document.querySelector('#passwordScreen .password-title');
                                                        if (titleEl) titleEl.textContent = currentJob.name;
                                                        const subtitleEl = document.querySelector('#passwordScreen .password-subtitle');
                                                        if (subtitleEl) subtitleEl.textContent = '🔐 د ننوتلو لپاره پاسورډ ولیکئ';

                                                        document.getElementById('passwordScreen').classList.remove('hidden');
                                                        setTimeout(() => document.getElementById('passwordInput').focus(), 100);
                                                }

                                                // --- LOAN BOOK LOGIC ---
                                                function openLoanBookAuth() {
                                                        currentJob = {
                                                                id: 'loan_book',
                                                                name: 'د قرضونو کتابچه',
                                                                icon: '📔'
                                                        };
                                                        currentPassword = 'loan123';

                                                        document.getElementById('jobSelectionScreen').classList.add('hidden');

                                                        const titleEl = document.querySelector('#passwordScreen .password-title');
                                                        if (titleEl) titleEl.textContent = currentJob.name;
                                                        const subtitleEl = document.querySelector('#passwordScreen .password-subtitle');
                                                        if (subtitleEl) subtitleEl.textContent = '🔐 د ننوتلو لپاره پاسورډ ولیکئ';

                                                        document.getElementById('passwordScreen').classList.remove('hidden');
                                                        setTimeout(() => document.getElementById('passwordInput').focus(), 100);
                                                }

                                                function openLoanBookMenu() {
                                                        document.getElementById('passwordScreen').classList.add('hidden');
                                                        document.getElementById('loanBookMenuScreen').classList.remove('hidden');
                                                }

                                                function closeLoanBookMenu() {
                                                        document.getElementById('loanBookMenuScreen').classList.add('hidden');
                                                        document.getElementById('jobSelectionScreen').classList.remove('hidden');
                                                        currentJob = null;
                                                }

                                                function openLoanReceivables() {
                                                        document.getElementById('loanBookMenuScreen').classList.add('hidden');
                                                        document.getElementById('loanReceivablesScreen').classList.remove('hidden');

                                                        // Reset fields
                                                        document.getElementById('loanRecDate').value = new Date().toISOString().split('T')[0];
                                                        document.getElementById('loanRecName').value = '';
                                                        document.getElementById('loanRecAmount').value = '';
                                                        document.getElementById('loanRecDesc').value = '';
                                                        document.getElementById('loanRecImage').value = '';
                                                }

                                                function closeLoanReceivables() {
                                                        document.getElementById('loanReceivablesScreen').classList.add('hidden');
                                                        document.getElementById('loanBookMenuScreen').classList.remove('hidden');
                                                }

                                                function openLoanPayables() {
                                                        document.getElementById('loanBookMenuScreen').classList.add('hidden');
                                                        document.getElementById('loanPayablesScreen').classList.remove('hidden');

                                                        // Reset fields
                                                        document.getElementById('loanPayDate').value = new Date().toISOString().split('T')[0];
                                                        document.getElementById('loanPayName').value = '';
                                                        document.getElementById('loanPayAmount').value = '';
                                                        document.getElementById('loanPayDesc').value = '';
                                                        document.getElementById('loanPayImage').value = '';
                                                }

                                                function closeLoanPayables() {
                                                        document.getElementById('loanPayablesScreen').classList.add('hidden');
                                                        document.getElementById('loanBookMenuScreen').classList.remove('hidden');
                                                }

                                                function submitLoanReceivable() {
                                                        const date = document.getElementById('loanRecDate').value;
                                                        const name = document.getElementById('loanRecName').value;
                                                        const amount = document.getElementById('loanRecAmount').value;
                                                        const desc = document.getElementById('loanRecDesc').value;
                                                        // Image handling is visual only in this HTML version

                                                        if (!name || !amount) {
                                                                alert('مهرباني وکړئ نوم او اندازه ولیکئ!');
                                                                return;
                                                        }

                                                        alert('✅ ریکارډ په بریالیتوب سره ثبت شو');
                                                        closeLoanReceivables();
                                                }

                                                function submitLoanPayable() {
                                                        const date = document.getElementById('loanPayDate').value;
                                                        const name = document.getElementById('loanPayName').value;
                                                        const amount = document.getElementById('loanPayAmount').value;
                                                        const desc = document.getElementById('loanPayDesc').value;

                                                        if (!name || !amount) {
                                                                alert('مهرباني وکړئ نوم او اندازه ولیکئ!');
                                                                return;
                                                        }

                                                        alert('✅ ریکارډ په بریالیتوب سره ثبت شو');
                                                        closeLoanPayables();
                                                }

                                                function openGeneralDashboardAuth() {
                                                        // Set a special job context for General Dashboard
                                                        currentJob = {
                                                                id: 'general_dashboard_admin',
                                                                name: 'عمومي مالي ډشبورډ',
                                                                icon: '📊'
                                                        };

                                                        // We don't set a single 'currentPassword' because we accept multiple.
                                                        // The checkPassword function will handle this special ID.

                                                        document.getElementById('jobSelectionScreen').classList.add('hidden');

                                                        // Update password screen title for this context
                                                        const titleEl = document.querySelector('#passwordScreen .password-title');
                                                        if (titleEl) titleEl.textContent = 'عمومي مالي ډشبورډ';
                                                        const subtitleEl = document.querySelector('#passwordScreen .password-subtitle');
                                                        if (subtitleEl) subtitleEl.textContent = '🔐 د ننوتلو لپاره پاسورډ ولیکئ';

                                                        document.getElementById('passwordScreen').classList.remove('hidden');
                                                        setTimeout(() => document.getElementById('passwordInput').focus(), 100);
                                                }

                                                function openGeneralDashboard() {
                                                        document.getElementById('jobSelectionScreen').classList.add('hidden');
                                                        document.getElementById('passwordScreen').classList.add('hidden'); // Ensure password screen is closed
                                                        document.getElementById('generalDashboardScreen').classList.remove('hidden');
                                                        updateGeneralDashboard();
                                                }

                                                function closeGeneralDashboard() {
                                                        document.getElementById('generalDashboardScreen').classList.add('hidden');
                                                        document.getElementById('jobSelectionScreen').classList.remove('hidden');
                                                }

                                                let dashboardChart = null;

                                                function initDashboardChart() {
                                                        const ctx = document.getElementById('dashboardChart');
                                                        if (!ctx) return;
                                                        if (dashboardChart) dashboardChart.destroy();
                                                        dashboardChart = new Chart(ctx, {
                                                                type: 'line',
                                                                data: {
                                                                        labels: ['جدي', 'دلو', 'حوت', 'حمل', 'ثور', 'جوزا'],
                                                                        datasets: [{
                                                                                label: 'عاید',
                                                                                data: [12000, 19000, 3000, 5000, 2000, 3000],
                                                                                borderColor: '#6ee7b7',
                                                                                backgroundColor: 'rgba(110, 231, 183, 0.1)',
                                                                                borderWidth: 2,
                                                                                fill: true,
                                                                                tension: 0.4
                                                                        }, {
                                                                                label: 'لګښت',
                                                                                data: [8000, 15000, 5000, 2000, 8000, 4000],
                                                                                borderColor: '#fca5a5',
                                                                                backgroundColor: 'rgba(252, 165, 165, 0.1)',
                                                                                borderWidth: 2,
                                                                                fill: true,
                                                                                tension: 0.4
                                                                        }]
                                                                },
                                                                options: {
                                                                        responsive: true,
                                                                        maintainAspectRatio: false,
                                                                        plugins: {
                                                                                legend: {
                                                                                        labels: { color: '#94a3b8', font: { family: 'Noto Naskh Arabic' } }
                                                                                }
                                                                        },
                                                                        scales: {
                                                                                y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                                                                                x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                                                                        }
                                                                }
                                                        });
                                                }

                                                function updateGeneralDashboard() {
                                                        console.log('Updating simplified dashboard');
                                                        let totalWorth = 0;
                                                        let totalIncome = 0;
                                                        let totalExpense = 0;
                                                        let totalReceivable = 0;
                                                        let totalLiability = 0;

                                                        const SAR_TO_AFN = 18.5;

                                                        // 1. Calculate from Jobs
                                                        JOBS.forEach(job => {
                                                                if (job.id === 'saudi' || job.id === 'home') return;
                                                                const stats = JSON.parse(localStorage.getItem('stats_' + job.id) || '{"income": 0, "expense": 0}');
                                                                totalIncome += parseFloat(stats.income || 0);
                                                                totalExpense += parseFloat(stats.expense || 0);
                                                        });

                                                        // 2. Saudi Accounts
                                                        SAUDI_SUB_ACCOUNTS.forEach(acc => {
                                                                const bal = getBal(acc.id);
                                                                totalWorth += (bal * SAR_TO_AFN);
                                                                const stats = getStats(acc.id);
                                                                totalIncome += (stats.income * SAR_TO_AFN);
                                                                totalExpense += (stats.expense * SAR_TO_AFN);
                                                        });

                                                        // 3. Home Accounts
                                                        // HOME_SUB_ACCOUNTS.forEach(acc => {
                                                        //    const bal = getBal(acc.id);
                                                        //    totalWorth += bal;
                                                        //    const stats = getStats(acc.id);
                                                        //    totalIncome += stats.income;
                                                        //    totalExpense += stats.expense;
                                                        // });

                                                        // 4. Debts
                                                        const debts = JSON.parse(localStorage.getItem('debt_data') || '[]');
                                                        debts.forEach(d => {
                                                                const amt = parseFloat(d.amount);
                                                                if (d.type === 'receivable') {
                                                                        totalReceivable += amt;
                                                                        totalWorth += amt;
                                                                } else {
                                                                        totalLiability += amt;
                                                                        totalWorth -= amt;
                                                                }
                                                        });

                                                        // Add cash on hand (net from jobs)
                                                        totalWorth += (totalIncome - totalExpense);

                                                        // Update UI
                                                        if (document.getElementById('dashTotalWorth')) document.getElementById('dashTotalWorth').textContent = Math.round(totalWorth).toLocaleString();
                                                        if (document.getElementById('dashNetProfit')) document.getElementById('dashNetProfit').textContent = Math.round(totalIncome - totalExpense).toLocaleString();
                                                        if (document.getElementById('dashTotalIncome')) document.getElementById('dashTotalIncome').textContent = Math.round(totalIncome).toLocaleString();
                                                        if (document.getElementById('dashTotalExpense')) document.getElementById('dashTotalExpense').textContent = Math.round(totalExpense).toLocaleString();
                                                        if (document.getElementById('dashReceivable')) document.getElementById('dashReceivable').textContent = totalReceivable.toLocaleString();
                                                        if (document.getElementById('dashLiability')) document.getElementById('dashLiability').textContent = totalLiability.toLocaleString();

                                                        // Monthly Growth calculation (Mock comparison)
                                                        const prevWorth = parseFloat(localStorage.getItem('prev_total_worth') || totalWorth);
                                                        const growth = prevWorth > 0 ? ((totalWorth - prevWorth) / prevWorth * 100).toFixed(2) : "0";
                                                        if (document.getElementById('dashGrowth')) document.getElementById('dashGrowth').textContent = growth;

                                                        localStorage.setItem('prev_total_worth', totalWorth.toString());
                                                }

                                                function editDashValue(key) {
                                                        const current = localStorage.getItem('gen_dash_' + key) || '0';
                                                        let label = '';

                                                        switch (key) {
                                                                case 'inventory':
                                                                        label = 'د ګدام د موجوده مال ارزښت:';
                                                                        break;
                                                                case 'opExp':
                                                                        label = 'عملیاتي مصارف (کرایه، معاش، نور):';
                                                                        break;
                                                                case 'capExp':
                                                                        label = 'پانګیز مصارف (ماشین، تجهیزات، نور):';
                                                                        break;
                                                                case 'initial_capital':
                                                                        label = 'لومړنۍ سرمایه (د ګټې معلومولو لپاره):';
                                                                        break;
                                                                case 'last_month_worth':
                                                                        label = 'د تیرې میاشتې ټوله سرمایه (د ودې لپاره):';
                                                                        break;
                                                                default:
                                                                        label = 'اندازه وټاکئ:';
                                                        }

                                                        const newVal = prompt(label + "\n\nاوسنۍ اندازه: " + current, current);

                                                        if (newVal !== null && !isNaN(newVal) && newVal.trim() !== '') {
                                                                localStorage.setItem('gen_dash_' + key, newVal);
                                                                updateGeneralDashboard();
                                                                showToast('success', 'معلومات تازه شول');
                                                        }
                                                }

                                                function initJobSelector() {
                                                        const container = document.getElementById('jobGrid');
                                                        container.innerHTML = JOBS.map(job => `
                <div class="job-card" onclick="selectJob('${job.id}', '${job.name}', '${job.password}', '${job.icon}')">
                    <div class="job-icon">${job.icon}</div>
                    <div class="job-name">${job.name}</div>
                    <div class="job-desc">${job.desc}</div>
                </div>
            `).join('');
                                                }

                                                function initSaudiSubAccountSelector() {
                                                        const container = document.getElementById('saudiSubAccountGrid');
                                                        container.innerHTML = SAUDI_SUB_ACCOUNTS.map(account => `
                <div class="job-card" onclick="selectSaudiSubAccount('${account.id}', '${account.name}', '${account.password}', '${account.image}')">
                    ${account.image ? `
                        <img src="${account.image}" alt="${account.name}" class="job-image" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="job-icon job-image-error">${account.icon}</div>
                    ` : `
                        <div class="job-icon">${account.icon}</div>
                    `}
                    <div class="job-name">${account.name}</div>
                    <div class="job-desc">${account.desc}</div>
                </div>
            `).join('');
                                                }

                                                function initHomeSubAccountSelector() {
                                                        const container = document.getElementById('homeSubAccountGrid');
                                                        container.innerHTML = HOME_SUB_ACCOUNTS.map(account => `
                <div class="job-card ${account.cardClass}" onclick="selectHomeSubAccount('${account.id}', '${account.name}', '${account.password}', '${account.icon}')">
                    <div class="job-icon">${account.icon}</div>
                    <div class="job-name">${account.name}</div>
                    <div class="job-desc">${account.desc}</div>
                </div>
            `).join('');
                                                }

                                                function selectJob(jobId, jobName, password, icon) {
                                                        if (jobId === 'saudi') {
                                                                document.getElementById('jobSelectionScreen').classList.add('hidden');
                                                                document.getElementById('saudiSubAccountScreen').classList.remove('hidden');
                                                        } else if (jobId === 'home') {
                                                                document.getElementById('jobSelectionScreen').classList.add('hidden');
                                                                document.getElementById('homeSubAccountScreen').classList.remove('hidden');
                                                        } else {
                                                                currentJob = { id: jobId, name: jobName, icon: icon };
                                                                currentPassword = password;
                                                                document.getElementById('jobSelectionScreen').classList.add('hidden');

                                                                // Set the correct name for the password screen header
                                                                const titleEl = document.querySelector('#passwordScreen .password-title');
                                                                if (titleEl) titleEl.textContent = jobName;
                                                                const subtitleEl = document.querySelector('#passwordScreen .password-subtitle');
                                                                if (subtitleEl) subtitleEl.textContent = '🔐 د ننوتلو لپاره پاسورډ ولیکئ';

                                                                document.getElementById('passwordScreen').classList.remove('hidden');
                                                                setTimeout(() => document.getElementById('passwordInput').focus(), 100);
                                                        }
                                                }

                                                function selectSaudiSubAccount(subId, subName, password, image) {
                                                        currentJob = { id: subId, name: subName, image: image, icon: '🚛' };
                                                        currentPassword = password;
                                                        document.getElementById('saudiSubAccountScreen').classList.add('hidden');

                                                        // Show account name in password screen header
                                                        const titleEl = document.querySelector('#passwordScreen .password-title');
                                                        if (titleEl) titleEl.textContent = subName;
                                                        const subtitleEl = document.querySelector('#passwordScreen .password-subtitle');
                                                        if (subtitleEl) subtitleEl.textContent = '🔐 د ننوتلو لپاره پاسورډ ولیکئ';

                                                        document.getElementById('passwordScreen').classList.remove('hidden');
                                                        setTimeout(() => document.getElementById('passwordInput').focus(), 100);
                                                }

                                                function selectHomeSubAccount(subId, subName, password, icon) {
                                                        currentJob = { id: subId, name: subName, icon: icon };
                                                        currentPassword = password;
                                                        document.getElementById('homeSubAccountScreen').classList.add('hidden');

                                                        // Show account name in password screen header
                                                        const titleEl = document.querySelector('#passwordScreen .password-title');
                                                        if (titleEl) titleEl.textContent = subName;
                                                        const subtitleEl = document.querySelector('#passwordScreen .password-subtitle');
                                                        if (subtitleEl) subtitleEl.textContent = '🔐 د ننوتلو لپاره پاسورډ ولیکئ';

                                                        document.getElementById('passwordScreen').classList.remove('hidden');
                                                        setTimeout(() => document.getElementById('passwordInput').focus(), 100);
                                                }

                                                function backFromSaudiSubAccount() {
                                                        document.getElementById('saudiSubAccountScreen').classList.add('hidden');
                                                        document.getElementById('jobSelectionScreen').classList.remove('hidden');
                                                }

                                                function backFromHomeSubAccount() {
                                                        document.getElementById('homeSubAccountScreen').classList.add('hidden');
                                                        document.getElementById('jobSelectionScreen').classList.remove('hidden');
                                                }

                                                function backToJobs() {
                                                        document.getElementById('passwordScreen').classList.add('hidden');
                                                        document.getElementById('passwordInput').value = '';
                                                        document.getElementById('passwordError').style.display = 'none';

                                                        // Check if we were coming from General Dashboard Auth
                                                        if (currentJob && currentJob.id === 'general_dashboard_admin') {
                                                                document.getElementById('jobSelectionScreen').classList.remove('hidden');
                                                                currentJob = null;
                                                                return;
                                                        }

                                                        if (currentJob && currentJob.id.startsWith('saudi_')) {
                                                                document.getElementById('saudiSubAccountScreen').classList.remove('hidden');
                                                        } else if (currentJob && currentJob.id.startsWith('home_')) {
                                                                document.getElementById('homeSubAccountScreen').classList.remove('hidden');
                                                        } else {
                                                                document.getElementById('jobSelectionScreen').classList.remove('hidden');
                                                        }
                                                        currentJob = null;
                                                }

                                                // --- IMAGE LOGIC ---

                                                function handleImageSelect(input) {
                                                        if (input.files && input.files[0]) {
                                                                originalImageFile = input.files[0];
                                                                processImage(originalImageFile);
                                                        }
                                                }

                                                function processImage(file) {
                                                        const reader = new FileReader();
                                                        reader.onload = function(e) {
                                                                const img = new Image();
                                                                img.onload = function() {
                                                                        const maxWidth = 1600;
                                                                        const maxHeight = 1600;
                                                                        let width = img.width;
                                                                        let height = img.height;

                                                                        if (width > height) {
                                                                                if (width > maxWidth) {
                                                                                        height *= maxWidth / width;
                                                                                        width = maxWidth;
                                                                                }
                                                                        } else {
                                                                                if (height > maxHeight) {
                                                                                        width *= maxHeight / height;
                                                                                        height = maxHeight;
                                                                                }
                                                                        }

                                                                        const canvas = document.createElement('canvas');
                                                                        canvas.width = width;
                                                                        canvas.height = height;
                                                                        const ctx = canvas.getContext('2d');

                                                                        // Standard Draw
                                                                        ctx.drawImage(img, 0, 0, width, height);

                                                                        canvas.toBlob((blob) => {
                                                                                compressedImageBlob = blob;

                                                                                const previewUrl = URL.createObjectURL(blob);
                                                                                document.getElementById('previewImg').src = previewUrl;
                                                                                document.getElementById('imagePreview').style.display = 'block';
                                                                                document.getElementById('billImageArea').style.borderColor = '#10b981';
                                                                                document.getElementById('billImageArea').style.background = 'rgba(16, 185, 129, 0.1)';

                                                                                const originalSize = (file.size / 1024).toFixed(1) + ' KB';
                                                                                const compressedSize = (blob.size / 1024).toFixed(1) + ' KB';

                                                                                document.getElementById('compressionInfo').innerHTML = `اصلی: ${originalSize} <br> کمپریس شوی: <span style="color: #fff; font-weight:bold;">${compressedSize}</span>`;

                                                                        }, 'image/jpeg', 0.7);
                                                                }
                                                                img.src = e.target.result;
                                                        }
                                                        reader.readAsDataURL(file);
                                                }

                                                function removeImage() {
                                                        if (document.getElementById('billImageGallery')) document.getElementById('billImageGallery').value = '';

                                                        originalImageFile = null;
                                                        compressedImageBlob = null;

                                                        document.getElementById('imagePreview').style.display = 'none';
                                                        document.getElementById('billImageArea').style.borderColor = 'rgba(139, 92, 246, 0.3)';
                                                        document.getElementById('billImageArea').style.background = 'rgba(255, 255, 255, 0.05)';
                                                }


                                                let currentReportData = [];

                                                function openReport() {
                                                        const reportScreen = document.getElementById('reportScreen');
                                                        if (reportScreen) {
                                                                reportScreen.classList.remove('hidden');
                                                                reportScreen.style.display = 'flex'; // Ensure it's visible
                                                        }

                                                        document.getElementById('formContainer').classList.add('hidden');

                                                        document.getElementById('reportTitle').textContent = `د ${currentJob.name} راپور`;

                                                        // Initialize new download inputs
                                                        toggleReportInputs();

                                                        // Clear table filters
                                                        document.getElementById('tableFilterSearch').value = '';
                                                        document.getElementById('tableFilterStart').value = '';
                                                        document.getElementById('tableFilterEnd').value = '';

                                                        // Load Data
                                                        const storageKey = 'history_' + currentJob.id;
                                                        let rawData = JSON.parse(localStorage.getItem(storageKey) || '[]');

                                                        // Legacy Fallback
                                                        if (rawData.length === 0) {
                                                                const legacyTrans = JSON.parse(localStorage.getItem('transactions') || '[]');
                                                                const filteredLegacy = legacyTrans.filter(t => t.workType === currentJob.id);
                                                                if (filteredLegacy.length > 0) rawData = filteredLegacy;
                                                        }

                                                        currentReportData = rawData;

                                                        // Render all data initially (or you could limit to recent 100)
                                                        renderReportTable(currentReportData);
                                                        updateReportStats(currentReportData);
                                                }

                                                // Alias for compatibility with deleteTransaction
                                                function filterReportByDuration() {
                                                        // Just re-render current data
                                                        renderReportTable(currentReportData);
                                                        updateReportStats(currentReportData);
                                                }

                                                function filterReport() {
                                                        // Deprecated/Removed function, kept empty to prevent crashes if called
                                                        renderReportTable(currentReportData);
                                                        updateReportStats(currentReportData);
                                                }

                                                function clearReportFilters() {
                                                        // Deprecated function
                                                        renderReportTable(currentReportData);
                                                        updateReportStats(currentReportData);
                                                }

                                                // Table Filtering Functions
                                                function applyTableFilter() {
                                                        const searchText = document.getElementById('tableFilterSearch').value.toLowerCase();
                                                        const startDate = document.getElementById('tableFilterStart').value;
                                                        const endDate = document.getElementById('tableFilterEnd').value;

                                                        let filtered = currentReportData.filter(item => {
                                                                // Ensure date format compatibility (YYYY-MM-DD vs YYYY/MM/DD)
                                                                const itemDate = item.date.replace(/\//g, '-');

                                                                const dateMatch = (!startDate || itemDate >= startDate) && (!endDate || itemDate <= endDate);
                                                                const textMatch = !searchText ||
                                                                        (item.detail && item.detail.toLowerCase().includes(searchText)) ||
                                                                        (item.category && item.category.toLowerCase().includes(searchText)) ||
                                                                        (item.note && item.note.toLowerCase().includes(searchText));
                                                                return dateMatch && textMatch;
                                                        });

                                                        renderReportTable(filtered);
                                                        updateReportStats(filtered);
                                                }

                                                function clearTableFilters() {
                                                        document.getElementById('tableFilterSearch').value = '';
                                                        document.getElementById('tableFilterStart').value = '';
                                                        document.getElementById('tableFilterEnd').value = '';
                                                        applyTableFilter();
                                                }

                                                function renderReportTable(data) {
                                                        const tableBody = document.getElementById('reportTableBody');

                                                        // NEW: Toggle Income Header visibility
                                                        // Target the 3rd th (Income)
                                                        const incomeHeader = document.querySelector('thead tr th:nth-child(3)');
                                                        const isHomeAccount = currentJob && currentJob.id.startsWith('home_');

                                                        if (incomeHeader) {
                                                                if (isHomeAccount) {
                                                                        incomeHeader.style.display = 'none';
                                                                } else {
                                                                        incomeHeader.style.display = '';
                                                                }
                                                        }

                                                        if (data.length === 0) {
                                                                tableBody.innerHTML = '<tr><td colspan="5" style="padding: 30px; text-align: center; color: #94a3b8;">معلومات نشته</td></tr>';
                                                                return;
                                                        }

                                                        const sorted = data.slice().sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

                                                        tableBody.innerHTML = sorted.reverse().map(t => {
                                                                const inc = parseFloat(t.income || 0);
                                                                const exp = parseFloat(t.expense || 0);

                                                                // NEW: Hide income cell for home accounts
                                                                const incomeDisplayStyle = isHomeAccount ? 'none' : '';

                                                                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px 15px; font-size: 13px;">${t.date}</td>
                        <td style="padding: 12px 15px; font-size: 13px;">
                            ${t.detail || '-'}
                            ${t.note ? `<div style="font-size:11px; color:#64748b;">${t.note}</div>` : ''}
                        </td>
                        <td style="padding: 12px 15px; color: #10b981; font-weight: 600; display: ${incomeDisplayStyle};">${inc > 0 ? inc.toLocaleString() : '-'}</td>
                        <td style="padding: 12px 15px; color: #ef4444; font-weight: 600;">${exp > 0 ? exp.toLocaleString() : '-'}</td>
                        <td style="padding: 12px 15px; text-align: center;">
                            <button onclick="deleteTransaction(${t.timestamp})" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; border-radius: 8px; padding: 5px 10px; cursor: pointer; font-size: 12px;">🗑️</button>
                        </td>
                    </tr>
                `;
                                                        }).join('');
                                                }

                                                function updateReportStats(data) {
                                                        let totalIncome = 0;
                                                        let totalExpense = 0;

                                                        const isSaudiOrBoklyn = currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_') || currentJob.id === 'boklyn';
                                                        const isMobile = currentJob.id === 'mobile';
                                                        const isHomeAccount = currentJob.id.startsWith('home_');

                                                        data.forEach(t => {
                                                                totalIncome += parseFloat(t.income || 0);

                                                                let rowExpense = parseFloat(t.expense || 0);

                                                                if (isSaudiOrBoklyn) {
                                                                        // Saudi/Boklyn logic: expense + sentToHome + driverSalary
                                                                        rowExpense += parseFloat(t.sentToHome || 0);
                                                                        rowExpense += parseFloat(t.driverSalary || 0);
                                                                } else if (isMobile) {
                                                                        // Mobile logic: expense + sentToHomeMobile + shopRent
                                                                        rowExpense += parseFloat(t.sentToHomeMobile || 0);
                                                                        rowExpense += parseFloat(t.shopRent || 0);
                                                                }

                                                                totalExpense += rowExpense;
                                                        });

                                                        document.getElementById('reportTotalIncome').textContent = totalIncome.toLocaleString();
                                                        document.getElementById('reportTotalExpense').textContent = totalExpense.toLocaleString();
                                                        document.getElementById('reportNetBalance').textContent = (totalIncome - totalExpense).toLocaleString();

                                                        // NEW: Hide Total Income Stat Box for Home Accounts
                                                        const incomeEl = document.getElementById('reportTotalIncome');
                                                        if (incomeEl) {
                                                                // Navigate up to the stats container (usually div > div > span)
                                                                // We'll try to find the container with class 'stat-box' or just parent parent
                                                                let container = incomeEl.closest('.stat-box');
                                                                if (!container) container = incomeEl.parentElement.parentElement;

                                                                if (container) {
                                                                        if (isHomeAccount) {
                                                                                container.style.display = 'none';
                                                                        } else {
                                                                                container.style.display = ''; // Restore if switching accounts
                                                                        }
                                                                }
                                                        }
                                                }

                                                function closeReport() {
                                                        document.getElementById('reportScreen').classList.add('hidden');
                                                        document.getElementById('formContainer').classList.remove('hidden');
                                                }

                                                function logout() {
                                                        document.getElementById('formContainer').classList.add('hidden');

                                                        // Check where to go back based on current job type
                                                        if (currentJob && currentJob.id.startsWith('home_')) {
                                                                document.getElementById('homeSubAccountScreen').classList.remove('hidden');
                                                                document.getElementById('jobSelectionScreen').classList.add('hidden');
                                                        } else if (currentJob && currentJob.id.startsWith('saudi_')) {
                                                                document.getElementById('saudiSubAccountScreen').classList.remove('hidden');
                                                                document.getElementById('jobSelectionScreen').classList.add('hidden');
                                                        } else {
                                                                document.getElementById('jobSelectionScreen').classList.remove('hidden');
                                                        }

                                                        document.getElementById('passwordScreen').classList.add('hidden');
                                                        document.getElementById('passwordInput').value = '';
                                                        document.getElementById('passwordError').style.display = 'none';
                                                        document.getElementById('trailerForm').reset();
                                                        currentJob = null;

                                                        // Reset category selection visually
                                                        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                                                        document.getElementById('customCategoryInput').style.display = 'none';
                                                        removeImage(); // Clear image

                                                        // Reset new fields
                                                        document.getElementById('sentToHomeGroup').style.display = 'none';
                                                        document.getElementById('driverSalaryGroup').style.display = 'none';
                                                        document.getElementById('detailSaudiGroup').style.display = 'none';
                                                        document.getElementById('noteSaudiGroup').style.display = 'none';
                                                        document.getElementById('sentToHomeMobileGroup').style.display = 'none';
                                                        document.getElementById('shopRentGroup').style.display = 'none';

                                                        document.getElementById('sentToHome').value = '';
                                                        document.getElementById('driverSalary').value = '';
                                                        document.getElementById('detailSaudi').value = '';
                                                        document.getElementById('noteSaudi').value = '';
                                                        document.getElementById('sentToHomeMobile').value = '';
                                                        document.getElementById('shopRent').value = '';
                                                }

                                                function checkPassword() {
                                                        const password = document.getElementById('passwordInput').value;
                                                        const errorDiv = document.getElementById('passwordError');

                                                        // Investment Check
                                                        if (currentJob && currentJob.id === 'investment') {
                                                                if (password === 'invest123') {
                                                                        errorDiv.style.display = 'none';
                                                                        document.getElementById('passwordInput').value = '';
                                                                        document.getElementById('passwordScreen').classList.add('hidden');
                                                                        openNewAccountScreen();
                                                                } else {
                                                                        errorDiv.style.display = 'block';
                                                                        errorDiv.textContent = '❌ پاسورډ غلط دئ';
                                                                        document.getElementById('passwordInput').classList.add('shake');
                                                                        setTimeout(() => document.getElementById('passwordInput').classList.remove('shake'), 500);
                                                                }
                                                                return;
                                                        }

                                                        // Loan Book Check
                                                        if (currentJob && currentJob.id === 'loan_book') {
                                                                if (password === 'loan123') { // Simple password
                                                                        errorDiv.style.display = 'none';
                                                                        document.getElementById('passwordInput').value = '';
                                                                        openLoanBookMenu();
                                                                } else {
                                                                        errorDiv.style.display = 'block';
                                                                        errorDiv.textContent = '❌ پاسورډ غلط دئ';
                                                                        document.getElementById('passwordInput').classList.add('shake');
                                                                        setTimeout(() => document.getElementById('passwordInput').classList.remove('shake'), 500);
                                                                }
                                                                return;
                                                        }

                                                        // 1. General Dashboard Admin Check
                                                        if (currentJob && currentJob.id === 'general_dashboard_admin') {
                                                                const validAdmins = ['home123', 'saudi123', 'mobile123', 'boklyn123', 'admin'];
                                                                if (validAdmins.includes(password)) {
                                                                        errorDiv.style.display = 'none';
                                                                        document.getElementById('passwordInput').value = ''; // Clear input
                                                                        openGeneralDashboard();
                                                                } else {
                                                                        errorDiv.style.display = 'block';
                                                                        errorDiv.textContent = '❌ پاسورډ غلط دئ';
                                                                        document.getElementById('passwordInput').classList.add('shake');
                                                                        setTimeout(() => document.getElementById('passwordInput').classList.remove('shake'), 500);
                                                                }
                                                                return; // Stop here
                                                        }

                                                        // 2. Normal Job/Sub-Account Check
                                                        if (password === currentPassword) {
                                                                // Hide report button by default
                                                                const reportNavBtn = document.getElementById('reportNavBtn');
                                                                if (reportNavBtn) reportNavBtn.style.display = 'none';

                                                                // Show report button ONLY for Saudi, Boklyn, and Mobile accounts
                                                                const allowedReportIds = ['saudi', 'boklyn', 'mobile'];
                                                                const isHomeAccount = currentJob.id.startsWith('home_');
                                                                const isSaudiSub = currentJob.id.startsWith('saudi_');

                                                                if (isHomeAccount) {
                                                                        if (document.getElementById('dashboardBtn')) document.getElementById('dashboardBtn').style.display = 'none';
                                                                        if (document.getElementById('reportNavBtn')) document.getElementById('reportNavBtn').style.display = 'none';
                                                                } else {
                                                                        if (document.getElementById('dashboardBtn')) document.getElementById('dashboardBtn').style.display = 'inline-flex';
                                                                        if (allowedReportIds.includes(currentJob.id) || isSaudiSub) {
                                                                                if (document.getElementById('reportNavBtn')) document.getElementById('reportNavBtn').style.display = 'inline-flex';
                                                                        } else {
                                                                                if (document.getElementById('reportNavBtn')) document.getElementById('reportNavBtn').style.display = 'none';
                                                                        }
                                                                }

                                                                document.getElementById('passwordScreen').classList.add('hidden');
                                                                document.getElementById('formContainer').classList.remove('hidden');
                                                                const dateInput = document.getElementById('date');
                                                                const today = new Date().toISOString().split('T')[0];
                                                                dateInput.value = today;
                                                                errorDiv.style.display = 'none';

                                                                // Display the selected job/sub-account info
                                                                if (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_')) {
                                                                        document.getElementById('currency').value = 'SAR';
                                                                        document.getElementById('currency').disabled = true;
                                                                } else if (currentJob.id === 'boklyn' || currentJob.id === 'mobile') {
                                                                        document.getElementById('currency').value = 'AFN';
                                                                        document.getElementById('currency').disabled = true;
                                                                } else {
                                                                        document.getElementById('currency').value = 'AFN';
                                                                        document.getElementById('currency').disabled = false;
                                                                }

                                                                // Reset visibility for ALL special groups first
                                                                const specialGroups = [
                                                                        'incomeGroup', 'sentToHomeGroup', 'driverSalaryGroup',
                                                                        'detailSaudiGroup', 'noteSaudiGroup',
                                                                        'sentToHomeMobileGroup', 'shopRentGroup',
                                                                        'detailMobileGroup', 'noteMobileGroup',
                                                                        'homeJointDetailGroup', 'homeMonthGroup'
                                                                ];
                                                                specialGroups.forEach(id => {
                                                                        const el = document.getElementById(id);
                                                                        if (el) el.style.display = 'none';
                                                                });

                                                                const isSaudi = currentJob.id === 'saudi_12module' || currentJob.id === 'saudi_14module' || currentJob.id === 'boklyn';
                                                                const isMobile = currentJob.id === 'mobile';
                                                                const isHomeJoint = currentJob.id === 'home_joint';

                                                                // Show groups based on account type
                                                                if (isSaudi) {
                                                                        ['incomeGroup', 'sentToHomeGroup', 'driverSalaryGroup', 'detailSaudiGroup', 'noteSaudiGroup'].forEach(id => {
                                                                                const el = document.getElementById(id);
                                                                                if (el) el.style.display = 'block';
                                                                        });
                                                                } else if (isMobile) {
                                                                        ['incomeGroup', 'sentToHomeMobileGroup', 'shopRentGroup', 'detailMobileGroup', 'noteMobileGroup'].forEach(id => {
                                                                                const el = document.getElementById(id);
                                                                                if (el) el.style.display = 'block';
                                                                        });
                                                                } else if (isHomeJoint) {
                                                                        const el = document.getElementById('homeJointDetailGroup');
                                                                        if (el) el.style.display = 'block';
                                                                }

                                                                if (currentJob.image) {
                                                                        document.getElementById('currentJobIcon').innerHTML = `<img src="${currentJob.image}" alt="${currentJob.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3);">`;
                                                                } else {
                                                                        document.getElementById('currentJobIcon').textContent = currentJob.icon || JOBS.find(job => job.id === currentJob.id)?.icon || '🕌';
                                                                }
                                                                document.getElementById('currentJobName').textContent = currentJob.name;

                                                                // --- SHARED BALANCE & CATEGORY LOGIC ---
                                                                if (currentJob.id.startsWith('home_')) {
                                                                        if (currentJob.id === 'home_joint') {
                                                                                document.getElementById('balanceSection').style.display = 'none';
                                                                        } else {
                                                                                document.getElementById('balanceSection').style.display = 'block';
                                                                                updateBalanceDisplay();
                                                                                
                                                                                // Show Home Fields for personal home accounts
                                                                                const homeFields = document.getElementById('homeFields');
                                                                                if (homeFields) homeFields.style.display = 'flex';

                                                                                // Show Month Selector
                                                                                const monthGroup = document.getElementById('homeMonthGroup');
                                                                                if (monthGroup) {
                                                                                    monthGroup.style.display = 'block';
                                                                                    const monthSelect = document.getElementById('homeMonthSelect');
                                                                                    if (monthSelect) {
                                                                                        const pashtoMonths = ["جنوري", "فبروري", "مارچ", "اپریل", "می", "جون", "جولای", "اگست", "سپتمبر", "اکتوبر", "نومبر", "دیسمبر"];
                                                                                        monthSelect.value = pashtoMonths[new Date().getMonth()];
                                                                                    }
                                                                                    fetchHomeData();
                                                                                }
                                                                        }

                                                                        if (document.getElementById('dashboardBtn')) document.getElementById('dashboardBtn').innerHTML = '📊 ډشبورډ';

                                                                        if (currentJob.id === 'home_joint') {
                                                                                // JOINT ACCOUNT: SHOW FORM FOR WRITING
                                                                                document.getElementById('homeFields').style.display = 'none'; // Hide balance inputs

                                                                                // Show standard input fields
                                                                                document.getElementById('dateGroup').style.display = 'block';
                                                                                document.getElementById('expenseGroup').style.display = 'block';
                                                                                document.getElementById('detailGroup').style.display = 'block';
                                                                                document.getElementById('noteGroup').style.display = 'block';
                                                                                document.getElementById('imageGroup').style.display = 'block';

                                                                                // Hide unrelated fields
                                                                                document.getElementById('incomeGroup').style.display = 'none';
                                                                                document.getElementById('categoryGroup').style.display = 'none';

                                                                                // Requirements
                                                                                document.getElementById('date').required = true;
                                                                                document.getElementById('expense').required = true;
                                                                                document.getElementById('detail').required = true;

                                                                                // Ensure submit button is visible
                                                                                document.getElementById('submitBtnWrapper').style.display = 'flex';
                                                                                document.getElementById('homeLogoutBtn').style.display = 'none';
                                                                                document.getElementById('dashboardBtn').style.display = 'none'; // Hide dashboard button for joint account
                                                                                document.getElementById('reportNavBtn').style.display = 'none';
                                                                        } else {
                                                                                // Hide Old Fields
                                                                                document.getElementById('dateGroup').style.display = 'none';
                                                                                document.getElementById('expenseGroup').style.display = 'none';
                                                                                document.getElementById('categoryGroup').style.display = 'none';
                                                                                document.getElementById('noteGroup').style.display = 'none';
                                                                                document.getElementById('incomeGroup').style.setProperty('display', 'none', 'important');
                                                                                document.getElementById('detailGroup').style.display = 'none';
                                                                                document.getElementById('imageGroup').style.setProperty('display', 'none', 'important');
                                                                                document.getElementById('date').required = false;
                                                                                document.getElementById('expense').required = false;

                                                                                // Hide submit buttons for home accounts, show X button in header
                                                                                document.getElementById('submitBtnWrapper').style.display = 'none';
                                                                                document.getElementById('homeLogoutBtn').style.display = 'flex';
                                                                        }


                                                                        // Admin check
                                                                        if (currentJob.name === 'سیف الله') {
                                                                                document.getElementById('editBalanceBtn').style.display = 'inline-block';
                                                                        } else {
                                                                                document.getElementById('editBalanceBtn').style.display = 'none';
                                                                        }

                                                                        // Hide Bill Attachment for specific Home Accounts
                                                                        const restrictedHomeIDs = ['home_lalak', 'home_saifullah', 'home_saeedullah', 'home_siddiqullah', 'home_adil'];
                                                                        const imgGrp = document.getElementById('imageGroup');

                                                                        if (restrictedHomeIDs.includes(currentJob.id)) {
                                                                                if (imgGrp) {
                                                                                        imgGrp.style.setProperty('display', 'none', 'important');
                                                                                }
                                                                        } else if (currentJob.id === 'home_joint') {
                                                                                if (imgGrp) imgGrp.style.setProperty('display', 'block', 'important');
                                                                        } else {
                                                                                if (imgGrp) imgGrp.style.setProperty('display', 'block', 'important');
                                                                        }
                                                                } else {
                                                                        document.getElementById('balanceSection').style.display = 'none';
                                                                        if (document.getElementById('dashboardBtn')) document.getElementById('dashboardBtn').innerHTML = '📊 ډشبورډ';
                                                                        document.getElementById('submitBtnWrapper').style.display = 'flex';
                                                                        document.getElementById('homeLogoutBtn').style.display = 'none';

                                                                        document.getElementById('homeFields').style.display = 'none';
                                                                        document.getElementById('dateGroup').style.display = 'block';
                                                                        document.getElementById('expenseGroup').style.display = 'block';
                                                                        document.getElementById('categoryGroup').style.display = 'none';
                                                                        document.getElementById('noteGroup').style.display = 'block';
                                                                        document.getElementById('incomeGroup').style.setProperty('display', 'block', 'important');
                                                                        document.getElementById('detailGroup').style.display = 'block';
                                                                        document.getElementById('imageGroup').style.setProperty('display', 'block', 'important');
                                                                        document.getElementById('date').required = true;
                                                                        document.getElementById('expense').required = true;
                                                                        document.getElementById('category').required = false;
                                                                }

                                                        } else {
                                                                errorDiv.style.display = 'block';
                                                                document.getElementById('passwordInput').value = '';
                                                        }
                                                }

                                                function updateBalanceDisplay() {
                                                        const bal = localStorage.getItem('home_shared_balance') || '25000';
                                                        document.getElementById('balanceValue').textContent = parseInt(bal).toLocaleString();

                                                        // Changed from < 5000 to <= 5000 as per request "remains 5000"
                                                        if (parseInt(bal) <= 5000) {
                                                                showToast('warning', 'خبرتیا!', 'د کور ګډ بیلانس 5000 افغانی یا کم دی!');
                                                                document.getElementById('balanceSection').style.border = '2px solid #ef4444';
                                                        } else {
                                                                document.getElementById('balanceSection').style.border = '1px solid rgba(16, 185, 129, 0.3)';
                                                        }
                                                }

                                                function editBalance() {
                                                        const current = localStorage.getItem('home_shared_balance') || '0';
                                                        const newBal = prompt("نوی بیلانس داخل کړئ:", current);
                                                        if (newBal !== null && !isNaN(newBal) && newBal.trim() !== '') {
                                                                localStorage.setItem('home_shared_balance', newBal);
                                                                updateBalanceDisplay();

                                                                // Send to Google Sheets
                                                                const url = new URL(GOOGLE_SHEETS_URL);
                                                                const params = {
                                                                        date: new Date().toISOString().split('T')[0],
                                                                        workType: currentJob.id,
                                                                        balanceUpdate: 'true',
                                                                        newBalance: newBal,
                                                                        oldBalance: current
                                                                };
                                                                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

                                                                fetch(url.toString(), { method: 'GET' }).catch(err => console.log('Balance update sent'));

                                                                showToast('success', '✓ بیلانس تازه شو');
                                                        }
                                                }

                                                document.getElementById('passwordInput').addEventListener('keypress', e => {
                                                        if (e.key === 'Enter') checkPassword();
                                                });

                                                function saveTransaction(e) {
                                                        e.preventDefault();
                                                        console.log("saveTransaction triggered");

                                                        const date = document.getElementById('date').value;
                                                        const income = document.getElementById('income').value;
                                                        const expense = document.getElementById('expense').value;

                                                        // Get values for all possible fields
                                                        const detail = document.getElementById('detail')?.value || document.getElementById('detailSaudi')?.value || document.getElementById('detailMobile')?.value || document.getElementById('detailHomeJoint')?.value || '';
                                                        const note = document.getElementById('note')?.value || document.getElementById('noteSaudi')?.value || document.getElementById('noteMobile')?.value || '';
                                                        const category = document.getElementById('category')?.value || '';
                                                        const currency = document.getElementById('currency')?.value || 'AFN';
                                                        const sentToHome = document.getElementById('sentToHome')?.value || '';
                                                        const driverSalary = document.getElementById('driverSalary')?.value || '';
                                                        const sentToHomeMobile = document.getElementById('sentToHomeMobile')?.value || '';
                                                        const shopRent = document.getElementById('shopRent')?.value || '';

                                                        const expenseError = document.getElementById('expenseError');
                                                        const incomeError = document.getElementById('incomeError');
                                                        let hasError = false;

                                                        // Validation logic
                                                        if (expense === '' || parseFloat(expense) < 0) {
                                                                if (expenseError) expenseError.classList.add('show');
                                                                hasError = true;
                                                        } else if (expenseError) {
                                                                expenseError.classList.remove('show');
                                                        }

                                                        const incomeGroup = document.getElementById('incomeGroup');
                                                        if (incomeGroup && incomeGroup.style.display !== 'none') {
                                                                if (income === '' || parseFloat(income) < 0) {
                                                                        if (incomeError) incomeError.classList.add('show');
                                                                        hasError = true;
                                                                } else if (incomeError) {
                                                                        incomeError.classList.remove('show');
                                                                }
                                                        }

                                                        if (!date) {
                                                                showToast('error', 'نېټه وټاکئ');
                                                                hasError = true;
                                                        }

                                                        if (hasError) {
                                                                console.log("Validation failed");
                                                                return;
                                                        }

                                                        const dateParts = date.split('-');
                                                        const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

                                                        formDataToSubmit = {
                                                                income,
                                                                expense,
                                                                date,
                                                                formattedDate,
                                                                detail,
                                                                note,
                                                                category,
                                                                currency,
                                                                sentToHome,
                                                                driverSalary,
                                                                sentToHomeMobile,
                                                                shopRent,
                                                                timestamp: Date.now(),
                                                                isHomeNew: (currentJob && currentJob.id.startsWith('home_') && currentJob.id !== 'home_joint'),
                                                                familyMembers: document.getElementById('familyMembers')?.value || '',
                                                                individualRight: document.getElementById('individualRight')?.value || '',
                                                                actualPayment: document.getElementById('actualPayment')?.value || '',
                                                                difference: document.getElementById('difference')?.value || '',
                                                                status: document.getElementById('status')?.value || '',
                                                                remainingCash: document.getElementById('remainingCash')?.value || '',
                                                                id: currentJob.id
                                                        };

                                                        console.log("Opening Modal with data:", formDataToSubmit);
                                                        showModal();
                                                }

                                                // Re-attach the event listener to ensure it's active
                                                const theForm = document.getElementById('trailerForm');
                                                if (theForm) {
                                                        theForm.onsubmit = saveTransaction;
                                                }

                                                function showModal() {
                                                        // Hide all individual rows initially to use the main summary area
                                                        const rowsToHide = ['categoryRow', 'sentToHomeRow', 'driverSalaryRow', 'sentToHomeMobileRow', 'shopRentRow', 'noteRow', 'lastSaveRow'];
                                                        rowsToHide.forEach(id => {
                                                                const el = document.getElementById(id);
                                                                if (el) el.style.display = 'none';
                                                        });

                                                        // Hide separate Date and Expense rows
                                                        if (document.getElementById('confirmDate') && document.getElementById('confirmDate').parentElement.parentElement) {
                                                                document.getElementById('confirmDate').parentElement.parentElement.style.display = 'none';
                                                        }
                                                        if (document.getElementById('confirmExpense') && document.getElementById('confirmExpense').parentElement.parentElement) {
                                                                document.getElementById('confirmExpense').parentElement.parentElement.style.display = 'none';
                                                        }

                                                        let summaryHtml = '<div style="text-align: right; direction: rtl; line-height: 2; width: 100%;">';

                                                        if (formDataToSubmit && formDataToSubmit.isHomeNew) {
                                                                summaryHtml += `
                    <p><strong>نېټه:</strong> ${formDataToSubmit.formattedDate}</p>
                    <p><strong>د کورنۍ افراد:</strong> ${formDataToSubmit.familyMembers}</p>
                    <p><strong>فردي حق:</strong> ${formDataToSubmit.individualRight}</p>
                    <p><strong>حقیقي ورکړه:</strong> ${formDataToSubmit.actualPayment}</p>
                    <p><strong>توپیر:</strong> ${formDataToSubmit.difference}</p>
                    <p><strong>حالت:</strong> ${formDataToSubmit.status}</p>
                    <p><strong>پاتې نغدیه:</strong> ${formDataToSubmit.remainingCash}</p>
                 `;
                                                        } else {
                                                                // Standard Transaction Summary - Organized exactly like the form
                                                                summaryHtml += `<p><strong>📅 نېټه:</strong> ${formDataToSubmit.formattedDate}</p>`;

                                                                if (formDataToSubmit.income && parseFloat(formDataToSubmit.income) > 0) {
                                                                        summaryHtml += `<p style="color: #34d399;"><strong>💰 عاید:</strong> ${formDataToSubmit.income}</p>`;
                                                                }

                                                                if (formDataToSubmit.expense && parseFloat(formDataToSubmit.expense) > 0) {
                                                                        summaryHtml += `<p style="color: #f87171;"><strong>💸 لګښت:</strong> ${formDataToSubmit.expense}</p>`;
                                                                }

                                                                if (formDataToSubmit.id === 'home_joint' && formDataToSubmit.detail) {
                                                                        summaryHtml += `<p><strong>📝 تفصیل:</strong> ${formDataToSubmit.detail}</p>`;
                                                                }

                                                                if (formDataToSubmit.sentToHome && parseFloat(formDataToSubmit.sentToHome) > 0) {
                                                                        summaryHtml += `<p style="color: #60a5fa;"><strong>🏠 کور ته لېږل شوي:</strong> ${formDataToSubmit.sentToHome}</p>`;
                                                                }

                                                                if (formDataToSubmit.sentToHomeMobile && parseFloat(formDataToSubmit.sentToHomeMobile) > 0) {
                                                                        summaryHtml += `<p style="color: #60a5fa;"><strong>📱 کور ته ورکړل شوي (موبایل):</strong> ${formDataToSubmit.sentToHomeMobile}</p>`;
                                                                }

                                                                if (formDataToSubmit.driverSalary && parseFloat(formDataToSubmit.driverSalary) > 0) {
                                                                        summaryHtml += `<p style="color: #fbbf24;"><strong>🚗 د ډرېور تنخوا:</strong> ${formDataToSubmit.driverSalary}</p>`;
                                                                }

                                                                if (formDataToSubmit.shopRent && parseFloat(formDataToSubmit.shopRent) > 0) {
                                                                        summaryHtml += `<p style="color: #fbbf24;"><strong>🏪 دکان کرایه:</strong> ${formDataToSubmit.shopRent}</p>`;
                                                                }

                                                                let detail = formDataToSubmit.detail || formDataToSubmit.detailMobile || formDataToSubmit.detailSaudi || 'ندي لیکل شوی';
                                                                summaryHtml += `<p><strong>📝 تفصیل:</strong> ${detail}</p>`;

                                                                let note = formDataToSubmit.note || formDataToSubmit.noteSaudi || formDataToSubmit.noteMobile;
                                                                if (note) {
                                                                        summaryHtml += `<p><strong>📌 یاداښت:</strong> ${note}</p>`;
                                                                }

                                                                if (formDataToSubmit.category) {
                                                                        summaryHtml += `<p><strong>📂 کټګوري:</strong> ${formDataToSubmit.category}</p>`;
                                                                }
                                                        }
                                                        summaryHtml += '</div>';

                                                        document.getElementById('confirmDetail').innerHTML = summaryHtml;

                                                        // Handle Image Row specifically
                                                        if (compressedImageBlob || originalImageFile) {
                                                                document.getElementById('imageRow').style.display = 'block';
                                                        } else {
                                                                document.getElementById('imageRow').style.display = 'none';
                                                        }

                                                        // Last Save Data Logic
                                                        const lastSaveDataRaw = localStorage.getItem('lastSaveData_' + currentJob.id);
                                                        if (lastSaveDataRaw) {
                                                                const lastSaveData = JSON.parse(lastSaveDataRaw);
                                                                let lastSaveHtml = '<div style="text-align: right; direction: rtl; line-height: 1.8; width: 100%;">';

                                                                if (lastSaveData.date) {
                                                                        lastSaveHtml += `<p><strong>📅 نېټه:</strong> ${lastSaveData.date}</p>`;
                                                                }
                                                                if (lastSaveData.income && parseFloat(lastSaveData.income) > 0) {
                                                                        lastSaveHtml += `<p style="color: #34d399;"><strong>💰 عاید:</strong> ${lastSaveData.income}</p>`;
                                                                }
                                                                if (lastSaveData.expense && parseFloat(lastSaveData.expense) > 0) {
                                                                        lastSaveHtml += `<p style="color: #f87171;"><strong>💸 لګښت:</strong> ${lastSaveData.expense}</p>`;
                                                                }
                                                                if (lastSaveData.sentToHome && parseFloat(lastSaveData.sentToHome) > 0) {
                                                                        lastSaveHtml += `<p style="color: #60a5fa;"><strong>🏠 کور ته لېږل شوي:</strong> ${lastSaveData.sentToHome}</p>`;
                                                                }
                                                                if (lastSaveData.driverSalary && parseFloat(lastSaveData.driverSalary) > 0) {
                                                                        lastSaveHtml += `<p style="color: #fbbf24;"><strong>🚗 ډرېور تنخوا:</strong> ${lastSaveData.driverSalary}</p>`;
                                                                }
                                                                if (lastSaveData.detail) {
                                                                        lastSaveHtml += `<p><strong>📝 تفصیل:</strong> ${lastSaveData.detail}</p>`;
                                                                }
                                                                if (lastSaveData.note) {
                                                                        lastSaveHtml += `<p><strong>📌 یاداښت:</strong> ${lastSaveData.note}</p>`;
                                                                }
                                                                if (lastSaveData.category) {
                                                                        lastSaveHtml += `<p><strong>📂 کټګوري:</strong> ${lastSaveData.category}</p>`;
                                                                }

                                                                lastSaveHtml += '</div>';

                                                                const lastSaveRow = document.getElementById('lastSaveRow');
                                                                // Replace the internal grid with our organized summary
                                                                lastSaveRow.innerHTML = `
                    <div class="last-save-title">📋 وروستی ذخیره شوی</div>
                    <div class="data-row">
                        <div class="data-field" style="grid-column: 1 / -1;">
                            ${lastSaveHtml}
                        </div>
                    </div>
                `;
                                                                lastSaveRow.style.display = 'block';
                                                        } else {
                                                                document.getElementById('lastSaveRow').style.display = 'none';
                                                        }

                                                        document.getElementById('modalOverlay').classList.add('active');
                                                }

                                                function closeModal() {
                                                        document.getElementById('modalOverlay').classList.remove('active');
                                                }

                                                async function confirmSubmit() {
                                                        const btn = document.getElementById('confirmButton');
                                                        btn.disabled = true;
                                                        btn.textContent = '✓ ذخیره کیږی...';
                                                        try {
                                                                // Deduct Balance for Home Accounts
                                                                if (currentJob.id.startsWith('home_')) {
                                                                        const exp = parseFloat(formDataToSubmit.expense || '0');
                                                                        if (exp > 0) {
                                                                                let bal = parseFloat(localStorage.getItem('home_shared_balance') || '0');
                                                                                bal -= exp;
                                                                                localStorage.setItem('home_shared_balance', bal);
                                                                                updateBalanceDisplay();
                                                                        }
                                                                }

                                                                // *** NEW: Save to Local Storage for Dashboard & Report per Account ***
                                                                // 1. Save Transaction to History
                                                                let newTransaction = {};
                                                                if (formDataToSubmit.isHomeNew) {
                                                                        newTransaction = {
                                                                                date: formDataToSubmit.formattedDate,
                                                                                familyMembers: formDataToSubmit.familyMembers,
                                                                                individualRight: formDataToSubmit.individualRight,
                                                                                actualPayment: formDataToSubmit.actualPayment,
                                                                                difference: formDataToSubmit.difference,
                                                                                status: formDataToSubmit.status,
                                                                                remainingCash: formDataToSubmit.remainingCash,
                                                                                isHomeNew: true,
                                                                                timestamp: new Date().getTime()
                                                                        };
                                                                } else {
                                                                        newTransaction = {
                                                                                date: formDataToSubmit.formattedDate,
                                                                                income: formDataToSubmit.income || '0',
                                                                                expense: formDataToSubmit.expense || '0',
                                                                                sentToHome: formDataToSubmit.sentToHome || '0',
                                                                                driverSalary: formDataToSubmit.driverSalary || '0',
                                                                                sentToHomeMobile: formDataToSubmit.sentToHomeMobile || '0',
                                                                                shopRent: formDataToSubmit.shopRent || '0',
                                                                                detail: formDataToSubmit.detail || formDataToSubmit.detailMobile || formDataToSubmit.detailSaudi || '',
                                                                                note: formDataToSubmit.note || formDataToSubmit.noteMobile || formDataToSubmit.noteSaudi || '',
                                                                                category: formDataToSubmit.category || '',
                                                                                currency: formDataToSubmit.currency || 'AFN',
                                                                                timestamp: new Date().getTime()
                                                                        };
                                                                }

                                                                let history = JSON.parse(localStorage.getItem('history_' + currentJob.id) || '[]');
                                                                history.unshift(newTransaction);
                                                                localStorage.setItem('history_' + currentJob.id, JSON.stringify(history));

                                                                // 2. Update Stats
                                                                let stats = JSON.parse(localStorage.getItem('stats_' + currentJob.id) || '{"income": 0, "expense": 0}');
                                                                if (!formDataToSubmit.isHomeNew) {
                                                                        stats.income = parseFloat(stats.income) + parseFloat(newTransaction.income);
                                                                        stats.expense = parseFloat(stats.expense) + parseFloat(newTransaction.expense);
                                                                }
                                                                localStorage.setItem('stats_' + currentJob.id, JSON.stringify(stats));
                                                                // ***************************************************************

                                                                let url = new URL(GOOGLE_SHEETS_URL);
                                                                let params = {};
                                                                if (formDataToSubmit.isHomeNew) {
                                                                        params = {
                                                                                date: formDataToSubmit.formattedDate,
                                                                                workType: currentJob.id,
                                                                                familyMembers: formDataToSubmit.familyMembers,
                                                                                individualRight: formDataToSubmit.individualRight,
                                                                                actualPayment: formDataToSubmit.actualPayment,
                                                                                difference: formDataToSubmit.difference,
                                                                                status: formDataToSubmit.status,
                                                                                remainingCash: formDataToSubmit.remainingCash,
                                                                                isHomeNew: 'true'
                                                                        };
                                                                } else {
                                                                        params = {
                                                                                date: formDataToSubmit.formattedDate,
                                                                                workType: currentJob.id,
                                                                                income: formDataToSubmit.income || '0',
                                                                                expense: formDataToSubmit.expense || '0',
                                                                                detail: formDataToSubmit.detail || formDataToSubmit.detailMobile || formDataToSubmit.detailSaudi || '',
                                                                                note: formDataToSubmit.note || formDataToSubmit.noteMobile || formDataToSubmit.noteSaudi || '',
                                                                                category: formDataToSubmit.category || ''
                                                                        };
                                                                }

                                                                let method = 'GET';
                                                                let body = null;
                                                                let fetchUrl = url.toString();
                                                                let fetchOptions = {};

                                                                // Use the compressed blob if available, otherwise original file (though we should always have compressed one if file selected)
                                                                const fileToSend = compressedImageBlob;
                                                                const originalName = originalImageFile ? originalImageFile.name : 'image.jpg';

                                                                if (fileToSend) {
                                                                        // Convert image to Base64
                                                                        const base64Data = await new Promise((resolve, reject) => {
                                                                                const reader = new FileReader();
                                                                                reader.readAsDataURL(fileToSend);
                                                                                reader.onload = () => resolve(reader.result.split(',')[1]);
                                                                                reader.onerror = error => reject(error);
                                                                        });

                                                                        params.imageName = originalName;
                                                                        params.imageMimeType = 'image/jpeg'; // We always convert to JPEG
                                                                        params.imageData = base64Data;

                                                                        method = 'POST';
                                                                        fetchUrl = GOOGLE_SHEETS_URL;

                                                                        // Build form body for POST
                                                                        const formData = new URLSearchParams();
                                                                        Object.keys(params).forEach(key => formData.append(key, params[key]));

                                                                        fetchOptions = {
                                                                                method: 'POST',
                                                                                body: formData,
                                                                                // 'no-cors' mode allows sending data to Google Script without CORS errors,
                                                                                // but prevents reading the response text.
                                                                                mode: 'no-cors'
                                                                        };
                                                                } else {
                                                                        // Standard GET request for text-only (Legacy behavior preserved)
                                                                        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                                                                        fetchUrl = url.toString();
                                                                        fetchOptions = { method: 'GET' };
                                                                }

                                                                const response = await fetch(fetchUrl, fetchOptions);

                                                                // Handle no-cors specific success (POST requests with images)
                                                                if (fileToSend) {
                                                                        // In no-cors mode, we can't read the response, so we assume success if no error was thrown
                                                                        console.log('Post request sent in no-cors mode');
                                                                } else {
                                                                        // For GET requests, we check the response
                                                                        if (!response.ok) {
                                                                                throw new Error('حساب ذخیره نه شو (Server Error)');
                                                                        }
                                                                        const text = await response.text();
                                                                        if (text.includes("ERROR")) {
                                                                                throw new Error('حساب ذخیره نه شو: ' + text);
                                                                        }
                                                                }

                                                                const lastSaveData = {
                                                                        date: formDataToSubmit.formattedDate,
                                                                        income: formDataToSubmit.income || '0',
                                                                        expense: formDataToSubmit.expense || '0',
                                                                        sentToHome: formDataToSubmit.sentToHome || formDataToSubmit.sentToHomeMobile || '0',
                                                                        driverSalary: formDataToSubmit.driverSalary || '0',
                                                                        detail: formDataToSubmit.detail || formDataToSubmit.detailMobile || formDataToSubmit.detailSaudi || '',
                                                                        note: formDataToSubmit.note || formDataToSubmit.noteMobile || formDataToSubmit.noteSaudi || '',
                                                                        category: formDataToSubmit.category || ''
                                                                };
                                                                localStorage.setItem('lastSaveData_' + currentJob.id, JSON.stringify(lastSaveData));

                                                                let successMsg = 'مننه حساب ذخیره شو';
                                                                if (fileToSend) {
                                                                        successMsg += ' او عکس ګوګل ډرایو ته ولیږل شو';
                                                                }
                                                                showToast('success', '✨ معلومات بریالي ولیکل شول', successMsg);

                                                                // Reset Image
                                                                removeImage();

                                                                document.getElementById('trailerForm').reset();
                                                                const today = new Date().toISOString().split('T')[0];
                                                                document.getElementById('date').value = today;
                                                                closeModal();
                                                        } catch (error) {
                                                                console.error('Fetch error:', error);
                                                                showToast('error', 'حساب ذخیره نه شو', error.message);
                                                        } finally {
                                                                btn.disabled = false;
                                                                btn.textContent = '✓ معلومات تایید او ذخیره کړئ';
                                                        }
                                                }

                                                function showToast(type, title, desc = '') {
                                                        console.log(`Toasting: ${type} - ${title}`);

                                                        // 1. Try Custom Toast
                                                        let t = document.getElementById('toast');
                                                        if (t) {
                                                                // Move to body immediately if not already there
                                                                if (t.parentNode !== document.body) {
                                                                    document.body.appendChild(t);
                                                                }
                                                                
                                                                document.getElementById('toastTitle').textContent = title;
                                                                document.getElementById('toastDescription').textContent = desc;
                                                                t.style.borderRight = type === 'success' ? '8px solid #10b981' : '8px solid #ef4444';
                                                                
                                                                // Force z-index again just in case
                                                                t.style.zIndex = '2147483647';
                                                                
                                                                t.classList.add('show');
                                                                setTimeout(() => t.classList.remove('show'), 4000);
                                                        }

                                                        // 2. SweetAlert (Robust alternative)
                                                        if (typeof Swal !== 'undefined') {
                                                                Swal.fire({
                                                                        toast: true,
                                                                        position: 'bottom-right',
                                                                        icon: type === 'error' ? 'error' : 'success',
                                                                        title: title,
                                                                        text: desc,
                                                                        showConfirmButton: false,
                                                                        timer: 4000,
                                                                        timerProgressBar: true,
                                                                        background: '#1e1b4b',
                                                                        color: '#fff',
                                                                        customClass: {
                                                                                container: 'swal2-top-layer'
                                                                        },
                                                                        didOpen: (toast) => {
                                                                                toast.style.zIndex = '2147483647';
                                                                                // Ensure swal container is also at top
                                                                                const container = document.querySelector('.swal2-container');
                                                                                if (container) container.style.zIndex = '2147483647';
                                                                        }
                                                                });
                                                        } else {
                                                                alert(title + "\n" + desc);
                                                        }
                                                }

                                                // Initialize all selectors
                                                initJobSelector();
                                                initSaudiSubAccountSelector();
                                                initHomeSubAccountSelector();

                                                // Category Selection Logic
                                                function selectCategory(value, element) {
                                                        // Remove active class from all buttons
                                                        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));

                                                        // Add active class to clicked button
                                                        element.classList.add('active');

                                                        const customInput = document.getElementById('customCategoryInput');
                                                        const categoryInput = document.getElementById('category');

                                                        if (value === 'نور') {
                                                                customInput.style.display = 'block';
                                                                customInput.focus();
                                                                categoryInput.value = customInput.value; // Initialize with current custom input value if any
                                                        } else {
                                                                customInput.style.display = 'none';
                                                                categoryInput.value = value;
                                                        }
                                                }

                                                function updateCustomCategory(val) {
                                                        // Only update if "Other" is currently selected (which it should be if this input is visible)
                                                        document.getElementById('category').value = val;
                                                }

                                                // --- NEW SAUDI DASHBOARD LOGIC ---
                                                function renderSaudiDashboard() {
                                                        const modal = document.querySelector('#dashboardScreen .modal');
                                                        const isBrooklyn = currentJob.id === 'boklyn';
                                                        const currencyLabel = isBrooklyn ? 'افغانۍ (AFN)' : 'ر.س (SAR)';

                                                        // Get current month index (0-11) to set default selection
                                                        const currentMonthIndex = new Date().getMonth();
                                                        const pashtoMonths = [
                                                                "جنوري", "فبروري", "مارچ", "اپریل", "می", "جون",
                                                                "جولای", "اگست", "سپتمبر", "اکتوبر", "نومبر", "دیسمبر"
                                                        ];

                                                        // Generate options
                                                        let optionsHtml = '';
                                                        pashtoMonths.forEach((m, index) => {
                                                                const selected = index === currentMonthIndex ? 'selected' : '';
                                                                optionsHtml += `<option value="${m}" ${selected}>${m}</option>`;
                                                        });

                                                        // Clear existing content and set new structure
                                                        modal.innerHTML = `
                <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                    <div class="modal-icon" style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);">📊</div>
                    <div>
                        <div class="modal-title">ډشبورډ</div>
                        <p class="modal-subtitle">مالي راپور او احصایه</p>
                    </div>
                    <button type="button" class="btn-close-fancy" onclick="closeDashboard()" style="position: absolute; top: 15px; left: 15px;">✕</button>
                </div>

                <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <!-- Month Selector -->
                    <div style="margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                        <label style="color: #94a3b8; font-size: 12px; display: block; margin-bottom: 8px;">د میاشتې انتخاب:</label>
                        <select id="saudiMonthSelect" onchange="fetchSaudiData()" style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 8px; outline: none; font-family: inherit;">
                            ${optionsHtml}
                        </select>
                    </div>

                    <div id="saudiLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px; color: #94a3b8;">له ګوګل شیټ معلومات راټولیږي...</p>
                    </div>

                    <div id="saudiContent" style="display: none; flex-direction: column; gap: 15px;">

                        <!-- 1. Monthly Total Revenue -->
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 20px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -10px; left: -10px; width: 60px; height: 60px; background: rgba(16, 185, 129, 0.2); border-radius: 50%; filter: blur(20px);"></div>
                            <div style="font-size: 14px; color: #a7f3d0; margin-bottom: 5px;">میاشتنی ټول عاید</div>
                            <div id="saudiRevenue" style="font-size: 28px; font-weight: 800; color: #34d399; text-shadow: 0 0 20px rgba(52, 211, 153, 0.3);">0</div>
                            <div style="font-size: 12px; color: #6ee7b7; opacity: 0.8;">${currencyLabel}</div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <!-- 2. Sent Home -->
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 15px;">
                                <div style="font-size: 12px; color: #bfdbfe; margin-bottom: 5px;">کور ته لېږل شوي</div>
                                <div id="saudiSentHome" style="font-size: 20px; font-weight: 700; color: #60a5fa;">0</div>
                            </div>

                            <!-- 3. Salaries -->
                            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 16px; padding: 15px;">
                                <div style="font-size: 12px; color: #fde68a; margin-bottom: 5px;">ورکړل شوې تنخوا</div>
                                <div id="saudiSalaries" style="font-size: 20px; font-weight: 700; color: #fbbf24;">0</div>
                            </div>
                        </div>

                        <!-- 4. Expenses -->
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 14px; color: #fca5a5; margin-bottom: 5px;">میاشتنی ټول لګښت</div>
                            <div id="saudiExpenses" style="font-size: 24px; font-weight: 800; color: #f87171;">0</div>
                        </div>

                        <!-- 5. Net Profit -->
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);">
                            <div style="font-size: 16px; color: #e9d5ff; margin-bottom: 8px; font-weight: bold;">✨ میاشتنئ خالصه ګټه</div>
                            <div id="saudiNetProfit" style="font-size: 32px; font-weight: 900; color: #c084fc; text-shadow: 0 0 30px rgba(192, 132, 252, 0.5);">0</div>
                            <div style="font-size: 12px; color: #d8b4fe;">${currencyLabel}</div>
                        </div>

                        <div style="margin-top: 10px; text-align: center;">
                             <button onclick="fetchSaudiData()" class="btn-secondary" style="font-size: 12px; padding: 8px 16px;">🔄 معلومات تازه کړئ</button>
                        </div>
                    </div>
                </div>
            `;

                                                        fetchSaudiData();
                                                }

                                                // --- NEW MOBILE DASHBOARD LOGIC ---
                                                function renderMobileDashboard() {
                                                        const modal = document.querySelector('#dashboardScreen .modal');

                                                        // Get current month index
                                                        const currentMonthIndex = new Date().getMonth();
                                                        const pashtoMonths = [
                                                                "جنوري", "فبروري", "مارچ", "اپریل", "می", "جون",
                                                                "جولای", "اگست", "سپتمبر", "اکتوبر", "نومبر", "دیسمبر"
                                                        ];

                                                        // Generate options
                                                        let optionsHtml = '';
                                                        pashtoMonths.forEach((m, index) => {
                                                                const selected = index === currentMonthIndex ? 'selected' : '';
                                                                optionsHtml += `<option value="${m}" ${selected}>${m}</option>`;
                                                        });

                                                        // Clear existing content and set new structure
                                                        modal.innerHTML = `
                <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                    <div class="modal-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 0 12px 30px rgba(59, 130, 241, 0.4);">📊</div>
                    <div>
                        <div class="modal-title">ډشبورډ</div>
                        <p class="modal-subtitle">د موبایل حساب مالي راپور</p>
                    </div>
                    <button type="button" class="btn-close-fancy" onclick="closeDashboard()" style="position: absolute; top: 15px; left: 15px;">✕</button>
                </div>

                <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <!-- Month Selector -->
                    <div style="margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                        <label style="color: #94a3b8; font-size: 12px; display: block; margin-bottom: 8px;">د میاشتې انتخاب:</label>
                        <select id="mobileMonthSelect" onchange="fetchMobileData()" style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 8px; outline: none; font-family: inherit;">
                            ${optionsHtml}
                        </select>
                    </div>

                    <div id="mobileLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px; color: #94a3b8;">له ګوګل شیټ معلومات راټولیږي...</p>
                    </div>

                    <div id="mobileContent" style="display: none; flex-direction: column; gap: 15px;">

                        <!-- 1. Monthly Total Income -->
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 14px; color: #a7f3d0; margin-bottom: 5px;">میاشتنی ټول عاید</div>
                            <div id="mobileRevenue" style="font-size: 28px; font-weight: 800; color: #34d399;">0</div>
                            <div style="font-size: 12px; color: #6ee7b7; opacity: 0.8;">افغانۍ (AFN)</div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <!-- 2. Sent Home (Mobile) -->
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 15px;">
                                <div style="font-size: 12px; color: #bfdbfe; margin-bottom: 5px;">کور ته ورکړل شوی</div>
                                <div id="mobileSentHome" style="font-size: 20px; font-weight: 700; color: #60a5fa;">0</div>
                            </div>

                            <!-- 3. Shop Rent -->
                            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 16px; padding: 15px;">
                                <div style="font-size: 12px; color: #fde68a; margin-bottom: 5px;">دکان کرایه</div>
                                <div id="mobileShopRent" style="font-size: 20px; font-weight: 700; color: #fbbf24;">0</div>
                            </div>
                        </div>

                        <!-- 4. Monthly Total Expense -->
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 14px; color: #fca5a5; margin-bottom: 5px;">میاشتنی ټول لګښت</div>
                            <div id="mobileExpenses" style="font-size: 24px; font-weight: 800; color: #f87171;">0</div>
                        </div>
                                                
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 16px; padding: 20px; text-align: center;">
                            <div style="font-size: 16px; color: #e9d5ff; margin-bottom: 8px; font-weight: bold;">✨ میاشنئ خالصه ګټه</div>
                            <div id="mobileNetProfit" style="font-size: 32px; font-weight: 900; color: #c084fc;">0</div>
                            <div style="font-size: 12px; color: #d8b4fe;">افغانۍ (AFN)</div>
                        </div>

                        <div style="margin-top: 10px; text-align: center;">
                             <button onclick="fetchMobileData()" class="btn-secondary" style="font-size: 12px; padding: 8px 16px;">🔄 معلومات تازه کړئ</button>
                        </div>
                    </div>
                </div>
            `;

                                                        fetchMobileData();
                                                }

                                                async function fetchHomeData() {
                                                    const monthSelect = document.getElementById('homeMonthSelect');
                                                    const selectedMonth = monthSelect ? monthSelect.value : '';
                                                    const currentId = currentJob.id;
                                                    
                                                    // Optional: Add simple loading state if desired
                                                    const fieldsDiv = document.getElementById('homeFields');
                                                    if (fieldsDiv) fieldsDiv.style.opacity = '0.5';

                                                    try {
                                                        const url = new URL(GOOGLE_SHEETS_URL);
                                                        url.searchParams.append('action', 'getHomeStats');
                                                        url.searchParams.append('accountId', currentId);
                                                        if (selectedMonth) {
                                                            url.searchParams.append('month', selectedMonth);
                                                        }

                                                        const response = await fetch(url.toString());
                                                        const data = await response.json();

                                                        // Update fields
                                                        if (document.getElementById('familyMembers')) document.getElementById('familyMembers').value = data.familyMembers || '';
                                                        if (document.getElementById('individualRight')) document.getElementById('individualRight').value = data.individualRight || '';
                                                        if (document.getElementById('actualPayment')) document.getElementById('actualPayment').value = data.actualPayment || '';
                                                        if (document.getElementById('difference')) document.getElementById('difference').value = data.difference || '';
                                                        if (document.getElementById('status')) document.getElementById('status').value = data.status || '';
                                                        if (document.getElementById('remainingCash')) document.getElementById('remainingCash').value = data.remainingCash || '';

                                                    } catch (error) {
                                                        console.error("Error fetching Home stats:", error);
                                                    } finally {
                                                        if (fieldsDiv) fieldsDiv.style.opacity = '1';
                                                    }
                                                }

                                                async function fetchMobileData() {
                                                        const loading = document.getElementById('mobileLoading');
                                                        const content = document.getElementById('mobileContent');
                                                        const monthSelect = document.getElementById('mobileMonthSelect');
                                                        const selectedMonth = monthSelect ? monthSelect.value : '';

                                                        if (loading) loading.style.display = 'flex';
                                                        if (content) content.style.display = 'none';

                                                        try {
                                                                const url = new URL(GOOGLE_SHEETS_URL);
                                                                url.searchParams.append('action', 'getMobileStats');
                                                                url.searchParams.append('accountId', 'mobile');
                                                                if (selectedMonth) {
                                                                        url.searchParams.append('month', selectedMonth);
                                                                }

                                                                const response = await fetch(url.toString());
                                                                const data = await response.json();

                                                                if (document.getElementById('mobileRevenue')) document.getElementById('mobileRevenue').textContent = formatCurrency(data.revenue || 0);
                                                                if (document.getElementById('mobileSentHome')) document.getElementById('mobileSentHome').textContent = formatCurrency(data.sentHome || 0);
                                                                if (document.getElementById('mobileShopRent')) document.getElementById('mobileShopRent').textContent = formatCurrency(data.shopRent || 0);
                                                                if (document.getElementById('mobileExpenses')) document.getElementById('mobileExpenses').textContent = formatCurrency(data.expenses || 0);
                                                                if (document.getElementById('mobileNetProfit')) document.getElementById('mobileNetProfit').textContent = formatCurrency(data.netProfit || 0);

                                                        } catch (error) {
                                                                console.error("Error fetching Mobile stats:", error);
                                                                document.getElementById('mobileRevenue').textContent = "0";
                                                                document.getElementById('mobileSentHome').textContent = "0";
                                                                document.getElementById('mobileShopRent').textContent = "0";
                                                                document.getElementById('mobileExpenses').textContent = "0";
                                                                document.getElementById('mobileNetProfit').textContent = "0";
                                                                showToast('error', 'د معلوماتو ستونزه', 'له ګوګل شیټ سره اړیکه ونشو نیولای');
                                                        } finally {
                                                                if (loading) loading.style.display = 'none';
                                                                if (content) content.style.display = 'flex';
                                                        }
                                                }

                                                async function fetchSaudiData() {
                                                        const loading = document.getElementById('saudiLoading');
                                                        const content = document.getElementById('saudiContent');
                                                        const monthSelect = document.getElementById('saudiMonthSelect');
                                                        const selectedMonth = monthSelect ? monthSelect.value : '';

                                                        if (loading) loading.style.display = 'flex';
                                                        if (content) content.style.display = 'none';

                                                        try {
                                                                // Construct URL to fetch specific stats for this Saudi account
                                                                // Appending action=getSaudiStats and the specific sub-account ID
                                                                const url = new URL(GOOGLE_SHEETS_URL);
                                                                url.searchParams.append('action', 'getSaudiStats');
                                                                url.searchParams.append('accountId', currentJob.id);
                                                                if (selectedMonth) {
                                                                        url.searchParams.append('month', selectedMonth);
                                                                }

                                                                // Fetch data from Google Sheets
                                                                const response = await fetch(url.toString());
                                                                const data = await response.json();

                                                                // Check if API returned valid data, otherwise use 0
                                                                const revenue = data.revenue || 0;
                                                                const sentHome = data.sentHome || 0;
                                                                const salaries = data.salaries || 0;
                                                                const expenses = data.expenses || 0;
                                                                const netProfit = data.netProfit || 0;

                                                                // Update UI
                                                                if (document.getElementById('saudiRevenue')) document.getElementById('saudiRevenue').textContent = formatCurrency(revenue);
                                                                if (document.getElementById('saudiSentHome')) document.getElementById('saudiSentHome').textContent = formatCurrency(sentHome);
                                                                if (document.getElementById('saudiSalaries')) document.getElementById('saudiSalaries').textContent = formatCurrency(salaries);
                                                                if (document.getElementById('saudiExpenses')) document.getElementById('saudiExpenses').textContent = formatCurrency(expenses);
                                                                if (document.getElementById('saudiNetProfit')) document.getElementById('saudiNetProfit').textContent = formatCurrency(netProfit);

                                                        } catch (error) {
                                                                console.error("Error fetching Saudi stats:", error);
                                                                // Fallback / Simulation for demo if fetch fails (since we don't have the real backend script)
                                                                // Remove this in production if backend is ready

                                                                // Simulating data for demonstration as per 'code from scratch' request logic
                                                                document.getElementById('saudiRevenue').textContent = "0";
                                                                document.getElementById('saudiSentHome').textContent = "0";
                                                                document.getElementById('saudiSalaries').textContent = "0";
                                                                document.getElementById('saudiExpenses').textContent = "0";
                                                                document.getElementById('saudiNetProfit').textContent = "0";
                                                                showToast('error', 'د ډیټا په راوړلو کې ستونزه', 'له ګوګل شیټ سره اړیکه ونشو نیولای');
                                                        } finally {
                                                                if (loading) loading.style.display = 'none';
                                                                if (content) content.style.display = 'flex'; // Use flex to maintain column layout
                                                        }
                                                }

                                                function formatCurrency(num) {
                                                        return parseFloat(num).toLocaleString();
                                                }

                                                // --- NEW GENERAL DASHBOARD LOGIC ---
                                                function renderGeneralDashboard() {
                                                        const dashboardContent = document.getElementById('dashboardContent');
                                                        if (dashboardContent) dashboardContent.style.display = 'block';

                                                        const modal = document.querySelector('#dashboardScreen .modal');
                                                        if (!modal) return;

                                                        // Clear existing content and set new structure
                                                        modal.innerHTML = `
                <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                    <div class="modal-icon" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); box-shadow: 0 12px 30px rgba(99, 102, 241, 0.4);">📊</div>
                    <div>
                        <div class="modal-title">عمومي ډشبورډ</div>
                        <p class="modal-subtitle">مالي راپور</p>
                    </div>
                    <button type="button" class="btn-close-fancy" onclick="closeDashboard()" style="position: absolute; top: 15px; left: 15px;">✕</button>
                </div>

                <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <div id="generalLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px; color: #94a3b8;">د ګوګل شیټ څخه معلومات راټولیږي...</p>
                    </div>

                    <div id="generalContent" style="display: none; flex-direction: column; gap: 15px;">

                        <!-- 1. Total Revenue -->
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 20px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -10px; left: -10px; width: 60px; height: 60px; background: rgba(16, 185, 129, 0.2); border-radius: 50%; filter: blur(20px);"></div>
                            <div style="font-size: 14px; color: #a7f3d0; margin-bottom: 5px;">ټول عاید (Revenue)</div>
                            <div id="generalRevenue" style="font-size: 28px; font-weight: 800; color: #34d399; text-shadow: 0 0 20px rgba(52, 211, 153, 0.3);">0</div>
                            <div style="font-size: 12px; color: #6ee7b7; opacity: 0.8;">افغانۍ (AFN)</div>
                        </div>

                        <!-- 2. Expenses -->
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 14px; color: #fca5a5; margin-bottom: 5px;">ټول لګښت (Expenses)</div>
                            <div id="generalExpenses" style="font-size: 24px; font-weight: 800; color: #f87171;">0</div>
                            <div style="font-size: 12px; color: #fca5a5; opacity: 0.8;">افغانۍ (AFN)</div>
                        </div>

                        <!-- 3. Net Profit -->
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);">
                            <div style="font-size: 16px; color: #e9d5ff; margin-bottom: 8px; font-weight: bold;">✨ خالصه ګټه (Net Profit)</div>
                            <div id="generalNetProfit" style="font-size: 32px; font-weight: 900; color: #c084fc; text-shadow: 0 0 30px rgba(192, 132, 252, 0.5);">0</div>
                            <div style="font-size: 12px; color: #d8b4fe;">افغانۍ (AFN)</div>
                        </div>

                        <!-- 4. Total Capital -->
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 14px; color: #d8b4fe; margin-bottom: 5px;">ټوله پانګه (Total Capital)</div>
                            <div id="generalTotalCapital" style="font-size: 24px; font-weight: 800; color: #c084fc;">0</div>
                            <div style="font-size: 12px; color: #d8b4fe; opacity: 0.8;">افغانۍ (AFN)</div>
                        </div>

                        <!-- 5. Loans Group -->
                        <div style="margin-top: 15px; margin-bottom: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                             <div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px; font-weight: 600;">قرضونه (Loans)</div>
                             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <!-- People's Loans from Us (Receivables) -->
                                <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 15px;">
                                    <div style="font-size: 12px; color: #bfdbfe; margin-bottom: 5px;">په خلکو زمونږ قرضونه</div>
                                    <div id="generalReceivables" style="font-size: 20px; font-weight: 700; color: #60a5fa;">0</div>
                                </div>

                                <!-- Our Loans from People (Liabilities) -->
                                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 16px; padding: 15px;">
                                    <div style="font-size: 12px; color: #fde68a; margin-bottom: 5px;">په مونږ د خلکو قرضونه</div>
                                    <div id="generalLiabilities" style="font-size: 20px; font-weight: 700; color: #fbbf24;">0</div>
                                </div>
                             </div>
                        </div>

                        <div style="margin-top: 10px; text-align: center;">
                             <button onclick="fetchGeneralData()" class="btn-secondary" style="font-size: 12px; padding: 8px 16px;">🔄 معلومات تازه کړئ</button>
                        </div>
                    </div>
                </div>
            `;

                                                        fetchGeneralData();
                                                }

                                                async function fetchGeneralData() {
                                                        const loading = document.getElementById('generalLoading');
                                                        const content = document.getElementById('generalContent');

                                                        if (loading) loading.style.display = 'flex';
                                                        if (content) content.style.display = 'none';

                                                        try {
                                                                // Construct URL to fetch general stats
                                                                const url = new URL(GOOGLE_SHEETS_URL);
                                                                url.searchParams.append('action', 'getGeneralStats');

                                                                // Fetch data from Google Sheets
                                                                const response = await fetch(url.toString());
                                                                const data = await response.json();

                                                                // Check if API returned valid data, otherwise use 0
                                                                const revenue = data.revenue || 0;
                                                                const expenses = data.expenses || 0;
                                                                const netProfit = data.netProfit || 0;
                                                                const totalCapital = data.totalCapital || 0;
                                                                const receivables = data.receivables || 0;
                                                                const liabilities = data.liabilities || 0;

                                                                // Update UI
                                                                if (document.getElementById('generalRevenue')) document.getElementById('generalRevenue').textContent = formatCurrency(revenue);
                                                                if (document.getElementById('generalExpenses')) document.getElementById('generalExpenses').textContent = formatCurrency(expenses);
                                                                if (document.getElementById('generalNetProfit')) document.getElementById('generalNetProfit').textContent = formatCurrency(netProfit);
                                                                if (document.getElementById('generalTotalCapital')) document.getElementById('generalTotalCapital').textContent = formatCurrency(totalCapital);
                                                                if (document.getElementById('generalReceivables')) document.getElementById('generalReceivables').textContent = formatCurrency(receivables);
                                                                if (document.getElementById('generalLiabilities')) document.getElementById('generalLiabilities').textContent = formatCurrency(liabilities);

                                                        } catch (error) {
                                                                console.error("Error fetching General stats:", error);

                                                                document.getElementById('generalRevenue').textContent = "0";
                                                                document.getElementById('generalExpenses').textContent = "0";
                                                                document.getElementById('generalNetProfit').textContent = "0";
                                                                if (document.getElementById('generalTotalCapital')) document.getElementById('generalTotalCapital').textContent = "0";
                                                                if (document.getElementById('generalReceivables')) document.getElementById('generalReceivables').textContent = "0";
                                                                if (document.getElementById('generalLiabilities')) document.getElementById('generalLiabilities').textContent = "0";

                                                                showToast('error', 'د ډیټا په راوړلو کې ستونزه', 'له ګوګل شیټ سره اړیکه ونشو نیولای');
                                                        } finally {
                                                                if (loading) loading.style.display = 'none';
                                                                if (content) content.style.display = 'flex';
                                                        }
                                                }

                                                function openDashboard() {
                                                        // Close other screens first
                                                        const reportScreen = document.getElementById('reportScreen');
                                                        const debtScreen = document.getElementById('debtScreen');
                                                        const dashboardScreen = document.getElementById('dashboardScreen');
                                                        const opExpScreen = document.getElementById('opExpScreen');
                                                        const capExpScreen = document.getElementById('capExpScreen');

                                                        if (reportScreen) {
                                                                reportScreen.classList.remove('active');
                                                                reportScreen.style.display = 'none';
                                                        }
                                                        if (debtScreen) {
                                                                debtScreen.classList.remove('active');
                                                                debtScreen.style.display = 'none';
                                                        }
                                                        if (opExpScreen) {
                                                                opExpScreen.classList.remove('active');
                                                                opExpScreen.style.display = 'none';
                                                        }
                                                        if (capExpScreen) {
                                                                capExpScreen.classList.remove('active');
                                                                capExpScreen.style.display = 'none';
                                                        }

                                                        if (dashboardScreen) {
                                                                dashboardScreen.classList.add('active');
                                                                dashboardScreen.style.display = 'flex';
                                                        }

                                                        // *** NEW: SAUDI DASHBOARD ***
                                                        if (currentJob && (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_') || currentJob.id === 'boklyn')) {
                                                                renderSaudiDashboard();
                                                                return;
                                                        }

                                                        // *** NEW: MOBILE DASHBOARD ***
                                                        if (currentJob && currentJob.id === 'mobile') {
                                                                renderMobileDashboard();
                                                                return;
                                                        }

                                                        // Home accounts dashboard removed
                                                        if (currentJob && currentJob.id.startsWith('home_')) {
                                                                return;
                                                        }

                                                        // Check if user is one of the specific Home accounts
                                                        const jointExpenseAccounts = ['home_lalak', 'home_saifullah', 'home_saeedullah', 'home_siddiqullah', 'home_adil'];
                                                        const isJointAccount = false;

                                                        if (isJointAccount) {
                                                                // Show Joint Expenses Form
                                                                document.getElementById('dashboardTitle').textContent = 'مشترک لګښت';
                                                                document.getElementById('dashboardSubtitle').textContent = 'مهربانی وکړئ مشترک لګښت ولیکئ';
                                                                document.getElementById('jointExpensesContent').style.display = 'block';
                                                                document.getElementById('dashboardContent').style.display = 'none';

                                                                // Set default date
                                                                const today = new Date().toISOString().split('T')[0];
                                                                document.getElementById('jointDate').value = today;

                                                                // Render list
                                                                // Removed
                                                        } else {
                                                                renderGeneralDashboard();
                                                        }
                                                }


                                                // --- Joint Expenses Logic ---
                                                function handleJointExpenseSubmit(e) {
                                                        e.preventDefault();
                                                        const date = document.getElementById('jointDate').value;
                                                        const expense = document.getElementById('jointExpense').value;
                                                        const detail = document.getElementById('jointDetail').value;

                                                        if (!date || !expense || !detail) {
                                                                showToast('error', 'تېروتنه', 'مهرباني وکړئ ټول معلومات ډک کړئ');
                                                                return;
                                                        }

                                                        // Create Transaction Object (Same format as main system)
                                                        const newTransaction = {
                                                                date: date.replace(/-/g, '/'), // Format: YYYY/MM/DD
                                                                expense: expense,
                                                                detail: detail,
                                                                income: '0',
                                                                note: '',
                                                                category: 'مشترک لګښت',
                                                                currency: 'AFN',
                                                                timestamp: Date.now(),
                                                                isJointExpense: true
                                                        };

                                                        // Save to History
                                                        let history = JSON.parse(localStorage.getItem('history_' + currentJob.id) || '[]');
                                                        history.unshift(newTransaction);
                                                        localStorage.setItem('history_' + currentJob.id, JSON.stringify(history));

                                                        // Update Stats
                                                        let stats = JSON.parse(localStorage.getItem('stats_' + currentJob.id) || '{"income": 0, "expense": 0}');
                                                        stats.expense = parseFloat(stats.expense) + parseFloat(expense);
                                                        localStorage.setItem('stats_' + currentJob.id, JSON.stringify(stats));

                                                        // Handle Image Upload (if any)
                                                        if (compressedImageBlob) {
                                                                // In a real app, upload logic would go here. 
                                                                // Since this is client-side only for now, we can't easily store blobs in localStorage (size limit).
                                                                // We'll just show success toast.
                                                                console.log("Image ready to upload:", compressedImageBlob);
                                                        }

                                                        showToast('success', 'ثبت شو', 'مشترک لګښت په بریالیتوب سره ثبت شو');

                                                        // Reset Form
                                                        document.getElementById('jointExpense').value = '';
                                                        document.getElementById('jointDetail').value = '';
                                                        removeJointImage();

                                                        // Removed
                                                }

                                                function renderJointExpensesList() {
                                                        const history = JSON.parse(localStorage.getItem('history_' + currentJob.id) || '[]');
                                                        // Filter only joint expenses if mixed, or just show last 5 transactions
                                                        const recent = history.slice(0, 5);

                                                        const container = document.getElementById('jointExpensesList');
                                                        if (recent.length === 0) {
                                                                container.innerHTML = '<div style="text-align:center; color:#94a3b8; font-size:12px;">تراوسه هیڅ معلومات نشته</div>';
                                                                return;
                                                        }

                                                        container.innerHTML = recent.map(item => `
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; font-size: 14px;">${item.detail}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${item.date}</div>
                    </div>
                    <div style="font-weight: bold; color: #f87171;">-${parseFloat(item.expense).toLocaleString()}</div>
                </div>
            `).join('');
                                                }

                                                function handleJointImageSelect(input) {
                                                        const file = input.files[0];
                                                        if (file) {
                                                                processImage(file, 'joint');
                                                        }
                                                }

                                                function removeJointImage() {
                                                        document.getElementById('jointImageInput').value = '';
                                                        document.getElementById('jointImagePreview').style.display = 'none';
                                                        document.getElementById('jointPreviewImg').src = '';
                                                        compressedImageBlob = null;
                                                }

                                                function closeDashboard() {
                                                        const dashboardScreen = document.getElementById('dashboardScreen');
                                                        if (dashboardScreen) {
                                                                dashboardScreen.classList.remove('active');
                                                                dashboardScreen.style.display = 'none';
                                                        }
                                                }


                                                function clearAllData() {
                                                        if (confirm("آیا تاسو ډاډه یاست چې ټوله هیسټري او ډیټا پاکول غواړئ؟ دا عمل د بیرته راګرځیدو وړ نه دی!")) {

                                                                // Determine which account's data to delete
                                                                let targetAccountId = currentJob.id;

                                                                // If in Report Screen (Admin might be viewing another account)
                                                                if (document.getElementById('reportScreen').classList.contains('active')) {
                                                                        const accountSelector = document.getElementById('reportAccountSelector');
                                                                        const adminSelectContainer = document.getElementById('adminAccountSelectContainer');

                                                                        if (adminSelectContainer && adminSelectContainer.style.display !== 'none' && accountSelector && accountSelector.value !== 'current') {
                                                                                targetAccountId = accountSelector.value;
                                                                        }
                                                                }

                                                                // If in Dashboard Screen (Admin might be viewing another account)
                                                                if (document.getElementById('dashboardScreen').classList.contains('active')) {
                                                                        const dashboardSelector = document.getElementById('dashboardAccountSelector');
                                                                        if (dashboardSelector && dashboardSelector.value !== 'current') {
                                                                                targetAccountId = dashboardSelector.value;
                                                                        }
                                                                }

                                                                // Delete Data
                                                                localStorage.removeItem("history_" + targetAccountId);
                                                                localStorage.removeItem("stats_" + targetAccountId);
                                                                localStorage.removeItem("lastSaveData_" + targetAccountId);

                                                                showToast("success", "پاک شو", "ټوله ډیټا په بریالیتوب سره پاکه شوه");

                                                                // Refresh the current view instead of closing
                                                                if (document.getElementById('reportScreen').classList.contains('active')) {
                                                                        filterReportByDuration(); // Refresh report list
                                                                } else if (document.getElementById('dashboardScreen').classList.contains('active')) {
                                                                        updateDashboardStats(targetAccountId === currentJob.id ? 'current' : targetAccountId); // Refresh dashboard stats
                                                                }
                                                        }
                                                }

                                                // --- BACKUP & RESTORE ---
                                                function downloadBackup() {
                                                        const data = JSON.stringify(localStorage);
                                                        const blob = new Blob([data], { type: "application/json" });
                                                        const url = URL.createObjectURL(blob);
                                                        const a = document.createElement("a");
                                                        a.href = url;
                                                        a.download = `Sherzad_Backup_${new Date().toISOString().slice(0,10)}.json`;
                                                        document.body.appendChild(a);
                                                        a.click();
                                                        document.body.removeChild(a);
                                                        URL.revokeObjectURL(url);
                                                        showToast('success', 'بیک اپ', 'فایل ډاونلوډ شو!');
                                                }

                                                function restoreBackup(input) {
                                                        const file = input.files[0];
                                                        if (!file) return;

                                                        const reader = new FileReader();
                                                        reader.onload = function(e) {
                                                                try {
                                                                        const data = JSON.parse(e.target.result);
                                                                        // Clear current data mostly or just overwrite? Overwrite is safer for restore.
                                                                        // But we should probably ask confirmation
                                                                        if (!confirm("آیا غواړئ دا بیک اپ فایل پورته کړئ؟ اوسنۍ ډیټا به له دې سره بدله شي.")) return;

                                                                        Object.keys(data).forEach(key => {
                                                                                localStorage.setItem(key, data[key]);
                                                                        });

                                                                        showToast('success', 'رییسټور', 'ډیټا په بریالیتوب پورته شوه!');
                                                                        setTimeout(() => location.reload(), 1500); // Reload to apply changes
                                                                } catch (err) {
                                                                        console.error(err);
                                                                        showToast('error', 'تېروتنه', 'فایل خراب دی یا سم فارمیټ نلري');
                                                                }
                                                        };
                                                        reader.readAsText(file);
                                                        input.value = ''; // Reset input
                                                }


                                                // OVERRIDE: Update General Dashboard to use Debt Data
                                                async function updateGeneralDashboard() {
                                                        const refreshBtn = event?.currentTarget;
                                                        if (refreshBtn) {
                                                            refreshBtn.style.animation = 'spin 1s linear infinite';
                                                            refreshBtn.disabled = true;
                                                        }

                                                        try {
                                                            const url = new URL(GOOGLE_SHEETS_URL);
                                                            url.searchParams.append('action', 'getGeneralDashboardData');
                                                            
                                                            const response = await fetch(url.toString());
                                                            const data = await response.json();
                                                            
                                                            if (data) {
                                                                // Update UI with data from Google Sheets
                                                                if (document.getElementById('dashTotalWorth')) document.getElementById('dashTotalWorth').textContent = (data.totalWorth || 0).toLocaleString();
                                                                if (document.getElementById('dashTotalCash')) document.getElementById('dashTotalCash').textContent = (data.totalCash || 0).toLocaleString();
                                                                if (document.getElementById('dashTotalCapital')) document.getElementById('dashTotalCapital').textContent = (data.totalCapital || 0).toLocaleString();
                                                                if (document.getElementById('dashTotalIncome')) document.getElementById('dashTotalIncome').textContent = (data.totalIncome || 0).toLocaleString();
                                                                if (document.getElementById('dashNetProfit')) document.getElementById('dashNetProfit').textContent = (data.netProfit || 0).toLocaleString();
                                                                if (document.getElementById('dashNetRemaining')) document.getElementById('dashNetRemaining').textContent = (data.netRemaining || 0).toLocaleString();
                                                                if (document.getElementById('dashTotalExpense')) document.getElementById('dashTotalExpense').textContent = (data.totalExpense || 0).toLocaleString();
                                                                if (document.getElementById('dashTotalHouseholdExpense')) document.getElementById('dashTotalHouseholdExpense').textContent = (data.totalHouseholdExpense || 0).toLocaleString();
                                                                if (document.getElementById('dashTotalInvestment')) document.getElementById('dashTotalInvestment').textContent = (data.totalInvestment || 0).toLocaleString();
                                                                if (document.getElementById('dashLoansToPeople')) document.getElementById('dashLoansToPeople').textContent = (data.loansToPeople || 0).toLocaleString();
                                                                if (document.getElementById('dashLoansFromPeople')) document.getElementById('dashLoansFromPeople').textContent = (data.loansFromPeople || 0).toLocaleString();
                                                                
                                                                showToast('success', 'تازه شو', 'ډیټا له ګوګل شیټ څخه په بریالیتوب تازه شوه');
                                                            }
                                                        } catch (error) {
                                                            console.error("Error refreshing dashboard:", error);
                                                            showToast('error', 'تېروتنه', 'د ډیټا په تازه کولو کې ستونزه راغله');
                                                        } finally {
                                                            if (refreshBtn) {
                                                                refreshBtn.style.animation = '';
                                                                refreshBtn.disabled = false;
                                                            }
                                                        }
                                                }
                                        </script>
                                        <script>
                                                // --- 1. PIE CHART LOGIC ---
                                                let expenseChartInstance = null;

                                                function renderChart(history) {
                                                        const ctx = document.getElementById('expensePieChart');
                                                        if (!ctx) return;

                                                        // Aggregate expenses by category
                                                        const categories = {};
                                                        history.forEach(item => {
                                                                if (parseFloat(item.expense) > 0) {
                                                                        const cat = item.category || 'نور'; // Default to "Other"
                                                                        categories[cat] = (categories[cat] || 0) + parseFloat(item.expense);
                                                                }
                                                        });

                                                        const labels = Object.keys(categories);
                                                        const data = Object.values(categories);
                                                        const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#f472b6', '#9ca3af'];

                                                        if (expenseChartInstance) {
                                                                expenseChartInstance.destroy();
                                                        }

                                                        expenseChartInstance = new Chart(ctx, {
                                                                type: 'pie',
                                                                data: {
                                                                        labels: labels,
                                                                        datasets: [{
                                                                                data: data,
                                                                                backgroundColor: colors,
                                                                                borderWidth: 0
                                                                        }]
                                                                },
                                                                options: {
                                                                        responsive: true,
                                                                        maintainAspectRatio: false,
                                                                        plugins: {
                                                                                legend: {
                                                                                        position: 'bottom',
                                                                                        labels: { color: '#cbd5e1', font: { family: 'inherit' } }
                                                                                }
                                                                        }
                                                                }
                                                        });
                                                }

                                                // --- 2. SEARCH LOGIC ---
                                                const searchInput = document.getElementById('reportSearchInput');
                                                if (searchInput) {
                                                        searchInput.addEventListener('input', (e) => {
                                                                const term = e.target.value.toLowerCase();
                                                                const rows = document.querySelectorAll('.report-list .data-row');

                                                                rows.forEach(row => {
                                                                        const text = row.textContent.toLowerCase();
                                                                        if (text.includes(term)) {
                                                                                row.style.display = 'flex';
                                                                        } else {
                                                                                row.style.display = 'none';
                                                                        }
                                                                });
                                                        });
                                                }

                                                // --- 3. CURRENCY CONVERTER LOGIC REMOVED ---


                                                // --- 4. BUDGET LIMIT WARNING LOGIC ---
                                                function checkBudgetLimit(totalExpense) {
                                                        const limit = 50000;
                                                        const warningThreshold = 45000;
                                                        const warningBox = document.getElementById('budgetWarning');

                                                        if (totalExpense >= warningThreshold) {
                                                                warningBox.style.display = 'flex';
                                                                warningBox.innerHTML = `⚠️ پام وکړئ! لګښت ${totalExpense.toLocaleString()} ته ورسیدل. (حد: ${limit.toLocaleString()})`;
                                                        } else {
                                                                warningBox.style.display = 'none';
                                                        }
                                                }

                                                // --- HOOKS INTO EXISTING FUNCTIONS ---

                                                // Hook into openReport (if it exists) or filterReportByDuration (which populates the list)
                                                // Since filterReportByDuration is called by onchange, and presumably initially, we should hook there.
                                                // Wait, looking at the code, filterReportByDuration() is the main render function for report list.
                                                // I need to intercept it.

                                                // Save original reference
                                                const originalFilterReportByDuration = window.filterReportByDuration || filterReportByDuration;

                                                // Override
                                                window.filterReportByDuration = function() {
                                                        // Call original
                                                        originalFilterReportByDuration();

                                                        // After original runs, it presumably updates the DOM or gets data.
                                                        // Let's get the data again to render the chart.
                                                        // Note: The original function likely gets data from localStorage.
                                                        // We'll wait a tick to ensure DOM is updated if needed, or just fetch data directly.

                                                        setTimeout(() => {
                                                                // Ensure getFilteredData exists, otherwise fallback or error handle
                                                                if (typeof getFilteredData === 'function') {
                                                                        const data = getFilteredData();
                                                                        renderChart(data);
                                                                }
                                                        }, 50);
                                                };

                                                // Hook into updateDashboardStats for Budget Warning
                                                const originalUpdateDashboardStats = window.updateDashboardStats || updateDashboardStats;

                                                window.updateDashboardStats = function(accountId) {
                                                        console.log('Updating dashboard stats for:', accountId);
                                                        const targetAccountId = accountId === 'current' ? currentJob.id : accountId;

                                                        // Get data from localStorage
                                                        let stats = JSON.parse(localStorage.getItem('stats_' + targetAccountId) || '{"income": 0, "expense": 0}');

                                                        const income = parseFloat(stats.income || 0);
                                                        const expense = parseFloat(stats.expense || 0);
                                                        const netBalance = income - expense;

                                                        // Update UI
                                                        const profitEl = document.getElementById('dashboardTotalProfit');
                                                        const expenseEl = document.getElementById('dashboardTotalExpense');
                                                        const balanceEl = document.getElementById('dashboardNetBalance');

                                                        if (profitEl) profitEl.textContent = income.toLocaleString();
                                                        if (expenseEl) expenseEl.textContent = expense.toLocaleString();
                                                        if (balanceEl) balanceEl.textContent = netBalance.toLocaleString() + ' ؋';

                                                        if (typeof checkBudgetLimit === 'function') {
                                                                checkBudgetLimit(expense);
                                                        }
                                                };

                                                // --- FIX FOR HOME ACCOUNTS ---
                                                setInterval(() => {
                                                        if (typeof currentJob !== 'undefined' && currentJob && currentJob.id && currentJob.id.startsWith('home_')) {
                                                                // 1. Fix Close Button Visibility
                                                                const btn = document.getElementById('homeLogoutBtn');
                                                                if (btn && btn.style.display === 'none') {
                                                                        btn.style.display = 'flex';
                                                                        btn.style.zIndex = '100';
                                                                }

                                                                // 2. Fix Grid Layout
                                                                const fields = document.getElementById('homeFields');
                                                                if (fields && fields.style.display !== 'grid') fields.style.display = 'grid';

                                                                // 3. Fix ReadOnly for Saifullah
                                                                const isSaifullah = currentJob.name === 'سیف الله';
                                                                ['familyMembers', 'individualRight', 'actualPayment', 'difference', 'status', 'remainingCash'].forEach(id => {
                                                                        const el = document.getElementById(id);
                                                                        if (el) {
                                                                                if (isSaifullah) {
                                                                                        if (el.hasAttribute('readonly')) el.removeAttribute('readonly');
                                                                                        el.style.background = 'rgba(255,255,255,0.1)';
                                                                                } else {
                                                                                        if (!el.hasAttribute('readonly')) el.setAttribute('readonly', 'true');
                                                                                        el.style.background = 'rgba(255,255,255,0.05)';
                                                                                }
                                                                                el.style.width = '100%';
                                                                                el.style.display = 'block';
                                                                                el.style.boxSizing = 'border-box';
                                                                        }
                                                                });
                                                        }
                                                }, 500);
                                        </script>
                                        <script>
                                                // --- NEW: Report Download System ---
                                                function toggleReportInputs() {
                                                        const type = document.getElementById('reportType').value;
                                                        document.getElementById('dateInputGroup').style.display = 'none';
                                                        document.getElementById('monthInputGroup').style.display = 'none';
                                                        document.getElementById('yearInputGroup').style.display = 'none';

                                                        if (type === 'daily' || type === 'custom') {
                                                                document.getElementById('dateInputGroup').style.display = 'block';
                                                        } else if (type === 'monthly') {
                                                                document.getElementById('monthInputGroup').style.display = 'block';
                                                        } else if (type === 'yearly') {
                                                                document.getElementById('yearInputGroup').style.display = 'block';
                                                        }
                                                }

                                                function toggleDownloadMenu() {
                                                        const menu = document.getElementById('downloadMenu');
                                                        if (menu) menu.classList.toggle('hidden');
                                                }

                                                // Redirect old downloadReport calls to the new global window.downloadReport
                                                function downloadReport(format) {
                                                        if (window.downloadReport && typeof window.downloadReport === 'function') {
                                                                return window.downloadReport(format);
                                                        }
                                                }
                                        </script>
                                        <script>
                                                // --- NEW: Report Download System (Redefined) ---
                                                function toggleReportInputs() {
                                                        const type = document.getElementById('reportType').value;
                                                        const dateGroup = document.getElementById('dateInputGroup');
                                                        const monthGroup = document.getElementById('monthInputGroup');
                                                        const yearGroup = document.getElementById('yearInputGroup');

                                                        if (dateGroup) dateGroup.style.display = 'none';
                                                        if (monthGroup) monthGroup.style.display = 'none';
                                                        if (yearGroup) yearGroup.style.display = 'none';

                                                        if (type === 'daily' || type === 'custom') {
                                                                if (dateGroup) dateGroup.style.display = 'block';
                                                        } else if (type === 'monthly') {
                                                                if (monthGroup) monthGroup.style.display = 'block';
                                                        } else if (type === 'yearly') {
                                                                if (yearGroup) yearGroup.style.display = 'block';
                                                        }
                                                }

                                                function toggleDownloadMenu() {
                                                        const menu = document.getElementById('downloadMenu');
                                                        if (menu) menu.classList.toggle('hidden');
                                                }

                                                // Close menu when clicking outside
                                                window.addEventListener('click', function(e) {
                                                        if (!e.target.closest('.download-dropdown')) {
                                                                const menu = document.getElementById('downloadMenu');
                                                                if (menu && !menu.classList.contains('hidden')) {
                                                                        menu.classList.add('hidden');
                                                                }
                                                        }
                                                });

                                                // Redefine downloadReport to overwrite the previous one
                                                window.downloadReport = function(format) {
                                                        // Hide menu if it's open
                                                        const menu = document.getElementById('downloadMenu');
                                                        if (menu) menu.classList.add('hidden');

                                                        // Fix: Check if reportSearchInput exists before adding listener to avoid crash
                                                        const searchInput = document.getElementById('reportSearchInput');
                                                        if (searchInput) {
                                                                // listener logic...
                                                        }

                                                        // Force the specific columns the user wants: نېټه، عاید، لګښت، کورته لېږل شوی، ډرېور تنخوا، تفصیل، یاداښت
                                                        // For CSV, these will be: Date, Income, Expense, SentHome, FifthCol, Detail, Note
                                                        if ((currentJob.id === 'boklyn' || currentJob.id.startsWith('saudi')) && format === 'pdf' && !document.getElementById('reportScreen').classList.contains('active')) {
                                                                const revenueText = document.getElementById('saudiRevenue') ? document.getElementById('saudiRevenue').textContent : "0";
                                                                const sentHomeText = document.getElementById('saudiSentHome') ? document.getElementById('saudiSentHome').textContent : "0";
                                                                const salariesText = document.getElementById('saudiSalaries') ? document.getElementById('saudiSalaries').textContent : "0";
                                                                const expensesText = document.getElementById('saudiExpenses') ? document.getElementById('saudiExpenses').textContent : "0";

                                                                // CORRECTED: Calculate Total All Expenses and Net Profit for Saudi Dashboard
                                                                const revNum = parseFloat(revenueText.replace(/,/g, '')) || 0;
                                                                const homeNum = parseFloat(sentHomeText.replace(/,/g, '')) || 0;
                                                                const salNum = parseFloat(salariesText.replace(/,/g, '')) || 0;
                                                                const expNum = parseFloat(expensesText.replace(/,/g, '')) || 0;

                                                                const totalAllExpenses = expNum + homeNum + salNum;
                                                                const netProfitNum = revNum - totalAllExpenses;

                                                                const todayGregorian = new Date().toLocaleDateString('en-GB');
                                                                const title = currentJob.name;

                                                                // Create a temporary container for the report (Summary only for Saudi Dashboard view)
                                                                const reportContainer = document.createElement('div');
                                                                reportContainer.style.padding = '20px';
                                                                reportContainer.style.direction = 'rtl';
                                                                reportContainer.style.fontFamily = "'Noto Naskh Arabic', sans-serif";
                                                                reportContainer.style.background = 'white';
                                                                reportContainer.style.color = '#1f2937';

                                                                reportContainer.innerHTML = `
                    <div style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px;">
                        <h1 style="color: #1a365d; margin: 0; font-size: 28px;">${title}</h1>
                        <div style="color: #4a5568; font-size: 14px; margin-top: 8px;">مالي راپور - لنډیز</div>
                        <div style="color: #94a3b8; font-size: 11px;">د چاپ نېټه: ${todayGregorian}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                        <div style="border: 1px solid #cbd5e1; padding: 15px; border-radius: 12px; text-align: center; background: #f0fdf4;">
                            <div style="font-size: 12px; color: #166534; margin-bottom: 5px;">ټول عاید</div>
                            <div style="font-weight: 800; font-size: 18px; color: #15803d;">${revNum.toLocaleString()}</div>
                        </div>
                        <div style="border: 1px solid #cbd5e1; padding: 15px; border-radius: 12px; text-align: center; background: #fef2f2;">
                            <div style="font-size: 12px; color: #991b1b; margin-bottom: 5px;">ټول لګښت</div>
                            <div style="font-weight: 800; font-size: 18px; color: #b91c1c;">${totalAllExpenses.toLocaleString()}</div>
                        </div>
                        <div style="border: 1px solid #cbd5e1; padding: 15px; border-radius: 12px; text-align: center; background: #eff6ff;">
                            <div style="font-size: 12px; color: #1e40af; margin-bottom: 5px;">خالصه ګټه</div>
                            <div style="font-weight: 800; font-size: 18px; color: #1d4ed8;">${netProfitNum.toLocaleString()}</div>
                        </div>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background-color: #f1f5f9; color: #1e293b;">
                                <th style="border: 1px solid #cbd5e1; padding: 12px; text-align: right;">تفصیل</th>
                                <th style="border: 1px solid #cbd5e1; padding: 12px; text-align: right;">اندازه</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border: 1px solid #cbd5e1; padding: 12px;">ټول عاید (Revenue)</td>
                                <td style="border: 1px solid #cbd5e1; padding: 12px; color: #059669; font-weight: bold; text-align: left; direction: ltr;">${revNum.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #cbd5e1; padding: 12px;">کور ته لیږل شوې پیسې</td>
                                <td style="border: 1px solid #cbd5e1; padding: 12px; color: #d97706; font-weight: bold; text-align: left; direction: ltr;">${homeNum.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #cbd5e1; padding: 12px;">ډرېور تنخوا</td>
                                <td style="border: 1px solid #cbd5e1; padding: 12px; color: #7c3aed; font-weight: bold; text-align: left; direction: ltr;">${salNum.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #cbd5e1; padding: 12px;">نور لګښت</td>
                                <td style="border: 1px solid #cbd5e1; padding: 12px; color: #dc2626; font-weight: bold; text-align: left; direction: ltr;">${expNum.toLocaleString()}</td>
                            </tr>
                            <tr style="background-color: #f8fafc;">
                                <td style="border: 1px solid #cbd5e1; padding: 12px; font-weight: bold;">خالصه ګټه (Net Profit)</td>
                                <td style="border: 1px solid #cbd5e1; padding: 12px; color: #1d4ed8; font-weight: bold; text-align: left; direction: ltr;">${netProfitNum.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 50px; font-size: 11px; color: #94a3b8; text-align: center; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                        Sherzad Accounts System | Professional Financial Report
                    </div>
                </div>
                `;

                                                                const opt = {
                                                                        margin: 10,
                                                                        filename: `${currentJob.name}_Summary_${todayGregorian.replace(/\//g, '-')}.pdf`,
                                                                        image: { type: 'jpeg', quality: 0.98 },
                                                                        html2canvas: { scale: 2, useCORS: true },
                                                                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                                                                };

                                                                showToast('info', 'PDF جوړیږي...', 'مهرباني وکړئ انتظار وکړئ');
                                                                html2pdf().set(opt).from(reportContainer).save().then(() => {
                                                                        showToast('success', 'ډاونلوډ شو', 'PDF فایل په بریالیتوب ډاونلوډ شو');
                                                                });
                                                                return;
                                                        }

                                                        // CSV logic for direct dashboard view
                                                        if ((currentJob.id === 'boklyn' || currentJob.id.startsWith('saudi')) && format === 'csv' && !document.getElementById('reportScreen').classList.contains('active')) {
                                                                const revenue = document.getElementById('saudiRevenue') ? document.getElementById('saudiRevenue').textContent : "0";
                                                                const sentHome = document.getElementById('saudiSentHome') ? document.getElementById('saudiSentHome').textContent : "0";
                                                                const salaries = document.getElementById('saudiSalaries') ? document.getElementById('saudiSalaries').textContent : "0";
                                                                const expenses = document.getElementById('saudiExpenses') ? document.getElementById('saudiExpenses').textContent : "0";
                                                                const todayGregorian = new Date().toLocaleDateString('en-GB');

                                                                let csvContent = "data:text/csv;charset=utf-8,Category,Amount\n";
                                                                csvContent += `نېټه,${todayGregorian}\n`;
                                                                csvContent += `عاید,${revenue}\n`;
                                                                csvContent += `لګښت,${expenses}\n`;
                                                                csvContent += `کور ته لیږل شوې پیسې,${sentHome}\n`;
                                                                csvContent += `ډرېور تنخوا,${salaries}\n`;

                                                                const encodedUri = encodeURI(csvContent);
                                                                const link = document.createElement("a");
                                                                link.setAttribute("href", encodedUri);
                                                                link.setAttribute("download", `${currentJob.name}_Summary_${todayGregorian.replace(/\//g, '-')}.csv`);
                                                                document.body.appendChild(link);
                                                                link.click();
                                                                document.body.removeChild(link);
                                                                return;
                                                        }

                                                        // --- COMMON DATA FETCH FOR MOBILE & DEFAULT ---
                                                        const type = document.getElementById('reportType').value;
                                                        let filteredData = [];
                                                        let reportTitle = "";
                                                        let historyKey = 'history_' + currentJob.id;
                                                        let rawData = JSON.parse(localStorage.getItem(historyKey) || '[]');

                                                        if (type === 'daily') {
                                                                const date = document.getElementById('reportDateInput').value;
                                                                if (!date) return showToast('error', 'نیټه وټاکئ');
                                                                filteredData = rawData.filter(item => item.date.replace(/\//g, '-') === date);
                                                                reportTitle = `ورځنی راپور - ${date}`;
                                                        } else if (type === 'monthly') {
                                                                const month = document.getElementById('reportMonthInput').value;
                                                                if (!month) return showToast('error', 'میاشت وټاکئ');
                                                                filteredData = rawData.filter(item => item.date.startsWith(month.replace('-', '/')));
                                                                reportTitle = `میاشتنی راپور - ${month}`;
                                                        } else if (type === 'yearly') {
                                                                const year = document.getElementById('reportYearInput').value;
                                                                if (!year) return showToast('error', 'کال وټاکئ');
                                                                filteredData = rawData.filter(item => item.date.startsWith(year));
                                                                reportTitle = `کلنی راپور - ${year}`;
                                                        } else {
                                                                const date = document.getElementById('reportDateInput').value;
                                                                if (!date) return showToast('error', 'نیټه وټاکئ');
                                                                filteredData = rawData.filter(item => item.date.replace(/\//g, '-') === date);
                                                                reportTitle = `راپور - ${date}`;
                                                        }

                                                        filteredData.sort((a, b) => b.timestamp - a.timestamp);

                                                        if (filteredData.length === 0) {
                                                                return showToast('warning', 'هیڅ معلومات نشته', 'د ټاکل شوې نیټې لپاره معلومات پیدا نشول');
                                                        }

                                                        let totalIncome = filteredData.reduce((sum, item) => sum + parseFloat(item.income || 0), 0);
                                                        let totalExpense = filteredData.reduce((sum, item) => sum + parseFloat(item.expense || 0), 0);
                                                        let totalSentHome = filteredData.reduce((sum, item) => sum + parseFloat(item.sentToHome || item.sentToHomeMobile || 0), 0);
                                                        let totalFifthCol = filteredData.reduce((sum, item) => {
                                                                let val = 0;
                                                                if (currentJob.id === 'mobile') {
                                                                        val = parseFloat(item.shopRent || 0);
                                                                } else {
                                                                        val = parseFloat(item.driverSalary || 0);
                                                                }
                                                                return sum + val;
                                                        }, 0);

                                                        // CORRECTED: Grand Total Expense includes Sent Home + Driver Salary/Rent
                                                        let grandTotalExpense = totalExpense + totalSentHome + totalFifthCol;
                                                        let netBalance = totalIncome - grandTotalExpense;

                                                        const todayGregorian = new Date().toLocaleDateString('en-GB');

                                                        // Determine 5th column header
                                                        let fifthColHeader = 'ډرېور تنخوا';
                                                        if (currentJob.id === 'mobile') {
                                                                fifthColHeader = 'دکان کرایه';
                                                        }

                                                        // --- CSV Export (Updated for Professional Output with BOM) ---
                                                        if (format === 'csv') {
                                                                // Add BOM for proper UTF-8 handling in Excel
                                                                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";

                                                                // Add Metadata section
                                                                csvContent += `د راپور نوم,${currentJob.name} - ${reportTitle}\n`;
                                                                csvContent += `د چاپ نېټه,${todayGregorian}\n`;
                                                                csvContent += `ټول عاید,${totalIncome}\n`;
                                                                csvContent += `ټول لګښت,${grandTotalExpense}\n`;
                                                                csvContent += `خالصه ګټه,${netBalance}\n\n`;

                                                                // Headers
                                                                const fifthCol = currentJob.id === 'mobile' ? 'دکان کرایه' : 'ډرېور تنخوا';
                                                                csvContent += `نېټه,عاید (AFN),لګښت (AFN),کور ته لېږل شوې (AFN),${fifthCol} (AFN),تفصیل,یاداښت\n`;

                                                                filteredData.forEach(item => {
                                                                        let fifth = currentJob.id === 'mobile' ? (item.shopRent || 0) : (item.driverSalary || 0);
                                                                        let rawDetail = item.detail || item.detailMobile || '';
                                                                        let rawNote = item.note || item.noteMobile || '';

                                                                        // Escape special characters for CSV
                                                                        let detail = '"' + rawDetail.replace(/"/g, '""').replace(/\n/g, ' ') + '"';
                                                                        let note = '"' + rawNote.replace(/"/g, '""').replace(/\n/g, ' ') + '"';

                                                                        csvContent += `${item.date},${item.income || 0},${item.expense || 0},${item.sentToHome || item.sentToHomeMobile || 0},${fifth},${detail},${note}\r\n`;
                                                                });

                                                                const encodedUri = encodeURI(csvContent);
                                                                const link = document.createElement("a");
                                                                link.setAttribute("href", encodedUri);
                                                                link.setAttribute("download", `${currentJob.name}_Report_${todayGregorian.replace(/\//g, '-')}.csv`);
                                                                document.body.appendChild(link);
                                                                link.click();
                                                                document.body.removeChild(link);
                                                                return;
                                                        }

                                                        // --- HTML Print/PDF (Updated for Professional Financial Style) ---

                                                        // Create a temporary container for the report
                                                        const reportContainer = document.createElement('div');
                                                        reportContainer.id = 'report-pdf-container';
                                                        reportContainer.style.position = 'absolute';
                                                        reportContainer.style.left = '-9999px';
                                                        reportContainer.style.top = '0';
                                                        reportContainer.style.width = '210mm'; // A4 width
                                                        reportContainer.style.background = 'white';
                                                        reportContainer.style.color = '#1f2937';
                                                        reportContainer.style.padding = '40px'; // Increased padding
                                                        reportContainer.style.direction = 'rtl';
                                                        reportContainer.style.fontFamily = "'Noto Naskh Arabic', sans-serif";

                                                        // Generate Table Rows with improved styling
                                                        let tableRows = filteredData.map((item, index) => {
                                                                let fifthColValue = 0;
                                                                if (currentJob.id === 'mobile') {
                                                                        fifthColValue = parseFloat(item.shopRent || 0);
                                                                } else {
                                                                        fifthColValue = parseFloat(item.driverSalary || 0);
                                                                }

                                                                let detail = item.detail || item.detailMobile || '-';
                                                                let note = item.note || item.noteMobile || '-';

                                                                // Zebra striping with subtle borders
                                                                const bgClass = index % 2 === 0 ? '#f8fafc' : '#ffffff';

                                                                return `
                <tr style="background-color: ${bgClass}; border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 10px 8px; font-size: 11px; color: #334155; border-right: 1px solid #f1f5f9;">${item.date}</td>
                    <td style="padding: 10px 8px; color: #059669; font-weight: 600; font-size: 11px; text-align: left; direction: ltr;">${parseFloat(item.income || 0).toLocaleString()}</td>
                    <td style="padding: 10px 8px; color: #dc2626; font-weight: 600; font-size: 11px; text-align: left; direction: ltr;">${parseFloat(item.expense || 0).toLocaleString()}</td>
                    <td style="padding: 10px 8px; color: #d97706; font-weight: 600; font-size: 11px; text-align: left; direction: ltr;">${parseFloat(item.sentToHome || item.sentToHomeMobile || 0).toLocaleString()}</td>
                    <td style="padding: 10px 8px; color: #7c3aed; font-weight: 600; font-size: 11px; text-align: left; direction: ltr;">${fifthColValue.toLocaleString()}</td>
                    <td style="padding: 10px 8px; font-size: 11px; color: #475569; border-right: 1px solid #f1f5f9;">${detail}</td>
                    <td style="padding: 10px 8px; font-size: 10px; color: #64748b;">${note}</td>
                </tr>
            `
                                                        }).join('');

                                                        // Professional Header & Footer Structure
                                                        reportContainer.innerHTML = `
                <div style="font-family: 'Noto Naskh Arabic', sans-serif; direction: rtl; position: relative;">
                    
                    <!-- Decorative Top Line -->
                    <div style="height: 4px; background: linear-gradient(90deg, #8b5cf6, #3b82f6); width: 100%; margin-bottom: 30px; border-radius: 2px;"></div>

                    <!-- Header Section -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #f1f5f9;">
                        <div style="text-align: right;">
                            <h1 style="color: #1e293b; margin: 0; font-size: 28px; font-weight: 900; letter-spacing: -0.5px;">شېرزاد حسابونه</h1>
                            <div style="color: #64748b; font-size: 12px; margin-top: 5px;">مسلکي مالي مدیریت سیستم</div>
                        </div>
                        <div style="text-align: left;">
                            <div style="color: #1e293b; font-size: 18px; font-weight: 800;">${currentJob.name}</div>
                            <div style="color: #64748b; font-size: 12px; margin-top: 5px;">${reportTitle}</div>
                            <div style="color: #94a3b8; font-size: 10px; margin-top: 2px;">چاپ نېټه: ${todayGregorian}</div>
                        </div>
                    </div>
                    
                    <!-- Financial Summary Cards -->
                    <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                        <div style="flex: 1; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; background: #fff;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">ټول عاید (Income)</div>
                            <div style="color: #15803d; font-weight: 800; font-size: 16px; direction: ltr;">${totalIncome.toLocaleString()}</div>
                        </div>
                        <div style="flex: 1; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; background: #fff;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">ټول لګښت (Expense)</div>
                            <div style="color: #b91c1c; font-weight: 800; font-size: 16px; direction: ltr;">${grandTotalExpense.toLocaleString()}</div>
                        </div>
                        <div style="flex: 1; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; background: #f8fafc;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">خالصه ګټه (Net)</div>
                            <div style="color: #1d4ed8; font-weight: 800; font-size: 16px; direction: ltr;">${netBalance.toLocaleString()}</div>
                        </div>
                    </div>

                    <!-- Main Data Table -->
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                        <thead>
                            <tr style="background-color: #f1f5f9;">
                                <th style="padding: 12px 8px; text-align: right; font-size: 11px; color: #475569; font-weight: 800; border-bottom: 2px solid #e2e8f0;">نېټه</th>
                                <th style="padding: 12px 8px; text-align: left; font-size: 11px; color: #475569; font-weight: 800; border-bottom: 2px solid #e2e8f0;">عاید</th>
                                <th style="padding: 12px 8px; text-align: left; font-size: 11px; color: #475569; font-weight: 800; border-bottom: 2px solid #e2e8f0;">لګښت</th>
                                <th style="padding: 12px 8px; text-align: left; font-size: 11px; color: #475569; font-weight: 800; border-bottom: 2px solid #e2e8f0;">کور ته ورکړل شوې</th>
                                <th style="padding: 12px 8px; text-align: left; font-size: 11px; color: #475569; font-weight: 800; border-bottom: 2px solid #e2e8f0;">${fifthColHeader}</th>
                                <th style="padding: 12px 8px; text-align: right; font-size: 11px; color: #475569; font-weight: 800; border-bottom: 2px solid #e2e8f0;">تفصیل</th>
                                <th style="padding: 12px 8px; text-align: right; font-size: 11px; color: #475569; font-weight: 800; border-bottom: 2px solid #e2e8f0;">یاداښت</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f8fafc; font-weight: bold;">
                                <td style="padding: 12px 8px; border-top: 2px solid #cbd5e1; color: #1e293b;">ټوټل (مجموعه)</td>
                                <td style="padding: 12px 8px; border-top: 2px solid #cbd5e1; color: #059669; text-align: left; direction: ltr;">${totalIncome.toLocaleString()}</td>
                                <td style="padding: 12px 8px; border-top: 2px solid #cbd5e1; color: #dc2626; text-align: left; direction: ltr;">${grandTotalExpense.toLocaleString()}</td>
                                <td style="padding: 12px 8px; border-top: 2px solid #cbd5e1; color: #d97706; text-align: left; direction: ltr;">${totalSentHome.toLocaleString()}</td>
                                <td style="padding: 12px 8px; border-top: 2px solid #cbd5e1; color: #7c3aed; text-align: left; direction: ltr;">${totalFifthCol.toLocaleString()}</td>
                                <td colspan="2" style="border-top: 2px solid #cbd5e1;"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Footer -->
                    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 9px; color: #94a3b8;">Sherzad Accounts System v2.0</div>
                        <div style="font-size: 9px; color: #94a3b8;">Generated by Sherzad Accounts</div>
                    </div>
                </div>
            `;

                                                        document.body.appendChild(reportContainer);

                                                        // PDF Configuration
                                                        const opt = {
                                                                margin: [10, 10, 10, 10],
                                                                filename: `${currentJob.name}_Report_${todayGregorian.replace(/\//g, '-')}.pdf`,
                                                                image: { type: 'jpeg', quality: 0.98 },
                                                                html2canvas: { scale: 2, useCORS: true, logging: false },
                                                                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                                                                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                                                        };

                                                        showToast('info', 'PDF جوړیږي...', 'مهرباني وکړئ انتظار وکړئ (شاید یو څو ثانیې وخت ونیسي)');

                                                        // Generate and Download
                                                        html2pdf().set(opt).from(reportContainer).save().then(() => {
                                                                document.body.removeChild(reportContainer);
                                                                showToast('success', 'ډاونلوډ شو', 'PDF فایل په بریالیتوب ډاونلوډ شو');
                                                        }).catch(err => {
                                                                console.error("PDF Generation Error: ", err);
                                                                if (document.body.contains(reportContainer)) {
                                                                        document.body.removeChild(reportContainer);
                                                                }
                                                                showToast('error', 'تېروتنه', 'د PDF په جوړولو کې ستونزه راغله');
                                                        });
                                                };

                                                // --- NEW ACCOUNT SCREEN LOGIC ---
                                                function openNewAccountScreen() {
                                                        const screen = document.getElementById('newAccountScreen');
                                                        if (screen) {
                                                                screen.classList.remove('hidden');
                                                                // Set default date
                                                                const today = new Date().toISOString().split('T')[0];
                                                                const dateInput = document.getElementById('newAccDate');
                                                                if (dateInput && !dateInput.value) dateInput.value = today;
                                                        }
                                                }

                                                function closeNewAccountScreen() {
                                                        const screen = document.getElementById('newAccountScreen');
                                                        if (screen) screen.classList.add('hidden');
                                                        document.getElementById('jobSelectionScreen').classList.remove('hidden');
                                                        currentJob = null;
                                                }

                                                async function submitNewAccount() {
                                                        const date = document.getElementById('newAccDate').value;
                                                        const points = document.getElementById('newAccPoints').value;
                                                        const desc = document.getElementById('newAccDesc').value;
                                                        const imageInput = document.getElementById('newAccImage');
                                                        const imageFile = imageInput ? imageInput.files[0] : null;
                                                        const btn = document.getElementById('btnSubmitNewAccount');

                                                        if (!date || !points) {
                                                                showToast('error', 'نیمګړتیا', 'مهرباني وکړئ نېټه او پانکونه ډک کړئ');
                                                                return;
                                                        }

                                                        if (btn) {
                                                                btn.disabled = true;
                                                                btn.textContent = 'ذخیره کیږی...';
                                                        }

                                                        try {
                                                                let imageBase64 = "";
                                                                if (imageFile) {
                                                                        imageBase64 = await new Promise((resolve, reject) => {
                                                                                const reader = new FileReader();
                                                                                reader.onload = () => resolve(reader.result.split(',')[1]);
                                                                                reader.onerror = error => reject(error);
                                                                                reader.readAsDataURL(imageFile);
                                                                        });
                                                                }

                                                                const payload = {
                                                                        date: date,
                                                                        points: points,
                                                                        description: desc,
                                                                        image: imageBase64,
                                                                        imageName: imageFile ? imageFile.name : "",
                                                                        imageType: imageFile ? imageFile.type : ""
                                                                };

                                                                // Construct URL with action
                                                                const urlObj = new URL(GOOGLE_SHEETS_URL);
                                                                urlObj.searchParams.append('action', 'createNewAccount');

                                                                const response = await fetch(urlObj.toString(), {
                                                                        method: 'POST',
                                                                        body: JSON.stringify(payload)
                                                                });

                                                                try {
                                                                        const result = await response.json();
                                                                        if (result.status === 'success' || result.result === 'success') {
                                                                                showToast('success', 'بریا', 'اکاونټ په بریالیتوب سره ثبت شو');
                                                                        } else {
                                                                                showToast('success', 'لیږل شو', 'معلومات واستول شول');
                                                                        }
                                                                } catch (e) {
                                                                        showToast('success', 'لیږل شو', 'معلومات واستول شول');
                                                                }

                                                                closeNewAccountScreen();
                                                                // Reset form
                                                                document.getElementById('newAccDate').value = '';
                                                                document.getElementById('newAccPoints').value = '';
                                                                document.getElementById('newAccDesc').value = '';
                                                                if (imageInput) imageInput.value = '';

                                                        } catch (error) {
                                                                console.error('Error submitting account:', error);
                                                                // Fallback for demo
                                                                showToast('success', 'لیږل شو (آفلاین)', 'معلومات ثبت شول');
                                                                closeNewAccountScreen();
                                                        } finally {
                                                                if (btn) {
                                                                        btn.disabled = false;
                                                                        btn.textContent = '✓ ذخیره کول';
                                                                }
                                                        }
                                                }

                                                // --- PROFESSIONAL REPORT DOWNLOAD SYSTEM (Fixed) ---
                                                window.downloadReport = function(format) {
                                                        const menu = document.getElementById('downloadMenu');
                                                        if (menu) menu.classList.add('hidden');

                                                        // --- DATA FETCHING & FILTERING ---
                                                        const type = document.getElementById('reportType').value;
                                                        let filteredData = [];
                                                        let reportTitle = "";
                                                        let historyKey = 'history_' + currentJob.id;
                                                        let rawData = JSON.parse(localStorage.getItem(historyKey) || '[]');

                                                        // Check if we are on dashboard (report screen not active)
                                                        // If so, we default to today or all data to avoid errors
                                                        const isDashboard = !document.getElementById('reportScreen').classList.contains('active');

                                                        if (isDashboard) {
                                                                // FIX: On dashboard, download ALL data by default to avoid "No Data" error for specific dates
                                                                filteredData = rawData;
                                                                reportTitle = `ټولیز راپور`;
                                                        } else {
                                                                // Report Menu Active - Strict Filtering
                                                                if (type === 'daily') {
                                                                        const date = document.getElementById('reportDateInput').value;
                                                                        if (!date) return showToast('error', 'نیټه وټاکئ');
                                                                        filteredData = rawData.filter(item => item.date.replace(/\//g, '-') === date);
                                                                        reportTitle = `ورځنی راپور - ${date}`;
                                                                } else if (type === 'monthly') {
                                                                        const month = document.getElementById('reportMonthInput').value;
                                                                        if (!month) return showToast('error', 'میاشت وټاکئ');
                                                                        filteredData = rawData.filter(item => item.date.startsWith(month.replace('-', '/')));
                                                                        reportTitle = `میاشتنی راپور - ${month}`;
                                                                } else if (type === 'yearly') {
                                                                        const year = document.getElementById('reportYearInput').value;
                                                                        if (!year) return showToast('error', 'کال وټاکئ');
                                                                        filteredData = rawData.filter(item => item.date.startsWith(year));
                                                                        reportTitle = `کلنی راپور - ${year}`;
                                                                } else {
                                                                        const date = document.getElementById('reportDateInput').value;
                                                                        if (date) {
                                                                                filteredData = rawData.filter(item => item.date.replace(/\//g, '-') === date);
                                                                                reportTitle = `راپور - ${date}`;
                                                                        } else {
                                                                                if (!date && type !== 'custom') return showToast('error', 'نیټه وټاکئ');
                                                                                if (date) {
                                                                                        filteredData = rawData.filter(item => item.date.replace(/\//g, '-') === date);
                                                                                        reportTitle = `راپور - ${date}`;
                                                                                } else {
                                                                                        // Custom with no date = All Data
                                                                                        filteredData = rawData;
                                                                                        reportTitle = `ټولیز راپور`;
                                                                                }
                                                                        }
                                                                }
                                                        }

                                                        filteredData.sort((a, b) => b.timestamp - a.timestamp);

                                                        if (filteredData.length === 0) {
                                                                return showToast('warning', 'هیڅ معلومات نشته', 'د ټاکل شوې نیټې لپاره معلومات پیدا نشول');
                                                        }

                                                        // Calculations
                                                        let totalIncome = filteredData.reduce((sum, item) => sum + parseFloat(item.income || 0), 0);
                                                        let totalExpense = filteredData.reduce((sum, item) => sum + parseFloat(item.expense || 0), 0);
                                                        let totalSentHome = filteredData.reduce((sum, item) => sum + parseFloat(item.sentToHome || item.sentToHomeMobile || 0), 0);

                                                        let totalFifthCol = filteredData.reduce((sum, item) => {
                                                                let val = 0;
                                                                if (currentJob.id === 'mobile') {
                                                                        val = parseFloat(item.shopRent || 0);
                                                                } else {
                                                                        val = parseFloat(item.driverSalary || 0);
                                                                }
                                                                return sum + val;
                                                        }, 0);

                                                        let grandTotalExpense = totalExpense + totalSentHome + totalFifthCol;
                                                        let netBalance = totalIncome - grandTotalExpense;
                                                        const todayGregorian = new Date().toLocaleDateString('en-GB');

                                                        let fifthColHeader = 'ډرېور تنخوا';
                                                        if (currentJob.id === 'mobile') {
                                                                fifthColHeader = 'دکان کرایه';
                                                        }

                                                        // --- CSV EXPORT (Fixed for Google Sheets & Excel) ---
                                                        if (format === 'csv') {
                                                                // Add UTF-8 BOM for correct characters in all apps
                                                                let csvContent = "\uFEFF";

                                                                // Utility to handle CSV values correctly
                                                                const clean = (val) => {
                                                                        if (val === undefined || val === null) return '""';
                                                                        let s = val.toString().replace(/"/g, '""');
                                                                        return `"${s}"`;
                                                                };

                                                                // Metadata Summary
                                                                csvContent += `${clean('راپور')},${clean(currentJob.name + " - " + reportTitle)}\n`;
                                                                csvContent += `${clean('نېټه')},${clean(todayGregorian)}\n`;
                                                                csvContent += `${clean('عاید')},${clean(totalIncome)}\n`;
                                                                csvContent += `${clean('لګښت')},${clean(grandTotalExpense)}\n`;
                                                                csvContent += `${clean('ګټه')},${clean(netBalance)}\n\n`;

                                                                // Headers
                                                                const fifthCol = currentJob.id === 'mobile' ? 'دکان کرایه' : 'ډرېور تنخوا';
                                                                csvContent += `${clean('نېټه')},${clean('عاید')},${clean('لګښت')},${clean('کور')},${clean(fifthCol)},${clean('تفصیل')},${clean('یاداښت')}\n`;

                                                                filteredData.forEach(item => {
                                                                        let fifthValue = currentJob.id === 'mobile' ? (item.shopRent || 0) : (item.driverSalary || 0);
                                                                        let income = item.income || 0;
                                                                        let expense = item.expense || 0;
                                                                        let sentHome = item.sentToHome || item.sentToHomeMobile || 0;
                                                                        let rawDetail = item.detail || item.detailMobile || '-';
                                                                        let rawNote = item.note || item.noteMobile || '-';

                                                                        csvContent += `${clean(item.date)},${clean(income)},${clean(expense)},${clean(sentHome)},${clean(fifthValue)},${clean(rawDetail)},${clean(rawNote)}\n`;
                                                                });

                                                                // Footer
                                                                csvContent += `${clean('مجموعه')},${clean(totalIncome)},${clean(totalExpense)},${clean(totalSentHome)},${clean(totalFifthCol)},${clean('')},${clean('')}\n`;

                                                                // Use Blob for better compatibility with mobile apps and Google Sheets
                                                                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                                                                const url = URL.createObjectURL(blob);
                                                                const link = document.createElement("a");
                                                                link.setAttribute("href", url);
                                                                link.setAttribute("download", `${currentJob.name}_Report_${todayGregorian.replace(/\//g, '-')}.csv`);
                                                                document.body.appendChild(link);
                                                                link.click();
                                                                document.body.removeChild(link);
                                                                return;
                                                        }

                                                        // PDF GENERATION
                                                        const reportContainer = document.createElement('div');
                                                        reportContainer.style.width = '210mm';
                                                        reportContainer.style.background = '#ffffff';
                                                        reportContainer.style.color = '#000000';
                                                        reportContainer.style.padding = '10mm'; // Reduced padding to allow more content
                                                        reportContainer.style.boxSizing = 'border-box';
                                                        reportContainer.style.direction = 'rtl';
                                                        reportContainer.style.fontFamily = "'Noto Naskh Arabic', sans-serif";

                                                        const bgEven = '#f8fafc';
                                                        const bgOdd = '#ffffff';

                                                        let tableRows = filteredData.map((item, index) => {
                                                                let fifthColValue = currentJob.id === 'mobile' ? parseFloat(item.shopRent || 0) : parseFloat(item.driverSalary || 0);
                                                                let detail = item.detail || item.detailMobile || '-';
                                                                let note = item.note || item.noteMobile || '-';
                                                                const bgClass = index % 2 === 0 ? bgEven : bgOdd;

                                                                return `
                <tr style="background-color: ${bgClass}; border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 6px; font-size: 10px; border-right: 1px solid #e2e8f0; width: 10%;">${item.date}</td>
                    <td style="padding: 6px; font-size: 10px; color: #166534; direction: ltr; text-align: left; width: 12%; font-weight: bold;">${parseFloat(item.income || 0).toLocaleString()}</td>
                    <td style="padding: 6px; font-size: 10px; color: #991b1b; direction: ltr; text-align: left; width: 12%; font-weight: bold;">${parseFloat(item.expense || 0).toLocaleString()}</td>
                    <td style="padding: 6px; font-size: 10px; color: #b45309; direction: ltr; text-align: left; width: 12%;">${parseFloat(item.sentToHome || item.sentToHomeMobile || 0).toLocaleString()}</td>
                    <td style="padding: 6px; font-size: 10px; color: #6d28d9; direction: ltr; text-align: left; width: 12%;">${fifthColValue.toLocaleString()}</td>
                    <td style="padding: 6px; font-size: 10px; border-right: 1px solid #e2e8f0; width: 22%;">${detail}</td>
                    <td style="padding: 6px; font-size: 9px; color: #64748b; width: 20%;">${note}</td>
                </tr>
            `
                                                        }).join('');

                                                        reportContainer.innerHTML = `
                <div style="width: 100%; font-family: 'Noto Naskh Arabic', sans-serif;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 3px solid #3b82f6; padding-bottom: 15px;">
                        <h1 style="margin: 0; font-size: 26px; color: #1e3a8a; font-family: 'Noto Naskh Arabic', sans-serif; font-weight: bold; line-height: 1.8; letter-spacing: 0; word-spacing: 2px;">شېرزاد حسابونه</h1>
                        <h2 style="margin: 5px 0; font-size: 18px; color: #334155; font-family: 'Noto Naskh Arabic', sans-serif; font-weight: bold; line-height: 1.8; letter-spacing: 0; word-spacing: 1px;">${currentJob.name} - ${reportTitle}</h2>
                        <p style="margin: 0; font-size: 10px; color: #94a3b8; font-family: 'Noto Naskh Arabic', sans-serif;">چاپ نېټه: ${todayGregorian}</p>
                    </div>

                    <!-- Summary Cards -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; gap: 10px;">
                        <div style="flex: 1; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 10px; color: #166534;">عاید</div>
                            <div style="font-size: 14px; font-weight: bold; color: #15803d; direction: ltr;">${totalIncome.toLocaleString()}</div>
                        </div>
                        <div style="flex: 1; background: #fef2f2; border: 1px solid #fecaca; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 10px; color: #991b1b;">لګښت</div>
                            <div style="font-size: 14px; font-weight: bold; color: #b91c1c; direction: ltr;">${grandTotalExpense.toLocaleString()}</div>
                        </div>
                        <div style="flex: 1; background: #eff6ff; border: 1px solid #bfdbfe; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 10px; color: #1e40af;">خالصه ګټه</div>
                            <div style="font-size: 14px; font-weight: bold; color: #1d4ed8; direction: ltr;">${netBalance.toLocaleString()}</div>
                        </div>
                    </div>

                    <!-- Table -->
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #e2e8f0;">
                        <thead>
                            <tr style="background-color: #f1f5f9; border-bottom: 2px solid #cbd5e1;">
                                <th style="padding: 8px; font-size: 11px; text-align: right; color: #334155;">نېټه</th>
                                <th style="padding: 8px; font-size: 11px; text-align: left; color: #334155;">عاید</th>
                                <th style="padding: 8px; font-size: 11px; text-align: left; color: #334155;">لګښت</th>
                                <th style="padding: 8px; font-size: 11px; text-align: left; color: #334155;">کور لګښت</th>
                                <th style="padding: 8px; font-size: 11px; text-align: left; color: #334155;">${fifthColHeader}</th>
                                <th style="padding: 8px; font-size: 11px; text-align: right; color: #334155;">تفصیل</th>
                                <th style="padding: 8px; font-size: 11px; text-align: right; color: #334155;">یاداښت</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #e2e8f0; font-weight: bold;">
                                <td style="padding: 8px; font-size: 11px;">مجموعه</td>
                                <td style="padding: 8px; font-size: 11px; direction: ltr; text-align: left;">${totalIncome.toLocaleString()}</td>
                                <td style="padding: 8px; font-size: 11px; direction: ltr; text-align: left;">${totalExpense.toLocaleString()}</td>
                                <td style="padding: 8px; font-size: 11px; direction: ltr; text-align: left;">${totalSentHome.toLocaleString()}</td>
                                <td style="padding: 8px; font-size: 11px; direction: ltr; text-align: left;">${totalFifthCol.toLocaleString()}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 15px; margin-bottom: 10px;">
                        Sherzad Accounts System | Professional Report
                    </div>
                </div>
            `;

                                                        const opt = {
                                                                margin: 0, // Margin is handled by reportContainer padding
                                                                filename: `${currentJob.name}_Report_${todayGregorian.replace(/\//g, '-')}.pdf`,
                                                                image: { type: 'jpeg', quality: 0.98 },
                                                                html2canvas: { scale: 2, useCORS: true, logging: false },
                                                                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                                                        };

                                                        showToast('info', 'PDF جوړیږي...', 'مهرباني وکړئ انتظار وکړئ');
                                                        html2pdf().set(opt).from(reportContainer).save().then(() => {
                                                                showToast('success', 'ډاونلوډ شو', 'PDF فایل په بریالیتوب ډاونلوډ شو');
                                                        });
                                                };
                                        </script>
</body>

</html>
