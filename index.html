<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá - Premium Edition">
    <title>ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá</title>

    <!-- Favicon for browser tab - Icon file -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- iOS home screen icon - PNG file -->
    <link rel="apple-touch-icon" href="favicon.png">

    <!-- iOS web app configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QR Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: 'Inter', 'Noto Naskh Arabic', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0a0515 0%, #020203 40%, #030712 100%);
            color: #f8fafc;
            direction: rtl;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0;
            position: relative;
            min-height: 100vh;
            overflow: auto;
        }

        @media (min-width: 768px) {
            body {
                align-items: center;
            }
        }

        .bg-orbs {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: float-orb 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            top: -200px;
            right: -200px;
            animation-duration: 20s;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #ec4899, #f59e0b);
            bottom: -150px;
            left: -150px;
            animation-duration: 25s;
            animation-delay: -5s;
        }

        .orb-3 {
            width: 350px;
            height: 350px;
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
            top: 50%;
            right: 10%;
            animation-duration: 30s;
            animation-delay: -10s;
        }

        @keyframes float-orb {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(30px, -40px); }
            50% { transform: translate(-20px, 30px); }
            75% { transform: translate(40px, 20px); }
        }

        .glass {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04));
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
        }

        .glass::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05), transparent);
            pointer-events: none;
        }

        .glass-card {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 0 80px rgba(139, 92, 246, 0.1);
            position: relative;
            z-index: 1;
            padding: 14px 20px 24px 20px;
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            .glass-card {
                padding: 10px 14px 16px 14px;
            }
        }

        @media (min-width: 1024px) {
            .glass-card {
                padding: 40px;
            }
        }

        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-40px); filter: blur(20px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes modalPop {
            0% { opacity: 0; transform: scale(0.7) translateY(40px) rotateX(15deg); filter: blur(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0) rotateX(0); filter: blur(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes pulseIcon {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 15px 40px rgba(245, 158, 11, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 20px 50px rgba(245, 158, 11, 0.7);
            }
        }

        @keyframes floatLogo {
            0%, 100% { 
                transform: translateY(0) rotateZ(0deg);
                box-shadow: 0 20px 50px rgba(139, 92, 246, 0.5);
            }
            50% { 
                transform: translateY(-10px) rotateZ(2deg);
                box-shadow: 0 25px 60px rgba(139, 92, 246, 0.7);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .container {
            width: 100%;
            max-width: 750px;
            padding: 10px 16px 16px 16px;
            z-index: 10;
            animation: slideInDown 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            max-height: calc(100vh - 10px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        @media (min-width: 768px) {
            .container {
                padding: 10px 16px 16px 16px;
                max-height: calc(100vh - 10px);
                overflow-y: auto;
                overflow-x: hidden;
            }
        }

        @media (min-width: 768px) and (max-height: 900px) {
            .container {
                padding: 10px 16px 16px 16px;
                max-height: calc(100vh - 10px);
                overflow-y: auto;
                overflow-x: hidden;
            }
        }

        @media (min-width: 1024px) and (min-height: 900px) {
            .container {
                padding: 30px 50px;
                max-height: none;
                overflow-y: visible;
            }
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 50%, #ec4899 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 900;
            color: white;
            box-shadow: 0 20px 50px rgba(139, 92, 246, 0.5), inset -1px -1px 30px rgba(255, 255, 255, 0.3), inset 1px 1px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            animation: floatLogo 4s ease-in-out infinite;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            .logo {
                width: 60px;
                height: 60px;
                font-size: 28px;
                border-radius: 12px;
            }
        }

        @media (min-width: 1024px) {
            .logo {
                width: 100px;
                height: 100px;
                font-size: 48px;
                border-radius: 20px;
            }
        }

        .btn-close-fancy {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-close-fancy:hover {
            background: rgba(239, 68, 68, 0.8);
            border-color: rgba(239, 68, 68, 1);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }

        .logo::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
            animation: shine 3s infinite;
            z-index: 2;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        @media (min-width: 768px) {
            .header {
                gap: 12px;
                margin-bottom: 12px;
            }
        }

        @media (min-width: 1024px) {
            .header {
                gap: 20px;
                margin-bottom: 28px;
            }
        }

        h1 {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(to left, #c084fc, #60a5fa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            line-height: 1.1;
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            h1 {
                font-size: 18px;
            }
        }

        @media (min-width: 1024px) {
            h1 {
                font-size: 32px;
            }
        }

        .subtitle {
            color: #7dd3fc;
            font-size: 11px;
            margin-top: 2px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            .subtitle {
                font-size: 9px;
                margin-top: 0px;
            }
        }

        @media (min-width: 1024px) {
            .subtitle {
                font-size: 13px;
                margin-top: 8px;
            }
        }

        #jobSelectionScreen {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 21, 0.98);
            backdrop-filter: blur(30px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }

        #jobSelectionScreen.hidden {
            display: none;
        }

        .job-selection-card {
            max-width: 550px;
            width: 100%;
            animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .job-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .job-header h2 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(to left, #c084fc, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .job-header-subtitle {
            color: #7dd3fc;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .job-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        @media (min-width: 768px) {
            .job-grid {
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }
        }

        .job-card {
            padding: 20px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(59, 130, 246, 0.06));
            border: 2px solid rgba(139, 92, 246, 0.25);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: right;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @media (min-width: 768px) {
            .job-card {
                padding: 24px;
                border-radius: 18px;
                gap: 12px;
            }
        }

        .job-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05), transparent);
            pointer-events: none;
        }

        .job-card:hover {
            border-color: rgba(139, 92, 246, 0.6);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.12));
            box-shadow: 0 15px 40px rgba(139, 92, 246, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-6px);
        }

        .job-card:active {
            transform: translateY(-2px);
        }

        .job-icon {
            font-size: 28px;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
        }

        @media (min-width: 768px) {
            .job-icon {
                font-size: 32px;
            }
        }

        .job-card:nth-child(1) .job-icon { animation-delay: 0s; }
        .job-card:nth-child(2) .job-icon { animation-delay: 0.2s; }
        .job-card:nth-child(3) .job-icon { animation-delay: 0.4s; }
        .job-card:nth-child(4) .job-icon { animation-delay: 0.6s; }

        .job-name {
            font-size: 16px;
            font-weight: 800;
            background: linear-gradient(to left, #c084fc, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        @media (min-width: 768px) {
            .job-name {
                font-size: 18px;
            }
        }

        .job-desc {
            font-size: 12px;
            color: #a78bfa;
            font-weight: 500;
            opacity: 0.9;
        }

        @media (min-width: 768px) {
            .job-desc {
                font-size: 13px;
            }
        }

        /* Style for trailer images */
        .job-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 12px;
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .job-card:nth-child(1) .job-image { animation-delay: 0s; }
        .job-card:nth-child(2) .job-image { animation-delay: 0.2s; }

        .job-image-error {
            display: none;
            font-size: 48px;
        }

        #saudiSubAccountScreen {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 21, 0.98);
            backdrop-filter: blur(30px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }

        #saudiSubAccountScreen.hidden {
            display: none;
        }

        /* Home Sub-Account Screen Styles */
        #homeSubAccountScreen {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 21, 0.98);
            backdrop-filter: blur(30px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }

        #homeSubAccountScreen.hidden {
            display: none;
        }

        /* Home sub-account card styles with different gradients */
        .home-card-lalak {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(34, 211, 238, 0.08)) !important;
            border-color: rgba(6, 182, 212, 0.35) !important;
        }
        .home-card-lalak:hover {
            border-color: rgba(6, 182, 212, 0.7) !important;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.25), rgba(34, 211, 238, 0.15)) !important;
            box-shadow: 0 15px 40px rgba(6, 182, 212, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }
        .home-card-lalak .job-name {
            background: linear-gradient(to left, #22d3ee, #06b6d4) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        .home-card-saifullah {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(192, 132, 252, 0.08)) !important;
            border-color: rgba(168, 85, 247, 0.35) !important;
        }
        .home-card-saifullah:hover {
            border-color: rgba(168, 85, 247, 0.7) !important;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.25), rgba(192, 132, 252, 0.15)) !important;
            box-shadow: 0 15px 40px rgba(168, 85, 247, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }
        .home-card-saifullah .job-name {
            background: linear-gradient(to left, #c084fc, #a855f7) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        .home-card-saeedullah {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.08)) !important;
            border-color: rgba(59, 130, 246, 0.35) !important;
        }
        .home-card-saeedullah:hover {
            border-color: rgba(59, 130, 246, 0.7) !important;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(96, 165, 250, 0.15)) !important;
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }
        .home-card-saeedullah .job-name {
            background: linear-gradient(to left, #60a5fa, #3b82f6) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        .home-card-siddiqullah {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(244, 114, 182, 0.08)) !important;
            border-color: rgba(236, 72, 153, 0.35) !important;
        }
        .home-card-siddiqullah:hover {
            border-color: rgba(236, 72, 153, 0.7) !important;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.25), rgba(244, 114, 182, 0.15)) !important;
            box-shadow: 0 15px 40px rgba(236, 72, 153, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }
        .home-card-siddiqullah .job-name {
            background: linear-gradient(to left, #f472b6, #ec4899) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        #passwordScreen {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 21, 0.98);
            backdrop-filter: blur(30px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }

        #passwordScreen.hidden {
            display: none;
        }

        .password-card {
            max-width: 500px;
            width: 100%;
            animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .password-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 28px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .lock-icon {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 15px 40px rgba(245, 158, 11, 0.5);
            animation: pulseIcon 2s ease-in-out infinite;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .lock-icon {
                width: 80px;
                height: 80px;
                font-size: 42px;
            }
        }

        .password-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(to left, #c084fc, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .password-subtitle {
            color: #7dd3fc;
            font-size: 13px;
            margin-top: 8px;
            font-weight: 600;
        }

        .password-input-group {
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        .password-input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #c084fc;
            text-transform: uppercase;
        }

        .password-input {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-family: inherit;
            transition: all 0.3s ease;
            text-align: center;
            letter-spacing: 2px;
        }

        .password-input:focus {
            outline: none;
            border-color: #a855f7;
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
            transform: translateY(-2px);
        }

        .password-error {
            color: #ef4444;
            font-size: 13px;
            margin-top: 10px;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
            padding: 8px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .password-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            animation: fadeInUp 0.8s ease-out 0.6s both;
        }

        .password-button {
            flex: 1;
            padding: 16px;
            border-radius: 16px;
            border: none;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .password-button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: white;
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        .btn-primary:hover {
            box-shadow: 0 15px 40px rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }

        .form-grid {
            display: grid;
            gap: 16px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #c084fc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            background: rgba(10, 5, 21, 0.6);
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 14px;
            color: #f8fafc;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #a855f7;
            background: rgba(10, 5, 21, 0.8);
            box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .hint {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .error-message {
            font-size: 11px;
            color: #ef4444;
            margin-top: 6px;
            display: none;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            padding: 6px 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
        }

        .error-message.show {
            display: flex;
            animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: white;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
            font-family: inherit;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(139, 92, 246, 0.5);
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn-wrapper {
            margin-top: 10px;
            display: flex;
            gap: 12px;
        }

        .btn-secondary {
            padding: 16px;
            border-radius: 16px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }

        /* NEW STYLES FOR BALANCE */
        .balance-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.8s ease-out 0.3s both;
            display: none; /* Hidden by default */
        }

        .balance-label {
            font-size: 12px;
            color: #6ee7b7;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .balance-value {
            font-size: 32px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .balance-currency {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            font-weight: 500;
            margin-top: 8px;
        }

        .balance-edit-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: none; /* Only for admin */
        }

        .balance-edit-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 21, 0.95);
            backdrop-filter: blur(25px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            max-width: 550px;
            width: 100%;
            animation: modalPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .modal-icon {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(to left, #6ee7b7, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-subtitle {
            color: #7dd3fc;
            font-size: 12px;
            margin-top: 6px;
            font-weight: 600;
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .data-row {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-row-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 400px) {
            .data-row-grid {
                grid-template-columns: 1fr;
            }
        }

        .data-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .data-label {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
        }

        .data-value {
            font-size: 15px;
            color: #f1f5f9;
            font-weight: 700;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .btn-success {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 18px 40px rgba(16, 185, 129, 0.5);
        }

        .btn-success:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .last-save-section {
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.05));
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
        }

        .last-save-title {
            font-size: 13px;
            font-weight: 700;
            color: #fbbf24;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 14px;
            z-index: 10001;
            transform: translateX(120%);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 350px;
            backdrop-filter: blur(20px);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
            border: 1px solid rgba(52, 211, 153, 0.5);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
        }

        .toast.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
            border: 1px solid rgba(248, 113, 113, 0.5);
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.4);
        }

        .toast.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
            border: 1px solid rgba(251, 191, 36, 0.5);
            box-shadow: 0 15px 40px rgba(245, 158, 11, 0.4);
        }

        .toast-title {
            font-size: 14px;
            font-weight: 800;
            color: white;
            margin-bottom: 4px;
        }

        .toast-description {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .back-button-container {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 10;
        }

        @media (max-width: 767px) {
            .back-button-container {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 16px;
            }
        }

        @media (min-width: 768px) {
            .back-button-container {
                top: 16px;
            }
        }

        /* CATEGORY ICONS STYLES */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        @media (max-width: 480px) {
            .category-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .category-btn {
            background: rgba(10, 5, 21, 0.6);
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #f8fafc;
            font-family: inherit;
        }

        .category-btn:hover {
            border-color: #a855f7;
            background: rgba(139, 92, 246, 0.1);
            transform: translateY(-2px);
        }

        .category-btn.active {
            border-color: #a855f7;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.2));
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .category-btn-icon {
            font-size: 24px;
        }

        .category-btn-label {
            font-size: 11px;
            font-weight: 600;
        }

        #customCategoryInput {
            margin-top: 12px;
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }

        /* Checkbox for Document Mode */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-wrapper:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #8b5cf6;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 13px;
            color: #e2e8f0;
            font-weight: 600;
            cursor: pointer;
        }

        .camera-options-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 12px;
            justify-content: center;
        }

        .camera-option-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #ccc;
            font-size: 12px;
            cursor: pointer;
        }

        .camera-option-toggle input {
            width: 16px;
            height: 16px;
            accent-color: #8b5cf6;
            margin: 0;
            cursor: pointer;
            padding: 0; /* Override global input padding */
        }

        /* Override global input styles for these checkboxes */
        .camera-option-toggle input[type="checkbox"] {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        /* Camera Modal Styles */
        #cameraModal {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 20000;
            display: none;
            flex-direction: column;
        }

        #cameraView {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            pointer-events: none;
        }

        .camera-controls-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: auto;
        }

        .camera-controls-bottom {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            pointer-events: auto;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding-bottom: 20px;
        }

        .camera-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        .shutter-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255,255,255,0.5);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .shutter-btn:active {
            transform: scale(0.9);
        }

        .camera-mode-selector {
            display: flex;
            gap: 20px;
            background: rgba(0,0,0,0.5);
            padding: 8px 16px;
            border-radius: 20px;
            margin-bottom: 10px;
        }

        .camera-mode {
            color: #ccc;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
        }

        .camera-mode.active {
            color: #fbbf24; /* Warning yellow */
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        #qr-reader {
            width: 100%;
            height: 100%;
            display: none;
        }

        /* Loading Overlay for OCR */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 20001;
            color: white;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* DASHBOARD STYLES */
        @media (min-width: 768px) {
            .dashboard-container {
                flex-direction: row !important;
            }
            .dashboard-sidebar {
                width: 280px;
                border-left: 1px solid rgba(255,255,255,0.1);
                border-bottom: none;
                height: 100vh;
            }
        }

        @media (max-width: 767px) {
            .dashboard-sidebar {
                width: 100%;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                border-left: none;
                flex-direction: row !important;
                align-items: center;
                justify-content: space-between;
                padding: 10px 16px !important;
                gap: 10px !important;
            }
            .nav-menu {
                display: none !important; /* Hide menu items on mobile for simplicity or use hamburger */
            }
        }

        .saudi-asset-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .saudi-asset-row:last-child {
            border-bottom: none;
        }

        /* Ensure default hidden state */
        .hidden { display: none !important; }

        .saudi-asset-row {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(59, 130, 246, 0.03));
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
</style>
</head>
<body>
    <div class="bg-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- Main Job Selection Screen -->
    <div id="jobSelectionScreen">
        <div class="glass-card job-selection-card">
            <div class="job-header">
                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                <div>
                    <h2>Ÿàÿ±⁄ÅŸÜŸä ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá</h2>
                    <p class="job-header-subtitle">ÿ≠ÿ≥ÿßÿ® ÿßŸÜÿ™ÿÆÿßÿ® ⁄©⁄ìÿ¶</p>
                </div>
            </div>

            <div class="job-grid" id="jobGrid"></div>

            <div style="margin-top: 25px; border-top: none; padding-top: 20px;">
                <button onclick="openGeneralDashboardAuth()" style="width: 100%; padding: 14px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: #94a3b8; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    üìä ÿπŸÖŸàŸÖŸä ŸÖÿßŸÑŸä ⁄âÿ¥ÿ®Ÿàÿ±⁄â
                </button>
            </div>
        </div>
    </div>

    <!-- General Dashboard Screen -->
    <div id="generalDashboardScreen" class="hidden" style="position: fixed; inset: 0; background: rgba(10, 5, 21, 0.98); backdrop-filter: blur(30px); display: flex; align-items: flex-start; justify-content: center; z-index: 9999; padding: 60px 10px 20px 10px; overflow: auto;">
        <div class="glass-card job-selection-card" style="max-width: 1400px; width: 98%; max-height: 98vh; height: auto; overflow-y: auto; display: flex; flex-direction: column; padding: 20px;">
             <button type="button" onclick="closeGeneralDashboard()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>

            <div class="job-header" style="flex-direction: row; margin-bottom: 25px; gap: 20px; flex-shrink: 0; align-items: center; padding-top: 20px;">
                <div class="logo" style="width: 100px; height: 100px; font-size: 40px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.1);"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 20px;"></div>
                <div style="text-align: right;">
                    <h2 style="font-size: 28px; margin-bottom: 5px;">ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá</h2>
                    <p class="job-header-subtitle" style="font-size: 16px;">ÿπŸÖŸàŸÖŸä ŸÖÿßŸÑŸä ⁄âÿ¥ÿ®Ÿàÿ±⁄â</p>
                </div>
            </div>

            <div class="job-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; flex-grow: 1; align-content: start; padding-bottom: 20px;">

                <!-- COLUMN 1: Assets & Income (Left/Top in Mobile) -->
                <div style="display: flex; flex-direction: column; gap: 16px; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 20px; border: 1px solid rgba(16, 185, 129, 0.1);">
                    <h3 style="color: #6ee7b7; font-size: 18px; margin-bottom: 5px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                        <span>ÿπÿß€åÿØ ÿßŸà ÿ≥ÿ±ŸÖÿß€åŸá</span>
                        <span style="font-size: 20px;">üí∞</span>
                    </h3>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div class="job-icon" style="font-size: 28px;">üèõÔ∏è</div>
                        <div class="job-name" style="font-size: 14px; color: #94a3b8;">ŸºŸàŸÑŸá ŸæÿßŸÜ⁄´Ÿá</div>
                        <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #6ee7b7;"><span id="dashTotalCapital">0</span> <span style="font-size: 12px; font-weight: 400;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div class="job-icon" style="font-size: 28px;">üíµ</div>
                        <div class="job-name" style="font-size: 14px; color: #94a3b8;">ŸºŸàŸÑ ÿπÿß€åÿØ</div>
                        <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #6ee7b7;"><span id="dashTotalIncome">0</span> <span style="font-size: 12px; font-weight: 400;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div class="job-icon" style="font-size: 28px;">üìà</div>
                        <div class="job-name" style="font-size: 14px; color: #94a3b8;">ÿÆÿßŸÑÿµŸá ⁄´ŸºŸá</div>
                        <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #6ee7b7;"><span id="dashNetProfit">0</span> <span style="font-size: 12px; font-weight: 400;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div class="job-icon" style="font-size: 28px;">üí∞</div>
                        <div class="job-name" style="font-size: 14px; color: #94a3b8;">ÿÆÿßŸÑÿµŸá Ÿæÿßÿ™€å Ÿæ€åÿ≥€ê</div>
                        <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #6ee7b7;"><span id="dashNetRemaining">0</span> <span style="font-size: 12px; font-weight: 400;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                </div>

                <!-- COLUMN 2: Expenses & Liabilities (Right/Bottom in Mobile) -->
                <div style="display: flex; flex-direction: column; gap: 16px; padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 20px; border: 1px solid rgba(239, 68, 68, 0.1);">
                    <h3 style="color: #fca5a5; font-size: 18px; margin-bottom: 5px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                        <span>ŸÖÿµÿßÿ±ŸÅ ÿßŸà ŸÇÿ±ÿ∂ŸàŸÜŸá</span>
                        <span style="font-size: 20px;">üí∏</span>
                    </h3>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
                        <div class="job-icon" style="font-size: 28px;">üìâ</div>
                        <div class="job-name" style="font-size: 14px; color: #94a3b8;">ŸºŸàŸÑ ŸÖÿµÿßÿ±ŸÅ</div>
                        <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #fca5a5;"><span id="dashTotalExpense">0</span> <span style="font-size: 12px; font-weight: 400;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>


                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
                        <div class="job-icon" style="font-size: 28px;">üè†</div>
                        <div class="job-name" style="font-size: 14px; color: #94a3b8;">ŸºŸàŸÑ ⁄©Ÿàÿ±ŸÜŸä ŸÖÿµÿßÿ±ŸÅ</div>
                        <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #60a5fa;"><span id="dashTotalHouseholdExpense">0</span> <span style="font-size: 12px; font-weight: 400;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2);">
                        <div class="job-icon" style="font-size: 28px;">üíº</div>
                        <div class="job-name" style="font-size: 14px; color: #94a3b8;">ŸºŸàŸÑŸá ŸæÿßŸÜ⁄´ŸàŸÜŸá</div>
                        <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #c084fc;"><span id="dashTotalInvestment">0</span> <span style="font-size: 12px; font-weight: 400;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>
                </div>

                <!-- COLUMN 3: Loans (New Group) -->
                <div style="display: flex; flex-direction: column; gap: 16px; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 20px; border: 1px solid rgba(59, 130, 246, 0.1);">
                    <h3 style="color: #60a5fa; font-size: 18px; margin-bottom: 5px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                        <span>ÿØ ÿÆŸÑ⁄©Ÿà ŸÇÿ±ÿ∂ŸàŸÜŸá</span>
                        <span style="font-size: 20px;">ü§ù</span>
                    </h3>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div class="job-icon" style="font-size: 28px;">üì§</div>
                        <div class="job-name" style="font-size: 14px; color: #94a3b8;">ŸæŸá ÿÆŸÑ⁄©Ÿà ÿ≤ŸÖŸàŸÜ⁄ñ ŸÇÿ±ÿ∂ŸàŸÜŸá</div>
                        <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #10b981;"><span id="dashLoansToPeople">0</span> <span style="font-size: 12px; font-weight: 400;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
                        <div class="job-icon" style="font-size: 28px;">üì•</div>
                        <div class="job-name" style="font-size: 14px; color: #94a3b8;">ŸæŸá ŸÖŸàŸÜ⁄ñ ÿØ ÿÆŸÑ⁄©Ÿà ŸÇÿ±ÿ∂ŸàŸÜŸá</div>
                        <div class="job-desc" style="font-size: 22px; font-weight: 800; color: #ef4444;"><span id="dashLoansFromPeople">0</span> <span style="font-size: 12px; font-weight: 400;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

<!-- Saudi Sub-Account Selection Screen -->
    <div id="saudiSubAccountScreen" class="hidden">
        <div class="glass-card job-selection-card">
            <button type="button" onclick="backFromSaudiSubAccount()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1)';">‚úï</button>
            <div class="job-header">
                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                <div>
                    <h2>ÿ≥ÿπŸàÿØŸä ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá</h2>
                    <p class="job-header-subtitle">ŸÅÿ±ÿπŸä ÿ≠ÿ≥ÿßÿ® ÿßŸÜÿ™ÿÆÿßÿ® ⁄©⁄ìÿ¶</p>
                </div>
            </div>
            <div class="job-grid" id="saudiSubAccountGrid"></div>
        </div>
    </div>

    <!-- Home Sub-Account Selection Screen -->
    <div id="homeSubAccountScreen" class="hidden">
        <div class="glass-card job-selection-card">
            <button type="button" onclick="backFromHomeSubAccount()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1)';">‚úï</button>
            <div class="job-header">
                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                <div>
                    <h2>ÿØ ⁄©Ÿàÿ± ŸÖÿµÿßÿ±ŸÅ</h2>
                    <p class="job-header-subtitle">ŸÅÿ±ÿπŸä ÿ≠ÿ≥ÿßÿ® ÿßŸÜÿ™ÿÆÿßÿ® ⁄©⁄ìÿ¶</p>
                </div>
            </div>
            <div class="job-grid" id="homeSubAccountGrid"></div>
        </div>
    </div>

    <!-- Password Screen -->
    <div id="passwordScreen" class="hidden">
        <div class="glass-card password-card">
            <button type="button" onclick="backToJobs()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1)';">‚úï</button>
            <div class="password-header">
                <div class="lock-icon">üîí</div>
                <div>
                    <div class="password-title">ÿØ 2026 ⁄©ÿßŸÑ ŸÅŸàÿ±ŸÖ</div>
                    <p class="password-subtitle">‚ú® Ÿæÿßÿ≥Ÿàÿ±⁄â ÿØÿßÿÆŸÑ ⁄©⁄ìÿ¶</p>
                </div>
            </div>

            <div class="password-input-group">
                <label class="password-input-label" for="passwordInput">üîê Ÿæÿßÿ≥Ÿàÿ±⁄â</label>
                <input type="password" id="passwordInput" class="password-input" placeholder="Ÿæÿßÿ≥Ÿàÿ±⁄â ŸàŸÑ€å⁄©ÿ¶..." autocomplete="off">
            </div>

            <div class="password-error" id="passwordError">‚ùå Ÿæÿßÿ≥Ÿàÿ±⁄â ÿ∫ŸÑÿ∑ ÿØÿ¶</div>

            <div class="password-buttons">
                <button type="button" class="password-button btn-primary" style="width: 100%;" onclick="checkPassword()">ÿØÿÆŸàŸÑ</button>
            </div>
        </div>
    </div>

    <!-- Report Screen -->
    <div id="reportScreen" class="hidden">
        <div class="glass-card" style="max-width: 1000px; margin: 20px auto; padding: 25px; position: relative; max-height: 90vh; display: flex; flex-direction: column;">
            <button type="button" onclick="closeReport()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer;">‚úï</button>

            <div class="header" style="margin-bottom: 20px; flex-shrink: 0;">
                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                <div>
                    <h2 id="reportTitle">ÿ≠ÿ≥ÿßÿ®Ÿä ÿ±ÿßŸæŸàÿ±</h2>
                    <p class="subtitle" id="reportSubtitle">ÿØ ŸÖÿπÿßŸÖŸÑŸà ŸÑ€åÿ≥ÿ™ ÿßŸà ÿ¨ÿ≤ÿ¶€åÿßÿ™</p>
                </div>
            </div>

            <!-- Search & Stats Container -->
            <div style="flex-shrink: 0;">
                <!-- Search Inputs -->
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-bottom: 20px; display: flex; gap: 24px; flex-wrap: wrap; align-items: flex-end;">
                    <div style="flex: 2; min-width: 250px; margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 10px; font-size: 13px; color: #94a3b8; font-weight: 600;">ÿØ ⁄ÖŸá ÿ¥Ÿä ŸÑŸºŸàŸÜ ⁄©Ÿàÿ¶ÿü</label>
                        <input type="text" id="reportSearchText" placeholder="üîç ŸÑŸºŸàŸÜ (ÿ™ŸÅÿµ€åŸÑÿå ŸÜŸàŸÖ...)" oninput="filterReport()" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; outline: none; transition: all 0.3s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                    </div>
                    <div style="flex: 1; min-width: 180px; margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 10px; font-size: 13px; color: #94a3b8; font-weight: 600;">ŸÑŸá ŸÜ€êŸº€ê</label>
                        <input type="date" id="reportStartDate" onchange="filterReport()" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; outline: none; transition: all 0.3s;">
                    </div>
                    <div style="flex: 1; min-width: 180px; margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 10px; font-size: 13px; color: #94a3b8; font-weight: 600;">ÿ™ÿ± ŸÜ€êŸº€ê</label>
                        <input type="date" id="reportEndDate" onchange="filterReport()" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; outline: none; transition: all 0.3s;">
                    </div>
                    <div style="flex: 0; min-width: 120px; margin-bottom: 10px;">
                        <button onclick="clearReportFilters()" style="width: 100%; padding: 14px 20px; height: 52px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">Ÿæÿß⁄©ŸàŸÑ ‚úï</button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="glass-card" style="padding: 15px; text-align: center; border: 1px solid rgba(16, 185, 129, 0.3);">
                        <div style="color: #94a3b8; font-size: 13px;">ŸºŸàŸÑ ÿπÿßÿ¶ÿØ</div>
                        <div id="reportTotalIncome" style="color: #10b981; font-size: 20px; font-weight: 800;">0</div>
                    </div>
                    <div class="glass-card" style="padding: 15px; text-align: center; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <div style="color: #94a3b8; font-size: 13px;">ŸºŸàŸÑ ŸÖÿµÿßÿ±ŸÅ</div>
                        <div id="reportTotalExpense" style="color: #ef4444; font-size: 20px; font-weight: 800;">0</div>
                    </div>
                    <div class="glass-card" style="padding: 15px; text-align: center; border: 1px solid rgba(59, 130, 246, 0.3);">
                        <div style="color: #94a3b8; font-size: 13px;">ÿÆÿßŸÑÿµ ÿ®€åŸÑÿßŸÜÿ≥</div>
                        <div id="reportNetBalance" style="color: #60a5fa; font-size: 20px; font-weight: 800;">0</div>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div style="flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <table style="width: 100%; border-collapse: collapse; direction: rtl; text-align: right; position: relative;">
                    <thead style="position: sticky; top: 0; background: #0a0515; z-index: 10;">
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <th style="padding: 15px; color: #94a3b8; font-weight: 600;">ŸÜ€êŸºŸá</th>
                            <th style="padding: 15px; color: #94a3b8; font-weight: 600;">ÿ™ŸÅÿµ€åŸÑ</th>
                            <th style="padding: 15px; color: #94a3b8; font-weight: 600;">ÿπÿßÿ¶ÿØ</th>
                            <th style="padding: 15px; color: #94a3b8; font-weight: 600;">ŸÖÿµÿ±ŸÅ</th>
                            <th style="padding: 15px; color: #94a3b8; font-weight: 600;">ÿ≠ÿ∞ŸÅ</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Main Form Container -->
    <div class="container hidden" id="formContainer">
        <div class="glass-card" style="position: relative;">
            <button type="button" id="homeLogoutBtn" onclick="logout()" style="position: absolute; top: 20px; left: 20px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 36px; height: 36px; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; z-index: 10;">‚úï</button>

            <div class="header">
                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                <div>
                    <h1>ÿØ Ÿàÿ±⁄ÅŸÜŸä ÿ≠ÿ≥ÿßÿ® ŸÅŸàÿ±ŸÖ</h1>
                    <p class="subtitle">‚ú® ŸÖŸáÿ±ÿ®ÿßŸÜŸä Ÿà⁄©⁄ìÿ¶ ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸæŸá ÿØŸÇ€åŸÇŸá ÿ™Ÿà⁄´Ÿá ⁄â⁄© ⁄©⁄ìÿ¶</p>
                </div>
            </div>

            <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(59, 130, 246, 0.06)); border: 2px solid rgba(139, 92, 246, 0.25); border-radius: 16px; margin-bottom: 24px;">
                <div style="font-size: 28px; margin-bottom: 8px;" id="currentJobIcon"></div>
                <div style="font-size: 16px; font-weight: 800; background: linear-gradient(to left, #c084fc, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="currentJobName"></div>
            </div>
            <div style="display: flex; gap: 12px; margin-bottom: 24px;" id="navButtonsRow">
                <button type="button" id="dashboardBtn" class="btn-secondary" style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); color: #c084fc; font-weight: 700; flex: 1; padding: 12px; border-radius: 12px;" onclick="openDashboard()">
                    üìä ⁄âÿ¥ÿ®Ÿàÿ±⁄â 
                </button>
                <button type="button" id="reportNavBtn" class="btn-secondary" style="background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; font-weight: 700; flex: 1; padding: 12px; border-radius: 12px; display: none;" onclick="openReport()">
                    üìã ÿ±ÿßŸæŸàÿ±
                </button>
            </div>

            <!-- Balance Section (Only for Home Accounts) -->
            <div id="balanceSection" class="balance-section" style="display: flex; justify-content: space-between; align-items: center; width: 100%; box-sizing: border-box; padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 16px; margin-bottom: 24px; border: 1px solid rgba(139, 92, 246, 0.2);">
                <div style="flex: 1;">
                    <div class="balance-label" style="font-size: 14px; color: #94a3b8; margin-bottom: 4px;">ŸÖŸàÿ¨ŸàÿØŸá ⁄´⁄â ÿ®€åŸÑÿßŸÜÿ≥</div>
                    <div class="balance-value" style="font-size: 24px; font-weight: 800; color: #c084fc;">
                        <span id="balanceValue">0</span>
                        <span class="balance-currency">AFN</span>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="button" id="editBalanceBtn" class="balance-edit-btn" onclick="editBalance()" style="width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; font-size: 20px;">‚úèÔ∏è</button>
                </div>
            </div>

            <form id="trailerForm" class="form-grid" style="width: 100%; display: flex; flex-direction: column; gap: 0;">
                <!-- New Home Fields - Grid Layout -->
                <div id="homeFields" style="width: 100%; display: flex; flex-direction: column; gap: 15px; margin-bottom: 24px; direction: rtl;">
                    <!-- Row 1: 50% / 50% -->
                    <div style="display: flex; gap: 12px; width: 100%;">
                        <div class="input-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ÿØ ⁄©Ÿàÿ±ŸÜ€ç ÿßŸÅÿ±ÿßÿØŸà ÿ™ÿπÿØÿßÿØ</label>
                            <input type="number" id="familyMembers" placeholder="-" class="data-input" readonly style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                        </div>
                        <div class="input-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">üí∞ ŸÅÿ±ÿØŸä ŸÖÿßŸÑŸä ÿ≠ŸÇ</label>
                            <input type="number" id="individualRight" placeholder="-" class="data-input" readonly style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                        </div>
                    </div>

                    <!-- Row 2: 100% -->
                    <div class="input-group" style="width: 100%;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">üíµ ÿ≠ŸÇ€åŸÇŸä Ÿàÿ±⁄©⁄ìŸá</label>
                        <input type="number" id="actualPayment" placeholder="-" class="data-input" readonly style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                    </div>

                    <!-- Row 3: 50% / 50% -->
                    <div style="display: flex; gap: 12px; width: 100%;">
                        <div class="input-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">üìä ÿ™ŸàŸæ€åÿ±</label>
                            <input type="number" id="difference" placeholder="-" readonly class="data-input" style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                        </div>
                        <div class="input-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">üîÑ ÿ≠ÿßŸÑÿ™</label>
                            <input type="text" id="status" placeholder="-" readonly class="data-input" style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                        </div>
                    </div>

                    <!-- Row 4: 100% -->
                    <div class="input-group" style="width: 100%;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">üìâ Ÿæÿßÿ™€ê ŸÜÿ∫ÿØ€åŸá</label>
                        <input type="number" id="remainingCash" placeholder="-" readonly class="data-input" style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px;">
                    </div>
                </div>

                <div class="input-group full-width" id="dateGroup">
                    <label for="date">üìÖ ŸÜ€êŸºŸá (2026)</label>
                    <input type="date" id="date" name="date" min="2026-01-01" max="2026-12-31" required style="width: 95%; box-sizing: border-box;">
                    <p class="hint">‚≠ê €åŸàÿßÿ≤€ê ÿØ 2026 ⁄©ÿßŸÑ ŸÜ€åŸº€ê ŸÖŸÜŸÑ ⁄©€å⁄ñŸä</p>
                </div>

                <!-- Income Field (Hidden for Home Accounts, Visible for others) -->
                <div class="input-group full-width" id="incomeGroup" style="display: none;">
                    <label for="income">üí∞ ÿπÿßÿ¶ÿØ</label>
                    <input type="number" id="income" name="income" min="0" placeholder="ÿπÿßÿ¶ÿØ ŸàŸÑ€å⁄©ÿ¶">
                    <p class="error-message" id="incomeError">‚ùå ÿπÿßÿ¶ÿØ ŸÑ€å⁄©ŸÑ ŸÑÿßÿ≤ŸÖ ÿØ€å (ÿµŸÅÿ± €åÿß ŸÑŸà⁄ì ÿπÿØÿØ ŸàŸÑ€å⁄©ÿ¶)</p>
                </div>

                <div class="input-group full-width" id="expenseGroup">
                    <label for="expense">üí∏ ŸÖÿµÿßÿ±ŸÅ</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="expense" name="expense" min="0" placeholder="ŸÖÿµÿßÿ±ŸÅ ŸàŸÑ€å⁄©ÿ¶" style="flex: 1;">
                        <input type="hidden" id="currency" name="currency" value="AFN">
                    </div>
                    <p class="error-message" id="expenseError">‚ùå ŸÖÿµÿßÿ±ŸÅ ŸÑ€å⁄©ŸÑ ŸÑÿßÿ≤ŸÖ ÿØ€å (ÿµŸÅÿ± €åÿß ŸÑŸà⁄ì ÿπÿØÿØ ŸàŸÑ€å⁄©ÿ¶)</p>
                </div>

                <!-- New Field 1: Sent to Home Expense -->
                <div class="input-group full-width" id="sentToHomeGroup" style="display: none;">
                    <label for="sentToHome" style="color: #60a5fa;">üè† ⁄©Ÿàÿ± ÿ™Ÿá ŸÑ€ê⁄ñŸÑ ÿ¥Ÿà€å ÿÆÿ±⁄ÖŸá</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="sentToHome" name="sentToHome" min="0" placeholder="ŸÖŸÇÿØÿßÿ± ŸàŸÑ€å⁄©ÿ¶" style="flex: 1;">
                    </div>
                </div>

                <!-- New Field 2: Driver Salary -->
                <div class="input-group full-width" id="driverSalaryGroup" style="display: none;">
                    <label for="driverSalary" style="color: #34d399;">üöó ÿØ ⁄âÿ±€êŸàÿ± ÿ™ŸÜÿÆŸàÿß</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="driverSalary" name="driverSalary" min="0" placeholder="ŸÖŸÇÿØÿßÿ± ŸàŸÑ€å⁄©ÿ¶" style="flex: 1;">
                    </div>
                </div>

                <!-- New Field 3: Sent to Home (Mobile) -->
                <div class="input-group full-width" id="sentToHomeMobileGroup" style="display: none;">
                    <label for="sentToHomeMobile" style="color: #60a5fa;">üè† ⁄©Ÿàÿ± ÿ™Ÿá Ÿàÿ±⁄©⁄ìŸÑ ÿ¥Ÿà€å ÿÆÿ±⁄ÖŸá</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="sentToHomeMobile" name="sentToHomeMobile" min="0" placeholder="ŸÖŸÇÿØÿßÿ± ŸàŸÑ€å⁄©ÿ¶" style="flex: 1;">
                    </div>
                </div>

                <!-- New Field 4: Shop Rent (Mobile) -->
                <div class="input-group full-width" id="shopRentGroup" style="display: none;">
                    <label for="shopRent" style="color: #fbbf24;">üè™ ÿØ⁄©ÿßŸÜ ⁄©ÿ±ÿß€åŸá</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="shopRent" name="shopRent" min="0" placeholder="ŸÖŸÇÿØÿßÿ± ŸàŸÑ€å⁄©ÿ¶" style="flex: 1;">
                    </div>
                </div>

                <!-- Category Field (For Home Accounts) - REPLACED WITH ICONS -->
                <div class="input-group full-width" id="categoryGroup" style="display: none;">
                    <label>üìÇ ⁄©Ÿº⁄´Ÿàÿ±Ÿä (ÿØ ŸÖÿµÿßÿ±ŸÅŸà ŸÑŸæÿßÿ±Ÿá)</label>
                    <input type="hidden" id="category" name="category">

                    <div class="category-grid">
                        <div class="category-btn" onclick="selectCategory('ÿÆŸàÿ±ÿß⁄©', this)">
                            <div class="category-btn-icon">üçî</div>
                            <div class="category-btn-label">ÿÆŸàÿ±ÿß⁄©</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ÿ±Ÿàÿ∫ÿ™€åÿß', this)">
                            <div class="category-btn-icon">üíä</div>
                            <div class="category-btn-label">ÿ±Ÿàÿ∫ÿ™€åÿß</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ÿ™ÿπŸÑ€åŸÖ', this)">
                            <div class="category-btn-icon">üìö</div>
                            <div class="category-btn-label">ÿ™ÿπŸÑ€åŸÖ</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ÿ™ŸÅÿ±€åÿ≠', this)">
                            <div class="category-btn-icon">üéÆ</div>
                            <div class="category-btn-label">ÿ™ŸÅÿ±€åÿ≠</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('Ÿºÿ±ÿßŸÜÿ≥ŸæŸàÿ±Ÿº', this)">
                            <div class="category-btn-icon">üöï</div>
                            <div class="category-btn-label">Ÿºÿ±ÿßŸÜÿ≥ŸæŸàÿ±Ÿº</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ÿ¨ÿßŸÖ€ê', this)">
                            <div class="category-btn-icon">üëï</div>
                            <div class="category-btn-label">ÿ¨ÿßŸÖ€ê</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ŸÖ€åŸÑŸÖŸá', this)">
                            <div class="category-btn-icon">‚òï</div>
                            <div class="category-btn-label">ŸÖ€åŸÑŸÖŸá</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ŸÜŸàÿ±', this)">
                            <div class="category-btn-icon">‚ûï</div>
                            <div class="category-btn-label">ŸÜŸàÿ±...</div>
                        </div>
                    </div>

                    <input type="text" id="customCategoryInput" placeholder="ÿØ ⁄©Ÿº⁄´Ÿàÿ±€ç ŸÜŸàŸÖ ŸàŸÑ€å⁄©ÿ¶..." oninput="updateCustomCategory(this.value)">
                </div>

                <div class="input-group full-width" id="detailGroup">
                    <label for="detail">üìù ÿØ ⁄©ÿßÿ± ÿ™ŸÅÿµ€åŸÑ</label>
                    <textarea id="detail" name="detail" placeholder="ÿØ ⁄©ÿßÿ± ÿ™ŸÅÿµ€åŸÑ ŸàŸÑ€å⁄©ÿ¶..."></textarea>
                </div>

                <div class="input-group full-width" id="noteGroup">
                    <label for="note">üìå €åÿßÿØÿß⁄öÿ™ (ÿßÿÆÿ™€åÿßÿ±Ÿä)</label>
                    <input type="text" id="note" name="note" placeholder="€åÿßÿØÿß⁄öÿ™ ŸàŸÑ€å⁄©ÿ¶...">
                </div>

                <div class="input-group full-width" id="imageGroup">
                    <label>üì∑ ÿØ ÿ®€åŸÑ/ŸÅÿßÿ™Ÿàÿ±€ê ÿπ⁄©ÿ≥ (ÿßÿÆÿ™€åÿßÿ±Ÿä)</label>
                    <!-- Main Container Box -->
                    <div id="billImageArea" style="background: rgba(255, 255, 255, 0.05); border: 2px dashed rgba(139, 92, 246, 0.3); border-radius: 14px; padding: 15px; transition: all 0.3s;">

                        <!-- Inner Flex Container (Grid Option) -->
                        <div style="display: flex; justify-content: space-around; align-items: center; gap: 10px; flex-wrap: wrap;">

                            <!-- Option 1: Gallery (Standard Image) -->
                            <div onclick="document.getElementById('billImageGallery').click()" style="text-align: center; cursor: pointer; flex: 1; min-width: 80px; padding: 10px; border-radius: 10px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                <div style="font-size: 24px; margin-bottom: 4px;">üìÇ</div>
                                <div style="font-size: 11px; color: #a78bfa; font-weight: 600;">ŸÅÿß€åŸÑ/⁄´ÿßŸÑÿ±Ÿä</div>
                            </div>

                        </div>
                    </div>

                    <!-- Hidden Inputs -->
                    <input type="file" id="billImageGallery" name="billImageGallery" accept="image/*" style="display: none;" onchange="handleImageSelect(this)">

                    <!-- Preview Area -->
                    <div id="imagePreview" style="display: none; margin-top: 12px; position: relative; text-align: center;">
                        <img id="previewImg" src="" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div id="compressionInfo" style="font-size: 11px; color: #6ee7b7; margin-top: 5px;"></div>
                        <button type="button" onclick="removeImage()" style="position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold;">‚úï</button>
                    </div>
                </div>

                <div class="submit-btn-wrapper full-width" id="submitBtnWrapper">
                    <button type="button" class="btn-secondary" onclick="logout()">ÿÆÿ±Ÿàÿ¨</button>
                    <button type="submit" class="submit-btn">‚úì ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="glass-card modal">
            <div class="modal-header">
                <div class="modal-icon">‚úì</div>
                <div>
                    <div class="modal-title">ÿ™ÿß€å€åÿØ</div>
                    <p class="modal-subtitle">ŸÖŸáÿ±ÿ®ÿßŸÜŸä Ÿà⁄©⁄ìÿ¶ ŸÖÿπŸÑŸàŸÖÿßÿ™ Ÿà⁄´Ÿàÿ±ÿ¶</p>
                </div>
            </div>

            <div class="modal-body">
                <div class="last-save-section" id="lastSaveRow" style="display: none;">
                    <div class="last-save-title">üìã Ÿàÿ±Ÿàÿ≥ÿ™€å ÿ∞ÿÆ€åÿ±Ÿá ÿ¥Ÿà€å</div>
                    <div class="data-row-grid">
                        <div class="data-field">
                            <span class="data-label">üìÖ ŸÜ€êŸºŸá</span>
                            <span class="data-value" id="lastSaveDate">-</span>
                        </div>
                        <div class="data-field">
                            <span class="data-label">üí∏ ŸÖÿµÿßÿ±ŸÅ</span>
                            <span class="data-value" id="lastSaveExpense">-</span>
                        </div>
                        <div class="data-field">
                            <span class="data-label">üìù ÿ™ŸÅÿµ€åŸÑ</span>
                            <span class="data-value" id="lastSaveDetail">-</span>
                        </div>
                    </div>
                    <div class="data-field" id="lastSaveNoteRow" style="margin-top: 12px; display: none;">
                        <span class="data-label">üìå €åÿßÿØÿß⁄öÿ™</span>
                        <span class="data-value" id="lastSaveNote">-</span>
                    </div>
                </div>

                <div class="last-save-title" style="margin-top: 20px; margin-bottom: 10px; color: #c084fc; font-weight: 700;">üìù ŸÜŸàŸä ŸÖÿπŸÑŸàŸÖÿßÿ™</div>
                <div class="data-row">
                    <div class="data-row-grid">
                        <div class="data-field">
                            <span class="data-label">üìÖ ŸÜ€êŸºŸá</span>
                            <span class="data-value" id="confirmDate">-</span>
                        </div>
                        <div class="data-field">
                            <span class="data-label">üí∏ ŸÖÿµÿßÿ±ŸÅ</span>
                            <span class="data-value" id="confirmExpense">-</span>
                        </div>
                    </div>
                </div>

                <div class="data-row">
                    <div class="data-row-grid">
                        <div class="data-field" style="grid-column: 1 / -1;">
                            <span class="data-label">üìù ÿØ ⁄©ÿßÿ± ÿ™ŸÅÿµ€åŸÑ</span>
                            <span class="data-value" id="confirmDetail">-</span>
                        </div>
                    </div>
                </div>

                <!-- Added Category to Modal -->
                <div class="data-row" id="categoryRow" style="display: none;">
                    <div class="data-field">
                        <span class="data-label">üìÇ ⁄©Ÿº⁄´Ÿàÿ±Ÿä</span>
                        <span class="data-value" id="confirmCategory">-</span>
                    </div>
                </div>

                <div class="data-row" id="sentToHomeRow" style="display: none;">
                    <div class="data-field">
                        <span class="data-label" style="color: #60a5fa;">üè† ⁄©Ÿàÿ± ÿ™Ÿá ŸÑ€ê⁄ñŸÑ ÿ¥Ÿà€å ÿÆÿ±⁄ÖŸá</span>
                        <span class="data-value" id="confirmSentToHome">-</span>
                    </div>
                </div>
                <div class="data-row" id="driverSalaryRow" style="display: none;">
                    <div class="data-field">
                        <span class="data-label" style="color: #34d399;">üöó ÿØ ⁄âÿ±€êŸàÿ± ÿ™ŸÜÿÆŸàÿß</span>
                        <span class="data-value" id="confirmDriverSalary">-</span>
                    </div>
                </div>

                <div class="data-row" id="sentToHomeMobileRow" style="display: none;">
                    <div class="data-field">
                        <span class="data-label" style="color: #60a5fa;">üè† ⁄©Ÿàÿ± ÿ™Ÿá Ÿàÿ±⁄©⁄ìŸÑ ÿ¥Ÿà€å ÿÆÿ±⁄ÖŸá</span>
                        <span class="data-value" id="confirmSentToHomeMobile">-</span>
                    </div>
                </div>
                <div class="data-row" id="shopRentRow" style="display: none;">
                    <div class="data-field">
                        <span class="data-label" style="color: #fbbf24;">üè™ ÿØ⁄©ÿßŸÜ ⁄©ÿ±ÿß€åŸá</span>
                        <span class="data-value" id="confirmShopRent">-</span>
                    </div>
                </div>

                <div class="data-row" id="imageRow" style="display: none;">
                    <div class="data-field">
                        <span class="data-label">üì∑ ÿ®€åŸÑ ÿ∂ŸÖ€åŸÖŸá</span>
                        <span class="data-value" style="color: #6ee7b7;">‚úì ÿπ⁄©ÿ≥ ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥Ÿà (Compressed)</span>
                    </div>
                </div>

                <div class="data-row" id="noteRow" style="display: none;">
                    <div class="data-field">
                        <span class="data-label">üìå €åÿßÿØÿß⁄öÿ™</span>
                        <span class="data-value" id="confirmNote">-</span>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeModal()">‚úèÔ∏è ÿ™ÿµÿ≠€åÿ≠</button>
                <button type="button" class="btn-success" id="confirmButton" onclick="confirmSubmit()">‚úì ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™ÿß€å€åÿØ ÿßŸà ÿ∞ÿÆ€åÿ±Ÿá ⁄©⁄ìÿ¶ </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 700px; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); box-shadow: 0 12px 30px rgba(99, 102, 241, 0.4);">üìä</div>
                <div>
                    <div class="modal-title" id="dashboardTitle">⁄âÿ¥ÿ®Ÿàÿ±⁄â</div>
                    <p class="modal-subtitle" id="dashboardSubtitle">ÿØ ÿ≠ÿ≥ÿßÿ® ÿπŸÖŸàŸÖŸä ŸÖÿπŸÑŸàŸÖÿßÿ™</p>
                </div>
                <button type="button" id="dashboardDeleteBtn" class="btn-secondary" style="margin-right: auto; background: rgba(239, 68, 68, 0.2); color: #fca5a5; margin-left: 10px; font-size: 12px; display: none;" onclick="clearAllData()">üóëÔ∏è ⁄ìŸÜ⁄´ŸàŸÑ</button>
                <button type="button" class="btn-close-fancy" onclick="closeDashboard()" style="position: absolute; top: 15px; left: 15px;">‚úï</button>
            </div>

            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">

                <!-- Joint Expenses Form (Hidden by default) -->
                <div id="jointExpensesContent" style="display:none !important;" style="display: none;">
                    <form onsubmit="handleJointExpenseSubmit(event)" style="display: flex; flex-direction: column; gap: 15px;">

                        <!-- Date -->
                        <div class="input-group full-width">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">üìÖ ŸÜ€êŸºŸá</label>
                            <input type="date" id="jointDate" required style="width: 95%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; box-sizing: border-box;">
                        </div>

                        <!-- Expenses -->
                        <div class="input-group full-width">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">üí∏ ŸÖÿµÿßÿ±ŸÅ </label>
                            <input type="number" id="jointExpense" required min="0" placeholder="ŸÖÿµÿßÿ±ŸÅ ŸàŸÑ€å⁄©ÿ¶" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; box-sizing: border-box;">
                        </div>

                        <!-- Details -->
                        <div class="input-group full-width">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">üìù ÿ™ŸÅÿµ€åŸÑ</label>
                            <textarea id="jointDetail" required placeholder="ÿØ ŸÖÿµÿßÿ±ŸÅŸà ÿ™ŸÅÿµ€åŸÑ ŸàŸÑ€å⁄©ÿ¶..." rows="3" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; resize: none; box-sizing: border-box;"></textarea>
                        </div>

                        <!-- Image Upload (Same system as others) -->
                        <div class="input-group full-width">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #94a3b8;">üì∑ ÿØ ÿ®€åŸÑ ÿπ⁄©ÿ≥ŸàŸÜŸà</label>
                            <div style="background: rgba(255, 255, 255, 0.05); border: 2px dashed rgba(139, 92, 246, 0.3); border-radius: 14px; padding: 15px;">
                                <div style="display: flex; justify-content: space-around; align-items: center; gap: 10px;">
                                    <div onclick="document.getElementById('jointImageInput').click()" style="text-align: center; cursor: pointer; flex: 1; padding: 10px; border-radius: 10px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                        <div style="font-size: 24px; margin-bottom: 4px;">üìÇ</div>
                                        <div style="font-size: 11px; color: #a78bfa;">⁄´ÿßŸÑÿ±Ÿä</div>
                                    </div>
                                    <div onclick="openCamera('photo', 'joint')" style="text-align: center; cursor: pointer; flex: 1; padding: 10px; border-radius: 10px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                        <div style="font-size: 24px; margin-bottom: 4px;">üì∏</div>
                                        <div style="font-size: 11px; color: #6ee7b7;">⁄©€êŸÖÿ±Ÿá</div>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="jointImageInput" accept="image/*" style="display: none;" onchange="handleJointImageSelect(this)">

                            <!-- Preview -->
                            <div id="jointImagePreview" style="display: none; margin-top: 12px; position: relative; text-align: center;">
                                <img id="jointPreviewImg" src="" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <button type="button" onclick="removeJointImage()" style="position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer;">‚úï</button>
                            </div>
                        </div>

                        <button type="submit" class="submit-btn" style="margin-top: 10px;">‚úì ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                    </form>

                <!-- Original Dashboard Content -->
                <div id="dashboardContent">
                    <!-- Data Management & Features -->
                    <div id="adminOnlyFeatures" style="display:none;">
                <div style="margin-bottom: 15px;">
                     <button class="btn-primary" onclick="downloadBackup()" style="width: 100%; background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);">üíæ ÿ®€å⁄© ÿßŸæ (Backup)</button>
                </div>
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <input type="file" id="restoreFile" style="display: none;" onchange="restoreBackup(this)">
                    <button class="btn-secondary" onclick="document.getElementById('restoreFile').click()" style="width: 100%; border: 1px dashed #6366f1; color: #818cf8;">üìÇ ⁄â€åŸºÿß ÿ®€åÿ±ÿ™Ÿá ŸæŸàÿ±ÿ™Ÿá ⁄©ŸàŸÑ (Restore)</button>
                </div>

                <!-- Budget Warning -->
                <div id="budgetWarning" style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 12px; border-radius: 12px; margin-bottom: 15px; display: none; align-items: center; gap: 8px; font-size: 13px;">
                    ‚ö†Ô∏è ÿÆÿ®ÿ±ÿ™€åÿß: ÿ≥ÿ™ÿßÿ≥Ÿà ŸÖÿµÿßÿ±ŸÅ Ÿºÿß⁄©ŸÑ ÿ¥ŸàŸä ÿ≠ÿØ ÿ™Ÿá ŸÜ⁄ñÿØ€ê ÿØŸä!
                </div>

                                </div>
                </div> <!-- End dashboardContent -->
            </div>
        </div>
    </div>

    <!-- Report Screen - REMOVED -->


    <div id="opExpScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column; position: relative;">
            <button type="button" onclick="closeOpExpScreen()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
            <div class="modal-header" style="padding-top: 10px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #f43f5e, #fb7185); box-shadow: 0 12px 30px rgba(244, 63, 94, 0.4);">üí∏</div>
                <div>
                    <div class="modal-title">ÿπŸÖŸÑ€åÿßÿ™Ÿä ŸÖÿµÿßÿ±ŸÅ</div>
                    <p class="modal-subtitle">ÿØ Ÿàÿ±⁄ÅŸÜŸä ŸÅÿπÿßŸÑ€åÿ™ ŸÖÿµÿßÿ±ŸÅ</p>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <form onsubmit="handleOpExpSubmit(event)" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <input type="number" id="opExpAmount" required placeholder="ŸÖŸÇÿØÿßÿ± (ÿßŸÅÿ∫ÿßŸÜ€ç)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                        <input type="date" id="opExpDate" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    </div>
                    <input type="text" id="opExpDesc" required placeholder="ÿ™ŸÅÿµ€åŸÑ (ŸÖÿ´ŸÑÿß: ÿ™€êŸÑÿå ÿ™ÿ±ŸÖ€åŸÖ...)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    <button type="submit" class="btn-primary" style="background: #10b981;">ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                </form>
                <div id="opExpList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="capExpScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column; position: relative;">
            <button type="button" onclick="closeCapExpScreen()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
            <div class="modal-header" style="padding-top: 10px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #fb923c, #f97316); box-shadow: 0 12px 30px rgba(251, 146, 60, 0.4);">üèóÔ∏è</div>
                <div>
                    <div class="modal-title">ŸæÿßŸÜ⁄´€åÿ≤ ŸÖÿµÿßÿ±ŸÅ</div>
                    <p class="modal-subtitle">ÿØ ÿ¥ÿ™ŸÖŸÜ€åŸà ÿßŸà ÿØÿß€åŸÖŸä Ÿàÿ≥ÿß€åŸÑŸà ŸÖÿµÿßÿ±ŸÅ</p>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <form onsubmit="handleCapExpSubmit(event)" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <input type="number" id="capExpAmount" required placeholder="ŸÖŸÇÿØÿßÿ± (ÿßŸÅÿ∫ÿßŸÜ€ç)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                        <input type="date" id="capExpDate" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    </div>
                    <input type="text" id="capExpDesc" required placeholder="ÿ™ŸÅÿµ€åŸÑ (ŸÖÿ´ŸÑÿß: ŸÖŸàŸºÿ± ÿßÿÆ€åÿ≥ÿ™ŸÑÿå ŸàÿØÿßŸÜ€ç...)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    <button type="submit" class="btn-primary" style="background: #fb923c;">ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                </form>
                <div id="capExpList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="opExpScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column; position: relative;">
            <button type="button" onclick="closeOpExpScreen()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
            <div class="modal-header" style="padding-top: 10px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #f43f5e, #fb7185); box-shadow: 0 12px 30px rgba(244, 63, 94, 0.4);">üí∏</div>
                <div>
                    <div class="modal-title">ÿπŸÖŸÑ€åÿßÿ™Ÿä ŸÖÿµÿßÿ±ŸÅ</div>
                    <p class="modal-subtitle">ÿØ Ÿàÿ±⁄ÅŸÜŸä ŸÅÿπÿßŸÑ€åÿ™ ŸÖÿµÿßÿ±ŸÅ</p>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <form onsubmit="handleOpExpSubmit(event)" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <input type="number" id="opExpAmount" required placeholder="ŸÖŸÇÿØÿßÿ± (ÿßŸÅÿ∫ÿßŸÜ€ç)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                        <input type="date" id="opExpDate" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    </div>
                    <input type="text" id="opExpDesc" required placeholder="ÿ™ŸÅÿµ€åŸÑ (ŸÖÿ´ŸÑÿß: ÿ™€êŸÑÿå ÿ™ÿ±ŸÖ€åŸÖ...)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    <button type="submit" class="submit-btn" style="background: #10b981;">ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                </form>
                <div id="opExpList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="capExpScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column; position: relative;">
            <button type="button" onclick="closeCapExpScreen()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
            <div class="modal-header" style="padding-top: 10px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #fb923c, #f97316); box-shadow: 0 12px 30px rgba(251, 146, 60, 0.4);">üèóÔ∏è</div>
                <div>
                    <div class="modal-title">ŸæÿßŸÜ⁄´€åÿ≤ ŸÖÿµÿßÿ±ŸÅ</div>
                    <p class="modal-subtitle">ÿØ ÿ¥ÿ™ŸÖŸÜ€åŸà ÿßŸà ÿØÿß€åŸÖŸä Ÿàÿ≥ÿß€åŸÑŸà ŸÖÿµÿßÿ±ŸÅ</p>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <form onsubmit="handleCapExpSubmit(event)" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <input type="number" id="capExpAmount" required placeholder="ŸÖŸÇÿØÿßÿ± (ÿßŸÅÿ∫ÿßŸÜ€ç)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                        <input type="date" id="capExpDate" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    </div>
                    <input type="text" id="capExpDesc" required placeholder="ÿ™ŸÅÿµ€åŸÑ (ŸÖÿ´ŸÑÿß: ŸÖŸàŸºÿ± ÿßÿÆ€åÿ≥ÿ™ŸÑÿå ŸàÿØÿßŸÜ€ç...)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    <button type="submit" class="submit-btn" style="background: #fb923c;">ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                </form>
                <div id="capExpList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="toast-title" id="toastTitle"></div>
        <div class="toast-description" id="toastDescription"></div>
    </div>

    <script>
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxUgijxJUusdYz6gBc1Cxo0VxO2Kzalg77G_fpEndycuYmzguf72zceS0pN4T_ZF7Whpw/exec';
        // Note: DRIVE_FOLDER_URL is usually handled by the Google Script, not frontend directly unless using Google Picker API,
        // but keeping it here as it was in the original code.
        const DRIVE_FOLDER_URL = 'https://drive.google.com/drive/folders/1I5FZzH-exwNCoFTMsfMnjS31ep8MX8RX';

        const JOBS = [
            { id: 'saudi', name: 'ÿ≥ÿπŸàÿØŸä ÿ≠ÿ≥ÿßÿ®', password: 'saudi123', icon: 'üïå', desc: 'ÿØ ÿ≥ÿπŸàÿØŸä ⁄©ÿßÿ±' },
            { id: 'boklyn', name: 'ÿ®Ÿà⁄©ŸÑ€åŸÜ ÿ≠ÿ≥ÿßÿ®', password: 'boklyn123', icon: 'üèóÔ∏è', desc: 'ÿØ ÿ®Ÿà⁄©ŸÑ€åŸÜ ⁄©ÿßÿ±' },
            { id: 'mobile', name: 'ŸÖŸàÿ®ÿß€åŸÑ ÿ≠ÿ≥ÿßÿ®', password: 'mobile123', icon: 'üì±', desc: 'ÿØ ŸÖŸàÿ®ÿß€åŸÑŸàŸÜŸà ⁄©ÿßÿ±' },
            { id: 'home', name: '⁄©Ÿàÿ± ŸÖÿµÿßÿ±ŸÅ', password: 'home123', icon: 'üè†', desc: ' ÿØ ⁄©Ÿàÿ± Ÿàÿ±⁄ÅŸÜÿ¶ ÿÆÿ±⁄ÖŸá' }
        ];

        // Saudi Sub-Accounts Data
        const SAUDI_SUB_ACCOUNTS = [
            { id: 'saudi_12module', name: '12 ŸÖÿß⁄âŸÑ ÿ™ÿ±€êŸÑŸá 3125 ŸÜŸÖÿ®ÿ±', password: 'saudi123', icon: 'üöõ', image: './trailer_3125.jpg', desc: '12 ŸÖÿß⁄âŸÑ ÿ™ÿ±€êŸÑŸá' },
            { id: 'saudi_14module', name: '14 ŸÖÿß⁄âŸÑ ÿ™ÿ±€êŸÑŸá 6437 ŸÜŸÖÿ®ÿ±', password: 'saudi123', icon: 'üöö', image: './trailer_6437.jpg', desc: '14 ŸÖÿß⁄âŸÑ ÿ™ÿ±€êŸÑŸá' }
        ];

        // Home Sub-Accounts Data
        const HOME_SUB_ACCOUNTS = [
            { id: 'home_lalak', name: 'ŸÑŸÑ⁄©', password: 'home123', icon: 'üë®‚Äçüëß‚Äçüë¶', desc: 'ÿØ ŸÑŸÑ⁄© ŸÖÿµÿßÿ±ŸÅ', cardClass: 'home-card-lalak' },
            { id: 'home_saifullah', name: 'ÿ≥€åŸÅ ÿßŸÑŸÑŸá', password: 'home123', icon: 'üë§', desc: 'ÿØ ÿ≥€åŸÅ ÿßŸÑŸÑŸá ŸÖÿµÿßÿ±ŸÅ', cardClass: 'home-card-saifullah' },
            { id: 'home_saeedullah', name: 'ÿ≥ÿπ€åÿØ ÿßŸÑŸÑŸá', password: 'home123', icon: 'üë§', desc: 'ÿØ ÿ≥ÿπ€åÿØ ÿßŸÑŸÑŸá ŸÖÿµÿßÿ±ŸÅ', cardClass: 'home-card-saeedullah' },
            { id: 'home_siddiqullah', name: 'ÿµÿØ€åŸÇ ÿßŸÑŸÑŸá', password: 'home123', icon: 'üë§', desc: 'ÿØ ÿµÿØ€åŸÇ ÿßŸÑŸÑŸá ŸÖÿµÿßÿ±ŸÅ', cardClass: 'home-card-siddiqullah' },
            { id: 'home_adil', name: 'ÿπÿßÿØŸÑ', password: 'home123', icon: 'üë§', desc: 'ÿØ ÿπÿßÿØŸÑ ŸÖÿµÿßÿ±ŸÅ', cardClass: 'home-card-adil' }
        ];

        let currentJob = null;
        let currentPassword = null;
        let formDataToSubmit = null;
        let originalImageFile = null; // Store the original file
        let compressedImageBlob = null; // Store the compressed blob

        // Camera Variables
        let videoStream = null;
        let currentMode = 'photo';
        let html5QrCode = null;

        /* Currency Helper Functions */
        function openOpExpScreen() {
            document.getElementById('opExpScreen').classList.add('active');
            renderExpList('opExp');
        }
        function closeOpExpScreen() {
            document.getElementById('opExpScreen').classList.remove('active');
        }
        function openCapExpScreen() {
            document.getElementById('capExpScreen').classList.add('active');
            renderExpList('capExp');
        }
        function closeCapExpScreen() {
            document.getElementById('capExpScreen').classList.remove('active');
        }

        function handleOpExpSubmit(e) {
            e.preventDefault();
            saveExp('opExp');
        }
        function handleCapExpSubmit(e) {
            e.preventDefault();
            saveExp('capExp');
        }

        function saveExp(type) {
            const amount = document.getElementById(type + 'Amount').value;
            const date = document.getElementById(type + 'Date').value;
            const desc = document.getElementById(type + 'Desc').value;
            if(!amount || !date || !desc) return;

            const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
            list.push({ amount, date, desc, timestamp: Date.now() });
            localStorage.setItem(type + '_list', JSON.stringify(list));

            document.getElementById(type + 'Amount').value = '';
            document.getElementById(type + 'Desc').value = '';
            renderExpList(type);
            updateGeneralDashboard();
            showToast('success', 'ÿ±€å⁄©ÿßÿ±⁄â ÿ∞ÿÆ€åÿ±Ÿá ÿ¥Ÿà');
        }

        function renderExpList(type) {
            const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
            const container = document.getElementById(type + 'List');
            container.innerHTML = list.reverse().map(item => `
                <div class="data-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <div>
                        <div style="font-weight: bold;">${item.desc}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${item.date}</div>
                    </div>
                    <div style="font-weight: bold; color: ${type === 'opExp' ? '#f87171' : '#fb923c'}">${parseFloat(item.amount).toLocaleString()} ÿã</div>
                </div>
            `).join('');
        }

        /* Expenses Helpers */
        function openOpExpScreen() {
            document.getElementById('opExpScreen').classList.add('active');
            renderExpList('opExp');
        }
        function closeOpExpScreen() {
            document.getElementById('opExpScreen').classList.remove('active');
        }
        function openCapExpScreen() {
            document.getElementById('capExpScreen').classList.add('active');
            renderExpList('capExp');
        }
        function closeCapExpScreen() {
            document.getElementById('capExpScreen').classList.remove('active');
        }

        function handleOpExpSubmit(e) {
            e.preventDefault();
            saveExp('opExp');
        }
        function handleCapExpSubmit(e) {
            e.preventDefault();
            saveExp('capExp');
        }

        function saveExp(type) {
            const amount = document.getElementById(type + 'Amount').value;
            const date = document.getElementById(type + 'Date').value;
            const desc = document.getElementById(type + 'Desc').value;
            if(!amount || !date || !desc) return;

            const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
            list.push({ amount, date, desc, timestamp: Date.now() });
            localStorage.setItem(type + '_list', JSON.stringify(list));

            document.getElementById(type + 'Amount').value = '';
            document.getElementById(type + 'Desc').value = '';
            renderExpList(type);
            updateGeneralDashboard();
            showToast('success', 'ÿ±€å⁄©ÿßÿ±⁄â ÿ∞ÿÆ€åÿ±Ÿá ÿ¥Ÿà');
        }

        function renderExpList(type) {
            const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
            const container = document.getElementById(type + 'List');
            container.innerHTML = list.reverse().map(item => `
                <div class="data-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 5px;">
                    <div>
                        <div style="font-weight: bold;">${item.desc}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${item.date}</div>
                    </div>
                    <div style="font-weight: bold; color: ${type === 'opExp' ? '#f87171' : '#fb923c'}">${parseFloat(item.amount).toLocaleString()} ÿã</div>
                </div>
            `).join('');
        }

        function getCurrencyLabel() {
            if (currentJob && (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_'))) {
                return 'ÿ±.ÿ≥';
            }
            return 'ÿã';
        }

        function getCurrencyCode() {
            if (currentJob && (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_'))) {
                return 'SAR';
            }
            return 'AFN';
        }

        // --- DELETION LOGIC ---
        function deleteTransaction(timestamp) {
            if (!confirm('ÿ¢€åÿß ÿ∫Ÿàÿß⁄ìÿ¶ ÿØÿß ÿ±€å⁄©ÿßÿ±⁄â ÿ≠ÿ∞ŸÅ ⁄©⁄ìÿ¶ÿü')) return;

            let targetAccountId = currentJob.id;
            const accountSelector = document.getElementById('reportAccountSelector');
            const adminSelectContainer = document.getElementById('adminAccountSelectContainer');

            if (adminSelectContainer && adminSelectContainer.style.display !== 'none' && accountSelector && accountSelector.value !== 'current') {
                targetAccountId = accountSelector.value;
            }

            let history = JSON.parse(localStorage.getItem('history_' + targetAccountId) || '[]');
            const initialLength = history.length;

            // Filter out the item with the matching timestamp
            // Note: Old data might not have timestamp, but new ones do.
            // If no timestamp, we might need another strategy, but for now assuming timestamp exists as per line 2569
            history = history.filter(item => {
                // Handle legacy data without timestamp if necessary (though difficult without unique ID)
                if (item.timestamp) {
                    return item.timestamp != timestamp;
                }
                return true; // Keep items without timestamp to be safe or delete by index? Timestamp is safer.
            });

            if (history.length < initialLength) {
                localStorage.setItem('history_' + targetAccountId, JSON.stringify(history));

                // Recalculate Stats from scratch
                recalculateStats(targetAccountId);

                showToast('success', 'ÿ±€å⁄©ÿßÿ±⁄â ÿ≠ÿ∞ŸÅ ÿ¥Ÿà');
                filterReportByDuration(); // Refresh list

                // If dashboard is open, update it too
                if(document.getElementById('dashboardScreen').classList.contains('active')) {
                    updateDashboardStats(targetAccountId);
                }
            } else {
                showToast('error', 'ÿ™€êÿ±Ÿàÿ™ŸÜŸá', 'ÿ±€å⁄©ÿßÿ±⁄â ŸàŸÜŸá ŸÖŸàŸÜÿØŸÑ ÿ¥Ÿà');
            }
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ÿÆÿ∑ÿ±: ÿ¢€åÿß ÿ™ÿßÿ≥Ÿà ⁄âÿß⁄âŸá €åÿßÿ≥ÿ™ ⁄Ü€ê ÿØ ÿØ€ê ÿ≠ÿ≥ÿßÿ® ŸºŸàŸÑ ÿ±€å⁄©ÿßÿ±⁄âŸàŸÜŸá ÿ≠ÿ∞ŸÅ ⁄©ŸàŸÑ ÿ∫Ÿàÿß⁄ìÿ¶ÿü\n\nÿØÿß ÿπŸÖŸÑ ÿØ ÿ®€êÿ±ÿ™Ÿá ÿ±ÿß⁄´ÿ±⁄ÅŸàŸÑŸà Ÿà⁄ì ŸÜŸá ÿØ€å!')) return;

            const userInput = prompt('ÿØ ÿ™ÿß€å€åÿØ ŸÑŸæÿßÿ±Ÿá "delete" ŸàŸÑ€å⁄©ÿ¶:');
            if (userInput !== 'delete') {
                if (userInput !== null) showToast('error', 'ÿ™€êÿ±Ÿàÿ™ŸÜŸá', 'ÿ™ÿß€å€åÿØ ŸÜÿß⁄©ÿßŸÖ ÿ¥Ÿà');
                return;
            }

            let targetAccountId = currentJob.id;
            const accountSelector = document.getElementById('reportAccountSelector');
            const adminSelectContainer = document.getElementById('adminAccountSelectContainer');

            if (adminSelectContainer && adminSelectContainer.style.display !== 'none' && accountSelector && accountSelector.value !== 'current') {
                targetAccountId = accountSelector.value;
            }

            // Clear History
            localStorage.setItem('history_' + targetAccountId, '[]');

            // Reset Stats
            localStorage.setItem('stats_' + targetAccountId, JSON.stringify({income: 0, expense: 0}));

            // Reset Balance (Only for Home Accounts if needed, or generally)
            if (targetAccountId.startsWith('home_')) {
                 // For shared balance, we might want to keep it or reset it? 
                 // User asked to delete "written data". Usually implies transactions history.
                 // Balance is separate in localStorage 'home_shared_balance'.
                 // I will leave shared balance alone as it is "Shared".
            }

            showToast('success', '‚ú® ŸºŸàŸÑ ÿ±€å⁄©ÿßÿ±⁄âŸàŸÜŸá Ÿæÿß⁄© ÿ¥ŸàŸÑ');
            filterReportByDuration();

            if(document.getElementById('dashboardScreen').classList.contains('active')) {
                updateDashboardStats(targetAccountId);
            }
        }

        function recalculateStats(accountId) {
            let history = JSON.parse(localStorage.getItem('history_' + accountId) || '[]');
            let income = 0;
            let expense = 0;

            const isSaudiOrBoklyn = accountId === 'saudi' || accountId.startsWith('saudi_') || accountId === 'boklyn';
            const isMobile = accountId === 'mobile';

            history.forEach(item => {
                income += parseFloat(item.income || 0);
                
                let rowExpense = parseFloat(item.expense || 0);
                if (isSaudiOrBoklyn) {
                    rowExpense += parseFloat(item.sentToHome || 0);
                    rowExpense += parseFloat(item.driverSalary || 0);
                } else if (isMobile) {
                    rowExpense += parseFloat(item.sentToHomeMobile || 0);
                    rowExpense += parseFloat(item.shopRent || 0);
                }
                expense += rowExpense;
            });

            localStorage.setItem('stats_' + accountId, JSON.stringify({income, expense}));
        }

        // --- GENERAL DASHBOARD LOGIC ---

        function openGeneralDashboardAuth() {
            // Set a special job context for General Dashboard
            currentJob = { 
                id: 'general_dashboard_admin', 
                name: 'ÿπŸÖŸàŸÖŸä ŸÖÿßŸÑŸä ⁄âÿ¥ÿ®Ÿàÿ±⁄â', 
                icon: 'üìä' 
            };

            // We don't set a single 'currentPassword' because we accept multiple.
            // The checkPassword function will handle this special ID.

            document.getElementById('jobSelectionScreen').classList.add('hidden');
            document.getElementById('passwordScreen').classList.remove('hidden');

            // Update password screen title for this context
            document.querySelector('#passwordScreen .password-title').textContent = 'ÿπŸÖŸàŸÖŸä ŸÖÿßŸÑŸä ⁄âÿ¥ÿ®Ÿàÿ±⁄â';
            document.querySelector('#passwordScreen .password-subtitle').textContent = 'üîê ÿØ ŸÜŸÜŸàÿ™ŸÑŸà ŸÑŸæÿßÿ±Ÿá Ÿæÿßÿ≥Ÿàÿ±⁄â ŸàŸÑ€å⁄©ÿ¶';

            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
        }

        function openGeneralDashboard() {
            document.getElementById('jobSelectionScreen').classList.add('hidden');
            document.getElementById('passwordScreen').classList.add('hidden'); // Ensure password screen is closed
            document.getElementById('generalDashboardScreen').classList.remove('hidden');
            updateGeneralDashboard();
        }

        function closeGeneralDashboard() {
            document.getElementById('generalDashboardScreen').classList.add('hidden');
            document.getElementById('jobSelectionScreen').classList.remove('hidden');
        }

        let dashboardChart = null;
        function initDashboardChart() {
            const ctx = document.getElementById('dashboardChart');
            if (!ctx) return;
            if (dashboardChart) dashboardChart.destroy();
            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['ÿ¨ÿØŸä', 'ÿØŸÑŸà', 'ÿ≠Ÿàÿ™', 'ÿ≠ŸÖŸÑ', 'ÿ´Ÿàÿ±', 'ÿ¨Ÿàÿ≤ÿß'],
                    datasets: [{
                        label: 'ÿπÿß€åÿØ',
                        data: [12000, 19000, 3000, 5000, 2000, 3000],
                        borderColor: '#6ee7b7',
                        backgroundColor: 'rgba(110, 231, 183, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'ŸÖÿµÿ±ŸÅ',
                        data: [8000, 15000, 5000, 2000, 8000, 4000],
                        borderColor: '#fca5a5',
                        backgroundColor: 'rgba(252, 165, 165, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8', font: { family: 'Noto Naskh Arabic' } }
                        }
                    },
                    scales: {
                        y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
        }

        function updateGeneralDashboard() {
            console.log('Updating simplified dashboard');
            let totalWorth = 0;
            let totalIncome = 0;
            let totalExpense = 0;
            let totalReceivable = 0;
            let totalLiability = 0;

            const SAR_TO_AFN = 18.5; 

            // 1. Calculate from Jobs
            JOBS.forEach(job => {
                if (job.id === 'saudi' || job.id === 'home') return;
                const stats = JSON.parse(localStorage.getItem('stats_' + job.id) || '{"income": 0, "expense": 0}');
                totalIncome += parseFloat(stats.income || 0);
                totalExpense += parseFloat(stats.expense || 0);
            });

            // 2. Saudi Accounts
            SAUDI_SUB_ACCOUNTS.forEach(acc => {
                const bal = getBal(acc.id);
                totalWorth += (bal * SAR_TO_AFN);
                const stats = getStats(acc.id);
                totalIncome += (stats.income * SAR_TO_AFN);
                totalExpense += (stats.expense * SAR_TO_AFN);
            });

            // 3. Home Accounts
            // HOME_SUB_ACCOUNTS.forEach(acc => {
            //    const bal = getBal(acc.id);
            //    totalWorth += bal;
            //    const stats = getStats(acc.id);
            //    totalIncome += stats.income;
            //    totalExpense += stats.expense;
            // });

            // 4. Debts
            const debts = JSON.parse(localStorage.getItem('debt_data') || '[]');
            debts.forEach(d => {
                const amt = parseFloat(d.amount);
                if (d.type === 'receivable') {
                    totalReceivable += amt;
                    totalWorth += amt;
                } else {
                    totalLiability += amt;
                    totalWorth -= amt;
                }
            });

            // Add cash on hand (net from jobs)
            totalWorth += (totalIncome - totalExpense);

            // Update UI
            if (document.getElementById('dashTotalWorth')) document.getElementById('dashTotalWorth').textContent = Math.round(totalWorth).toLocaleString();
            if (document.getElementById('dashNetProfit')) document.getElementById('dashNetProfit').textContent = Math.round(totalIncome - totalExpense).toLocaleString();
            if (document.getElementById('dashTotalIncome')) document.getElementById('dashTotalIncome').textContent = Math.round(totalIncome).toLocaleString();
            if (document.getElementById('dashTotalExpense')) document.getElementById('dashTotalExpense').textContent = Math.round(totalExpense).toLocaleString();
            if (document.getElementById('dashReceivable')) document.getElementById('dashReceivable').textContent = totalReceivable.toLocaleString();
            if (document.getElementById('dashLiability')) document.getElementById('dashLiability').textContent = totalLiability.toLocaleString();

            // Monthly Growth calculation (Mock comparison)
            const prevWorth = parseFloat(localStorage.getItem('prev_total_worth') || totalWorth);
            const growth = prevWorth > 0 ? ((totalWorth - prevWorth) / prevWorth * 100).toFixed(2) : "0";
            if (document.getElementById('dashGrowth')) document.getElementById('dashGrowth').textContent = growth;

            localStorage.setItem('prev_total_worth', totalWorth.toString());
        }

        function editDashValue(key) {
            const current = localStorage.getItem('gen_dash_' + key) || '0';
            let label = '';

            switch(key) {
                case 'inventory': label = 'ÿØ ⁄´ÿØÿßŸÖ ÿØ ŸÖŸàÿ¨ŸàÿØŸá ŸÖÿßŸÑ ÿßÿ±ÿ≤⁄öÿ™:'; break;
                case 'opExp': label = 'ÿπŸÖŸÑ€åÿßÿ™Ÿä ŸÖÿµÿßÿ±ŸÅ (⁄©ÿ±ÿß€åŸáÿå ŸÖÿπÿßÿ¥ÿå ŸÜŸàÿ±):'; break;
                case 'capExp': label = 'ŸæÿßŸÜ⁄´€åÿ≤ ŸÖÿµÿßÿ±ŸÅ (ŸÖÿßÿ¥€åŸÜÿå ÿ™ÿ¨Ÿá€åÿ≤ÿßÿ™ÿå ŸÜŸàÿ±):'; break;
                case 'initial_capital': label = 'ŸÑŸàŸÖ⁄ìŸÜ€ç ÿ≥ÿ±ŸÖÿß€åŸá (ÿØ ⁄´Ÿº€ê ŸÖÿπŸÑŸàŸÖŸàŸÑŸà ŸÑŸæÿßÿ±Ÿá):'; break;
                case 'last_month_worth': label = 'ÿØ ÿ™€åÿ±€ê ŸÖ€åÿßÿ¥ÿ™€ê ŸºŸàŸÑŸá ÿ≥ÿ±ŸÖÿß€åŸá (ÿØ ŸàÿØ€ê ŸÑŸæÿßÿ±Ÿá):'; break;
                default: label = 'ŸÖŸÇÿØÿßÿ± ŸàŸºÿß⁄©ÿ¶:';
            }

            const newVal = prompt(label + "\n\nÿßŸàÿ≥ŸÜ€ç ÿßŸÜÿØÿßÿ≤Ÿá: " + current, current);

            if (newVal !== null && !isNaN(newVal) && newVal.trim() !== '') {
                localStorage.setItem('gen_dash_' + key, newVal);
                updateGeneralDashboard();
                showToast('success', 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™ÿßÿ≤Ÿá ÿ¥ŸàŸÑ');
            }
        }

        function initJobSelector() {
            const container = document.getElementById('jobGrid');
            container.innerHTML = JOBS.map(job => `
                <div class="job-card" onclick="selectJob('${job.id}', '${job.name}', '${job.password}', '${job.icon}')">
                    <div class="job-icon">${job.icon}</div>
                    <div class="job-name">${job.name}</div>
                    <div class="job-desc">${job.desc}</div>
                </div>
            `).join('');
        }

        function initSaudiSubAccountSelector() {
            const container = document.getElementById('saudiSubAccountGrid');
            container.innerHTML = SAUDI_SUB_ACCOUNTS.map(account => `
                <div class="job-card" onclick="selectSaudiSubAccount('${account.id}', '${account.name}', '${account.password}', '${account.image}')">
                    ${account.image ? `
                        <img src="${account.image}" alt="${account.name}" class="job-image" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="job-icon job-image-error">${account.icon}</div>
                    ` : `
                        <div class="job-icon">${account.icon}</div>
                    `}
                    <div class="job-name">${account.name}</div>
                    <div class="job-desc">${account.desc}</div>
                </div>
            `).join('');
        }

        function initHomeSubAccountSelector() {
            const container = document.getElementById('homeSubAccountGrid');
            container.innerHTML = HOME_SUB_ACCOUNTS.map(account => `
                <div class="job-card ${account.cardClass}" onclick="selectHomeSubAccount('${account.id}', '${account.name}', '${account.password}', '${account.icon}')">
                    <div class="job-icon">${account.icon}</div>
                    <div class="job-name">${account.name}</div>
                    <div class="job-desc">${account.desc}</div>
                </div>
            `).join('');
        }

        function selectJob(jobId, jobName, password, icon) {
            if (jobId === 'saudi') {
                document.getElementById('jobSelectionScreen').classList.add('hidden');
                document.getElementById('saudiSubAccountScreen').classList.remove('hidden');
            } else if (jobId === 'home') {
                document.getElementById('jobSelectionScreen').classList.add('hidden');
                document.getElementById('homeSubAccountScreen').classList.remove('hidden');
            } else {
                currentJob = { id: jobId, name: jobName, icon: icon };
                currentPassword = password;
                document.getElementById('jobSelectionScreen').classList.add('hidden');
                document.getElementById('passwordScreen').classList.remove('hidden');
                setTimeout(() => document.getElementById('passwordInput').focus(), 100);
            }
        }

        function selectSaudiSubAccount(subId, subName, password, image) {
            currentJob = { id: subId, name: subName, image: image, icon: 'üöõ' };
            currentPassword = password;
            document.getElementById('saudiSubAccountScreen').classList.add('hidden');
            document.getElementById('passwordScreen').classList.remove('hidden');
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
        }

        function selectHomeSubAccount(subId, subName, password, icon) {
            currentJob = { id: subId, name: subName, icon: icon };
            currentPassword = password;
            document.getElementById('homeSubAccountScreen').classList.add('hidden');
            document.getElementById('passwordScreen').classList.remove('hidden');
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
        }

        function backFromSaudiSubAccount() {
            document.getElementById('saudiSubAccountScreen').classList.add('hidden');
            document.getElementById('jobSelectionScreen').classList.remove('hidden');
        }

        function backFromHomeSubAccount() {
            document.getElementById('homeSubAccountScreen').classList.add('hidden');
            document.getElementById('jobSelectionScreen').classList.remove('hidden');
        }

        function backToJobs() {
            document.getElementById('passwordScreen').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';

             // Check if we were coming from General Dashboard Auth
            if (currentJob && currentJob.id === 'general_dashboard_admin') {
                 document.getElementById('jobSelectionScreen').classList.remove('hidden');
                 currentJob = null;
                 return;
            }

            if (currentJob && currentJob.id.startsWith('saudi_')) {
                document.getElementById('saudiSubAccountScreen').classList.remove('hidden');
            } else if (currentJob && currentJob.id.startsWith('home_')) {
                document.getElementById('homeSubAccountScreen').classList.remove('hidden');
            } else {
                document.getElementById('jobSelectionScreen').classList.remove('hidden');
            }
            currentJob = null;
        }

        // --- IMAGE LOGIC ---

        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                originalImageFile = input.files[0];
                processImage(originalImageFile);
            }
        }

        function processImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const maxWidth = 1600; 
                    const maxHeight = 1600;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');

                    // Standard Draw
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        compressedImageBlob = blob;

                        const previewUrl = URL.createObjectURL(blob);
                        document.getElementById('previewImg').src = previewUrl;
                        document.getElementById('imagePreview').style.display = 'block';
                        document.getElementById('billImageArea').style.borderColor = '#10b981';
                        document.getElementById('billImageArea').style.background = 'rgba(16, 185, 129, 0.1)';

                        const originalSize = (file.size / 1024).toFixed(1) + ' KB';
                        const compressedSize = (blob.size / 1024).toFixed(1) + ' KB';

                        document.getElementById('compressionInfo').innerHTML = `ÿßÿµŸÑ€å: ${originalSize} <br> ⁄©ŸÖŸæÿ±€åÿ≥ ÿ¥Ÿà€å: <span style="color: #fff; font-weight:bold;">${compressedSize}</span>`;

                    }, 'image/jpeg', 0.7);
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        function removeImage() {
            if(document.getElementById('billImageGallery')) document.getElementById('billImageGallery').value = '';

            originalImageFile = null;
            compressedImageBlob = null;

            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('billImageArea').style.borderColor = 'rgba(139, 92, 246, 0.3)';
            document.getElementById('billImageArea').style.background = 'rgba(255, 255, 255, 0.05)';
        }


        let currentReportData = [];

        function openReport() {
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('reportScreen').classList.remove('hidden');

            document.getElementById('reportTitle').textContent = `ÿØ ${currentJob.name} ÿ±ÿßŸæŸàÿ±`;

            // Reset filters
            document.getElementById('reportSearchText').value = '';
            document.getElementById('reportStartDate').value = '';
            document.getElementById('reportEndDate').value = '';

            // Load Data
            const storageKey = 'history_' + currentJob.id;
            let rawData = JSON.parse(localStorage.getItem(storageKey) || '[]');

            // Legacy Fallback
            if (rawData.length === 0) {
                 const legacyTrans = JSON.parse(localStorage.getItem('transactions') || '[]');
                 const filteredLegacy = legacyTrans.filter(t => t.workType === currentJob.id);
                 if (filteredLegacy.length > 0) rawData = filteredLegacy;
            }

            currentReportData = rawData;
            filterReport();
        }

        // Alias for compatibility with deleteTransaction
        function filterReportByDuration() {
            filterReport();
        }

        function filterReport() {
            const searchText = document.getElementById('reportSearchText').value.toLowerCase();
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            let filtered = currentReportData.filter(item => {
                const dateMatch = (!startDate || item.date >= startDate) && (!endDate || item.date <= endDate);
                const textMatch = !searchText || 
                                  (item.detail && item.detail.toLowerCase().includes(searchText)) ||
                                  (item.category && item.category.toLowerCase().includes(searchText)) ||
                                  (item.note && item.note.toLowerCase().includes(searchText));
                return dateMatch && textMatch;
            });

            renderReportTable(filtered);
            updateReportStats(filtered);
        }

        function clearReportFilters() {
            document.getElementById('reportSearchText').value = '';
            document.getElementById('reportStartDate').value = '';
            document.getElementById('reportEndDate').value = '';
            filterReport();
        }

        function renderReportTable(data) {
            const tableBody = document.getElementById('reportTableBody');

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="padding: 30px; text-align: center; color: #94a3b8;">ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÜÿ¥ÿ™Ÿá</td></tr>';
                return;
            }

            const sorted = data.slice().sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));

            tableBody.innerHTML = sorted.reverse().map(t => {
                const inc = parseFloat(t.income || 0);
                const exp = parseFloat(t.expense || 0);

                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px 15px; font-size: 13px;">${t.date}</td>
                        <td style="padding: 12px 15px; font-size: 13px;">
                            ${t.detail || '-'}
                            ${t.note ? `<div style="font-size:11px; color:#64748b;">${t.note}</div>` : ''}
                        </td>
                        <td style="padding: 12px 15px; color: #10b981; font-weight: 600;">${inc > 0 ? inc.toLocaleString() : '-'}</td>
                        <td style="padding: 12px 15px; color: #ef4444; font-weight: 600;">${exp > 0 ? exp.toLocaleString() : '-'}</td>
                        <td style="padding: 12px 15px; text-align: center;">
                            <button onclick="deleteTransaction(${t.timestamp})" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; border-radius: 8px; padding: 5px 10px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateReportStats(data) {
            let totalIncome = 0;
            let totalExpense = 0;
            
            const isSaudiOrBoklyn = currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_') || currentJob.id === 'boklyn';
            const isMobile = currentJob.id === 'mobile';

            data.forEach(t => {
                totalIncome += parseFloat(t.income || 0);
                
                let rowExpense = parseFloat(t.expense || 0);
                
                if (isSaudiOrBoklyn) {
                    // Saudi/Boklyn logic: expense + sentToHome + driverSalary
                    rowExpense += parseFloat(t.sentToHome || 0);
                    rowExpense += parseFloat(t.driverSalary || 0);
                } else if (isMobile) {
                    // Mobile logic: expense + sentToHomeMobile + shopRent
                    rowExpense += parseFloat(t.sentToHomeMobile || 0);
                    rowExpense += parseFloat(t.shopRent || 0);
                }
                
                totalExpense += rowExpense;
            });
            
            document.getElementById('reportTotalIncome').textContent = totalIncome.toLocaleString();
            document.getElementById('reportTotalExpense').textContent = totalExpense.toLocaleString();
            document.getElementById('reportNetBalance').textContent = (totalIncome - totalExpense).toLocaleString();
        }

        function closeReport() {
            document.getElementById('reportScreen').classList.add('hidden');
            document.getElementById('formContainer').classList.remove('hidden');
        }

        function logout() {
            document.getElementById('formContainer').classList.add('hidden');

            // Check where to go back based on current job type
            if (currentJob && currentJob.id.startsWith('home_')) {
                document.getElementById('homeSubAccountScreen').classList.remove('hidden');
                document.getElementById('jobSelectionScreen').classList.add('hidden');
            } else if (currentJob && currentJob.id.startsWith('saudi_')) {
                document.getElementById('saudiSubAccountScreen').classList.remove('hidden');
                document.getElementById('jobSelectionScreen').classList.add('hidden');
            } else {
                document.getElementById('jobSelectionScreen').classList.remove('hidden');
            }

            document.getElementById('passwordScreen').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('trailerForm').reset();
            currentJob = null;

            // Reset category selection visually
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('customCategoryInput').style.display = 'none';
            removeImage(); // Clear image

            // Reset new fields
            document.getElementById('sentToHomeGroup').style.display = 'none';
            document.getElementById('driverSalaryGroup').style.display = 'none';
            document.getElementById('sentToHomeMobileGroup').style.display = 'none';
            document.getElementById('shopRentGroup').style.display = 'none';

            document.getElementById('sentToHome').value = '';
            document.getElementById('driverSalary').value = '';
            document.getElementById('sentToHomeMobile').value = '';
            document.getElementById('shopRent').value = '';
        }

        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('passwordError');

            // 1. General Dashboard Admin Check
            if (currentJob && currentJob.id === 'general_dashboard_admin') {
                const validAdmins = ['home123', 'saudi123', 'mobile123', 'boklyn123', 'admin'];
                if (validAdmins.includes(password)) {
                    errorDiv.style.display = 'none';
                    document.getElementById('passwordInput').value = ''; // Clear input
                    openGeneralDashboard();
                } else {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = '‚ùå Ÿæÿßÿ≥Ÿàÿ±⁄â ÿ∫ŸÑÿ∑ ÿØÿ¶';
                    document.getElementById('passwordInput').classList.add('shake');
                    setTimeout(() => document.getElementById('passwordInput').classList.remove('shake'), 500);
                }
                return; // Stop here
            }

            // 2. Normal Job/Sub-Account Check
            if (password === currentPassword) {
                // Hide report button by default
                const reportNavBtn = document.getElementById('reportNavBtn');
                if (reportNavBtn) reportNavBtn.style.display = 'none';

                // Show report button ONLY for Saudi, Boklyn, and Mobile accounts
                const allowedReportIds = ['saudi', 'boklyn', 'mobile'];
                const isHomeAccount = currentJob.id.startsWith('home_');
                const isSaudiSub = currentJob.id.startsWith('saudi_');

                if (isHomeAccount) {
                    if (document.getElementById('dashboardBtn')) document.getElementById('dashboardBtn').style.display = 'none';
                    if (document.getElementById('reportNavBtn')) document.getElementById('reportNavBtn').style.display = 'none';
                } else {
                    if (document.getElementById('dashboardBtn')) document.getElementById('dashboardBtn').style.display = 'inline-flex';
                    if (allowedReportIds.includes(currentJob.id) || isSaudiSub) {
                        if (document.getElementById('reportNavBtn')) document.getElementById('reportNavBtn').style.display = 'inline-flex';
                    } else {
                        if (document.getElementById('reportNavBtn')) document.getElementById('reportNavBtn').style.display = 'none';
                    }
                }

                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('formContainer').classList.remove('hidden');
                const dateInput = document.getElementById('date');
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                errorDiv.style.display = 'none';

                // Display the selected job/sub-account info
                if (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_')) {
                    document.getElementById('currency').value = 'SAR';
                    document.getElementById('currency').disabled = true;
                } else if (currentJob.id === 'boklyn' || currentJob.id === 'mobile') {
                    document.getElementById('currency').value = 'AFN';
                    document.getElementById('currency').disabled = true;
                } else {
                    document.getElementById('currency').value = 'AFN';
                    document.getElementById('currency').disabled = false;
                }

                // Show/Hide specific fields for Saudi/Brooklyn
                const isSaudiOrBrooklyn = (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_') || currentJob.id === 'boklyn');
                const isMobile = (currentJob.id === 'mobile');

                if (isSaudiOrBrooklyn) {
                    document.getElementById('sentToHomeGroup').style.display = 'block';
                    document.getElementById('driverSalaryGroup').style.display = 'block';
                } else {
                    document.getElementById('sentToHomeGroup').style.display = 'none';
                    document.getElementById('driverSalaryGroup').style.display = 'none';
                }

                if (isMobile) {
                    document.getElementById('sentToHomeMobileGroup').style.display = 'block';
                    document.getElementById('shopRentGroup').style.display = 'block';
                } else {
                    document.getElementById('sentToHomeMobileGroup').style.display = 'none';
                    document.getElementById('shopRentGroup').style.display = 'none';
                }

                if (currentJob.image) {
                    document.getElementById('currentJobIcon').innerHTML = `<img src="${currentJob.image}" alt="${currentJob.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3);">`;
                } else {
                    document.getElementById('currentJobIcon').textContent = currentJob.icon || JOBS.find(job => job.id === currentJob.id)?.icon || 'üïå';
                }
                document.getElementById('currentJobName').textContent = currentJob.name;

                // --- SHARED BALANCE & CATEGORY LOGIC ---
                if (currentJob.id.startsWith('home_')) {
                    document.getElementById('balanceSection').style.display = 'block';
                    if(document.getElementById('dashboardBtn')) document.getElementById('dashboardBtn').innerHTML = 'üìä ⁄âÿ¥ÿ®Ÿàÿ±⁄â';
                    updateBalanceDisplay();

                    // Show New Fields
                    document.getElementById('homeFields').style.display = 'block';

                    // Hide Old Fields
                    document.getElementById('dateGroup').style.display = 'none';
                    document.getElementById('expenseGroup').style.display = 'none';
                    document.getElementById('categoryGroup').style.display = 'none';
                    document.getElementById('noteGroup').style.display = 'none';
                    document.getElementById('incomeGroup').style.display = 'none';
                    document.getElementById('detailGroup').style.display = 'none';
                    document.getElementById('imageGroup').style.display = 'none';
                    document.getElementById('date').required = false;
                    document.getElementById('expense').required = false;

                    // Hide submit buttons for home accounts, show X button in header
                    document.getElementById('submitBtnWrapper').style.display = 'none';
                    document.getElementById('homeLogoutBtn').style.display = 'flex';


                    // Admin check
                    if (currentJob.name === 'ÿ≥€åŸÅ ÿßŸÑŸÑŸá') {
                        document.getElementById('editBalanceBtn').style.display = 'inline-block';
                    } else {
                        document.getElementById('editBalanceBtn').style.display = 'none';
                    }

                    // Remove Report Function for specific Home Accounts
                    // Fixed: 'ÿ≥ÿπ€åÿØÿßŸÑŸÑŸá' should be 'ÿ≥ÿπ€åÿØ ÿßŸÑŸÑŸá'
                    const restrictedHomeAccounts = ['ŸÑŸÑ⁄©', 'ÿ≥€åŸÅ ÿßŸÑŸÑŸá', 'ÿ≥ÿπ€åÿØ ÿßŸÑŸÑŸá', 'ÿµÿØ€åŸÇ ÿßŸÑŸÑŸá', 'ÿπÿßÿØŸÑ'];

                } else {
                    document.getElementById('balanceSection').style.display = 'none';
                    if(document.getElementById('dashboardBtn')) document.getElementById('dashboardBtn').innerHTML = 'üìä ⁄âÿ¥ÿ®Ÿàÿ±⁄â';
                    document.getElementById('submitBtnWrapper').style.display = 'flex';
                    document.getElementById('homeLogoutBtn').style.display = 'none';


                    document.getElementById('homeFields').style.display = 'none';
                    document.getElementById('dateGroup').style.display = 'block';
                    document.getElementById('expenseGroup').style.display = 'block';
                    document.getElementById('categoryGroup').style.display = 'none';
                    document.getElementById('noteGroup').style.display = 'block';
                    document.getElementById('incomeGroup').style.display = 'block';
                    document.getElementById('detailGroup').style.display = 'block';
                    document.getElementById('imageGroup').style.display = 'block';
                    document.getElementById('date').required = true;
                    document.getElementById('expense').required = true;
                    document.getElementById('category').required = false;
                }

            } else {
                errorDiv.style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        function updateBalanceDisplay() {
            const bal = localStorage.getItem('home_shared_balance') || '25000';
            document.getElementById('balanceValue').textContent = parseInt(bal).toLocaleString();

            // Changed from < 5000 to <= 5000 as per request "remains 5000"
            if (parseInt(bal) <= 5000) {
                showToast('warning', 'ÿÆÿ®ÿ±ÿ™€åÿß!', 'ÿØ ⁄©Ÿàÿ± ⁄´⁄â ÿ®€åŸÑÿßŸÜÿ≥ 5000 ÿßŸÅÿ∫ÿßŸÜ€åŸà €åÿß ⁄©ŸÖ ÿØ€å!');
                document.getElementById('balanceSection').style.border = '2px solid #ef4444';
            } else {
                document.getElementById('balanceSection').style.border = '1px solid rgba(16, 185, 129, 0.3)';
            }
        }

        function editBalance() {
            const current = localStorage.getItem('home_shared_balance') || '0';
            const newBal = prompt("ŸÜŸà€å ÿ®€åŸÑÿßŸÜÿ≥ ÿØÿßÿÆŸÑ ⁄©⁄ìÿ¶:", current);
            if (newBal !== null && !isNaN(newBal) && newBal.trim() !== '') {
                localStorage.setItem('home_shared_balance', newBal);
                updateBalanceDisplay();

                // Send to Google Sheets
                const url = new URL(GOOGLE_SHEETS_URL);
                const params = {
                    date: new Date().toISOString().split('T')[0],
                    workType: currentJob.id,
                    balanceUpdate: 'true',
                    newBalance: newBal,
                    oldBalance: current
                };
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

                fetch(url.toString(), { method: 'GET' }).catch(err => console.log('Balance update sent'));

                showToast('success', '‚úì ÿ®€åŸÑÿßŸÜÿ≥ ÿ™ÿßÿ≤Ÿá ÿ¥Ÿà');
            }
        }

        document.getElementById('passwordInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') checkPassword();
        });

        function saveTransaction(e) {
            e.preventDefault();

            if (currentJob.id.startsWith('home_')) {
                // Home accounts - not needed, data goes to Google Sheets directly
                return;
            }

            const rawIncome = document.getElementById('income').value;
            const rawExpense = document.getElementById('expense').value;

            const income = parseFloat(rawIncome || 0);
            const expense = parseFloat(rawExpense || 0);
            const date = document.getElementById('date').value;
            const detail = document.getElementById('detail').value;
            const note = document.getElementById('note').value;
            const category = document.getElementById('category').value;
            const currency = document.getElementById('currency').value;
            const sentToHome = document.getElementById('sentToHome').value;
            const driverSalary = document.getElementById('driverSalary').value;
            const sentToHomeMobile = document.getElementById('sentToHomeMobile').value;
            const shopRent = document.getElementById('shopRent').value;

            const expenseError = document.getElementById('expenseError');
            const incomeError = document.getElementById('incomeError');
            let hasError = false;

            // Validation for Expense
            if (rawExpense === '' || parseFloat(rawExpense) < 0) {
                expenseError.classList.add('show');
                hasError = true;
            } else {
                expenseError.classList.remove('show');
            }

            // Validation for Income (if visible)
            const incomeGroup = document.getElementById('incomeGroup');
            if (incomeGroup && incomeGroup.style.display !== 'none') {
                if (rawIncome === '' || parseFloat(rawIncome) < 0) {
                     incomeError.classList.add('show');
                     hasError = true;
                } else {
                     incomeError.classList.remove('show');
                }
            }

            if (!date) {
                showToast('error', 'ŸÜ€êŸºŸá ŸàŸºÿß⁄©ÿ¶');
                hasError = true;
            }

            if (hasError) return;

            const dateParts = date.split('-');
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

            formDataToSubmit = {
                income,
                expense,
                date,
                formattedDate,
                detail,
                note,
                category,
                currency,
                sentToHome,
                driverSalary,
                sentToHomeMobile,
                shopRent,
                timestamp: Date.now(),
                isHomeNew: currentJob.id.startsWith('home_'),
                familyMembers: document.getElementById('familyMembers') ? document.getElementById('familyMembers').value : '',
                individualRight: document.getElementById('individualRight') ? document.getElementById('individualRight').value : '',
                actualPayment: document.getElementById('actualPayment') ? document.getElementById('actualPayment').value : '',
                difference: document.getElementById('difference') ? document.getElementById('difference').value : '',
                status: document.getElementById('status') ? document.getElementById('status').value : '',
                remainingCash: document.getElementById('remainingCash') ? document.getElementById('remainingCash').value : ''
            };
            showModal();
        }

        document.getElementById('trailerForm').addEventListener('submit', saveTransaction);

        function showModal() {
            if (formDataToSubmit && formDataToSubmit.isHomeNew) {
                 let summary = `
                    <div style="text-align: right; direction: rtl; line-height: 2;">
                        <p><strong>ÿØ ⁄©Ÿàÿ±ŸÜ€ç ÿßŸÅÿ±ÿßÿØ:</strong> ${formDataToSubmit.familyMembers}</p>
                        <p><strong>ŸÅÿ±ÿØŸä ÿ≠ŸÇ:</strong> ${formDataToSubmit.individualRight}</p>
                        <p><strong>ÿ≠ŸÇ€åŸÇŸä Ÿàÿ±⁄©⁄ìŸá:</strong> ${formDataToSubmit.actualPayment}</p>
                        <p><strong>ÿ™ŸàŸæ€åÿ±:</strong> ${formDataToSubmit.difference}</p>
                        <p><strong>ÿ≠ÿßŸÑÿ™:</strong> ${formDataToSubmit.status}</p>
                        <p><strong>Ÿæÿßÿ™€ê ŸÜÿ∫ÿØ€åŸá:</strong> ${formDataToSubmit.remainingCash}</p>
                    </div>
                 `;
                 document.getElementById('confirmDetail').innerHTML = summary;

                 // Hide specific rows
                 document.getElementById('confirmDate').parentElement.parentElement.style.display = 'none';
                 document.getElementById('categoryRow').style.display = 'none';
                 document.getElementById('imageRow').style.display = 'none';
                 document.getElementById('noteRow').style.display = 'none';

                 document.getElementById('modalOverlay').classList.add('active');
                 return;
            }
            if (document.getElementById('confirmDate').parentElement && document.getElementById('confirmDate').parentElement.parentElement) {
                document.getElementById('confirmDate').parentElement.parentElement.style.display = 'flex';
            }
            document.getElementById('confirmDate').textContent = formDataToSubmit.formattedDate;
            document.getElementById('confirmExpense').textContent = formDataToSubmit.expense || '0';
            document.getElementById('confirmDetail').textContent = formDataToSubmit.detail || 'ŸÜÿØŸä ŸÑ€å⁄©ŸÑ ÿ¥Ÿà€å';

            // Category Row
            if (formDataToSubmit.category) {
                document.getElementById('confirmCategory').textContent = formDataToSubmit.category;
                document.getElementById('categoryRow').style.display = 'block';
            } else {
                document.getElementById('categoryRow').style.display = 'none';
            }

            // Sent to Home Row
            if (formDataToSubmit.sentToHome && parseFloat(formDataToSubmit.sentToHome) > 0) {
                document.getElementById('confirmSentToHome').textContent = formDataToSubmit.sentToHome;
                document.getElementById('sentToHomeRow').style.display = 'block';
            } else {
                document.getElementById('sentToHomeRow').style.display = 'none';
            }

            // Driver Salary Row
            if (formDataToSubmit.driverSalary && parseFloat(formDataToSubmit.driverSalary) > 0) {
                document.getElementById('confirmDriverSalary').textContent = formDataToSubmit.driverSalary;
                document.getElementById('driverSalaryRow').style.display = 'block';
            } else {
                document.getElementById('driverSalaryRow').style.display = 'none';
            }

            // Sent to Home Mobile Row
            if (formDataToSubmit.sentToHomeMobile && parseFloat(formDataToSubmit.sentToHomeMobile) > 0) {
                document.getElementById('confirmSentToHomeMobile').textContent = formDataToSubmit.sentToHomeMobile;
                document.getElementById('sentToHomeMobileRow').style.display = 'block';
            } else {
                document.getElementById('sentToHomeMobileRow').style.display = 'none';
            }

            // Shop Rent Row
            if (formDataToSubmit.shopRent && parseFloat(formDataToSubmit.shopRent) > 0) {
                document.getElementById('confirmShopRent').textContent = formDataToSubmit.shopRent;
                document.getElementById('shopRentRow').style.display = 'block';
            } else {
                document.getElementById('shopRentRow').style.display = 'none';
            }

            if (formDataToSubmit.note) {
                document.getElementById('confirmNote').textContent = formDataToSubmit.note;
                document.getElementById('noteRow').style.display = 'block';
            } else {
                document.getElementById('noteRow').style.display = 'none';
            }

            if (compressedImageBlob || originalImageFile) {
                document.getElementById('imageRow').style.display = 'block';
            } else {
                document.getElementById('imageRow').style.display = 'none';
            }

            const lastSaveData = localStorage.getItem('lastSaveData_' + currentJob.id);
            if (lastSaveData) {
                const data = JSON.parse(lastSaveData);
                document.getElementById('lastSaveDate').textContent = data.date;
                document.getElementById('lastSaveExpense').textContent = data.expense || '0';
                document.getElementById('lastSaveDetail').textContent = data.detail || 'ŸÜÿØŸä ŸÑ€å⁄©ŸÑ ÿ¥Ÿà€å';
                if (data.note) {
                    document.getElementById('lastSaveNote').textContent = data.note;
                    document.getElementById('lastSaveNoteRow').style.display = 'block';
                } else {
                    document.getElementById('lastSaveNoteRow').style.display = 'none';
                }
                document.getElementById('lastSaveRow').style.display = 'block';
            } else {
                document.getElementById('lastSaveRow').style.display = 'none';
            }
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        async function confirmSubmit() {
            const btn = document.getElementById('confirmButton');
            btn.disabled = true;
            btn.textContent = '‚úì ÿ´ÿ®ÿ™€å⁄ñŸä....';
            try {
                // Deduct Balance for Home Accounts
                if (currentJob.id.startsWith('home_')) {
                    const exp = parseFloat(formDataToSubmit.expense || '0');
                    if (exp > 0) {
                        let bal = parseFloat(localStorage.getItem('home_shared_balance') || '0');
                        bal -= exp;
                        localStorage.setItem('home_shared_balance', bal);
                        updateBalanceDisplay();
                    }
                }

                // *** NEW: Save to Local Storage for Dashboard & Report per Account ***
                // 1. Save Transaction to History
                let newTransaction = {};
                if (formDataToSubmit.isHomeNew) {
                     newTransaction = {
                        date: formDataToSubmit.formattedDate,
                        familyMembers: formDataToSubmit.familyMembers,
                        individualRight: formDataToSubmit.individualRight,
                        actualPayment: formDataToSubmit.actualPayment,
                        difference: formDataToSubmit.difference,
                        status: formDataToSubmit.status,
                        remainingCash: formDataToSubmit.remainingCash,
                        isHomeNew: true,
                        timestamp: new Date().getTime()
                    };
                } else {
                     newTransaction = {
                        date: formDataToSubmit.formattedDate,
                        income: formDataToSubmit.income || '0',
                        expense: formDataToSubmit.expense || '0',
                        sentToHome: formDataToSubmit.sentToHome || '0',
                        driverSalary: formDataToSubmit.driverSalary || '0',
                        sentToHomeMobile: formDataToSubmit.sentToHomeMobile || '0',
                        shopRent: formDataToSubmit.shopRent || '0',
                        detail: formDataToSubmit.detail || '',
                        note: formDataToSubmit.note || '',
                        category: formDataToSubmit.category || '',
                        currency: formDataToSubmit.currency || 'AFN',
                        timestamp: new Date().getTime()
                    };
                }

                let history = JSON.parse(localStorage.getItem('history_' + currentJob.id) || '[]');
                history.unshift(newTransaction);
                localStorage.setItem('history_' + currentJob.id, JSON.stringify(history));

                // 2. Update Stats
                let stats = JSON.parse(localStorage.getItem('stats_' + currentJob.id) || '{"income": 0, "expense": 0}');
                if (!formDataToSubmit.isHomeNew) {
                    stats.income = parseFloat(stats.income) + parseFloat(newTransaction.income);
                    stats.expense = parseFloat(stats.expense) + parseFloat(newTransaction.expense);
                }
                localStorage.setItem('stats_' + currentJob.id, JSON.stringify(stats));
                // ***************************************************************

                let url = new URL(GOOGLE_SHEETS_URL);
                let params = {};
                if (formDataToSubmit.isHomeNew) {
                     params = {
                        date: formDataToSubmit.formattedDate,
                        workType: currentJob.id,
                        familyMembers: formDataToSubmit.familyMembers,
                        individualRight: formDataToSubmit.individualRight,
                        actualPayment: formDataToSubmit.actualPayment,
                        difference: formDataToSubmit.difference,
                        status: formDataToSubmit.status,
                        remainingCash: formDataToSubmit.remainingCash,
                        isHomeNew: 'true'
                     };
                } else {
                     params = {
                        date: formDataToSubmit.formattedDate,
                        workType: currentJob.id,
                        income: formDataToSubmit.income || '0',
                        expense: formDataToSubmit.expense || '0',
                        detail: formDataToSubmit.detail || '',
                        note: formDataToSubmit.note || '',
                        category: formDataToSubmit.category || ''
                    };
                }

                let method = 'GET';
                let body = null;
                let fetchUrl = url.toString();
                let fetchOptions = {};

                // Use the compressed blob if available, otherwise original file (though we should always have compressed one if file selected)
                const fileToSend = compressedImageBlob; 
                const originalName = originalImageFile ? originalImageFile.name : 'image.jpg';

                if (fileToSend) {
                    // Convert image to Base64
                    const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(fileToSend);
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = error => reject(error);
                    });

                    params.imageName = originalName;
                    params.imageMimeType = 'image/jpeg'; // We always convert to JPEG
                    params.imageData = base64Data;

                    method = 'POST';
                    fetchUrl = GOOGLE_SHEETS_URL;

                    // Build form body for POST
                    const formData = new URLSearchParams();
                    Object.keys(params).forEach(key => formData.append(key, params[key]));

                    fetchOptions = {
                        method: 'POST',
                        body: formData,
                        // 'no-cors' mode allows sending data to Google Script without CORS errors,
                        // but prevents reading the response text.
                        mode: 'no-cors' 
                    };
                } else {
                    // Standard GET request for text-only (Legacy behavior preserved)
                    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                    fetchUrl = url.toString();
                    fetchOptions = { method: 'GET' };
                }

                const response = await fetch(fetchUrl, fetchOptions);

                // Only check text response if NOT in no-cors mode (GET requests)
                if (method === 'GET') {
                    const text = await response.text();
                    if (text.includes("ERROR")) {
                        throw new Error(text);
                    }
                }

                const lastSaveData = {
                    date: formDataToSubmit.formattedDate,
                    income: formDataToSubmit.income || '0',
                    expense: formDataToSubmit.expense || '0',
                    detail: formDataToSubmit.detail || '',
                    note: formDataToSubmit.note || '',
                    category: formDataToSubmit.category || ''
                };
                localStorage.setItem('lastSaveData_' + currentJob.id, JSON.stringify(lastSaveData));

                let successMsg = 'ŸÜ⁄ìÿ¶ ŸÖŸÜŸÜŸá ÿ≠ÿ≥ÿßÿ® ÿ∞ÿÆ€åÿ±Ÿá ÿ¥Ÿà';
                if (fileToSend) {
                    successMsg += ' ÿßŸà ÿπ⁄©ÿ≥ ⁄´Ÿà⁄´ŸÑ ⁄âÿ±ÿß€åŸà ÿ™Ÿá ŸàŸÑ€å⁄ñŸÑ ÿ¥Ÿà';
                }
                showToast('success', '‚ú® ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ®ÿ±€åÿßŸÑŸä ŸàŸÑ€å⁄©ŸÑ ÿ¥ŸàŸÑ', successMsg);

                // Reset Image
                removeImage();

                document.getElementById('trailerForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
                closeModal();
            } catch (error) {
                console.error('Fetch error:', error);
                showToast('error', '‚ùå ÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿà ÿ≥ÿ™ŸàŸÜÿ≤Ÿá', error.message);
            } finally { 
                btn.disabled = false;
                btn.textContent = '‚úì ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™ÿß€å€åÿØ ÿßŸà ÿ∞ÿÆ€åÿ±Ÿá ⁄©⁄ìÿ¶';
            }
        }

        function showToast(type, title, desc = '') {
            const toast = document.getElementById('toast');
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastDescription').textContent = desc;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 5000);
        }

        // Initialize all selectors
        initJobSelector();
        initSaudiSubAccountSelector();
        initHomeSubAccountSelector();

        // Category Selection Logic
        function selectCategory(value, element) {
            // Remove active class from all buttons
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));

            // Add active class to clicked button
            element.classList.add('active');

            const customInput = document.getElementById('customCategoryInput');
            const categoryInput = document.getElementById('category');

            if (value === 'ŸÜŸàÿ±') {
                customInput.style.display = 'block';
                customInput.focus();
                categoryInput.value = customInput.value; // Initialize with current custom input value if any
            } else {
                customInput.style.display = 'none';
                categoryInput.value = value;
            }
        }

        function updateCustomCategory(val) {
            // Only update if "Other" is currently selected (which it should be if this input is visible)
            document.getElementById('category').value = val;
        }

        // --- NEW SAUDI DASHBOARD LOGIC ---
        function renderSaudiDashboard() {
            const modal = document.querySelector('#dashboardScreen .modal');
            const isBrooklyn = currentJob.id === 'boklyn';
            const currencyLabel = isBrooklyn ? 'ÿßŸÅÿ∫ÿßŸÜ€ç (AFN)' : 'ÿ±.ÿ≥ (SAR)';

            // Clear existing content and set new structure
            modal.innerHTML = `
                <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                    <div class="modal-icon" style="background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);">üìä</div>
                    <div>
                        <div class="modal-title">⁄âÿ¥ÿ®Ÿàÿ±⁄â</div>
                        <p class="modal-subtitle">ŸÖÿßŸÑŸä ÿ±ÿßŸæŸàÿ± ÿßŸà ÿßÿ≠ÿµÿß€åŸá</p>
                    </div>
                    <button type="button" class="btn-close-fancy" onclick="closeDashboard()" style="position: absolute; top: 15px; left: 15px;">‚úï</button>
                </div>

                <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <div id="saudiLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px; color: #94a3b8;">ÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿà ÿ±ÿßŸºŸàŸÑ€å⁄ñŸä...</p>
                    </div>

                    <div id="saudiContent" style="display: none; display: flex; flex-direction: column; gap: 15px;">

                        <!-- 1. Monthly Total Revenue -->
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 20px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -10px; left: -10px; width: 60px; height: 60px; background: rgba(16, 185, 129, 0.2); border-radius: 50%; filter: blur(20px);"></div>
                            <div style="font-size: 14px; color: #a7f3d0; margin-bottom: 5px;">ŸÖ€åÿßÿ¥ÿ™ŸÜ€å ŸºŸàŸÑ ÿπÿßÿ¶ÿØ</div>
                            <div id="saudiRevenue" style="font-size: 28px; font-weight: 800; color: #34d399; text-shadow: 0 0 20px rgba(52, 211, 153, 0.3);">0</div>
                            <div style="font-size: 12px; color: #6ee7b7; opacity: 0.8;">${currencyLabel}</div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <!-- 2. Sent Home -->
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 15px;">
                                <div style="font-size: 12px; color: #bfdbfe; margin-bottom: 5px;">⁄©Ÿàÿ± ÿ™Ÿá ŸÑ€ê⁄ñŸÑ ÿ¥ŸàŸä</div>
                                <div id="saudiSentHome" style="font-size: 20px; font-weight: 700; color: #60a5fa;">0</div>
                            </div>

                            <!-- 3. Salaries -->
                            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 16px; padding: 15px;">
                                <div style="font-size: 12px; color: #fde68a; margin-bottom: 5px;">Ÿàÿ±⁄©⁄ìŸÑ ÿ¥Ÿà€ê ÿ™ŸÜÿÆŸàÿß</div>
                                <div id="saudiSalaries" style="font-size: 20px; font-weight: 700; color: #fbbf24;">0</div>
                            </div>
                        </div>

                        <!-- 4. Expenses -->
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 14px; color: #fca5a5; margin-bottom: 5px;">ŸÖ€åÿßÿ¥ÿ™ŸÜ€å ŸºŸàŸÑ ŸÖÿµÿßÿ±ŸÅ</div>
                            <div id="saudiExpenses" style="font-size: 24px; font-weight: 800; color: #f87171;">0</div>
                        </div>

                        <!-- 5. Net Profit -->
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);">
                            <div style="font-size: 16px; color: #e9d5ff; margin-bottom: 8px; font-weight: bold;">‚ú® ŸÖ€åÿßÿ¥ÿ™ŸÜÿ¶ ÿÆÿßŸÑÿµŸá ⁄´ŸºŸá</div>
                            <div id="saudiNetProfit" style="font-size: 32px; font-weight: 900; color: #c084fc; text-shadow: 0 0 30px rgba(192, 132, 252, 0.5);">0</div>
                            <div style="font-size: 12px; color: #d8b4fe;">${currencyLabel}</div>
                        </div>

                        <div style="margin-top: 10px; text-align: center;">
                             <button onclick="fetchSaudiData()" class="btn-secondary" style="font-size: 12px; padding: 8px 16px;">üîÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™ÿßÿ≤Ÿá ⁄©⁄ìÿ¶</button>
                        </div>
                    </div>
                </div>
            `;

            fetchSaudiData();
        }

        // --- NEW MOBILE DASHBOARD LOGIC ---
        function renderMobileDashboard() {
            const modal = document.querySelector('#dashboardScreen .modal');

            // Clear existing content and set new structure
            modal.innerHTML = `
                <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                    <div class="modal-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 0 12px 30px rgba(59, 130, 241, 0.4);">üìä</div>
                    <div>
                        <div class="modal-title">⁄âÿ¥ÿ®Ÿàÿ±⁄â</div>
                        <p class="modal-subtitle">ÿØ ŸÖŸàÿ®ÿß€åŸÑ ÿ≠ÿ≥ÿßÿ® ŸÖÿßŸÑŸä ÿ±ÿßŸæŸàÿ±</p>
                    </div>
                    <button type="button" class="btn-close-fancy" onclick="closeDashboard()" style="position: absolute; top: 15px; left: 15px;">‚úï</button>
                </div>

                <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <div id="mobileLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px; color: #94a3b8;">ÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿà ÿ±ÿßŸºŸàŸÑ€å⁄ñŸä...</p>
                    </div>

                    <div id="mobileContent" style="display: none; display: flex; flex-direction: column; gap: 15px;">

                        <!-- 1. Monthly Total Income -->
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 14px; color: #a7f3d0; margin-bottom: 5px;">ŸÖ€åÿßÿ¥ÿ™ŸÜ€å ŸºŸàŸÑ ÿπÿß€åÿØ</div>
                            <div id="mobileRevenue" style="font-size: 28px; font-weight: 800; color: #34d399;">0</div>
                            <div style="font-size: 12px; color: #6ee7b7; opacity: 0.8;">ÿßŸÅÿ∫ÿßŸÜ€ç (AFN)</div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <!-- 2. Sent Home (Mobile) -->
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 15px;">
                                <div style="font-size: 12px; color: #bfdbfe; margin-bottom: 5px;">⁄©Ÿàÿ± ÿ™Ÿá Ÿàÿ±⁄©⁄ìŸÑ ÿ¥Ÿà€å</div>
                                <div id="mobileSentHome" style="font-size: 20px; font-weight: 700; color: #60a5fa;">0</div>
                            </div>

                            <!-- 3. Shop Rent -->
                            <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 16px; padding: 15px;">
                                <div style="font-size: 12px; color: #fde68a; margin-bottom: 5px;">ÿØ⁄©ÿßŸÜ ⁄©ÿ±ÿß€åŸá</div>
                                <div id="mobileShopRent" style="font-size: 20px; font-weight: 700; color: #fbbf24;">0</div>
                            </div>
                        </div>

                        <!-- 4. Monthly Total Expense -->
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 14px; color: #fca5a5; margin-bottom: 5px;">ŸÖ€åÿßÿ¥ÿ™ŸÜ€å ŸºŸàŸÑ ŸÖÿµÿßÿ±ŸÅ</div>
                            <div id="mobileExpenses" style="font-size: 24px; font-weight: 800; color: #f87171;">0</div>
                        </div>

                        <!-- 5. Monthly Net Profit -->
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 16px; padding: 20px; text-align: center;">
                            <div style="font-size: 16px; color: #e9d5ff; margin-bottom: 8px; font-weight: bold;">‚ú® ŸÖ€åÿßÿ¥ŸÜÿ¶ ÿÆÿßŸÑÿµŸá ⁄´ŸºŸá</div>
                            <div id="mobileNetProfit" style="font-size: 32px; font-weight: 900; color: #c084fc;">0</div>
                            <div style="font-size: 12px; color: #d8b4fe;">ÿßŸÅÿ∫ÿßŸÜ€ç (AFN)</div>
                        </div>

                        <div style="margin-top: 10px; text-align: center;">
                             <button onclick="fetchMobileData()" class="btn-secondary" style="font-size: 12px; padding: 8px 16px;">üîÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™ÿßÿ≤Ÿá ⁄©⁄ìÿ¶</button>
                        </div>
                    </div>
                </div>
            `;

            fetchMobileData();
        }

        async function fetchMobileData() {
            const loading = document.getElementById('mobileLoading');
            const content = document.getElementById('mobileContent');

            if(loading) loading.style.display = 'flex';
            if(content) content.style.display = 'none';

            try {
                const url = new URL(GOOGLE_SHEETS_URL);
                url.searchParams.append('action', 'getMobileStats');
                url.searchParams.append('accountId', 'mobile');

                const response = await fetch(url.toString());
                const data = await response.json();

                if(document.getElementById('mobileRevenue')) document.getElementById('mobileRevenue').textContent = formatCurrency(data.revenue || 0);
                if(document.getElementById('mobileSentHome')) document.getElementById('mobileSentHome').textContent = formatCurrency(data.sentHome || 0);
                if(document.getElementById('mobileShopRent')) document.getElementById('mobileShopRent').textContent = formatCurrency(data.shopRent || 0);
                if(document.getElementById('mobileExpenses')) document.getElementById('mobileExpenses').textContent = formatCurrency(data.expenses || 0);
                if(document.getElementById('mobileNetProfit')) document.getElementById('mobileNetProfit').textContent = formatCurrency(data.netProfit || 0);

            } catch (error) {
                console.error("Error fetching Mobile stats:", error);
                document.getElementById('mobileRevenue').textContent = "0";
                document.getElementById('mobileSentHome').textContent = "0";
                document.getElementById('mobileShopRent').textContent = "0";
                document.getElementById('mobileExpenses').textContent = "0";
                document.getElementById('mobileNetProfit').textContent = "0";
                showToast('error', 'ÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿà ÿ≥ÿ™ŸàŸÜÿ≤Ÿá', 'ŸÑŸá ⁄´Ÿà⁄´ŸÑ ÿ¥€åŸº ÿ≥ÿ±Ÿá ÿß⁄ì€å⁄©Ÿá ŸàŸÜÿ¥Ÿà ŸÜ€åŸàŸÑÿß€å');
            } finally {
                if(loading) loading.style.display = 'none';
                if(content) content.style.display = 'flex';
            }
        }

        async function fetchSaudiData() {
            const loading = document.getElementById('saudiLoading');
            const content = document.getElementById('saudiContent');

            if(loading) loading.style.display = 'flex';
            if(content) content.style.display = 'none';

            try {
                // Construct URL to fetch specific stats for this Saudi account
                // Appending action=getSaudiStats and the specific sub-account ID
                const url = new URL(GOOGLE_SHEETS_URL);
                url.searchParams.append('action', 'getSaudiStats');
                url.searchParams.append('accountId', currentJob.id);

                // Fetch data from Google Sheets
                const response = await fetch(url.toString());
                const data = await response.json();

                // Check if API returned valid data, otherwise use 0
                const revenue = data.revenue || 0;
                const sentHome = data.sentHome || 0;
                const salaries = data.salaries || 0;
                const expenses = data.expenses || 0;
                const netProfit = data.netProfit || 0;

                // Update UI
                if(document.getElementById('saudiRevenue')) document.getElementById('saudiRevenue').textContent = formatCurrency(revenue);
                if(document.getElementById('saudiSentHome')) document.getElementById('saudiSentHome').textContent = formatCurrency(sentHome);
                if(document.getElementById('saudiSalaries')) document.getElementById('saudiSalaries').textContent = formatCurrency(salaries);
                if(document.getElementById('saudiExpenses')) document.getElementById('saudiExpenses').textContent = formatCurrency(expenses);
                if(document.getElementById('saudiNetProfit')) document.getElementById('saudiNetProfit').textContent = formatCurrency(netProfit);

            } catch (error) {
                console.error("Error fetching Saudi stats:", error);
                // Fallback / Simulation for demo if fetch fails (since we don't have the real backend script)
                // Remove this in production if backend is ready

                // Simulating data for demonstration as per 'code from scratch' request logic
                document.getElementById('saudiRevenue').textContent = "0";
                document.getElementById('saudiSentHome').textContent = "0";
                document.getElementById('saudiSalaries').textContent = "0";
                document.getElementById('saudiExpenses').textContent = "0";
                document.getElementById('saudiNetProfit').textContent = "0";

                showToast('error', 'ÿØ ⁄â€åŸºÿß ŸæŸá ÿ±ÿßŸà⁄ìŸÑŸà ⁄©€ê ÿ≥ÿ™ŸàŸÜÿ≤Ÿá', 'ŸÑŸá ⁄´Ÿà⁄´ŸÑ ÿ¥€åŸº ÿ≥ÿ±Ÿá ÿß⁄ì€å⁄©Ÿá ŸàŸÜÿ¥Ÿà ŸÜ€åŸàŸÑÿß€å');
            } finally {
                if(loading) loading.style.display = 'none';
                if(content) content.style.display = 'flex'; // Use flex to maintain column layout
            }
        }

        function formatCurrency(num) {
            return parseFloat(num).toLocaleString();
        }

        // --- NEW GENERAL DASHBOARD LOGIC ---
        function renderGeneralDashboard() {
            const modal = document.querySelector('#dashboardScreen .modal');

            // Clear existing content and set new structure
            modal.innerHTML = `
                <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                    <div class="modal-icon" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); box-shadow: 0 12px 30px rgba(99, 102, 241, 0.4);">üìä</div>
                    <div>
                        <div class="modal-title">ÿπŸÖŸàŸÖŸä ⁄âÿ¥ÿ®Ÿàÿ±⁄â</div>
                        <p class="modal-subtitle">ŸÖÿßŸÑŸä ÿ±ÿßŸæŸàÿ± ÿßŸà ÿßÿ≠ÿµÿß€åŸá</p>
                    </div>
                    <button type="button" class="btn-close-fancy" onclick="closeDashboard()" style="position: absolute; top: 15px; left: 15px;">‚úï</button>
                </div>

                <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <div id="generalLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px; color: #94a3b8;">ÿØ ⁄´Ÿà⁄´ŸÑ ÿ¥€åŸº ⁄ÖÿÆŸá ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ±ÿßŸºŸàŸÑ€å⁄ñŸä...</p>
                    </div>

                    <div id="generalContent" style="display: none; display: flex; flex-direction: column; gap: 15px;">

                        <!-- 1. Total Revenue -->
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 16px; padding: 20px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: -10px; left: -10px; width: 60px; height: 60px; background: rgba(16, 185, 129, 0.2); border-radius: 50%; filter: blur(20px);"></div>
                            <div style="font-size: 14px; color: #a7f3d0; margin-bottom: 5px;">ŸºŸàŸÑ ÿπŸàÿß€åÿØ (Revenue)</div>
                            <div id="generalRevenue" style="font-size: 28px; font-weight: 800; color: #34d399; text-shadow: 0 0 20px rgba(52, 211, 153, 0.3);">0</div>
                            <div style="font-size: 12px; color: #6ee7b7; opacity: 0.8;">ÿßŸÅÿ∫ÿßŸÜ€ç (AFN)</div>
                        </div>

                        <!-- 2. Expenses -->
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 14px; color: #fca5a5; margin-bottom: 5px;">ŸºŸàŸÑ ŸÖÿµÿßÿ±ŸÅ (Expenses)</div>
                            <div id="generalExpenses" style="font-size: 24px; font-weight: 800; color: #f87171;">0</div>
                            <div style="font-size: 12px; color: #fca5a5; opacity: 0.8;">ÿßŸÅÿ∫ÿßŸÜ€ç (AFN)</div>
                        </div>

                        <!-- 3. Net Profit -->
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);">
                            <div style="font-size: 16px; color: #e9d5ff; margin-bottom: 8px; font-weight: bold;">‚ú® ÿÆÿßŸÑÿµŸá ⁄´ŸºŸá (Net Profit)</div>
                            <div id="generalNetProfit" style="font-size: 32px; font-weight: 900; color: #c084fc; text-shadow: 0 0 30px rgba(192, 132, 252, 0.5);">0</div>
                            <div style="font-size: 12px; color: #d8b4fe;">ÿßŸÅÿ∫ÿßŸÜ€ç (AFN)</div>
                        </div>

                        <!-- 4. Total Capital -->
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 20px;">
                            <div style="font-size: 14px; color: #d8b4fe; margin-bottom: 5px;">ŸºŸàŸÑŸá ŸæÿßŸÜ⁄´Ÿá (Total Capital)</div>
                            <div id="generalTotalCapital" style="font-size: 24px; font-weight: 800; color: #c084fc;">0</div>
                            <div style="font-size: 12px; color: #d8b4fe; opacity: 0.8;">ÿßŸÅÿ∫ÿßŸÜ€ç (AFN)</div>
                        </div>

                        <!-- 5. Loans Group -->
                        <div style="margin-top: 15px; margin-bottom: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                             <div style="font-size: 14px; color: #94a3b8; margin-bottom: 10px; font-weight: 600;">ŸÇÿ±ÿ∂ŸàŸÜŸá (Loans)</div>
                             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <!-- People's Loans from Us (Receivables) -->
                                <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 15px;">
                                    <div style="font-size: 12px; color: #bfdbfe; margin-bottom: 5px;">ŸæŸá ÿÆŸÑ⁄©Ÿà ÿ≤ŸÖŸàŸÜ⁄ñ ŸÇÿ±ÿ∂ŸàŸÜŸá</div>
                                    <div id="generalReceivables" style="font-size: 20px; font-weight: 700; color: #60a5fa;">0</div>
                                </div>

                                <!-- Our Loans from People (Liabilities) -->
                                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 16px; padding: 15px;">
                                    <div style="font-size: 12px; color: #fde68a; margin-bottom: 5px;">ŸæŸá ŸÖŸàŸÜ⁄ñ ÿØ ÿÆŸÑ⁄©Ÿà ŸÇÿ±ÿ∂ŸàŸÜŸá</div>
                                    <div id="generalLiabilities" style="font-size: 20px; font-weight: 700; color: #fbbf24;">0</div>
                                </div>
                             </div>
                        </div>

                        <div style="margin-top: 10px; text-align: center;">
                             <button onclick="fetchGeneralData()" class="btn-secondary" style="font-size: 12px; padding: 8px 16px;">üîÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™ÿßÿ≤Ÿá ⁄©⁄ìÿ¶</button>
                        </div>
                    </div>
                </div>
            `;

            fetchGeneralData();
        }

        async function fetchGeneralData() {
            const loading = document.getElementById('generalLoading');
            const content = document.getElementById('generalContent');

            if(loading) loading.style.display = 'flex';
            if(content) content.style.display = 'none';

            try {
                // Construct URL to fetch general stats
                const url = new URL(GOOGLE_SHEETS_URL);
                url.searchParams.append('action', 'getGeneralStats');

                // Fetch data from Google Sheets
                const response = await fetch(url.toString());
                const data = await response.json();

                // Check if API returned valid data, otherwise use 0
                const revenue = data.revenue || 0;
                const expenses = data.expenses || 0;
                const netProfit = data.netProfit || 0;
                const totalCapital = data.totalCapital || 0;
                const receivables = data.receivables || 0;
                const liabilities = data.liabilities || 0;

                // Update UI
                if(document.getElementById('generalRevenue')) document.getElementById('generalRevenue').textContent = formatCurrency(revenue);
                if(document.getElementById('generalExpenses')) document.getElementById('generalExpenses').textContent = formatCurrency(expenses);
                if(document.getElementById('generalNetProfit')) document.getElementById('generalNetProfit').textContent = formatCurrency(netProfit);
                if(document.getElementById('generalTotalCapital')) document.getElementById('generalTotalCapital').textContent = formatCurrency(totalCapital);
                if(document.getElementById('generalReceivables')) document.getElementById('generalReceivables').textContent = formatCurrency(receivables);
                if(document.getElementById('generalLiabilities')) document.getElementById('generalLiabilities').textContent = formatCurrency(liabilities);

            } catch (error) {
                console.error("Error fetching General stats:", error);

                document.getElementById('generalRevenue').textContent = "0";
                document.getElementById('generalExpenses').textContent = "0";
                document.getElementById('generalNetProfit').textContent = "0";
                if(document.getElementById('generalTotalCapital')) document.getElementById('generalTotalCapital').textContent = "0";
                if(document.getElementById('generalReceivables')) document.getElementById('generalReceivables').textContent = "0";
                if(document.getElementById('generalLiabilities')) document.getElementById('generalLiabilities').textContent = "0";

                showToast('error', 'ÿØ ⁄â€åŸºÿß ŸæŸá ÿ±ÿßŸà⁄ìŸÑŸà ⁄©€ê ÿ≥ÿ™ŸàŸÜÿ≤Ÿá', 'ŸÑŸá ⁄´Ÿà⁄´ŸÑ ÿ¥€åŸº ÿ≥ÿ±Ÿá ÿß⁄ì€å⁄©Ÿá ŸàŸÜÿ¥Ÿà ŸÜ€åŸàŸÑÿß€å');
            } finally {
                if(loading) loading.style.display = 'none';
                if(content) content.style.display = 'flex';
            }
        }

        function openDashboard() { 
            // Close other screens first
            const reportScreen = document.getElementById('reportScreen');
            const debtScreen = document.getElementById('debtScreen');
            const dashboardScreen = document.getElementById('dashboardScreen');
            const opExpScreen = document.getElementById('opExpScreen');
            const capExpScreen = document.getElementById('capExpScreen');

            if (reportScreen) {
                reportScreen.classList.remove('active');
                reportScreen.style.display = 'none';
            }
            if (debtScreen) {
                debtScreen.classList.remove('active');
                debtScreen.style.display = 'none';
            }
            if (opExpScreen) {
                opExpScreen.classList.remove('active');
                opExpScreen.style.display = 'none';
            }
            if (capExpScreen) {
                capExpScreen.classList.remove('active');
                capExpScreen.style.display = 'none';
            }

            if (dashboardScreen) {
                dashboardScreen.classList.add('active');
                dashboardScreen.style.display = 'flex';
            }

            // *** NEW: SAUDI DASHBOARD ***
            if (currentJob && (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_') || currentJob.id === 'boklyn')) {
                renderSaudiDashboard();
                return;
            }

            // *** NEW: MOBILE DASHBOARD ***
            if (currentJob && currentJob.id === 'mobile') {
                renderMobileDashboard();
                return;
            }

            // Home accounts dashboard removed
            if (currentJob && currentJob.id.startsWith('home_')) {
                return;
            }

            // Check if user is one of the specific Home accounts
            const jointExpenseAccounts = ['home_lalak', 'home_saifullah', 'home_saeedullah', 'home_siddiqullah', 'home_adil'];
            const isJointAccount = false;

            if (isJointAccount) {
                // Show Joint Expenses Form
                document.getElementById('dashboardTitle').textContent = 'ŸÖÿ¥ÿ™ÿ±⁄© ŸÖÿµÿßÿ±ŸÅ';
                document.getElementById('dashboardSubtitle').textContent = 'ŸÖŸáÿ±ÿ®ÿßŸÜ€å Ÿà⁄©⁄ìÿ¶ ŸÖÿ¥ÿ™ÿ±⁄© ŸÖÿµÿßÿ±ŸÅ ŸàŸÑ€å⁄©ÿ¶';
                document.getElementById('jointExpensesContent').style.display = 'block';
                document.getElementById('dashboardContent').style.display = 'none';

                // Set default date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('jointDate').value = today;

                // Render list
                // Removed
            } else {
                renderGeneralDashboard();
            }
        }


        // --- Joint Expenses Logic ---
        function handleJointExpenseSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('jointDate').value;
            const expense = document.getElementById('jointExpense').value;
            const detail = document.getElementById('jointDetail').value;

            if (!date || !expense || !detail) {
                showToast('error', 'ÿ™€êÿ±Ÿàÿ™ŸÜŸá', 'ŸÖŸáÿ±ÿ®ÿßŸÜŸä Ÿà⁄©⁄ìÿ¶ ŸºŸàŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ⁄â⁄© ⁄©⁄ìÿ¶');
                return;
            }

            // Create Transaction Object (Same format as main system)
            const newTransaction = {
                date: date.replace(/-/g, '/'), // Format: YYYY/MM/DD
                expense: expense,
                detail: detail,
                income: '0',
                note: '',
                category: 'ŸÖÿ¥ÿ™ÿ±⁄© ŸÖÿµÿßÿ±ŸÅ',
                currency: 'AFN',
                timestamp: Date.now(),
                isJointExpense: true
            };

            // Save to History
            let history = JSON.parse(localStorage.getItem('history_' + currentJob.id) || '[]');
            history.unshift(newTransaction);
            localStorage.setItem('history_' + currentJob.id, JSON.stringify(history));

            // Update Stats
            let stats = JSON.parse(localStorage.getItem('stats_' + currentJob.id) || '{"income": 0, "expense": 0}');
            stats.expense = parseFloat(stats.expense) + parseFloat(expense);
            localStorage.setItem('stats_' + currentJob.id, JSON.stringify(stats));

            // Handle Image Upload (if any)
            if (compressedImageBlob) {
                // In a real app, upload logic would go here. 
                // Since this is client-side only for now, we can't easily store blobs in localStorage (size limit).
                // We'll just show success toast.
                console.log("Image ready to upload:", compressedImageBlob);
            }

            showToast('success', 'ÿ´ÿ®ÿ™ ÿ¥Ÿà', 'ŸÖÿ¥ÿ™ÿ±⁄© ŸÑ⁄´⁄öÿ™ ŸæŸá ÿ®ÿ±€åÿßŸÑ€åÿ™Ÿàÿ® ÿ≥ÿ±Ÿá ÿ´ÿ®ÿ™ ÿ¥Ÿà');

            // Reset Form
            document.getElementById('jointExpense').value = '';
            document.getElementById('jointDetail').value = '';
            removeJointImage();

            // Removed
        }

        function renderJointExpensesList() {
            const history = JSON.parse(localStorage.getItem('history_' + currentJob.id) || '[]');
            // Filter only joint expenses if mixed, or just show last 5 transactions
            const recent = history.slice(0, 5); 

            const container = document.getElementById('jointExpensesList');
            if (recent.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#94a3b8; font-size:12px;">ÿ™ÿ±ÿßŸàÿ≥Ÿá Ÿá€å⁄Ö ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÜÿ¥ÿ™Ÿá</div>';
                return;
            }

            container.innerHTML = recent.map(item => `
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; font-size: 14px;">${item.detail}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${item.date}</div>
                    </div>
                    <div style="font-weight: bold; color: #f87171;">-${parseFloat(item.expense).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function handleJointImageSelect(input) {
            const file = input.files[0];
            if (file) {
                processImage(file, 'joint');
            }
        }

        function removeJointImage() {
            document.getElementById('jointImageInput').value = '';
            document.getElementById('jointImagePreview').style.display = 'none';
            document.getElementById('jointPreviewImg').src = '';
            compressedImageBlob = null;
        }

        function closeDashboard() {
            const dashboardScreen = document.getElementById('dashboardScreen');
            if (dashboardScreen) {
                dashboardScreen.classList.remove('active');
                dashboardScreen.style.display = 'none';
            }
        }


        function clearAllData() { 
            if (confirm("ÿ¢€åÿß ÿ™ÿßÿ≥Ÿà ⁄âÿß⁄âŸá €åÿßÿ≥ÿ™ ⁄Ü€ê ŸºŸàŸÑŸá Ÿá€åÿ≥Ÿºÿ±Ÿä ÿßŸà ⁄â€åŸºÿß Ÿæÿß⁄©ŸàŸÑ ÿ∫Ÿàÿß⁄ìÿ¶ÿü ÿØÿß ÿπŸÖŸÑ ÿØ ÿ®€åÿ±ÿ™Ÿá ÿ±ÿß⁄´ÿ±⁄Å€åÿØŸà Ÿà⁄ì ŸÜŸá ÿØ€å!")) { 

                // Determine which account's data to delete
                let targetAccountId = currentJob.id;

                // If in Report Screen (Admin might be viewing another account)
                if (document.getElementById('reportScreen').classList.contains('active')) {
                     const accountSelector = document.getElementById('reportAccountSelector');
                     const adminSelectContainer = document.getElementById('adminAccountSelectContainer');

                     if (adminSelectContainer && adminSelectContainer.style.display !== 'none' && accountSelector && accountSelector.value !== 'current') {
                        targetAccountId = accountSelector.value;
                     }
                }

                // If in Dashboard Screen (Admin might be viewing another account)
                 if (document.getElementById('dashboardScreen').classList.contains('active')) {
                     const dashboardSelector = document.getElementById('dashboardAccountSelector');
                     if (dashboardSelector && dashboardSelector.value !== 'current') {
                        targetAccountId = dashboardSelector.value;
                     }
                }

                // Delete Data
                localStorage.removeItem("history_" + targetAccountId); 
                localStorage.removeItem("stats_" + targetAccountId); 
                localStorage.removeItem("lastSaveData_" + targetAccountId); 

                showToast("success", "Ÿæÿß⁄© ÿ¥Ÿà", "ŸºŸàŸÑŸá ⁄â€åŸºÿß ŸæŸá ÿ®ÿ±€åÿßŸÑ€åÿ™Ÿàÿ® ÿ≥ÿ±Ÿá Ÿæÿß⁄©Ÿá ÿ¥ŸàŸá"); 

                // Refresh the current view instead of closing
                if (document.getElementById('reportScreen').classList.contains('active')) {
                    filterReportByDuration(); // Refresh report list
                } else if (document.getElementById('dashboardScreen').classList.contains('active')) {
                    updateDashboardStats(targetAccountId === currentJob.id ? 'current' : targetAccountId); // Refresh dashboard stats
                }
            } 
        }

        // --- BACKUP & RESTORE ---
        function downloadBackup() {
            const data = JSON.stringify(localStorage);
            const blob = new Blob([data], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Sherzad_Backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('success', 'ÿ®€å⁄© ÿßŸæ', 'ŸÅÿß€åŸÑ ⁄âÿßŸàŸÜŸÑŸà⁄â ÿ¥Ÿà!');
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // Clear current data mostly or just overwrite? Overwrite is safer for restore.
                    // But we should probably ask confirmation
                    if(!confirm("ÿ¢€åÿß ÿ∫Ÿàÿß⁄ìÿ¶ ÿØÿß ÿ®€å⁄© ÿßŸæ ŸÅÿß€åŸÑ ŸæŸàÿ±ÿ™Ÿá ⁄©⁄ìÿ¶ÿü ÿßŸàÿ≥ŸÜ€ç ⁄â€åŸºÿß ÿ®Ÿá ŸÑŸá ÿØ€ê ÿ≥ÿ±Ÿá ÿ®ÿØŸÑŸá ÿ¥Ÿä.")) return;

                    Object.keys(data).forEach(key => {
                        localStorage.setItem(key, data[key]);
                    });

                    showToast('success', 'ÿ±€å€åÿ≥ŸºŸàÿ±', '⁄â€åŸºÿß ŸæŸá ÿ®ÿ±€åÿßŸÑ€åÿ™Ÿàÿ® ŸæŸàÿ±ÿ™Ÿá ÿ¥ŸàŸá!');
                    setTimeout(() => location.reload(), 1500); // Reload to apply changes
                } catch (err) {
                    console.error(err);
                    showToast('error', 'ÿ™€êÿ±Ÿàÿ™ŸÜŸá', 'ŸÅÿß€åŸÑ ÿÆÿ±ÿßÿ® ÿØ€å €åÿß ÿ≥ŸÖ ŸÅÿßÿ±ŸÖ€åŸº ŸÜŸÑÿ±Ÿä');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }


        // OVERRIDE: Update General Dashboard to use Debt Data
        function updateGeneralDashboard() {
            // 1. Calculate Account Balances
            const accounts = [
                { id: 'boklyn', type: 'afn' },
                { id: 'mobile', type: 'afn' },
                { id: 'saudi_12module', type: 'sar' }, // SAR
                { id: 'saudi_14module', type: 'sar' }  // SAR
            ];

            let totalCashAFN = 0;
            let boklynTotal = 0;
            let mobileTotal = 0;
            let saudiTotals = [];

            // Helper to get balance
            const getBal = (id) => {
                const stats = JSON.parse(localStorage.getItem('stats_' + id) || '{"income": 0, "expense": 0}');
                return parseFloat(stats.income) - parseFloat(stats.expense);
            };

            // Boklyn
            boklynTotal = getBal('boklyn');
            totalCashAFN += boklynTotal;

            // Mobile
            mobileTotal = getBal('mobile');
            totalCashAFN += mobileTotal;

            // Saudi Accounts
            const SAR_TO_AFN = 18.5; 
            let totalSaudiSAR = 0;

            SAUDI_SUB_ACCOUNTS.forEach(acc => {
                const bal = getBal(acc.id);
                saudiTotals.push({ name: acc.name, balance: bal, icon: acc.icon });
                totalSaudiSAR += bal;
            });

            const saudiInAFN = totalSaudiSAR * SAR_TO_AFN;

            // 3. Total Worth Calculation
            const totalCashCombined = totalCashAFN + saudiInAFN;
            const totalWorth = totalCashCombined;

            // 4. Update UI
            document.getElementById('dashTotalWorth').textContent = totalWorth.toLocaleString();
            document.getElementById('dashTotalCash').textContent = totalCashCombined.toLocaleString();
            if(document.getElementById('dashLiability')) document.getElementById('dashLiability').textContent = "0";
            if(document.getElementById('dashReceivable')) document.getElementById('dashReceivable').textContent = "0";


            // New Dashboard Stats Update (Placeholders)
            if(document.getElementById('dashTotalWorth')) document.getElementById('dashTotalWorth').textContent = (totalWorth || 0).toLocaleString();
            if(document.getElementById('dashNetProfit')) document.getElementById('dashNetProfit').textContent = "0";
            if(document.getElementById('dashTotalCash')) document.getElementById('dashTotalCash').textContent = (totalCashCombined || 0).toLocaleString();
            if(document.getElementById('dashCapitalInUse')) document.getElementById('dashCapitalInUse').textContent = "0";
            if(document.getElementById('dashInventory')) document.getElementById('dashInventory').textContent = (inventory || 0).toLocaleString();
            if(document.getElementById('dashZakat')) document.getElementById('dashZakat').textContent = Math.floor(zakat || 0).toLocaleString();
            if(document.getElementById('dashGrowth')) document.getElementById('dashGrowth').textContent = (growth || 0).toFixed(1);
            if(document.getElementById('dashOpExp')) document.getElementById('dashOpExp').textContent = (opExp || 0).toLocaleString();
            if(document.getElementById('dashCapExp')) document.getElementById('dashCapExp').textContent = (capExp || 0).toLocaleString();
            if(document.getElementById('dashTotalIncome')) document.getElementById('dashTotalIncome').textContent = "0";
            if(document.getElementById('dashPersonalExpense')) document.getElementById('dashPersonalExpense').textContent = "0";

        }

    </script>
    <script>
        // --- 1. PIE CHART LOGIC ---
        let expenseChartInstance = null;

        function renderChart(history) {
            const ctx = document.getElementById('expensePieChart');
            if (!ctx) return;

            // Aggregate expenses by category
            const categories = {};
            history.forEach(item => {
                if (parseFloat(item.expense) > 0) {
                    const cat = item.category || 'ŸÜŸàÿ±'; // Default to "Other"
                    categories[cat] = (categories[cat] || 0) + parseFloat(item.expense);
                }
            });

            const labels = Object.keys(categories);
            const data = Object.values(categories);
            const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#f472b6', '#9ca3af'];

            if (expenseChartInstance) {
                expenseChartInstance.destroy();
            }

            expenseChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#cbd5e1', font: { family: 'inherit' } }
                        }
                    }
                }
            });
        }

        // --- 2. SEARCH LOGIC ---
        document.getElementById('reportSearchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.report-list .data-row');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(term)) {
                    row.style.display = 'flex';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // --- 3. CURRENCY CONVERTER LOGIC REMOVED ---


        // --- 4. BUDGET LIMIT WARNING LOGIC ---
        function checkBudgetLimit(totalExpense) {
            const limit = 50000;
            const warningThreshold = 45000;
            const warningBox = document.getElementById('budgetWarning');

            if (totalExpense >= warningThreshold) {
                warningBox.style.display = 'flex';
                warningBox.innerHTML = `‚ö†Ô∏è ŸæÿßŸÖ Ÿà⁄©⁄ìÿ¶! ŸÖÿµÿßÿ±ŸÅ ${totalExpense.toLocaleString()} ÿ™Ÿá Ÿàÿ±ÿ≥€åÿØŸÑ. (ÿ≠ÿØ: ${limit.toLocaleString()})`;
            } else {
                warningBox.style.display = 'none';
            }
        }

        // --- HOOKS INTO EXISTING FUNCTIONS ---

        // Hook into openReport (if it exists) or filterReportByDuration (which populates the list)
        // Since filterReportByDuration is called by onchange, and presumably initially, we should hook there.
        // Wait, looking at the code, filterReportByDuration() is the main render function for report list.
        // I need to intercept it.

        // Save original reference
        const originalFilterReportByDuration = window.filterReportByDuration || filterReportByDuration;

        // Override
        window.filterReportByDuration = function() {
            // Call original
            originalFilterReportByDuration();

            // After original runs, it presumably updates the DOM or gets data.
            // Let's get the data again to render the chart.
            // Note: The original function likely gets data from localStorage.
            // We'll wait a tick to ensure DOM is updated if needed, or just fetch data directly.

            setTimeout(() => {
                // Ensure getFilteredData exists, otherwise fallback or error handle
                if (typeof getFilteredData === 'function') {
                    const data = getFilteredData(); 
                    renderChart(data);
                }
            }, 50);
        };

        // Hook into updateDashboardStats for Budget Warning
        const originalUpdateDashboardStats = window.updateDashboardStats || updateDashboardStats;

        window.updateDashboardStats = function(accountId) {
            console.log('Updating dashboard stats for:', accountId);
            const targetAccountId = accountId === 'current' ? currentJob.id : accountId;

            // Get data from localStorage
            let stats = JSON.parse(localStorage.getItem('stats_' + targetAccountId) || '{"income": 0, "expense": 0}');

            const income = parseFloat(stats.income || 0);
            const expense = parseFloat(stats.expense || 0);
            const netBalance = income - expense;

            // Update UI
            const profitEl = document.getElementById('dashboardTotalProfit');
            const expenseEl = document.getElementById('dashboardTotalExpense');
            const balanceEl = document.getElementById('dashboardNetBalance');

            if (profitEl) profitEl.textContent = income.toLocaleString();
            if (expenseEl) expenseEl.textContent = expense.toLocaleString();
            if (balanceEl) balanceEl.textContent = netBalance.toLocaleString() + ' ÿã';

            if (typeof checkBudgetLimit === 'function') {
                checkBudgetLimit(expense);
            }
        };

        // --- FIX FOR HOME ACCOUNTS ---
        setInterval(() => {
             if (typeof currentJob !== 'undefined' && currentJob && currentJob.id && currentJob.id.startsWith('home_')) {
                 // 1. Fix Close Button Visibility
                 const btn = document.getElementById('homeLogoutBtn');
                 if(btn && btn.style.display === 'none') {
                     btn.style.display = 'flex';
                     btn.style.zIndex = '100';
                 }

                 // 2. Fix Grid Layout
                 const fields = document.getElementById('homeFields');
                 if(fields && fields.style.display !== 'grid') fields.style.display = 'grid';

                 // 3. Fix ReadOnly for Saifullah
            const isSaifullah = currentJob.name === 'ÿ≥€åŸÅ ÿßŸÑŸÑŸá';
            ['familyMembers', 'individualRight', 'actualPayment', 'difference', 'status', 'remainingCash'].forEach(id => {
               const el = document.getElementById(id);
               if(el) {
                   if(isSaifullah) {
                       if(el.hasAttribute('readonly')) el.removeAttribute('readonly');
                       el.style.background = 'rgba(255,255,255,0.1)';
                   } else {
                       if(!el.hasAttribute('readonly')) el.setAttribute('readonly', 'true');
                       el.style.background = 'rgba(255,255,255,0.05)';
                   }
                   el.style.width = '100%';
                   el.style.display = 'block';
                   el.style.boxSizing = 'border-box';
               }
            });
             }
        }, 500);

    </script>
</body>
</html>
