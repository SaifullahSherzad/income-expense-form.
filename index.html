<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá - Premium Edition">
    <title>ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá</title>
    
    <!-- Favicon for browser tab - Icon file -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- iOS home screen icon - PNG file -->
    <link rel="apple-touch-icon" href="favicon.png">
    
    <!-- iOS web app configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá">
          
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QR Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: 'Inter', 'Noto Naskh Arabic', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0a0515 0%, #020203 40%, #030712 100%);
            color: #f8fafc;
            direction: rtl;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0;
            position: relative;
            min-height: 100vh;
            overflow: auto;
        }

        @media (min-width: 768px) {
            body {
                align-items: center;
            }
        }

        .bg-orbs {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: float-orb 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            top: -200px;
            right: -200px;
            animation-duration: 20s;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #ec4899, #f59e0b);
            bottom: -150px;
            left: -150px;
            animation-duration: 25s;
            animation-delay: -5s;
        }

        .orb-3 {
            width: 350px;
            height: 350px;
            background: linear-gradient(135deg, #06b6d4, #8b5cf6);
            top: 50%;
            right: 10%;
            animation-duration: 30s;
            animation-delay: -10s;
        }

        @keyframes float-orb {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(30px, -40px); }
            50% { transform: translate(-20px, 30px); }
            75% { transform: translate(40px, 20px); }
        }

        .glass {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04));
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
        }

        .glass::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05), transparent);
            pointer-events: none;
        }

        .glass-card {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 0 80px rgba(139, 92, 246, 0.1);
            position: relative;
            z-index: 1;
            padding: 14px 20px 24px 20px;
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            .glass-card {
                padding: 10px 14px 16px 14px;
            }
        }

        @media (min-width: 1024px) {
            .glass-card {
                padding: 40px;
            }
        }

        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-40px); filter: blur(20px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes modalPop {
            0% { opacity: 0; transform: scale(0.7) translateY(40px) rotateX(15deg); filter: blur(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0) rotateX(0); filter: blur(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes pulseIcon {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 15px 40px rgba(245, 158, 11, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 20px 50px rgba(245, 158, 11, 0.7);
            }
        }

        @keyframes floatLogo {
            0%, 100% { 
                transform: translateY(0) rotateZ(0deg);
                box-shadow: 0 20px 50px rgba(139, 92, 246, 0.5);
            }
            50% { 
                transform: translateY(-10px) rotateZ(2deg);
                box-shadow: 0 25px 60px rgba(139, 92, 246, 0.7);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .container {
            width: 100%;
            max-width: 750px;
            padding: 10px 16px 16px 16px;
            z-index: 10;
            animation: slideInDown 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            max-height: calc(100vh - 10px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        @media (min-width: 768px) {
            .container {
                padding: 10px 16px 16px 16px;
                max-height: calc(100vh - 10px);
                overflow-y: auto;
                overflow-x: hidden;
            }
        }

        @media (min-width: 768px) and (max-height: 900px) {
            .container {
                padding: 10px 16px 16px 16px;
                max-height: calc(100vh - 10px);
                overflow-y: auto;
                overflow-x: hidden;
            }
        }

        @media (min-width: 1024px) and (min-height: 900px) {
            .container {
                padding: 30px 50px;
                max-height: none;
                overflow-y: visible;
            }
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 50%, #ec4899 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 900;
            color: white;
            box-shadow: 0 20px 50px rgba(139, 92, 246, 0.5), inset -1px -1px 30px rgba(255, 255, 255, 0.3), inset 1px 1px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            animation: floatLogo 4s ease-in-out infinite;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            .logo {
                width: 60px;
                height: 60px;
                font-size: 28px;
                border-radius: 12px;
            }
        }

        @media (min-width: 1024px) {
            .logo {
                width: 100px;
                height: 100px;
                font-size: 48px;
                border-radius: 20px;
            }
        }

        .btn-close-fancy {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-close-fancy:hover {
            background: rgba(239, 68, 68, 0.8);
            border-color: rgba(239, 68, 68, 1);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }

        .logo::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
            animation: shine 3s infinite;
            z-index: 2;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        @media (min-width: 768px) {
            .header {
                gap: 12px;
                margin-bottom: 12px;
            }
        }

        @media (min-width: 1024px) {
            .header {
                gap: 20px;
                margin-bottom: 28px;
            }
        }

        h1 {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(to left, #c084fc, #60a5fa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            line-height: 1.1;
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            h1 {
                font-size: 18px;
            }
        }

        @media (min-width: 1024px) {
            h1 {
                font-size: 32px;
            }
        }

        .subtitle {
            color: #7dd3fc;
            font-size: 11px;
            margin-top: 2px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            .subtitle {
                font-size: 9px;
                margin-top: 0px;
            }
        }

        @media (min-width: 1024px) {
            .subtitle {
                font-size: 13px;
                margin-top: 8px;
            }
        }

        #jobSelectionScreen {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 21, 0.98);
            backdrop-filter: blur(30px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }

        #jobSelectionScreen.hidden {
            display: none;
        }

        .job-selection-card {
            max-width: 550px;
            width: 100%;
            animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .job-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .job-header h2 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(to left, #c084fc, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .job-header-subtitle {
            color: #7dd3fc;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .job-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        @media (min-width: 768px) {
            .job-grid {
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }
        }

        .job-card {
            padding: 20px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(59, 130, 246, 0.06));
            border: 2px solid rgba(139, 92, 246, 0.25);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: right;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @media (min-width: 768px) {
            .job-card {
                padding: 24px;
                border-radius: 18px;
                gap: 12px;
            }
        }

        .job-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05), transparent);
            pointer-events: none;
        }

        .job-card:hover {
            border-color: rgba(139, 92, 246, 0.6);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.12));
            box-shadow: 0 15px 40px rgba(139, 92, 246, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-6px);
        }

        .job-card:active {
            transform: translateY(-2px);
        }

        .job-icon {
            font-size: 28px;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
        }

        @media (min-width: 768px) {
            .job-icon {
                font-size: 32px;
            }
        }

        .job-card:nth-child(1) .job-icon { animation-delay: 0s; }
        .job-card:nth-child(2) .job-icon { animation-delay: 0.2s; }
        .job-card:nth-child(3) .job-icon { animation-delay: 0.4s; }
        .job-card:nth-child(4) .job-icon { animation-delay: 0.6s; }

        .job-name {
            font-size: 16px;
            font-weight: 800;
            background: linear-gradient(to left, #c084fc, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        @media (min-width: 768px) {
            .job-name {
                font-size: 18px;
            }
        }

        .job-desc {
            font-size: 12px;
            color: #a78bfa;
            font-weight: 500;
            opacity: 0.9;
        }

        @media (min-width: 768px) {
            .job-desc {
                font-size: 13px;
            }
        }

        /* Style for trailer images */
        .job-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 12px;
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .job-card:nth-child(1) .job-image { animation-delay: 0s; }
        .job-card:nth-child(2) .job-image { animation-delay: 0.2s; }

        .job-image-error {
            display: none;
            font-size: 48px;
        }

        #saudiSubAccountScreen {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 21, 0.98);
            backdrop-filter: blur(30px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }

        #saudiSubAccountScreen.hidden {
            display: none;
        }

        /* Home Sub-Account Screen Styles */
        #homeSubAccountScreen {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 21, 0.98);
            backdrop-filter: blur(30px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }

        #homeSubAccountScreen.hidden {
            display: none;
        }

        /* Home sub-account card styles with different gradients */
        .home-card-lalak {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(34, 211, 238, 0.08)) !important;
            border-color: rgba(6, 182, 212, 0.35) !important;
        }
        .home-card-lalak:hover {
            border-color: rgba(6, 182, 212, 0.7) !important;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.25), rgba(34, 211, 238, 0.15)) !important;
            box-shadow: 0 15px 40px rgba(6, 182, 212, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }
        .home-card-lalak .job-name {
            background: linear-gradient(to left, #22d3ee, #06b6d4) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        .home-card-saifullah {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(192, 132, 252, 0.08)) !important;
            border-color: rgba(168, 85, 247, 0.35) !important;
        }
        .home-card-saifullah:hover {
            border-color: rgba(168, 85, 247, 0.7) !important;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.25), rgba(192, 132, 252, 0.15)) !important;
            box-shadow: 0 15px 40px rgba(168, 85, 247, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }
        .home-card-saifullah .job-name {
            background: linear-gradient(to left, #c084fc, #a855f7) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        .home-card-saeedullah {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.08)) !important;
            border-color: rgba(59, 130, 246, 0.35) !important;
        }
        .home-card-saeedullah:hover {
            border-color: rgba(59, 130, 246, 0.7) !important;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(96, 165, 250, 0.15)) !important;
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }
        .home-card-saeedullah .job-name {
            background: linear-gradient(to left, #60a5fa, #3b82f6) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        .home-card-siddiqullah {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(244, 114, 182, 0.08)) !important;
            border-color: rgba(236, 72, 153, 0.35) !important;
        }
        .home-card-siddiqullah:hover {
            border-color: rgba(236, 72, 153, 0.7) !important;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.25), rgba(244, 114, 182, 0.15)) !important;
            box-shadow: 0 15px 40px rgba(236, 72, 153, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }
        .home-card-siddiqullah .job-name {
            background: linear-gradient(to left, #f472b6, #ec4899) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        #passwordScreen {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 21, 0.98);
            backdrop-filter: blur(30px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }

        #passwordScreen.hidden {
            display: none;
        }

        .password-card {
            max-width: 500px;
            width: 100%;
            animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .password-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 28px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .lock-icon {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 15px 40px rgba(245, 158, 11, 0.5);
            animation: pulseIcon 2s ease-in-out infinite;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .lock-icon {
                width: 80px;
                height: 80px;
                font-size: 42px;
            }
        }

        .password-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(to left, #c084fc, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .password-subtitle {
            color: #7dd3fc;
            font-size: 13px;
            margin-top: 8px;
            font-weight: 600;
        }

        .password-input-group {
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        .password-input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #c084fc;
            text-transform: uppercase;
        }

        .password-input {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-family: inherit;
            transition: all 0.3s ease;
            text-align: center;
            letter-spacing: 2px;
        }

        .password-input:focus {
            outline: none;
            border-color: #a855f7;
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
            transform: translateY(-2px);
        }

        .password-error {
            color: #ef4444;
            font-size: 13px;
            margin-top: 10px;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
            padding: 8px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .password-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            animation: fadeInUp 0.8s ease-out 0.6s both;
        }

        .password-button {
            flex: 1;
            padding: 16px;
            border-radius: 16px;
            border: none;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .password-button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: white;
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        .btn-primary:hover {
            box-shadow: 0 15px 40px rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }

        .form-grid {
            display: grid;
            gap: 16px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #c084fc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            background: rgba(10, 5, 21, 0.6);
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 14px;
            color: #f8fafc;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #a855f7;
            background: rgba(10, 5, 21, 0.8);
            box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .hint {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .error-message {
            font-size: 11px;
            color: #ef4444;
            margin-top: 6px;
            display: none;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            padding: 6px 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
        }

        .error-message.show {
            display: flex;
            animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: white;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
            font-family: inherit;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(139, 92, 246, 0.5);
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn-wrapper {
            margin-top: 10px;
            display: flex;
            gap: 12px;
        }

        .btn-secondary {
            padding: 16px;
            border-radius: 16px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }
        
        /* NEW STYLES FOR BALANCE */
        .balance-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.8s ease-out 0.3s both;
            display: none; /* Hidden by default */
        }
        
        .balance-label {
            font-size: 12px;
            color: #6ee7b7;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .balance-value {
            font-size: 32px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .balance-currency {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            font-weight: 500;
            margin-top: 8px;
        }
        
        .balance-edit-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: none; /* Only for admin */
        }
        
        .balance-edit-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 21, 0.95);
            backdrop-filter: blur(25px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            max-width: 550px;
            width: 100%;
            animation: modalPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .modal-icon {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(to left, #6ee7b7, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-subtitle {
            color: #7dd3fc;
            font-size: 12px;
            margin-top: 6px;
            font-weight: 600;
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .data-row {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-row-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 400px) {
            .data-row-grid {
                grid-template-columns: 1fr;
            }
        }

        .data-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .data-label {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
        }

        .data-value {
            font-size: 15px;
            color: #f1f5f9;
            font-weight: 700;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .btn-success {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 18px 40px rgba(16, 185, 129, 0.5);
        }

        .btn-success:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .last-save-section {
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.05));
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
        }
        
        .last-save-title {
            font-size: 13px;
            font-weight: 700;
            color: #fbbf24;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 14px;
            z-index: 10001;
            transform: translateX(120%);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 350px;
            backdrop-filter: blur(20px);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
            border: 1px solid rgba(52, 211, 153, 0.5);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
        }

        .toast.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
            border: 1px solid rgba(248, 113, 113, 0.5);
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.4);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
            border: 1px solid rgba(251, 191, 36, 0.5);
            box-shadow: 0 15px 40px rgba(245, 158, 11, 0.4);
        }

        .toast-title {
            font-size: 14px;
            font-weight: 800;
            color: white;
            margin-bottom: 4px;
        }

        .toast-description {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        .back-button-container {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 10;
        }

        @media (max-width: 767px) {
            .back-button-container {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 16px;
            }
        }

        @media (min-width: 768px) {
            .back-button-container {
                top: 16px;
            }
        }

        /* CATEGORY ICONS STYLES */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        @media (max-width: 480px) {
            .category-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .category-btn {
            background: rgba(10, 5, 21, 0.6);
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #f8fafc;
            font-family: inherit;
        }

        .category-btn:hover {
            border-color: #a855f7;
            background: rgba(139, 92, 246, 0.1);
            transform: translateY(-2px);
        }

        .category-btn.active {
            border-color: #a855f7;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.2));
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .category-btn-icon {
            font-size: 24px;
        }

        .category-btn-label {
            font-size: 11px;
            font-weight: 600;
        }
        
        #customCategoryInput {
            margin-top: 12px;
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }
        
        /* Checkbox for Document Mode */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .checkbox-wrapper:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #8b5cf6;
            margin: 0;
            cursor: pointer;
        }
        
        .checkbox-label {
            font-size: 13px;
            color: #e2e8f0;
            font-weight: 600;
            cursor: pointer;
        }

        .camera-options-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 12px;
            justify-content: center;
        }

        .camera-option-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #ccc;
            font-size: 12px;
            cursor: pointer;
        }

        .camera-option-toggle input {
            width: 16px;
            height: 16px;
            accent-color: #8b5cf6;
            margin: 0;
            cursor: pointer;
            padding: 0; /* Override global input padding */
        }
        
        /* Override global input styles for these checkboxes */
        .camera-option-toggle input[type="checkbox"] {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        /* Camera Modal Styles */
        #cameraModal {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 20000;
            display: none;
            flex-direction: column;
        }

        #cameraView {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            pointer-events: none;
        }

        .camera-controls-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: auto;
        }

        .camera-controls-bottom {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            pointer-events: auto;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding-bottom: 20px;
        }

        .camera-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        .shutter-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255,255,255,0.5);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .shutter-btn:active {
            transform: scale(0.9);
        }

        .camera-mode-selector {
            display: flex;
            gap: 20px;
            background: rgba(0,0,0,0.5);
            padding: 8px 16px;
            border-radius: 20px;
            margin-bottom: 10px;
        }

        .camera-mode {
            color: #ccc;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
        }

        .camera-mode.active {
            color: #fbbf24; /* Warning yellow */
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        #qr-reader {
            width: 100%;
            height: 100%;
            display: none;
        }

        /* Loading Overlay for OCR */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 20001;
            color: white;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* DASHBOARD STYLES */
        @media (min-width: 768px) {
            .dashboard-container {
                flex-direction: row !important;
            }
            .dashboard-sidebar {
                width: 280px;
                border-left: 1px solid rgba(255,255,255,0.1);
                border-bottom: none;
                height: 100vh;
            }
        }
        
        @media (max-width: 767px) {
            .dashboard-sidebar {
                width: 100%;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                border-left: none;
                flex-direction: row !important;
                align-items: center;
                justify-content: space-between;
                padding: 10px 16px !important;
                gap: 10px !important;
            }
            .nav-menu {
                display: none !important; /* Hide menu items on mobile for simplicity or use hamburger */
            }
        }

        .saudi-asset-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .saudi-asset-row:last-child {
            border-bottom: none;
        }

        /* Ensure default hidden state */
        .hidden { display: none !important; }
    
        .saudi-asset-row {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(59, 130, 246, 0.03));
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
</style>
</head>
<body>
    <div class="bg-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- Main Job Selection Screen -->
    <div id="jobSelectionScreen">
        <div class="glass-card job-selection-card">
            <div class="job-header">
                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                <div>
                    <h2>Ÿàÿ±⁄ÅŸÜŸä ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá</h2>
                    <p class="job-header-subtitle">ÿ≠ÿ≥ÿßÿ® ÿßŸÜÿ™ÿÆÿßÿ® ⁄©⁄ìÿ¶</p>
                </div>
            </div>
            
            <div class="job-grid" id="jobGrid"></div>

            <div style="margin-top: 25px; border-top: none; padding-top: 20px;">
                <button onclick="openGeneralDashboardAuth()" style="width: 100%; padding: 14px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: #94a3b8; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    üìä ÿπŸÖŸàŸÖŸä ŸÖÿßŸÑŸä ⁄âÿ¥ÿ®Ÿàÿ±⁄â
                </button>
            </div>
        </div>
    </div>

    <!-- General Dashboard Screen -->
    <div id="generalDashboardScreen" class="hidden" style="position: fixed; inset: 0; background: rgba(10, 5, 21, 0.98); backdrop-filter: blur(30px); display: flex; align-items: flex-start; justify-content: center; z-index: 9999; padding: 60px 10px 20px 10px; overflow: auto;">
        <div class="glass-card job-selection-card" style="max-width: 1400px; width: 98%; max-height: 98vh; height: auto; overflow-y: auto; display: flex; flex-direction: column; padding: 20px;">
             <button type="button" onclick="closeGeneralDashboard()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
            
            <div class="job-header" style="flex-direction: row; margin-bottom: 25px; gap: 20px; flex-shrink: 0; align-items: center; padding-top: 20px;">
                <div class="logo" style="width: 100px; height: 100px; font-size: 40px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.1);"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 20px;"></div>
                <div style="text-align: right;">
                    <h2 style="font-size: 28px; margin-bottom: 5px;">ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá</h2>
                    <p class="job-header-subtitle" style="font-size: 16px;">ÿπŸÖŸàŸÖŸä ŸÖÿßŸÑŸä ⁄âÿ¥ÿ®Ÿàÿ±⁄â</p>
                </div>
            </div>

            <div class="job-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; flex-grow: 1; align-content: start; padding-bottom: 20px;">
                <!-- Chart Area -->
                <div class="job-card" style="grid-column: span 2; min-height: 300px; padding: 20px; background: rgba(255,255,255,0.03); cursor: default; pointer-events: none;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #94a3b8; text-align: right;">üìä ÿØ ÿπÿß€åÿØ ÿßŸà ŸÖÿµÿ±ŸÅ ⁄´ÿ±ÿßŸÅ</h3>
                    <div style="height: 250px; width: 100%;">
                        <canvas id="dashboardChart"></canvas>
                    </div>
                </div>
                
                <!-- COLUMN 1: Assets & Income (Left/Top in Mobile) -->
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <h3 style="color: #6ee7b7; font-size: 18px; margin-bottom: 5px; border-bottom: 1px solid rgba(110, 231, 183, 0.2); padding-bottom: 5px;">ÿπÿß€åÿØ ÿßŸà ÿ≥ÿ±ŸÖÿß€åŸá</h3>
                    
                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üåç</div>
                        <div class="job-name" style="font-size: 16px;">ŸºŸàŸÑŸá ÿ≥ÿ±ŸÖÿß€åŸá</div>
                        <div class="job-desc" style="font-size: 20px;"><span id="dashTotalWorth">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üìà</div>
                        <div class="job-name" style="font-size: 16px;">ÿÆÿßŸÑÿµŸá ⁄´ŸºŸá</div>
                        <div class="job-desc" style="font-size: 20px; color: #6ee7b7;"><span id="dashNetProfit">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üí∞</div>
                        <div class="job-name" style="font-size: 16px;">ŸºŸàŸÑ ÿπÿß€åÿØ</div>
                        <div class="job-desc" style="font-size: 20px; color: #6ee7b7;"><span id="dashTotalIncome">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üíµ</div>
                        <div class="job-name" style="font-size: 16px;">ŸÖŸàÿ¨ŸàÿØŸá ŸÜŸÇÿØŸá</div>
                        <div class="job-desc" style="font-size: 20px;"><span id="dashTotalCash">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üì¶</div>
                        <div class="job-name" style="font-size: 16px;">ÿØ ⁄´ÿØÿßŸÖ ÿßÿ±ÿ≤⁄öÿ™</div>
                        <div class="job-desc" style="font-size: 20px;"><span id="dashInventory">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="position: relative; padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">ü§ù</div>
                        <div class="job-name" style="color: #fdba74; font-size: 16px;">Ÿæÿ± ÿÆŸÑ⁄©Ÿà ŸÇÿ±ÿ∂ŸàŸÜŸá</div>
                        <div class="job-desc" style="color: #fdba74; font-size: 20px;"><span id="dashReceivable">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1)); border-color: rgba(16, 185, 129, 0.3); cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üåô</div>
                        <div class="job-name" style="color: #6ee7b7; font-size: 16px;">ÿØ ÿ≤⁄©ÿßÿ™ ⁄©ÿ±Ÿá ÿßŸÜÿØÿßÿ≤Ÿá</div>
                        <div class="job-desc" style="color: #6ee7b7; font-size: 20px;"><span id="dashZakat">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üìä</div>
                        <div class="job-name" style="font-size: 16px;">ŸÖ€åÿßÿ¥ÿ™ŸÜ€ç ŸàÿØŸá</div>
                        <div class="job-desc" style="font-size: 20px; color: #60a5fa;"><span id="dashGrowth">0</span> <span style="font-size: 12px;">%</span></div>
                    </div>
                </div>

                <!-- COLUMN 2: Expenses & Liabilities (Right/Bottom in Mobile) -->
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <h3 style="color: #fca5a5; font-size: 18px; margin-bottom: 5px; border-bottom: 1px solid rgba(252, 165, 165, 0.2); padding-bottom: 5px;">ŸÖÿµÿßÿ±ŸÅ ÿßŸà ŸÇÿ±ÿ∂ŸàŸÜŸá</h3>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üìâ</div>
                        <div class="job-name" style="font-size: 16px;">ÿØ ⁄©ÿßÿ± ŸºŸàŸÑ ŸÖÿµÿßÿ±ŸÅ</div>
                        <div class="job-desc" style="font-size: 20px; color: #fca5a5;"><span id="dashTotalExpense">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                <!-- Operating Expenses -->
                <div class="job-card" style="position: relative; padding: 16px; gap: 8px; cursor: pointer;" onclick="openOpExpScreen()">
                    <div class="job-icon" style="font-size: 32px;">üí∏</div>
                    <div class="job-name" style="font-size: 16px;">ÿπŸÖŸÑ€åÿßÿ™Ÿä ŸÖÿµÿßÿ±ŸÅ</div>
                    <div class="job-desc" style="font-size: 20px; color: #f87171;"><span id="dashOpExp">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    <div style="font-size: 10px; color: #94a3b8;">ÿØ ÿ´ÿ®ÿ™ ŸÑŸæÿßÿ±Ÿá ⁄©ŸÑ€å⁄© Ÿà⁄©⁄ìÿ¶</div>
                </div>

                <!-- Capital Expenses -->
                <div class="job-card" style="position: relative; padding: 16px; gap: 8px; cursor: pointer;" onclick="openCapExpScreen()">
                    <div class="job-icon" style="font-size: 32px;">üèóÔ∏è</div>
                    <div class="job-name" style="font-size: 16px;">ŸæÿßŸÜ⁄´€åÿ≤ ŸÖÿµÿßÿ±ŸÅ</div>
                    <div class="job-desc" style="font-size: 20px; color: #fb923c;"><span id="dashCapExp">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    <div style="font-size: 10px; color: #94a3b8;">ÿØ ÿ´ÿ®ÿ™ ŸÑŸæÿßÿ±Ÿá ⁄©ŸÑ€å⁄© Ÿà⁄©⁄ìÿ¶</div>
                </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üí∏</div>
                        <div class="job-name" style="font-size: 16px;">ÿ¥ÿÆÿµŸä ŸÖÿµÿßÿ±ŸÅ</div>
                        <div class="job-desc" style="font-size: 20px; color: #fca5a5;"><span id="dashPersonalExpense">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="position: relative; padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üìâ</div>
                        <div class="job-name" style="color: #fca5a5; font-size: 16px;">Ÿæÿ± ŸÖŸàŸÜ⁄ñ ŸÇÿ±ÿ∂ŸàŸÜŸá</div>
                        <div class="job-desc" style="color: #fca5a5; font-size: 20px;"><span id="dashLiability">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>

                    <div class="job-card" style="padding: 16px; gap: 8px; cursor: default; pointer-events: none;">
                        <div class="job-icon" style="font-size: 32px;">üèóÔ∏è</div>
                        <div class="job-name" style="font-size: 16px;">ÿ≥ÿ±ŸÖÿß€åŸá ŸæŸá ÿ®ŸÜÿØ ⁄©€ê</div>
                        <div class="job-desc" style="font-size: 20px;"><span id="dashCapitalInUse">0</span> <span style="font-size: 12px;">ÿßŸÅÿ∫ÿßŸÜ€ç</span></div>
                    </div>
                </div>
            </div>

            <!-- Debt Book Button -->
            <div style="margin-top: 15px; flex-shrink: 0;">
                <button onclick="openDebtScreen()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; color: white; font-size: 18px; font-weight: 800; cursor: pointer; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4), inset 0 1px 0 rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform: scale(1);">
                    <span style="font-size: 24px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">üìí</span> 
                    <span style="text-shadow: 0 2px 4px rgba(0,0,0,0.2);">ÿØ ŸÇÿ±ÿ∂ŸàŸÜŸà ⁄©ÿ™ÿßÿ®⁄ÜŸá</span>
                </button>
            </div>
        </div>
    </div>

<!-- Saudi Sub-Account Selection Screen -->
    <div id="saudiSubAccountScreen" class="hidden">
        <div class="glass-card job-selection-card">
            <button type="button" onclick="backFromSaudiSubAccount()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1)';">‚úï</button>
            <div class="job-header">
                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                <div>
                    <h2>ÿ≥ÿπŸàÿØŸä ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá</h2>
                    <p class="job-header-subtitle">ŸÅÿ±ÿπŸä ÿ≠ÿ≥ÿßÿ® ÿßŸÜÿ™ÿÆÿßÿ® ⁄©⁄ìÿ¶</p>
                </div>
            </div>
            <div class="job-grid" id="saudiSubAccountGrid"></div>
        </div>
    </div>

    <!-- Home Sub-Account Selection Screen -->
    <div id="homeSubAccountScreen" class="hidden">
        <div class="glass-card job-selection-card">
            <button type="button" onclick="backFromHomeSubAccount()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1)';">‚úï</button>
            <div class="job-header">
                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                <div>
                    <h2>ÿØ ⁄©Ÿàÿ± ŸÖÿµÿßÿ±ŸÅ</h2>
                    <p class="job-header-subtitle">ŸÅÿ±ÿπŸä ÿ≠ÿ≥ÿßÿ® ÿßŸÜÿ™ÿÆÿßÿ® ⁄©⁄ìÿ¶</p>
                </div>
            </div>
            <div class="job-grid" id="homeSubAccountGrid"></div>
        </div>
    </div>

    <!-- Password Screen -->
    <div id="passwordScreen" class="hidden">
        <div class="glass-card password-card">
            <button type="button" onclick="backToJobs()" style="position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border: 1px solid rgba(255,255,255,0.2); z-index: 100; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1)';">‚úï</button>
            <div class="password-header">
                <div class="lock-icon">üîí</div>
                <div>
                    <div class="password-title">ÿØ 2026 ⁄©ÿßŸÑ ŸÅŸàÿ±ŸÖ</div>
                    <p class="password-subtitle">‚ú® Ÿæÿßÿ≥Ÿàÿ±⁄â ÿØÿßÿÆŸÑ ⁄©⁄ìÿ¶</p>
                </div>
            </div>

            <div class="password-input-group">
                <label class="password-input-label" for="passwordInput">üîê Ÿæÿßÿ≥Ÿàÿ±⁄â</label>
                <input type="password" id="passwordInput" class="password-input" placeholder="Ÿæÿßÿ≥Ÿàÿ±⁄â ŸàŸÑ€å⁄©ÿ¶..." autocomplete="off">
            </div>

            <div class="password-error" id="passwordError">‚ùå Ÿæÿßÿ≥Ÿàÿ±⁄â ÿ∫ŸÑÿ∑ ÿØÿ¶</div>

            <div class="password-buttons">
                <button type="button" class="password-button btn-primary" style="width: 100%;" onclick="checkPassword()">ÿØÿÆŸàŸÑ</button>
            </div>
        </div>
    </div>

    <!-- Main Form Container -->
    <div class="container hidden" id="formContainer">
        <div class="glass-card">
            <div class="header">
                <div class="logo"><img src="./logo.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px;"></div>
                <div>
                    <h1>ÿØ Ÿàÿ±⁄ÅŸÜŸä ÿ≠ÿ≥ÿßÿ® ŸÅŸàÿ±ŸÖ</h1>
                    <p class="subtitle">‚ú® ŸÖŸáÿ±ÿ®ÿßŸÜŸä Ÿà⁄©⁄ìÿ¶ ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸæŸá ÿØŸÇ€åŸÇŸá ÿ™Ÿà⁄´Ÿá ⁄â⁄© ⁄©⁄ìÿ¶</p>
                </div>
            </div>

            <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(59, 130, 246, 0.06)); border: 2px solid rgba(139, 92, 246, 0.25); border-radius: 16px; margin-bottom: 24px;">
                <div style="font-size: 28px; margin-bottom: 8px;" id="currentJobIcon"></div>
                <div style="font-size: 16px; font-weight: 800; background: linear-gradient(to left, #c084fc, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="currentJobName"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                <button type="button" class="btn-secondary" style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); color: #c084fc; font-weight: 700;" onclick="openDashboard()">
                    üìä ⁄âÿ¥ÿ®Ÿàÿ±⁄â
                </button>
                <button type="button" class="btn-secondary" style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); color: #c084fc; font-weight: 700;" onclick="openReport()">
                    üìà ÿ±ÿßŸæŸàÿ±
                </button>
            </div>
            
            <!-- Balance Section (Only for Home Accounts) -->
            <div id="balanceSection" class="balance-section">
                <div class="balance-label">ŸÖŸàÿ¨ŸàÿØŸá ⁄´⁄â ÿ®€åŸÑÿßŸÜÿ≥</div>
                <div class="balance-value">
                    <span id="balanceValue">0</span>
                    <span class="balance-currency">AFN</span>
                </div>
                <button id="editBalanceBtn" class="balance-edit-btn" onclick="editBalance()">‚úèÔ∏è</button>
            </div>

            <form id="trailerForm" class="form-grid">
                <div class="input-group full-width">
                    <label for="date">üìÖ ŸÜ€êŸºŸá (2026)</label>
                    <input type="date" id="date" name="date" min="2026-01-01" max="2026-12-31" required style="width: 95%;">
                    <p class="hint">‚≠ê €åŸàÿßÿ≤€ê ÿØ 2026 ⁄©ÿßŸÑ ŸÜ€åŸº€ê ŸÖŸÜŸÑ ⁄©€å⁄ñŸä</p>
                </div>

                <!-- Income Field (Hidden for Home Accounts, Visible for others) -->
                <div class="input-group full-width" id="incomeGroup" style="display: none;">
                    <label for="income">üí∞ ÿπÿßÿ¶ÿØ</label>
                    <input type="number" id="income" name="income" min="0" placeholder="ÿπÿßÿ¶ÿØ ŸàŸÑ€å⁄©ÿ¶">
                    <p class="error-message" id="incomeError">‚ùå ÿπÿßÿ¶ÿØ ŸÑ€å⁄©ŸÑ ŸÑÿßÿ≤ŸÖ ÿØ€å (ÿµŸÅÿ± €åÿß ŸÑŸà⁄ì ÿπÿØÿØ ŸàŸÑ€å⁄©ÿ¶)</p>
                </div>

                <div class="input-group full-width">
                    <label for="expense">üí∏ ŸÖÿµÿßÿ±ŸÅ</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="expense" name="expense" min="0" placeholder="ŸÖÿµÿßÿ±ŸÅ ŸàŸÑ€å⁄©ÿ¶" style="flex: 1;">
                        <select id="currency" name="currency" style="width: 100px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; cursor: pointer;">
                            <option value="AFN" selected>ÿã AFN</option>
                            <option value="USD">$ USD</option>
                            <option value="PKR">‚Ç® PKR</option>
                            <option value="SAR">ÿ±.ÿ≥ SAR</option>
                        </select>
                    </div>
                    <p class="error-message" id="expenseError">‚ùå ŸÖÿµÿßÿ±ŸÅ ŸÑ€å⁄©ŸÑ ŸÑÿßÿ≤ŸÖ ÿØ€å (ÿµŸÅÿ± €åÿß ŸÑŸà⁄ì ÿπÿØÿØ ŸàŸÑ€å⁄©ÿ¶)</p>
                </div>

                <!-- Category Field (For Home Accounts) - REPLACED WITH ICONS -->
                <div class="input-group full-width" id="categoryGroup" style="display: none;">
                    <label>üìÇ ⁄©Ÿº⁄´Ÿàÿ±Ÿä (ÿØ ŸÖÿµÿßÿ±ŸÅŸà ŸÑŸæÿßÿ±Ÿá)</label>
                    <input type="hidden" id="category" name="category">
                    
                    <div class="category-grid">
                        <div class="category-btn" onclick="selectCategory('ÿÆŸàÿ±ÿß⁄©', this)">
                            <div class="category-btn-icon">üçî</div>
                            <div class="category-btn-label">ÿÆŸàÿ±ÿß⁄©</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ÿ±Ÿàÿ∫ÿ™€åÿß', this)">
                            <div class="category-btn-icon">üíä</div>
                            <div class="category-btn-label">ÿ±Ÿàÿ∫ÿ™€åÿß</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ÿ™ÿπŸÑ€åŸÖ', this)">
                            <div class="category-btn-icon">üìö</div>
                            <div class="category-btn-label">ÿ™ÿπŸÑ€åŸÖ</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ÿ™ŸÅÿ±€åÿ≠', this)">
                            <div class="category-btn-icon">üéÆ</div>
                            <div class="category-btn-label">ÿ™ŸÅÿ±€åÿ≠</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('Ÿºÿ±ÿßŸÜÿ≥ŸæŸàÿ±Ÿº', this)">
                            <div class="category-btn-icon">üöï</div>
                            <div class="category-btn-label">Ÿºÿ±ÿßŸÜÿ≥ŸæŸàÿ±Ÿº</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ÿ¨ÿßŸÖ€ê', this)">
                            <div class="category-btn-icon">üëï</div>
                            <div class="category-btn-label">ÿ¨ÿßŸÖ€ê</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ŸÖ€åŸÑŸÖŸá', this)">
                            <div class="category-btn-icon">‚òï</div>
                            <div class="category-btn-label">ŸÖ€åŸÑŸÖŸá</div>
                        </div>
                        <div class="category-btn" onclick="selectCategory('ŸÜŸàÿ±', this)">
                            <div class="category-btn-icon">‚ûï</div>
                            <div class="category-btn-label">ŸÜŸàÿ±...</div>
                        </div>
                    </div>

                    <input type="text" id="customCategoryInput" placeholder="ÿØ ⁄©Ÿº⁄´Ÿàÿ±€ç ŸÜŸàŸÖ ŸàŸÑ€å⁄©ÿ¶..." oninput="updateCustomCategory(this.value)">
                </div>

                <div class="input-group full-width">
                    <label for="detail">üìù ÿØ ⁄©ÿßÿ± ÿ™ŸÅÿµ€åŸÑ</label>
                    <textarea id="detail" name="detail" placeholder="ÿØ ⁄©ÿßÿ± ÿ™ŸÅÿµ€åŸÑ ŸàŸÑ€å⁄©ÿ¶..."></textarea>
                </div>

                <div class="input-group full-width" id="noteGroup">
                    <label for="note">üìå €åÿßÿØÿß⁄öÿ™ (ÿßÿÆÿ™€åÿßÿ±Ÿä)</label>
                    <input type="text" id="note" name="note" placeholder="€åÿßÿØÿß⁄öÿ™ ŸàŸÑ€å⁄©ÿ¶...">
                </div>

                <div class="input-group full-width">
                    <label>üì∑ ÿØ ÿ®€åŸÑ/ŸÅÿßÿ™Ÿàÿ±€ê ÿπ⁄©ÿ≥ (ÿßÿÆÿ™€åÿßÿ±Ÿä)</label>
                    <!-- Main Container Box -->
                    <div id="billImageArea" style="background: rgba(255, 255, 255, 0.05); border: 2px dashed rgba(139, 92, 246, 0.3); border-radius: 14px; padding: 15px; transition: all 0.3s;">
                        
                        <!-- Inner Flex Container (Grid Option) -->
                        <div style="display: flex; justify-content: space-around; align-items: center; gap: 10px; flex-wrap: wrap;">
                            
                            <!-- Option 1: Gallery (Standard Image) -->
                            <div onclick="document.getElementById('billImageGallery').click()" style="text-align: center; cursor: pointer; flex: 1; min-width: 80px; padding: 10px; border-radius: 10px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                <div style="font-size: 24px; margin-bottom: 4px;">üìÇ</div>
                                <div style="font-size: 11px; color: #a78bfa; font-weight: 600;">ŸÅÿß€åŸÑ/⁄´ÿßŸÑÿ±Ÿä</div>
                            </div>

                            <!-- Option 2: Smart Camera -->
                            <div onclick="openCamera('photo')" style="text-align: center; cursor: pointer; flex: 1; min-width: 80px; padding: 10px; border-radius: 10px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                                <div style="font-size: 24px; margin-bottom: 4px;">üì∏</div>
                                <div style="font-size: 11px; color: #6ee7b7; font-weight: 600;">ÿ≥ŸÖÿßÿ±Ÿº ⁄©€êŸÖÿ±Ÿá</div>
                            </div>

                        </div>
                    </div>
                    
                    <!-- Document Mode Toggle -->
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="documentModeToggle" onchange="reprocessImage()">
                        <span class="checkbox-label">üìÑ ÿØ ÿßÿ≥ŸÜÿßÿØŸà ÿ≠ÿßŸÑÿ™ (Document Mode)</span>
                    </label>

                    <!-- Hidden Inputs -->
                    <input type="file" id="billImageGallery" name="billImageGallery" accept="image/*" style="display: none;" onchange="handleImageSelect(this)">

                    <!-- Preview Area -->
                    <div id="imagePreview" style="display: none; margin-top: 12px; position: relative; text-align: center;">
                        <img id="previewImg" src="" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div id="compressionInfo" style="font-size: 11px; color: #6ee7b7; margin-top: 5px;"></div>
                        <button type="button" onclick="removeImage()" style="position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold;">‚úï</button>
                    </div>
                </div>

                <div class="submit-btn-wrapper full-width">
                    <button type="button" class="btn-secondary" onclick="logout()">ÿÆÿ±Ÿàÿ¨</button>
                    <button type="submit" class="submit-btn">‚úì ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="glass-card modal">
            <div class="modal-header">
                <div class="modal-icon">‚úì</div>
                <div>
                    <div class="modal-title">ÿ™ÿß€å€åÿØ</div>
                    <p class="modal-subtitle">ŸÖŸáÿ±ÿ®ÿßŸÜŸä Ÿà⁄©⁄ìÿ¶ ŸÖÿπŸÑŸàŸÖÿßÿ™ Ÿà⁄´Ÿàÿ±ÿ¶</p>
                </div>
            </div>

            <div class="modal-body">
                <div class="last-save-section" id="lastSaveRow" style="display: none;">
                    <div class="last-save-title">üìã Ÿàÿ±Ÿàÿ≥ÿ™€å ÿ∞ÿÆ€åÿ±Ÿá ÿ¥Ÿà€å</div>
                    <div class="data-row-grid">
                        <div class="data-field">
                            <span class="data-label">üìÖ ŸÜ€êŸºŸá</span>
                            <span class="data-value" id="lastSaveDate">-</span>
                        </div>
                        <div class="data-field">
                            <span class="data-label">üí∏ ŸÖÿµÿßÿ±ŸÅ</span>
                            <span class="data-value" id="lastSaveExpense">-</span>
                        </div>
                        <div class="data-field">
                            <span class="data-label">üìù ÿ™ŸÅÿµ€åŸÑ</span>
                            <span class="data-value" id="lastSaveDetail">-</span>
                        </div>
                    </div>
                    <div class="data-field" id="lastSaveNoteRow" style="margin-top: 12px; display: none;">
                        <span class="data-label">üìå €åÿßÿØÿß⁄öÿ™</span>
                        <span class="data-value" id="lastSaveNote">-</span>
                    </div>
                </div>

                <div class="last-save-title" style="margin-top: 20px; margin-bottom: 10px; color: #c084fc; font-weight: 700;">üìù ŸÜŸàŸä ŸÖÿπŸÑŸàŸÖÿßÿ™</div>
                <div class="data-row">
                    <div class="data-row-grid">
                        <div class="data-field">
                            <span class="data-label">üìÖ ŸÜ€êŸºŸá</span>
                            <span class="data-value" id="confirmDate">-</span>
                        </div>
                        <div class="data-field">
                            <span class="data-label">üí∏ ŸÖÿµÿßÿ±ŸÅ</span>
                            <span class="data-value" id="confirmExpense">-</span>
                        </div>
                    </div>
                </div>

                <div class="data-row">
                    <div class="data-row-grid">
                        <div class="data-field" style="grid-column: 1 / -1;">
                            <span class="data-label">üìù ÿØ ⁄©ÿßÿ± ÿ™ŸÅÿµ€åŸÑ</span>
                            <span class="data-value" id="confirmDetail">-</span>
                        </div>
                    </div>
                </div>

                <!-- Added Category to Modal -->
                <div class="data-row" id="categoryRow" style="display: none;">
                    <div class="data-field">
                        <span class="data-label">üìÇ ⁄©Ÿº⁄´Ÿàÿ±Ÿä</span>
                        <span class="data-value" id="confirmCategory">-</span>
                    </div>
                </div>

                <div class="data-row" id="imageRow" style="display: none;">
                    <div class="data-field">
                        <span class="data-label">üì∑ ÿ®€åŸÑ ÿ∂ŸÖ€åŸÖŸá</span>
                        <span class="data-value" style="color: #6ee7b7;">‚úì ÿπ⁄©ÿ≥ ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥Ÿà (Compressed)</span>
                    </div>
                </div>

                <div class="data-row" id="noteRow" style="display: none;">
                    <div class="data-field">
                        <span class="data-label">üìå €åÿßÿØÿß⁄öÿ™</span>
                        <span class="data-value" id="confirmNote">-</span>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeModal()">‚úèÔ∏è ÿ™ÿµÿ≠€åÿ≠</button>
                <button type="button" class="btn-success" id="confirmButton" onclick="confirmSubmit()">‚úì ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™ÿß€å€åÿØ ÿßŸà ÿ∞ÿÆ€åÿ±Ÿá ⁄©⁄ìÿ¶ </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 700px; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); box-shadow: 0 12px 30px rgba(99, 102, 241, 0.4);">üìä</div>
                <div>
                    <div class="modal-title">⁄âÿ¥ÿ®Ÿàÿ±⁄â</div>
                    <p class="modal-subtitle">ÿØ ÿ≠ÿ≥ÿßÿ® ÿπŸÖŸàŸÖŸä ŸÖÿπŸÑŸàŸÖÿßÿ™</p>
                </div>
                <button type="button" id="dashboardDeleteBtn" class="btn-secondary" style="margin-right: auto; background: rgba(239, 68, 68, 0.2); color: #fca5a5; margin-left: 10px; font-size: 12px; display: none;" onclick="clearAllData()">üóëÔ∏è ⁄ìŸÜ⁄´ŸàŸÑ</button>
                <button type="button" class="btn-close-fancy" onclick="closeDashboard()">‚úï</button>
            </div>

            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <!-- Data Management & Features -->
                <div id="adminOnlyFeatures" style="display:none;">
                <div style="margin-bottom: 15px;">
                     <button class="btn-primary" onclick="downloadBackup()" style="width: 100%; background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);">üíæ ÿ®€å⁄© ÿßŸæ (Backup)</button>
                </div>
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <input type="file" id="restoreFile" style="display: none;" onchange="restoreBackup(this)">
                    <button class="btn-secondary" onclick="document.getElementById('restoreFile').click()" style="width: 100%; border: 1px dashed #6366f1; color: #818cf8;">üìÇ ⁄â€åŸºÿß ÿ®€åÿ±ÿ™Ÿá ŸæŸàÿ±ÿ™Ÿá ⁄©ŸàŸÑ (Restore)</button>
                </div>

                <!-- Budget Warning -->
                <div id="budgetWarning" style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 12px; border-radius: 12px; margin-bottom: 15px; display: none; align-items: center; gap: 8px; font-size: 13px;">
                    ‚ö†Ô∏è ÿÆÿ®ÿ±ÿ™€åÿß: ÿ≥ÿ™ÿßÿ≥Ÿà ŸÖÿµÿßÿ±ŸÅ Ÿºÿß⁄©ŸÑ ÿ¥ŸàŸä ÿ≠ÿØ ÿ™Ÿá ŸÜ⁄ñÿØ€ê ÿØŸä!
                </div>

                <!-- Currency Converter -->
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div style="font-size: 13px; font-weight: 700; color: #fbbf24; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span>üí± ÿØ ÿßÿ≥ÿπÿßÿ±Ÿà ÿ™ÿ®ÿßÿØŸÑŸá (ÿ™Ÿá AFN)</span>
                        <button onclick="fetchRates()" style="background: none; border: none; color: #6ee7b7; cursor: pointer; font-size: 16px;" title="ŸÜÿ±ÿÆŸàŸÜŸá ÿ™ÿßÿ≤Ÿá ⁄©⁄ìÿ¶">üîÑ</button>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="currencySelect" style="width: 35%; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;" onchange="updateRatePlaceholder()">
                            <option value="SAR">SAR (ÿ±€åÿßŸÑ)</option>
                            <option value="USD">USD (⁄âÿßŸÑÿ±)</option>
                            <option value="PKR">PKR (⁄©ŸÑÿØÿßÿ±)</option>
                        </select>
                        <input type="number" id="currencyInput" placeholder="ŸÖŸÇÿØÿßÿ±" style="flex: 1; min-width: 0; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;" oninput="convertCurrency()">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px; flex-wrap: wrap;">
                        <span style="color: #94a3b8; font-size: 12px;">ŸÜÿ±ÿÆ:</span>
                        <input type="number" id="exchangeRate" placeholder="ŸÜÿ±ÿÆ" value="18.5" style="width: 80px; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;" oninput="convertCurrency()">
                        <span style="color: #94a3b8;">=</span>
                        <span id="afnResult" style="color: #6ee7b7; font-weight: 800; min-width: 60px;">0 AFN</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05);">
                        <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 6px;">
                            <div style="font-size: 10px; color: #94a3b8;">$ USD</div>
                            <div id="rateUSD" style="font-size: 12px; color: #6ee7b7; font-weight: bold;">--</div>
                        </div>
                        <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 6px;">
                            <div style="font-size: 10px; color: #94a3b8;">ÿ±.ÿ≥ SAR</div>
                            <div id="rateSAR" style="font-size: 12px; color: #6ee7b7; font-weight: bold;">--</div>
                        </div>
                        <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 6px;">
                            <div style="font-size: 10px; color: #94a3b8;">‚Ç® PKR</div>
                            <div id="ratePKR" style="font-size: 12px; color: #6ee7b7; font-weight: bold;">--</div>
                        </div>
                    </div>
                    <div id="rateLastUpdated" style="font-size: 10px; color: #64748b; margin-top: 5px; text-align: left;"></div>
                </div>

                                </div>
                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); padding: 16px; border-radius: 16px;">
                        <div style="font-size: 12px; color: #6ee7b7; margin-bottom: 6px;">ŸºŸàŸÑŸá ⁄´ŸºŸá (ÿ¢ŸÖÿØ)</div>
                        <div style="font-size: 20px; font-weight: 800; color: #fff;">150,000</div>
                        <div style="font-size: 10px; color: #a7f3d0; margin-top: 4px;">+12% ÿØ ÿ™€åÿ±€ê ŸÖ€åÿßÿ¥ÿ™€ê ŸæŸá Ÿæÿ±ÿ™ŸÑŸá</div>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 16px; border-radius: 16px;">
                        <div style="font-size: 12px; color: #fca5a5; margin-bottom: 6px;">ŸºŸàŸÑ ŸÖÿµÿßÿ±ŸÅ</div>
                        <div style="font-size: 20px; font-weight: 800; color: #fff;">45,000</div>
                        <div style="font-size: 10px; color: #fecaca; margin-top: 4px;">-5% ÿØ ÿ™€åÿ±€ê ŸÖ€åÿßÿ¥ÿ™€ê ŸæŸá Ÿæÿ±ÿ™ŸÑŸá</div>
                    </div>
                </div>

                <!-- Chart Placeholder -->
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
                    <div style="font-size: 14px; font-weight: 700; color: #e2e8f0; margin-bottom: 16px;">ÿØ ÿ±ŸàÿßŸÜ€ê ŸÖ€åÿßÿ¥ÿ™€ê ÿßÿ≠ÿµÿß€åŸá</div>
                    <div style="display: flex; align-items: flex-end; justify-content: space-between; height: 150px; padding-top: 20px;">
                        <div style="width: 12%; background: rgba(139, 92, 246, 0.3); height: 40%; border-radius: 8px 8px 0 0; position: relative;"><span style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #94a3b8;">H1</span></div>
                        <div style="width: 12%; background: rgba(139, 92, 246, 0.5); height: 70%; border-radius: 8px 8px 0 0; position: relative;"><span style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #94a3b8;">H2</span></div>
                        <div style="width: 12%; background: rgba(139, 92, 246, 0.4); height: 50%; border-radius: 8px 8px 0 0; position: relative;"><span style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #94a3b8;">H3</span></div>
                        <div style="width: 12%; background: rgba(139, 92, 246, 0.7); height: 90%; border-radius: 8px 8px 0 0; position: relative;"><span style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #94a3b8;">H4</span></div>
                        <div style="width: 12%; background: rgba(139, 92, 246, 0.6); height: 60%; border-radius: 8px 8px 0 0; position: relative;"><span style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #94a3b8;">H5</span></div>
                    </div>
                </div>

                <div class="data-row">
                     <div class="data-field" style="flex-direction: row; justify-content: space-between; align-items: center;">
                        <span class="data-label">ÿßŸàÿ≥ŸÜ€å ÿÆÿßŸÑÿµ ÿ®€åŸÑÿßŸÜÿ≥</span>
                        <span class="data-value" style="color: #6ee7b7; font-size: 18px;">105,000 ÿã</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Screen -->
    <div id="reportScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 700px; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #f43f5e, #fb7185); box-shadow: 0 12px 30px rgba(244, 63, 94, 0.4);">üìà</div>
                <div>
                    <div class="modal-title">Ÿàÿ±Ÿàÿ≥ÿ™Ÿä ÿ±ÿßŸæŸàÿ±ŸàŸÜŸá</div>
                    <p class="modal-subtitle">ÿØ Ÿàÿ±Ÿàÿ≥ÿ™€åŸà ŸÖÿπÿßŸÖŸÑŸà ŸÑ€åÿ≥ÿ™</p>
                </div>
                <button type="button" id="reportDeleteBtn" class="btn-secondary" style="margin-right: auto; background: rgba(239, 68, 68, 0.2); color: #fca5a5; margin-left: 10px; font-size: 12px; display: none;" onclick="clearAllData()">üóëÔ∏è ⁄ìŸÜ⁄´ŸàŸÑ</button>
                <button type="button" class="btn-close-fancy" onclick="closeReport()">‚úï</button>
            </div>

            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <!-- Admin Account Selector -->
                <div id="adminAccountSelectContainer" style="margin-bottom: 12px; display: none;">
                    <label style="color: #94a3b8; font-size: 11px; margin-bottom: 4px; display: block;">ÿØ ÿ≠ÿ≥ÿßÿ® ÿßŸÜÿ™ÿÆÿßÿ® (ÿßÿØŸÖ€åŸÜ):</label>
                    <select id="reportAccountSelector" style="width: 100%; padding: 10px; font-size: 13px; border-radius: 10px; background: rgba(139, 92, 246, 0.15); color: white; border: 1px solid rgba(139, 92, 246, 0.3); outline: none;" onchange="filterReportByDuration()">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <div style="margin-bottom: 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <select id="reportDuration" style="padding: 10px; font-size: 12px; border-radius: 10px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); outline: none;" onchange="filterReportByDuration()">
                        <option value="all" style="background: #333;">ŸºŸàŸÑ ŸàÿÆÿ™</option>
                        <option value="today" style="background: #333;">ŸÜŸÜ Ÿàÿ±⁄Å</option>
                        <option value="week" style="background: #333;">ÿØÿß ÿßŸàŸÜ€ç</option>
                        <option value="month" style="background: #333;">ÿØÿß ŸÖ€åÿßÿ¥ÿ™</option>
                        <option value="year" style="background: #333;">ÿØÿß ⁄©ÿßŸÑ</option>
                    </select>
                    <button class="btn-secondary" style="padding: 10px 16px; font-size: 12px; background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid rgba(16, 185, 129, 0.3);" onclick="printReport()">üñ®Ô∏è Ÿæÿ±ŸÜŸº / PDF</button>
                    <button class="btn-secondary" style="padding: 10px 16px; font-size: 12px; background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3);" onclick="exportToCSV()">üìä Excel / CSV</button>
                </div>
                
                <!-- Search Box -->
                <div class="search-box-container" style="margin-bottom: 15px;">
                    <input type="text" id="reportSearchInput" placeholder="üîç ŸæŸá ÿ±ÿßŸæŸàÿ±ŸàŸÜŸà ⁄©€ê ŸÑŸºŸàŸÜ (Search)..." style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: white;">
                </div>

                <!-- Pie Chart Container -->
                <div class="chart-container" style="position: relative; height: 250px; width: 100%; margin-bottom: 20px;">
                    <canvas id="expensePieChart"></canvas>
                </div>

                <div class="report-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Report Item (Mock) -->
                    <div class="data-row" style="margin-bottom: 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span style="font-size: 14px; font-weight: 700; color: #f8fafc;">ÿ™€åŸÑ ÿßŸà ÿ±Ÿàÿ∫ŸÜ€åÿßÿ™</span>
                            <span style="font-size: 11px; color: #94a3b8;">2025-01-15 | üöõ Ÿºÿ±€åŸÑÿ± 3125</span>
                        </div>
                        <span style="color: #ef4444; font-weight: 700;">-12,000 ÿã</span>
                    </div>

                    <div class="data-row" style="margin-bottom: 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span style="font-size: 14px; font-weight: 700; color: #f8fafc;">⁄©ÿ±ÿß€åŸá ŸÑÿßÿ≥ÿ™Ÿá ÿ±ÿßŸà⁄ìŸÑ</span>
                            <span style="font-size: 11px; color: #94a3b8;">2025-01-14 | üèóÔ∏è ÿ®Ÿà⁄©ŸÑ€åŸÜ ⁄©ÿßÿ±</span>
                        </div>
                        <span style="color: #10b981; font-weight: 700;">+45,000 ÿã</span>
                    </div>

                    <!-- Dynamic Last Saved Item will be injected here via JS if available -->
                    <div id="lastSavedReportItem" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debt Screen -->
    <div id="debtScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column; position: relative;">
            <button type="button" onclick="closeDebtScreen()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
            <div class="modal-header" style="padding-top: 10px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 12px 30px rgba(245, 158, 11, 0.4);">üìí</div>
                <div>
                    <div class="modal-title">ÿØ ŸÇÿ±ÿ∂ŸàŸÜŸà ⁄©ÿ™ÿßÿ®⁄ÜŸá</div>
                    <p class="modal-subtitle">ÿØ ŸæŸàÿ± ÿßŸà ÿ∫Ÿà⁄öÿ™ŸÜŸà ŸÖÿØ€åÿ±€åÿ™</p>
                </div>
            </div>

            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <!-- Summary -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); padding: 20px; border-radius: 20px; display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <div style="font-size: 13px; color: #6ee7b7; margin-bottom: 8px; font-weight: 600;">ÿ≤ŸÖŸàŸÜ⁄ñ ŸæŸá ÿÆŸÑ⁄©Ÿà ŸÇÿ±ÿ∂ŸàŸÜŸá</div>
                        <div style="font-size: 22px; font-weight: 800; color: #fff; letter-spacing: 1px;" id="debtTotalReceivable">0</div>
                        <div style="font-size: 10px; color: #94a3b8; margin-top: 4px;">Receivable</div>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 20px; border-radius: 20px; display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <div style="font-size: 13px; color: #fca5a5; margin-bottom: 8px; font-weight: 600;">ÿØ ÿÆŸÑ⁄©Ÿà ŸæŸá ŸÖŸàŸÜ⁄ñ ŸÇÿ±ÿ∂ŸàŸÜŸá</div>
                        <div style="font-size: 22px; font-weight: 800; color: #fff; letter-spacing: 1px;" id="debtTotalLiability">0</div>
                        <div style="font-size: 10px; color: #94a3b8; margin-top: 4px;">Liability</div>
                    </div>
                </div>

                <!-- Add Button -->
                 <button class="btn-primary" onclick="openDebtForm()" style="width: 100%; height: 55px; border-radius: 15px; margin-bottom: 25px; background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span style="font-size: 20px;">‚ûï</span> ŸÜŸà€å ÿ±€å⁄©ÿßÿ±⁄â ÿßÿ∂ÿßŸÅŸá ⁄©ŸàŸÑ
                 </button>

                <!-- List Section Header -->
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding: 0 5px;">
                    <div style="height: 2px; flex: 1; background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.2));"></div>
                    <span style="color: #94a3b8; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">ÿØ ÿ´ÿ®ÿ™ ÿ¥Ÿà€åŸà ŸæŸàÿ±ŸàŸÜŸà ŸÑ€åÿ≥ÿ™</span>
                    <div style="height: 2px; flex: 1; background: linear-gradient(270deg, transparent, rgba(245, 158, 11, 0.2));"></div>
                </div>

                <!-- List -->
                <div id="debtList" style="display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px;">
                    <!-- JS Populates this -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Debt Form Modal -->
    <div id="debtFormModal" class="modal-overlay" style="z-index: 10001;">
        <div class="glass-card modal" style="max-width: 500px; position: relative;">
            <button type="button" onclick="closeDebtForm()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
             <div class="modal-header" style="padding-top: 10px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #6366f1, #a855f7); box-shadow: 0 12px 30px rgba(99, 102, 241, 0.3);">‚úèÔ∏è</div>
                <div>
                    <div class="modal-title">ÿØ ŸÇÿ±ÿ∂ ÿ´ÿ®ÿ™ŸàŸÑ</div>
                    <p class="modal-subtitle">ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸæŸá ÿØŸÇÿ™ ÿ≥ÿ±Ÿá ŸàŸÑ€å⁄©ÿ¶</p>
                </div>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <form id="debtForm" onsubmit="handleDebtSubmit(event)" style="display: flex; flex-direction: column; gap: 18px;">
                    <input type="hidden" id="debtId">
                    
                    <div class="input-group full-width">
                        <label style="color: #94a3b8; font-size: 13px; margin-bottom: 8px; display: block; font-weight: 500;">ÿØ ÿ±ÿß⁄©⁄ì€ê Ÿàÿ±⁄©⁄ì€ê ⁄âŸàŸÑ</label>
                        <div style="display: flex; gap: 12px;">
                            <label style="flex: 1; cursor: pointer; position: relative;">
                                <input type="radio" name="debtType" value="receivable" checked onchange="updateDebtTypeStyles()" style="position: absolute; opacity: 0;">
                                <div class="debt-type-btn" id="btnReceivable" style="padding: 12px; border-radius: 12px; text-align: center; border: 1px solid #10b981; background: rgba(16, 185, 129, 0.15); color: #6ee7b7; font-weight: 600; transition: all 0.3s ease;">ÿ≤ŸÖŸàŸÜ⁄ñ ŸæŸá ÿÆŸÑ⁄©Ÿà ŸÇÿ±ÿ∂</div>
                            </label>
                            <label style="flex: 1; cursor: pointer; position: relative;">
                                <input type="radio" name="debtType" value="liability" onchange="updateDebtTypeStyles()" style="position: absolute; opacity: 0;">
                                <div class="debt-type-btn" id="btnLiability" style="padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #94a3b8; font-weight: 600; transition: all 0.3s ease;">ÿØ ÿÆŸÑ⁄©Ÿà ŸæŸá ŸÖŸàŸÜ⁄ñ ŸÇÿ±ÿ∂</div>
                            </label>
                        </div>
                    </div>

                    <div class="input-group full-width">
                        <label style="color: #94a3b8; font-size: 13px; margin-bottom: 8px; display: block; font-weight: 500;">üë§ ÿØ ÿ¥ÿÆÿµ ŸÜŸàŸÖ</label>
                        <input type="text" id="debtName" required placeholder="ÿØ ŸÇÿ±ÿ∂ÿØÿßÿ± ŸÜŸàŸÖ ÿØŸÑÿ™Ÿá ŸàŸÑ€å⁄©ÿ¶..." style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; color: white; outline: none; transition: border-color 0.3s ease;" onfocus="this.style.borderColor='rgba(245, 158, 11, 0.5)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label style="color: #94a3b8; font-size: 13px; margin-bottom: 8px; display: block; font-weight: 500;">üí∞ ŸÖŸÇÿØÿßÿ± (ÿßŸÅÿ∫ÿßŸÜ€ç)</label>
                            <input type="number" id="debtAmount" required min="0" placeholder="0" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; color: white; outline: none; font-weight: 700;" onfocus="this.style.borderColor='rgba(245, 158, 11, 0.5)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                        </div>
                        <div class="input-group">
                            <label style="color: #94a3b8; font-size: 13px; margin-bottom: 8px; display: block; font-weight: 500;">üìÖ ŸÜ€êŸºŸá</label>
                            <input type="date" id="debtDate" required style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; color: white; outline: none;" onfocus="this.style.borderColor='rgba(245, 158, 11, 0.5)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                        </div>
                    </div>

                    <div class="input-group full-width">
                        <label style="color: #94a3b8; font-size: 13px; margin-bottom: 8px; display: block; font-weight: 500;">üìù ÿ™ŸÅÿµ€åŸÑ</label>
                        <textarea id="debtDesc" rows="3" placeholder="ŸÜŸàÿ± ÿß⁄ì€åŸÜ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿØŸÑÿ™Ÿá ŸàŸÑ€å⁄©ÿ¶..." style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; color: white; outline: none; resize: none;" onfocus="this.style.borderColor='rgba(245, 158, 11, 0.5)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'"></textarea>
                    </div>

                    <button type="submit" class="submit-btn" style="height: 55px; border-radius: 15px; margin-top: 10px; background: linear-gradient(135deg, #10b981, #059669); font-weight: 700; font-size: 16px; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);">‚úì ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ∞ÿÆ€åÿ±Ÿá ⁄©⁄ìÿ¶</button>
                </form>
            </div>
        </div>
    </div>

    <div id="opExpScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column; position: relative;">
            <button type="button" onclick="closeOpExpScreen()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
            <div class="modal-header" style="padding-top: 10px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #f43f5e, #fb7185); box-shadow: 0 12px 30px rgba(244, 63, 94, 0.4);">üí∏</div>
                <div>
                    <div class="modal-title">ÿπŸÖŸÑ€åÿßÿ™Ÿä ŸÖÿµÿßÿ±ŸÅ</div>
                    <p class="modal-subtitle">ÿØ Ÿàÿ±⁄ÅŸÜŸä ŸÅÿπÿßŸÑ€åÿ™ ŸÖÿµÿßÿ±ŸÅ</p>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <form onsubmit="handleOpExpSubmit(event)" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <input type="number" id="opExpAmount" required placeholder="ŸÖŸÇÿØÿßÿ± (ÿßŸÅÿ∫ÿßŸÜ€ç)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                        <input type="date" id="opExpDate" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    </div>
                    <input type="text" id="opExpDesc" required placeholder="ÿ™ŸÅÿµ€åŸÑ (ŸÖÿ´ŸÑÿß: ÿ™€êŸÑÿå ÿ™ÿ±ŸÖ€åŸÖ...)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    <button type="submit" class="btn-primary" style="background: #10b981;">ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                </form>
                <div id="opExpList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="capExpScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column; position: relative;">
            <button type="button" onclick="closeCapExpScreen()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
            <div class="modal-header" style="padding-top: 10px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #fb923c, #f97316); box-shadow: 0 12px 30px rgba(251, 146, 60, 0.4);">üèóÔ∏è</div>
                <div>
                    <div class="modal-title">ŸæÿßŸÜ⁄´€åÿ≤ ŸÖÿµÿßÿ±ŸÅ</div>
                    <p class="modal-subtitle">ÿØ ÿ¥ÿ™ŸÖŸÜ€åŸà ÿßŸà ÿØÿß€åŸÖŸä Ÿàÿ≥ÿß€åŸÑŸà ŸÖÿµÿßÿ±ŸÅ</p>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <form onsubmit="handleCapExpSubmit(event)" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <input type="number" id="capExpAmount" required placeholder="ŸÖŸÇÿØÿßÿ± (ÿßŸÅÿ∫ÿßŸÜ€ç)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                        <input type="date" id="capExpDate" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    </div>
                    <input type="text" id="capExpDesc" required placeholder="ÿ™ŸÅÿµ€åŸÑ (ŸÖÿ´ŸÑÿß: ŸÖŸàŸºÿ± ÿßÿÆ€åÿ≥ÿ™ŸÑÿå ŸàÿØÿßŸÜ€ç...)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    <button type="submit" class="btn-primary" style="background: #fb923c;">ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                </form>
                <div id="capExpList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="opExpScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column; position: relative;">
            <button type="button" onclick="closeOpExpScreen()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
            <div class="modal-header" style="padding-top: 10px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #f43f5e, #fb7185); box-shadow: 0 12px 30px rgba(244, 63, 94, 0.4);">üí∏</div>
                <div>
                    <div class="modal-title">ÿπŸÖŸÑ€åÿßÿ™Ÿä ŸÖÿµÿßÿ±ŸÅ</div>
                    <p class="modal-subtitle">ÿØ Ÿàÿ±⁄ÅŸÜŸä ŸÅÿπÿßŸÑ€åÿ™ ŸÖÿµÿßÿ±ŸÅ</p>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <form onsubmit="handleOpExpSubmit(event)" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <input type="number" id="opExpAmount" required placeholder="ŸÖŸÇÿØÿßÿ± (ÿßŸÅÿ∫ÿßŸÜ€ç)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                        <input type="date" id="opExpDate" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    </div>
                    <input type="text" id="opExpDesc" required placeholder="ÿ™ŸÅÿµ€åŸÑ (ŸÖÿ´ŸÑÿß: ÿ™€êŸÑÿå ÿ™ÿ±ŸÖ€åŸÖ...)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    <button type="submit" class="submit-btn" style="background: #10b981;">ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                </form>
                <div id="opExpList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="capExpScreen" class="modal-overlay">
        <div class="glass-card modal" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column; position: relative;">
            <button type="button" onclick="closeCapExpScreen()" class="btn-close-fancy" style="top: 15px; left: 15px;">‚úï</button>
            <div class="modal-header" style="padding-top: 10px;">
                <div class="modal-icon" style="background: linear-gradient(135deg, #fb923c, #f97316); box-shadow: 0 12px 30px rgba(251, 146, 60, 0.4);">üèóÔ∏è</div>
                <div>
                    <div class="modal-title">ŸæÿßŸÜ⁄´€åÿ≤ ŸÖÿµÿßÿ±ŸÅ</div>
                    <p class="modal-subtitle">ÿØ ÿ¥ÿ™ŸÖŸÜ€åŸà ÿßŸà ÿØÿß€åŸÖŸä Ÿàÿ≥ÿß€åŸÑŸà ŸÖÿµÿßÿ±ŸÅ</p>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <form onsubmit="handleCapExpSubmit(event)" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <input type="number" id="capExpAmount" required placeholder="ŸÖŸÇÿØÿßÿ± (ÿßŸÅÿ∫ÿßŸÜ€ç)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                        <input type="date" id="capExpDate" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    </div>
                    <input type="text" id="capExpDesc" required placeholder="ÿ™ŸÅÿµ€åŸÑ (ŸÖÿ´ŸÑÿß: ŸÖŸàŸºÿ± ÿßÿÆ€åÿ≥ÿ™ŸÑÿå ŸàÿØÿßŸÜ€ç...)" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white;">
                    <button type="submit" class="submit-btn" style="background: #fb923c;">ÿ∞ÿÆ€åÿ±Ÿá ⁄©ŸàŸÑ</button>
                </form>
                <div id="capExpList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Smart Camera Modal -->
    <div id="cameraModal">
        <div class="camera-overlay">
            <div class="camera-controls-top">
                <button type="button" class="camera-btn" onclick="closeCamera()">‚úï</button>
                <div style="color: white; font-weight: 600; text-shadow: 0 0 5px rgba(0,0,0,0.5);">⁄©€êŸÖÿ±Ÿá</div>
                <button type="button" class="camera-btn" id="flashBtn" onclick="toggleFlash()">‚ö°</button>
            </div>
            
            <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                 <div id="qr-reader"></div> <!-- QR Scan Area -->
                 <div id="focus-area" style="width: 250px; height: 350px; border: 2px solid rgba(255,255,255,0.5); border-radius: 20px; box-shadow: 0 0 0 1000px rgba(0,0,0,0.3); pointer-events: none;"></div>
            </div>

            <div class="camera-controls-bottom">
                
                <!-- NEW FILTERS OPTIONS -->
                <div class="camera-options-bar" id="cameraOptionsBar">
                    <label class="camera-option-toggle">
                        <input type="checkbox" id="camFilterBW">
                        <span>ÿ™Ÿàÿ±/ÿ≥Ÿæ€åŸÜ</span>
                    </label>
                    <label class="camera-option-toggle">
                        <input type="checkbox" id="camAutoCrop">
                        <span>ÿ¢ŸºŸà ⁄©ÿ±ÿßŸæ</span>
                    </label>
                </div>

                <div class="camera-mode-selector">
                    <div class="camera-mode" id="mode-photo" onclick="switchMode('photo')">ÿπ⁄©ÿ≥</div>
                    <div class="camera-mode" id="mode-qr" onclick="switchMode('qr')">QR ÿ≥⁄©€åŸÜ</div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 30px;">
                     <button type="button" class="shutter-btn" id="shutterBtn" onclick="takePicture()"></button>
                </div>
            </div>
        </div>
        <video id="cameraView" autoplay playsinline></video>
        <canvas id="cameraCanvas" style="display: none;"></canvas>
        <div id="loadingOverlay" class="loading-overlay">
             <div class="spinner"></div>
             <div id="loadingText">Ÿæÿ±Ÿàÿ≥ÿ≥ ÿ±ŸàÿßŸÜ ÿØ€å...</div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="toast-title" id="toastTitle"></div>
        <div class="toast-description" id="toastDescription"></div>
    </div>

    <script>
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxUgijxJUusdYz6gBc1Cxo0VxO2Kzalg77G_fpEndycuYmzguf72zceS0pN4T_ZF7Whpw/exec';
        // Note: DRIVE_FOLDER_URL is usually handled by the Google Script, not frontend directly unless using Google Picker API,
        // but keeping it here as it was in the original code.
        const DRIVE_FOLDER_URL = 'https://drive.google.com/drive/folders/1I5FZzH-exwNCoFTMsfMnjS31ep8MX8RX';
        
        const JOBS = [
            { id: 'saudi', name: 'ÿ≥ÿπŸàÿØŸä ÿ≠ÿ≥ÿßÿ®', password: 'saudi123', icon: 'üïå', desc: 'ÿØ ÿ≥ÿπŸàÿØŸä ⁄©ÿßÿ±' },
            { id: 'boklyn', name: 'ÿ®Ÿà⁄©ŸÑ€åŸÜ ÿ≠ÿ≥ÿßÿ®', password: 'boklyn123', icon: 'üèóÔ∏è', desc: 'ÿØ ÿ®Ÿà⁄©ŸÑ€åŸÜ ⁄©ÿßÿ±' },
            { id: 'mobile', name: 'ŸÖŸàÿ®ÿß€åŸÑ ÿ≠ÿ≥ÿßÿ®', password: 'mobile123', icon: 'üì±', desc: 'ÿØ ŸÖŸàÿ®ÿß€åŸÑŸàŸÜŸà ⁄©ÿßÿ±' },
            { id: 'home', name: '⁄©Ÿàÿ± ŸÖÿµÿßÿ±ŸÅ', password: 'home123', icon: 'üè†', desc: ' ÿØ ⁄©Ÿàÿ± Ÿàÿ±⁄ÅŸÜÿ¶ ÿÆÿ±⁄ÖŸá' }
        ];

        // Saudi Sub-Accounts Data
        const SAUDI_SUB_ACCOUNTS = [
            { id: 'saudi_12module', name: '12 ŸÖÿß⁄âŸÑ ÿ™ÿ±€êŸÑŸá 3125 ŸÜŸÖÿ®ÿ±', password: 'saudi123', icon: 'üöõ', image: './trailer_3125.jpg', desc: '12 ŸÖÿß⁄âŸÑ ÿ™ÿ±€êŸÑŸá' },
            { id: 'saudi_14module', name: '14 ŸÖÿß⁄âŸÑ ÿ™ÿ±€êŸÑŸá 6437 ŸÜŸÖÿ®ÿ±', password: 'saudi123', icon: 'üöö', image: './trailer_6437.jpg', desc: '14 ŸÖÿß⁄âŸÑ ÿ™ÿ±€êŸÑŸá' }
        ];

        // Home Sub-Accounts Data
        const HOME_SUB_ACCOUNTS = [
            { id: 'home_lalak', name: 'ŸÑŸÑ⁄©', password: 'home123', icon: 'üë®‚Äçüëß‚Äçüë¶', desc: 'ÿØ ŸÑŸÑ⁄© ŸÖÿµÿßÿ±ŸÅ', cardClass: 'home-card-lalak' },
            { id: 'home_saifullah', name: 'ÿ≥€åŸÅ ÿßŸÑŸÑŸá', password: 'home123', icon: 'üë§', desc: 'ÿØ ÿ≥€åŸÅ ÿßŸÑŸÑŸá ŸÖÿµÿßÿ±ŸÅ', cardClass: 'home-card-saifullah' },
            { id: 'home_saeedullah', name: 'ÿ≥ÿπ€åÿØ ÿßŸÑŸÑŸá', password: 'home123', icon: 'üë§', desc: 'ÿØ ÿ≥ÿπ€åÿØ ÿßŸÑŸÑŸá ŸÖÿµÿßÿ±ŸÅ', cardClass: 'home-card-saeedullah' },
            { id: 'home_siddiqullah', name: 'ÿµÿØ€åŸÇ ÿßŸÑŸÑŸá', password: 'home123', icon: 'üë§', desc: 'ÿØ ÿµÿØ€åŸÇ ÿßŸÑŸÑŸá ŸÖÿµÿßÿ±ŸÅ', cardClass: 'home-card-siddiqullah' }
        ];

        let currentJob = null;
        let currentPassword = null;
        let formDataToSubmit = null;
        let originalImageFile = null; // Store the original file
        let compressedImageBlob = null; // Store the compressed blob

        // Camera Variables
        let videoStream = null;
        let currentMode = 'photo';
        let html5QrCode = null;

        /* Currency Helper Functions */
        function openOpExpScreen() {
            document.getElementById('opExpScreen').classList.add('active');
            renderExpList('opExp');
        }
        function closeOpExpScreen() {
            document.getElementById('opExpScreen').classList.remove('active');
        }
        function openCapExpScreen() {
            document.getElementById('capExpScreen').classList.add('active');
            renderExpList('capExp');
        }
        function closeCapExpScreen() {
            document.getElementById('capExpScreen').classList.remove('active');
        }

        function handleOpExpSubmit(e) {
            e.preventDefault();
            saveExp('opExp');
        }
        function handleCapExpSubmit(e) {
            e.preventDefault();
            saveExp('capExp');
        }

        function saveExp(type) {
            const amount = document.getElementById(type + 'Amount').value;
            const date = document.getElementById(type + 'Date').value;
            const desc = document.getElementById(type + 'Desc').value;
            if(!amount || !date || !desc) return;
            
            const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
            list.push({ amount, date, desc, timestamp: Date.now() });
            localStorage.setItem(type + '_list', JSON.stringify(list));
            
            document.getElementById(type + 'Amount').value = '';
            document.getElementById(type + 'Desc').value = '';
            renderExpList(type);
            updateGeneralDashboard();
            showToast('success', 'ÿ±€å⁄©ÿßÿ±⁄â ÿ∞ÿÆ€åÿ±Ÿá ÿ¥Ÿà');
        }

        function renderExpList(type) {
            const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
            const container = document.getElementById(type + 'List');
            container.innerHTML = list.reverse().map(item => `
                <div class="data-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <div>
                        <div style="font-weight: bold;">${item.desc}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${item.date}</div>
                    </div>
                    <div style="font-weight: bold; color: ${type === 'opExp' ? '#f87171' : '#fb923c'}">${parseFloat(item.amount).toLocaleString()} ÿã</div>
                </div>
            `).join('');
        }

        /* Expenses Helpers */
        function openOpExpScreen() {
            document.getElementById('opExpScreen').classList.add('active');
            renderExpList('opExp');
        }
        function closeOpExpScreen() {
            document.getElementById('opExpScreen').classList.remove('active');
        }
        function openCapExpScreen() {
            document.getElementById('capExpScreen').classList.add('active');
            renderExpList('capExp');
        }
        function closeCapExpScreen() {
            document.getElementById('capExpScreen').classList.remove('active');
        }

        function handleOpExpSubmit(e) {
            e.preventDefault();
            saveExp('opExp');
        }
        function handleCapExpSubmit(e) {
            e.preventDefault();
            saveExp('capExp');
        }

        function saveExp(type) {
            const amount = document.getElementById(type + 'Amount').value;
            const date = document.getElementById(type + 'Date').value;
            const desc = document.getElementById(type + 'Desc').value;
            if(!amount || !date || !desc) return;
            
            const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
            list.push({ amount, date, desc, timestamp: Date.now() });
            localStorage.setItem(type + '_list', JSON.stringify(list));
            
            document.getElementById(type + 'Amount').value = '';
            document.getElementById(type + 'Desc').value = '';
            renderExpList(type);
            updateGeneralDashboard();
            showToast('success', 'ÿ±€å⁄©ÿßÿ±⁄â ÿ∞ÿÆ€åÿ±Ÿá ÿ¥Ÿà');
        }

        function renderExpList(type) {
            const list = JSON.parse(localStorage.getItem(type + '_list') || '[]');
            const container = document.getElementById(type + 'List');
            container.innerHTML = list.reverse().map(item => `
                <div class="data-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 5px;">
                    <div>
                        <div style="font-weight: bold;">${item.desc}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${item.date}</div>
                    </div>
                    <div style="font-weight: bold; color: ${type === 'opExp' ? '#f87171' : '#fb923c'}">${parseFloat(item.amount).toLocaleString()} ÿã</div>
                </div>
            `).join('');
        }

        function getCurrencyLabel() {
            if (currentJob && (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_'))) {
                return 'ÿ±.ÿ≥';
            }
            return 'ÿã';
        }
        
        function getCurrencyCode() {
            if (currentJob && (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_'))) {
                return 'SAR';
            }
            return 'AFN';
        }

        // --- DELETION LOGIC ---
        function deleteTransaction(timestamp) {
            if (!confirm('ÿ¢€åÿß ÿ∫Ÿàÿß⁄ìÿ¶ ÿØÿß ÿ±€å⁄©ÿßÿ±⁄â ÿ≠ÿ∞ŸÅ ⁄©⁄ìÿ¶ÿü')) return;

            let targetAccountId = currentJob.id;
            const accountSelector = document.getElementById('reportAccountSelector');
            const adminSelectContainer = document.getElementById('adminAccountSelectContainer');
            
            if (adminSelectContainer && adminSelectContainer.style.display !== 'none' && accountSelector && accountSelector.value !== 'current') {
                targetAccountId = accountSelector.value;
            }

            let history = JSON.parse(localStorage.getItem('history_' + targetAccountId) || '[]');
            const initialLength = history.length;
            
            // Filter out the item with the matching timestamp
            // Note: Old data might not have timestamp, but new ones do.
            // If no timestamp, we might need another strategy, but for now assuming timestamp exists as per line 2569
            history = history.filter(item => {
                // Handle legacy data without timestamp if necessary (though difficult without unique ID)
                if (item.timestamp) {
                    return item.timestamp != timestamp;
                }
                return true; // Keep items without timestamp to be safe or delete by index? Timestamp is safer.
            });
            
            if (history.length < initialLength) {
                localStorage.setItem('history_' + targetAccountId, JSON.stringify(history));
                
                // Recalculate Stats from scratch
                recalculateStats(targetAccountId);
                
                showToast('success', 'ÿ±€å⁄©ÿßÿ±⁄â ÿ≠ÿ∞ŸÅ ÿ¥Ÿà');
                filterReportByDuration(); // Refresh list
                
                // If dashboard is open, update it too
                if(document.getElementById('dashboardScreen').classList.contains('active')) {
                    updateDashboardStats(targetAccountId);
                }
            } else {
                showToast('error', 'ÿ™€êÿ±Ÿàÿ™ŸÜŸá', 'ÿ±€å⁄©ÿßÿ±⁄â ŸàŸÜŸá ŸÖŸàŸÜÿØŸÑ ÿ¥Ÿà');
            }
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ÿÆÿ∑ÿ±: ÿ¢€åÿß ÿ™ÿßÿ≥Ÿà ⁄âÿß⁄âŸá €åÿßÿ≥ÿ™ ⁄Ü€ê ÿØ ÿØ€ê ÿ≠ÿ≥ÿßÿ® ŸºŸàŸÑ ÿ±€å⁄©ÿßÿ±⁄âŸàŸÜŸá ÿ≠ÿ∞ŸÅ ⁄©ŸàŸÑ ÿ∫Ÿàÿß⁄ìÿ¶ÿü\n\nÿØÿß ÿπŸÖŸÑ ÿØ ÿ®€êÿ±ÿ™Ÿá ÿ±ÿß⁄´ÿ±⁄ÅŸàŸÑŸà Ÿà⁄ì ŸÜŸá ÿØ€å!')) return;
            
            const userInput = prompt('ÿØ ÿ™ÿß€å€åÿØ ŸÑŸæÿßÿ±Ÿá "delete" ŸàŸÑ€å⁄©ÿ¶:');
            if (userInput !== 'delete') {
                if (userInput !== null) showToast('error', 'ÿ™€êÿ±Ÿàÿ™ŸÜŸá', 'ÿ™ÿß€å€åÿØ ŸÜÿß⁄©ÿßŸÖ ÿ¥Ÿà');
                return;
            }

            let targetAccountId = currentJob.id;
            const accountSelector = document.getElementById('reportAccountSelector');
            const adminSelectContainer = document.getElementById('adminAccountSelectContainer');
            
            if (adminSelectContainer && adminSelectContainer.style.display !== 'none' && accountSelector && accountSelector.value !== 'current') {
                targetAccountId = accountSelector.value;
            }

            // Clear History
            localStorage.setItem('history_' + targetAccountId, '[]');
            
            // Reset Stats
            localStorage.setItem('stats_' + targetAccountId, JSON.stringify({income: 0, expense: 0}));
            
            // Reset Balance (Only for Home Accounts if needed, or generally)
            if (targetAccountId.startsWith('home_')) {
                 // For shared balance, we might want to keep it or reset it? 
                 // User asked to delete "written data". Usually implies transactions history.
                 // Balance is separate in localStorage 'home_shared_balance'.
                 // I will leave shared balance alone as it is "Shared".
            }

            showToast('success', '‚ú® ŸºŸàŸÑ ÿ±€å⁄©ÿßÿ±⁄âŸàŸÜŸá Ÿæÿß⁄© ÿ¥ŸàŸÑ');
            filterReportByDuration();
            
            if(document.getElementById('dashboardScreen').classList.contains('active')) {
                updateDashboardStats(targetAccountId);
            }
        }

        function recalculateStats(accountId) {
            let history = JSON.parse(localStorage.getItem('history_' + accountId) || '[]');
            let income = 0;
            let expense = 0;
            
            history.forEach(item => {
                income += parseFloat(item.income || 0);
                expense += parseFloat(item.expense || 0);
            });
            
            localStorage.setItem('stats_' + accountId, JSON.stringify({income, expense}));
        }

        // --- GENERAL DASHBOARD LOGIC ---
        
        function openGeneralDashboardAuth() {
            // Set a special job context for General Dashboard
            currentJob = { 
                id: 'general_dashboard_admin', 
                name: 'ÿπŸÖŸàŸÖŸä ŸÖÿßŸÑŸä ⁄âÿ¥ÿ®Ÿàÿ±⁄â', 
                icon: 'üìä' 
            };
            
            // We don't set a single 'currentPassword' because we accept multiple.
            // The checkPassword function will handle this special ID.
            
            document.getElementById('jobSelectionScreen').classList.add('hidden');
            document.getElementById('passwordScreen').classList.remove('hidden');
            
            // Update password screen title for this context
            document.querySelector('#passwordScreen .password-title').textContent = 'ÿπŸÖŸàŸÖŸä ŸÖÿßŸÑŸä ⁄âÿ¥ÿ®Ÿàÿ±⁄â';
            document.querySelector('#passwordScreen .password-subtitle').textContent = 'üîê ÿØ ŸÜŸÜŸàÿ™ŸÑŸà ŸÑŸæÿßÿ±Ÿá Ÿæÿßÿ≥Ÿàÿ±⁄â ŸàŸÑ€å⁄©ÿ¶';
            
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
        }

        function openGeneralDashboard() {
            document.getElementById('jobSelectionScreen').classList.add('hidden');
            document.getElementById('passwordScreen').classList.add('hidden'); // Ensure password screen is closed
            document.getElementById('generalDashboardScreen').classList.remove('hidden');
            updateGeneralDashboard();
        }

        function closeGeneralDashboard() {
            document.getElementById('generalDashboardScreen').classList.add('hidden');
            document.getElementById('jobSelectionScreen').classList.remove('hidden');
        }

        let dashboardChart = null;
        function initDashboardChart() {
            const ctx = document.getElementById('dashboardChart');
            if (!ctx) return;
            if (dashboardChart) dashboardChart.destroy();
            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['ÿ¨ÿØŸä', 'ÿØŸÑŸà', 'ÿ≠Ÿàÿ™', 'ÿ≠ŸÖŸÑ', 'ÿ´Ÿàÿ±', 'ÿ¨Ÿàÿ≤ÿß'],
                    datasets: [{
                        label: 'ÿπÿß€åÿØ',
                        data: [12000, 19000, 3000, 5000, 2000, 3000],
                        borderColor: '#6ee7b7',
                        backgroundColor: 'rgba(110, 231, 183, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'ŸÖÿµÿ±ŸÅ',
                        data: [8000, 15000, 5000, 2000, 8000, 4000],
                        borderColor: '#fca5a5',
                        backgroundColor: 'rgba(252, 165, 165, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8', font: { family: 'Noto Naskh Arabic' } }
                        }
                    },
                    scales: {
                        y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
        }

        function updateGeneralDashboard() {
            initDashboardChart();
            // 1. Calculate Account Balances
                const SAR_TO_AFN = 18.5;
                const USD_TO_AFN = 75;
                const PKR_TO_AFN = 0.3;

                const accounts = [
                    { id: 'boklyn', type: 'usd' },
                    { id: 'mobile', type: 'afn' }
                ];

                let totalIncome = 0;
                let totalExpense = 0;
                let totalCashCombined = 0;

                // Add all specific accounts
                JOBS.forEach(job => {
                    if (job.id === 'home' || job.id === 'saudi') return;
                    const stats = JSON.parse(localStorage.getItem('stats_' + job.id) || '{"income": 0, "expense": 0}');
                    const history = JSON.parse(localStorage.getItem('history_' + job.id) || '[]');
                    
                    history.forEach(t => {
                        let rate = 1;
                        if (t.currency === 'USD') rate = USD_TO_AFN;
                        else if (t.currency === 'SAR') rate = SAR_TO_AFN;
                        else if (t.currency === 'PKR') rate = PKR_TO_AFN;

                        totalIncome += (parseFloat(t.income) || 0) * rate;
                        totalExpense += (parseFloat(t.expense) || 0) * rate;
                    });
                });

                // Add Saudi Sub-accounts
                SAUDI_SUB_ACCOUNTS.forEach(acc => {
                    const stats = JSON.parse(localStorage.getItem('stats_' + acc.id) || '{"income": 0, "expense": 0}');
                    const history = JSON.parse(localStorage.getItem('history_' + acc.id) || '[]');
                    history.forEach(t => {
                        totalIncome += (parseFloat(t.income) || 0) * SAR_TO_AFN;
                        totalExpense += (parseFloat(t.expense) || 0) * SAR_TO_AFN;
                    });
                });

                totalCashCombined = totalIncome - totalExpense;
            const totalWorth = totalCashCombined + receivable + inventory - liability;

            // 4. Precise Zakat Calculation
            // Zakat is 2.5% of net assets if they exceed the Nisab (approx. 85g of gold)
            // Current estimate for Nisab in AFN is around 350,000 AFN (Adjust as needed)
            const NISAB_AFN = 350000; 
            const zakat = (totalWorth >= NISAB_AFN) ? (totalWorth * 0.025) : 0;
            
            // Monthly Growth Logic (Precise Comparison)
            const lastMonthWorth = parseFloat(localStorage.getItem('gen_dash_last_month_worth') || totalWorth.toString());
            const growth = lastMonthWorth > 0 ? ((totalWorth - lastMonthWorth) / lastMonthWorth * 100) : 0;

            // 5. Update UI with Precision
            // OpExp & CapExp totals
            const opExpList = JSON.parse(localStorage.getItem('opExp_list') || '[]');
            const totalOpExp = opExpList.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const capExpList = JSON.parse(localStorage.getItem('capExp_list') || '[]');
            const totalCapExp = capExpList.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);

            document.getElementById('dashTotalWorth').textContent = (totalWorth - totalOpExp - totalCapExp || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('dashTotalCash').textContent = (totalCashCombined || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('dashLiability').textContent = (liability || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('dashReceivable').textContent = (receivable || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            
            // New Dashboard Stats
            if(document.getElementById('dashInventory')) document.getElementById('dashInventory').textContent = (inventory || 0).toLocaleString();
            if(document.getElementById('dashZakat')) document.getElementById('dashZakat').textContent = Math.floor(zakat || 0).toLocaleString();
            if(document.getElementById('dashGrowth')) document.getElementById('dashGrowth').textContent = (growth || 0).toFixed(2);
            if(document.getElementById('dashOpExp')) document.getElementById('dashOpExp').textContent = (totalOpExp || 0).toLocaleString();
            if(document.getElementById('dashCapExp')) document.getElementById('dashCapExp').textContent = (totalCapExp || 0).toLocaleString();

            if(document.getElementById('dashNetProfit')) {
                const initialCapital = parseFloat(localStorage.getItem('gen_dash_initial_capital') || totalWorth.toString());
                const netProfit = totalWorth - initialCapital - totalOpExp - totalCapExp;
                document.getElementById('dashNetProfit').textContent = (netProfit || 0).toLocaleString();
            }
            
            if(document.getElementById('dashCapitalInUse')) {
                document.getElementById('dashCapitalInUse').textContent = ((inventory || 0) + (receivable || 0)).toLocaleString();
            }
    
        }

        function editDashValue(key) {
            const current = localStorage.getItem('gen_dash_' + key) || '0';
            let label = '';
            
            switch(key) {
                case 'liability': label = 'Ÿæÿ± ŸÖŸàŸÜ⁄ñ ŸÇÿ±ÿ∂ŸàŸÜŸá (ÿ®ÿß€åÿØ Ÿàÿ±⁄©⁄ìŸÑ ÿ¥Ÿä):'; break;
                case 'receivable': label = 'Ÿæÿ± ÿÆŸÑ⁄©Ÿà ŸÇÿ±ÿ∂ŸàŸÜŸá (ÿ®ÿß€åÿØ ÿ±ÿß⁄©⁄ìŸÑ ÿ¥Ÿä):'; break;
                case 'inventory': label = 'ÿØ ⁄´ÿØÿßŸÖ ÿØ ŸÖŸàÿ¨ŸàÿØŸá ŸÖÿßŸÑ ÿßÿ±ÿ≤⁄öÿ™:'; break;
                case 'opExp': label = 'ÿπŸÖŸÑ€åÿßÿ™Ÿä ŸÖÿµÿßÿ±ŸÅ (⁄©ÿ±ÿß€åŸáÿå ŸÖÿπÿßÿ¥ÿå ŸÜŸàÿ±):'; break;
                case 'capExp': label = 'ŸæÿßŸÜ⁄´€åÿ≤ ŸÖÿµÿßÿ±ŸÅ (ŸÖÿßÿ¥€åŸÜÿå ÿ™ÿ¨Ÿá€åÿ≤ÿßÿ™ÿå ŸÜŸàÿ±):'; break;
                case 'initial_capital': label = 'ŸÑŸàŸÖ⁄ìŸÜ€ç ÿ≥ÿ±ŸÖÿß€åŸá (ÿØ ⁄´Ÿº€ê ŸÖÿπŸÑŸàŸÖŸàŸÑŸà ŸÑŸæÿßÿ±Ÿá):'; break;
                case 'last_month_worth': label = 'ÿØ ÿ™€åÿ±€ê ŸÖ€åÿßÿ¥ÿ™€ê ŸºŸàŸÑŸá ÿ≥ÿ±ŸÖÿß€åŸá (ÿØ ŸàÿØ€ê ŸÑŸæÿßÿ±Ÿá):'; break;
                default: label = 'ŸÖŸÇÿØÿßÿ± ŸàŸºÿß⁄©ÿ¶:';
            }
            
            const newVal = prompt(label + "\n\nÿßŸàÿ≥ŸÜ€ç ÿßŸÜÿØÿßÿ≤Ÿá: " + current, current);
            
            if (newVal !== null && !isNaN(newVal) && newVal.trim() !== '') {
                localStorage.setItem('gen_dash_' + key, newVal);
                updateGeneralDashboard();
                showToast('success', 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™ÿßÿ≤Ÿá ÿ¥ŸàŸÑ');
            }
        }

        function initJobSelector() {
            const container = document.getElementById('jobGrid');
            container.innerHTML = JOBS.map(job => `
                <div class="job-card" onclick="selectJob('${job.id}', '${job.name}', '${job.password}', '${job.icon}')">
                    <div class="job-icon">${job.icon}</div>
                    <div class="job-name">${job.name}</div>
                    <div class="job-desc">${job.desc}</div>
                </div>
            `).join('');
        }

        function initSaudiSubAccountSelector() {
            const container = document.getElementById('saudiSubAccountGrid');
            container.innerHTML = SAUDI_SUB_ACCOUNTS.map(account => `
                <div class="job-card" onclick="selectSaudiSubAccount('${account.id}', '${account.name}', '${account.password}', '${account.image}')">
                    ${account.image ? `
                        <img src="${account.image}" alt="${account.name}" class="job-image" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="job-icon job-image-error">${account.icon}</div>
                    ` : `
                        <div class="job-icon">${account.icon}</div>
                    `}
                    <div class="job-name">${account.name}</div>
                    <div class="job-desc">${account.desc}</div>
                </div>
            `).join('');
        }

        function initHomeSubAccountSelector() {
            const container = document.getElementById('homeSubAccountGrid');
            container.innerHTML = HOME_SUB_ACCOUNTS.map(account => `
                <div class="job-card ${account.cardClass}" onclick="selectHomeSubAccount('${account.id}', '${account.name}', '${account.password}', '${account.icon}')">
                    <div class="job-icon">${account.icon}</div>
                    <div class="job-name">${account.name}</div>
                    <div class="job-desc">${account.desc}</div>
                </div>
            `).join('');
        }

        function selectJob(jobId, jobName, password, icon) {
            if (jobId === 'saudi') {
                document.getElementById('jobSelectionScreen').classList.add('hidden');
                document.getElementById('saudiSubAccountScreen').classList.remove('hidden');
            } else if (jobId === 'home') {
                document.getElementById('jobSelectionScreen').classList.add('hidden');
                document.getElementById('homeSubAccountScreen').classList.remove('hidden');
            } else {
                currentJob = { id: jobId, name: jobName, icon: icon };
                currentPassword = password;
                document.getElementById('jobSelectionScreen').classList.add('hidden');
                document.getElementById('passwordScreen').classList.remove('hidden');
                setTimeout(() => document.getElementById('passwordInput').focus(), 100);
            }
        }

        function selectSaudiSubAccount(subId, subName, password, image) {
            currentJob = { id: subId, name: subName, image: image, icon: 'üöõ' };
            currentPassword = password;
            document.getElementById('saudiSubAccountScreen').classList.add('hidden');
            document.getElementById('passwordScreen').classList.remove('hidden');
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
        }

        function selectHomeSubAccount(subId, subName, password, icon) {
            currentJob = { id: subId, name: subName, icon: icon };
            currentPassword = password;
            document.getElementById('homeSubAccountScreen').classList.add('hidden');
            document.getElementById('passwordScreen').classList.remove('hidden');
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
        }

        function backFromSaudiSubAccount() {
            document.getElementById('saudiSubAccountScreen').classList.add('hidden');
            document.getElementById('jobSelectionScreen').classList.remove('hidden');
        }

        function backFromHomeSubAccount() {
            document.getElementById('homeSubAccountScreen').classList.add('hidden');
            document.getElementById('jobSelectionScreen').classList.remove('hidden');
        }

        function backToJobs() {
            document.getElementById('passwordScreen').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';

             // Check if we were coming from General Dashboard Auth
            if (currentJob && currentJob.id === 'general_dashboard_admin') {
                 document.getElementById('jobSelectionScreen').classList.remove('hidden');
                 currentJob = null;
                 return;
            }

            if (currentJob && currentJob.id.startsWith('saudi_')) {
                document.getElementById('saudiSubAccountScreen').classList.remove('hidden');
            } else if (currentJob && currentJob.id.startsWith('home_')) {
                document.getElementById('homeSubAccountScreen').classList.remove('hidden');
            } else {
                document.getElementById('jobSelectionScreen').classList.remove('hidden');
            }
            currentJob = null;
        }

        // --- IMAGE & CAMERA LOGIC ---

        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                originalImageFile = input.files[0];
                processImage(originalImageFile);
            }
        }
        
        function reprocessImage() {
            if (originalImageFile) {
                processImage(originalImageFile);
            }
        }

        function processImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const maxWidth = 1600; 
                    const maxHeight = 1600;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    
                    const isDocMode = document.getElementById('documentModeToggle').checked;
                    // Check new camera filters if they exist (might be null if modal not open/created yet, but elements are in DOM)
                    const isBW = document.getElementById('camFilterBW') ? document.getElementById('camFilterBW').checked : false;
                    const isAutoCrop = document.getElementById('camAutoCrop') ? document.getElementById('camAutoCrop').checked : false;
                    
                    // Auto-Crop Simulation: Crop 10% from edges if enabled
                    let sx = 0, sy = 0, sWidth = img.width, sHeight = img.height;
                    
                    if (isAutoCrop) {
                        const cropFactor = 0.1; 
                        sx = img.width * cropFactor;
                        sy = img.height * cropFactor;
                        sWidth = img.width * (1 - 2 * cropFactor);
                        sHeight = img.height * (1 - 2 * cropFactor);
                    }
                    
                    if (isDocMode || isBW) {
                         ctx.filter = 'contrast(1.4) brightness(1.1) grayscale(1)';
                    }
                    
                    // Draw with cropping source parameters
                    ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, width, height);
                    ctx.filter = 'none';

                    canvas.toBlob((blob) => {
                        compressedImageBlob = blob;
                        
                        const previewUrl = URL.createObjectURL(blob);
                        document.getElementById('previewImg').src = previewUrl;
                        document.getElementById('imagePreview').style.display = 'block';
                        document.getElementById('billImageArea').style.borderColor = '#10b981';
                        document.getElementById('billImageArea').style.background = 'rgba(16, 185, 129, 0.1)';
                        
                        const originalSize = (file.size / 1024).toFixed(1) + ' KB';
                        const compressedSize = (blob.size / 1024).toFixed(1) + ' KB';
                        
                        let modeText = '';
                        if (isDocMode) modeText += '(Doc Mode) ';
                        if (isBW && !isDocMode) modeText += '(B&W) ';
                        if (isAutoCrop) modeText += '(Auto-Crop)';

                        document.getElementById('compressionInfo').innerHTML = `ÿßÿµŸÑ€å: ${originalSize} <br> ⁄©ŸÖŸæÿ±€åÿ≥ ÿ¥Ÿà€å: <span style="color: #fff; font-weight:bold;">${compressedSize}</span> ${modeText}`;

                    }, 'image/jpeg', 0.7);
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        function removeImage() {
            if(document.getElementById('billImageGallery')) document.getElementById('billImageGallery').value = '';
            
            originalImageFile = null;
            compressedImageBlob = null;
            
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('billImageArea').style.borderColor = 'rgba(139, 92, 246, 0.3)';
            document.getElementById('billImageArea').style.background = 'rgba(255, 255, 255, 0.05)';
        }

        // --- SMART CAMERA IMPLEMENTATION ---

        async function openCamera(mode) {
            currentMode = mode;
            document.getElementById('cameraModal').style.display = 'flex';
            switchMode(mode);

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" },
                    audio: false 
                });
                videoStream = stream;
                document.getElementById('cameraView').srcObject = stream;
            } catch (err) {
                console.error("Camera access error:", err);
                alert("⁄©€åŸÖÿ±€ê ÿ™Ÿá ŸÑÿßÿ≥ÿ±ÿ≥€å ŸÜÿ¥ÿ™Ÿá! ŸÖŸáÿ±ÿ®ÿßŸÜŸä Ÿà⁄©⁄ìÿ¶ ÿßÿ¨ÿßÿ≤Ÿá Ÿàÿ±⁄©⁄ìÿ¶.");
                closeCamera();
            }
        }

        function closeCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (html5QrCode) {
                html5QrCode.stop().then(() => { html5QrCode.clear(); }).catch(err => {});
            }
            document.getElementById('cameraModal').style.display = 'none';
            document.getElementById('qr-reader').innerHTML = '';
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.camera-mode').forEach(el => el.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');

            const shutterBtn = document.getElementById('shutterBtn');
            const focusArea = document.getElementById('focus-area');
            const qrReader = document.getElementById('qr-reader');

            if (mode === 'qr') {
                shutterBtn.style.display = 'none';
                focusArea.style.display = 'none';
                qrReader.style.display = 'block';
                startQrScanner();
            } else {
                shutterBtn.style.display = 'block';
                focusArea.style.display = 'block';
                qrReader.style.display = 'none';
                if (html5QrCode) {
                    html5QrCode.stop().then(() => { html5QrCode.clear(); }).catch(err => {});
                }
            }
        }

        async function toggleFlash() {
            if (videoStream) {
                const track = videoStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                if (capabilities.torch) {
                    const currentSettings = track.getSettings();
                    try {
                        await track.applyConstraints({
                            advanced: [{ torch: !currentSettings.torch }]
                        });
                        document.getElementById('flashBtn').style.color = !currentSettings.torch ? '#fbbf24' : 'white';
                    } catch (err) {
                        console.error("Flash error:", err);
                    }
                } else {
                    showToast('warning', 'ŸÅŸÑÿ¥ ŸÜÿ¥ÿ™Ÿá', 'ÿ≥ÿ™ÿßÿ≥Ÿà Ÿàÿ≥€åŸÑŸá ŸÅŸÑÿ¥ ŸÜŸá ŸÖŸÑÿßÿ™⁄ì ⁄©ŸàŸä.');
                }
            }
        }

        function takePicture() {
            const video = document.getElementById('cameraView');
            const canvas = document.getElementById('cameraCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(blob => {
                const file = new File([blob], "camera_capture.jpg", { type: "image/jpeg" });
                originalImageFile = file;
                processImage(file);
                closeCamera();
            }, 'image/jpeg', 0.8);
        }

        function startQrScanner() {
             html5QrCode = new Html5Qrcode("qr-reader");
             html5QrCode.start(
                 { facingMode: "environment" }, 
                 { fps: 10, qrbox: { width: 250, height: 250 } },
                 (decodedText, decodedResult) => {
                     // Handle QR Code Success
                     console.log(`Scan result: ${decodedText}`, decodedResult);
                     document.getElementById('detail').value = `Scanned QR: ${decodedText}`;
                     showToast('success', 'QR ÿ≥⁄©€åŸÜ ÿ¥Ÿà!', decodedText);
                     closeCamera();
                 },
                 (errorMessage) => {
                     // parse error, ignore it.
                 })
             .catch((err) => {
                 console.log(err);
             });
        }

        function logout() {
            document.getElementById('formContainer').classList.add('hidden');
            
            // Check where to go back based on current job type
            if (currentJob && currentJob.id.startsWith('home_')) {
                document.getElementById('homeSubAccountScreen').classList.remove('hidden');
                document.getElementById('jobSelectionScreen').classList.add('hidden');
            } else if (currentJob && currentJob.id.startsWith('saudi_')) {
                document.getElementById('saudiSubAccountScreen').classList.remove('hidden');
                document.getElementById('jobSelectionScreen').classList.add('hidden');
            } else {
                document.getElementById('jobSelectionScreen').classList.remove('hidden');
            }

            document.getElementById('passwordScreen').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('trailerForm').reset();
            currentJob = null;
            
            // Reset category selection visually
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('customCategoryInput').style.display = 'none';
            removeImage(); // Clear image
        }

        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('passwordError');

            // 1. General Dashboard Admin Check
            if (currentJob && currentJob.id === 'general_dashboard_admin') {
                const validAdmins = ['home123', 'saudi123', 'mobile123', 'boklyn123', 'admin'];
                if (validAdmins.includes(password)) {
                    errorDiv.style.display = 'none';
                    document.getElementById('passwordInput').value = ''; // Clear input
                    openGeneralDashboard();
                } else {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = '‚ùå Ÿæÿßÿ≥Ÿàÿ±⁄â ÿ∫ŸÑÿ∑ ÿØÿ¶';
                    document.getElementById('passwordInput').classList.add('shake');
                    setTimeout(() => document.getElementById('passwordInput').classList.remove('shake'), 500);
                }
                return; // Stop here
            }

            // 2. Normal Job/Sub-Account Check
            if (password === currentPassword) {
                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('formContainer').classList.remove('hidden');
                const dateInput = document.getElementById('date');
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                errorDiv.style.display = 'none';
                
                // Display the selected job/sub-account info
                if (currentJob.id === 'saudi' || currentJob.id.startsWith('saudi_')) {
                    document.getElementById('currency').value = 'SAR';
                    document.getElementById('currency').disabled = true;
                } else {
                    document.getElementById('currency').value = 'AFN';
                    document.getElementById('currency').disabled = false;
                }

                if (currentJob.image) {
                    document.getElementById('currentJobIcon').innerHTML = `<img src="${currentJob.image}" alt="${currentJob.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3);">`;
                } else {
                    document.getElementById('currentJobIcon').textContent = currentJob.icon || JOBS.find(job => job.id === currentJob.id)?.icon || 'üïå';
                }
                document.getElementById('currentJobName').textContent = currentJob.name;
                
                // --- SHARED BALANCE & CATEGORY LOGIC ---
                if (currentJob.id.startsWith('home_')) {
                    document.getElementById('balanceSection').style.display = 'block';
                    updateBalanceDisplay();
                    
                    document.getElementById('categoryGroup').style.display = 'block';
                    document.getElementById('noteGroup').style.display = 'none';
                    document.getElementById('incomeGroup').style.display = 'none'; // Hide Income for Home
                    // document.getElementById('category').required = true; // Hidden input doesn't support required attribute the same way visually, handled in validation


                    // Admin check
                    if (currentJob.name === 'ÿ≥€åŸÅ ÿßŸÑŸÑŸá') {
                        document.getElementById('editBalanceBtn').style.display = 'inline-block';
                    } else {
                        document.getElementById('editBalanceBtn').style.display = 'none';
                    }
                } else {
                    document.getElementById('balanceSection').style.display = 'none';
                    document.getElementById('categoryGroup').style.display = 'none';
                    document.getElementById('noteGroup').style.display = 'block';
                    document.getElementById('incomeGroup').style.display = 'block'; // Show Income for others
                    document.getElementById('category').required = false;
                }

            } else {
                errorDiv.style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        function updateBalanceDisplay() {
            const bal = localStorage.getItem('home_shared_balance') || '25000';
            document.getElementById('balanceValue').textContent = parseInt(bal).toLocaleString();
            
            // Changed from < 5000 to <= 5000 as per request "remains 5000"
            if (parseInt(bal) <= 5000) {
                showToast('warning', 'ÿÆÿ®ÿ±ÿ™€åÿß!', 'ÿØ ⁄©Ÿàÿ± ⁄´⁄â ÿ®€åŸÑÿßŸÜÿ≥ 5000 ÿßŸÅÿ∫ÿßŸÜ€åŸà €åÿß ⁄©ŸÖ ÿØ€å!');
                document.getElementById('balanceSection').style.border = '2px solid #ef4444';
            } else {
                document.getElementById('balanceSection').style.border = '1px solid rgba(16, 185, 129, 0.3)';
            }
        }

        function editBalance() {
            const current = localStorage.getItem('home_shared_balance') || '0';
            const newBal = prompt("ŸÜŸà€å ÿ®€åŸÑÿßŸÜÿ≥ ÿØÿßÿÆŸÑ ⁄©⁄ìÿ¶:", current);
            if (newBal !== null && !isNaN(newBal) && newBal.trim() !== '') {
                localStorage.setItem('home_shared_balance', newBal);
                updateBalanceDisplay();
                showToast('success', 'ÿ®€åŸÑÿßŸÜÿ≥ ÿ™ÿßÿ≤Ÿá ÿ¥Ÿà');
            }
        }

        document.getElementById('passwordInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') checkPassword();
        });

        function saveTransaction(e) {
            e.preventDefault();
            const income = parseFloat(document.getElementById('income').value || 0);
            const expense = parseFloat(document.getElementById('expense').value || 0);
            const date = document.getElementById('date').value;
            const detail = document.getElementById('detail').value;
            const note = document.getElementById('note').value;
            const category = document.getElementById('category').value;
            const currency = document.getElementById('currency').value;

            const expenseError = document.getElementById('expenseError');
            let hasError = false;

            if (!expense || expense <= 0) {
                expenseError.classList.add('show');
                hasError = true;
            } else {
                expenseError.classList.remove('show');
            }

            if (!date) {
                showToast('error', 'ŸÜ€êŸºŸá ŸàŸºÿß⁄©ÿ¶');
                hasError = true;
            }

            if (hasError) return;

            const dateParts = date.split('-');
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

            formDataToSubmit = {
                income,
                expense,
                date,
                formattedDate,
                detail,
                note,
                category,
                currency,
                timestamp: Date.now()
            };
            showModal();
        }

        document.getElementById('trailerForm').addEventListener('submit', saveTransaction);

        function showModal() {
            document.getElementById('confirmDate').textContent = formDataToSubmit.formattedDate;
            document.getElementById('confirmExpense').textContent = formDataToSubmit.expense || '0';
            document.getElementById('confirmDetail').textContent = formDataToSubmit.detail || 'ŸÜÿØŸä ŸÑ€å⁄©ŸÑ ÿ¥Ÿà€å';
            
            // Category Row
            if (formDataToSubmit.category) {
                document.getElementById('confirmCategory').textContent = formDataToSubmit.category;
                document.getElementById('categoryRow').style.display = 'block';
            } else {
                document.getElementById('categoryRow').style.display = 'none';
            }

            if (formDataToSubmit.note) {
                document.getElementById('confirmNote').textContent = formDataToSubmit.note;
                document.getElementById('noteRow').style.display = 'block';
            } else {
                document.getElementById('noteRow').style.display = 'none';
            }

            if (compressedImageBlob || originalImageFile) {
                document.getElementById('imageRow').style.display = 'block';
            } else {
                document.getElementById('imageRow').style.display = 'none';
            }

            const lastSaveData = localStorage.getItem('lastSaveData_' + currentJob.id);
            if (lastSaveData) {
                const data = JSON.parse(lastSaveData);
                document.getElementById('lastSaveDate').textContent = data.date;
                document.getElementById('lastSaveExpense').textContent = data.expense || '0';
                document.getElementById('lastSaveDetail').textContent = data.detail || 'ŸÜÿØŸä ŸÑ€å⁄©ŸÑ ÿ¥Ÿà€å';
                if (data.note) {
                    document.getElementById('lastSaveNote').textContent = data.note;
                    document.getElementById('lastSaveNoteRow').style.display = 'block';
                } else {
                    document.getElementById('lastSaveNoteRow').style.display = 'none';
                }
                document.getElementById('lastSaveRow').style.display = 'block';
            } else {
                document.getElementById('lastSaveRow').style.display = 'none';
            }
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        async function confirmSubmit() {
            const btn = document.getElementById('confirmButton');
            btn.disabled = true;
            btn.textContent = '‚úì ÿ´ÿ®ÿ™€å⁄ñŸä....';
            try {
                // Deduct Balance for Home Accounts
                if (currentJob.id.startsWith('home_')) {
                    const exp = parseFloat(formDataToSubmit.expense || '0');
                    if (exp > 0) {
                        let bal = parseFloat(localStorage.getItem('home_shared_balance') || '0');
                        bal -= exp;
                        localStorage.setItem('home_shared_balance', bal);
                        updateBalanceDisplay();
                    }
                }

                // *** NEW: Save to Local Storage for Dashboard & Report per Account ***
                // 1. Save Transaction to History
                const newTransaction = {
                    date: formDataToSubmit.formattedDate,
                    income: formDataToSubmit.income || '0',
                    expense: formDataToSubmit.expense || '0',
                    detail: formDataToSubmit.detail || '',
                    note: formDataToSubmit.note || '',
                    category: formDataToSubmit.category || '',
                    currency: formDataToSubmit.currency || 'AFN',
                    timestamp: new Date().getTime()
                };
                
                let history = JSON.parse(localStorage.getItem('history_' + currentJob.id) || '[]');
                history.unshift(newTransaction);
                localStorage.setItem('history_' + currentJob.id, JSON.stringify(history));

                // 2. Update Stats
                let stats = JSON.parse(localStorage.getItem('stats_' + currentJob.id) || '{"income": 0, "expense": 0}');
                stats.income = parseFloat(stats.income) + parseFloat(newTransaction.income);
                stats.expense = parseFloat(stats.expense) + parseFloat(newTransaction.expense);
                localStorage.setItem('stats_' + currentJob.id, JSON.stringify(stats));
                // ***************************************************************

                let url = new URL(GOOGLE_SHEETS_URL);
                let params = {
                    date: formDataToSubmit.formattedDate,
                    workType: currentJob.id,
                    income: formDataToSubmit.income || '0',
                    expense: formDataToSubmit.expense || '0',
                    detail: formDataToSubmit.detail || '',
                    note: formDataToSubmit.note || '',
                    category: formDataToSubmit.category || ''
                };

                let method = 'GET';
                let body = null;
                let fetchUrl = url.toString();
                let fetchOptions = {};

                // Use the compressed blob if available, otherwise original file (though we should always have compressed one if file selected)
                const fileToSend = compressedImageBlob; 
                const originalName = originalImageFile ? originalImageFile.name : 'image.jpg';

                if (fileToSend) {
                    // Convert image to Base64
                    const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(fileToSend);
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = error => reject(error);
                    });

                    params.imageName = originalName;
                    params.imageMimeType = 'image/jpeg'; // We always convert to JPEG
                    params.imageData = base64Data;
                    
                    method = 'POST';
                    fetchUrl = GOOGLE_SHEETS_URL;
                    
                    // Build form body for POST
                    const formData = new URLSearchParams();
                    Object.keys(params).forEach(key => formData.append(key, params[key]));
                    
                    fetchOptions = {
                        method: 'POST',
                        body: formData,
                        // 'no-cors' mode allows sending data to Google Script without CORS errors,
                        // but prevents reading the response text.
                        mode: 'no-cors' 
                    };
                } else {
                    // Standard GET request for text-only (Legacy behavior preserved)
                    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                    fetchUrl = url.toString();
                    fetchOptions = { method: 'GET' };
                }

                const response = await fetch(fetchUrl, fetchOptions);
                
                // Only check text response if NOT in no-cors mode (GET requests)
                if (method === 'GET') {
                    const text = await response.text();
                    if (text.includes("ERROR")) {
                        throw new Error(text);
                    }
                }
                
                const lastSaveData = {
                    date: formDataToSubmit.formattedDate,
                    income: formDataToSubmit.income || '0',
                    expense: formDataToSubmit.expense || '0',
                    detail: formDataToSubmit.detail || '',
                    note: formDataToSubmit.note || '',
                    category: formDataToSubmit.category || ''
                };
                localStorage.setItem('lastSaveData_' + currentJob.id, JSON.stringify(lastSaveData));
                
                let successMsg = 'ŸÜ⁄ìÿ¶ ŸÖŸÜŸÜŸá ÿ≠ÿ≥ÿßÿ® ÿ∞ÿÆ€åÿ±Ÿá ÿ¥Ÿà';
                if (fileToSend) {
                    successMsg += ' ÿßŸà ÿπ⁄©ÿ≥ ⁄´Ÿà⁄´ŸÑ ⁄âÿ±ÿß€åŸà ÿ™Ÿá ŸàŸÑ€å⁄ñŸÑ ÿ¥Ÿà';
                }
                showToast('success', '‚ú® ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ®ÿ±€åÿßŸÑŸä ŸàŸÑ€å⁄©ŸÑ ÿ¥ŸàŸÑ', successMsg);
                
                // Reset Image
                removeImage();
                
                document.getElementById('trailerForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
                closeModal();
            } catch (error) {
                console.error('Fetch error:', error);
                showToast('error', '‚ùå ÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿà ÿ≥ÿ™ŸàŸÜÿ≤Ÿá', error.message);
            } finally { 
                btn.disabled = false;
                btn.textContent = '‚úì ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ™ÿß€å€åÿØ ÿßŸà ÿ∞ÿÆ€åÿ±Ÿá ⁄©⁄ìÿ¶';
            }
        }

        function showToast(type, title, desc = '') {
            const toast = document.getElementById('toast');
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastDescription').textContent = desc;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 5000);
        }

        // Initialize all selectors
        initJobSelector();
        initSaudiSubAccountSelector();
        initHomeSubAccountSelector();

        // Category Selection Logic
        function selectCategory(value, element) {
            // Remove active class from all buttons
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            element.classList.add('active');
            
            const customInput = document.getElementById('customCategoryInput');
            const categoryInput = document.getElementById('category');

            if (value === 'ŸÜŸàÿ±') {
                customInput.style.display = 'block';
                customInput.focus();
                categoryInput.value = customInput.value; // Initialize with current custom input value if any
            } else {
                customInput.style.display = 'none';
                categoryInput.value = value;
            }
        }

        function updateCustomCategory(val) {
            // Only update if "Other" is currently selected (which it should be if this input is visible)
            document.getElementById('category').value = val;
        }

        function openDashboard() { 
            // Removed restricted access check - now open for everyone
            document.getElementById('dashboardScreen').classList.add('active');
            
            // Check if user is Saifullah for Delete Button Visibility
            const deleteBtn = document.getElementById('dashboardDeleteBtn');
            if (deleteBtn) {
                if (currentJob.name === 'ÿ≥€åŸÅ ÿßŸÑŸÑŸá') {
                    deleteBtn.style.display = 'block';
                } else {
                    deleteBtn.style.display = 'none';
                }
            }
            
            // Determine whose stats to show
            let targetAccountId = currentJob.id;
            
            // List of Super Admins who can see everything (conceptually, but here we need a selector if they want to see OTHERS)
            // The request says: "Everyone can see their own dashboard. The 4 admins can see ALL dashboards."
            // To implement "Admins seeing ALL", we need a selector in the dashboard similar to the Report screen.
            
            const adminIds = ['home_saifullah', 'home_lalak', 'home_saeedullah', 'home_siddiqullah'];
            const isAdmin = adminIds.includes(currentJob.id);
            // Toggle Admin Features
            const adminFeatures = document.getElementById("adminOnlyFeatures");
            if (adminFeatures) {
                adminFeatures.style.display = isAdmin ? "block" : "none";
            }
            
            const dashboardBody = document.querySelector('#dashboardScreen .modal-body');
            
            // Remove any existing selector first to avoid duplicates or stale state
            const existingSelector = document.getElementById('dashboardAccountSelector');
            if (existingSelector) existingSelector.closest('div').remove();

            // If Admin, inject a selector if it doesn't exist
            let selectorHtml = '';
            if (isAdmin) {
                selectorHtml = `
                    <div style="margin-bottom: 20px;">
                        <label style="display:block; color:#94a3b8; font-size:12px; margin-bottom:5px;">ÿ≠ÿ≥ÿßÿ® ÿßŸÜÿ™ÿÆÿßÿ® ⁄©⁄ìÿ¶:</label>
                        <select id="dashboardAccountSelector" style="width:100%; padding:10px; border-radius:8px; background:rgba(255,255,255,0.1); color:white; border:1px solid rgba(255,255,255,0.2);" onchange="updateDashboardStats(this.value)">
                            <option value="current">ÿÆŸæŸÑ ÿ≠ÿ≥ÿßÿ® (${currentJob.name})</option>
                `;
                
                // Add all accounts options
                JOBS.forEach(job => {
                   // Skip current job if already added as first option
                   if (job.id === currentJob.id) return;

                   if (job.id !== 'saudi' && job.id !== 'home') {
                       selectorHtml += `<option value="${job.id}">${job.name}</option>`;
                   }
                });
                SAUDI_SUB_ACCOUNTS.forEach(acc => {
                    // Skip if current user (unlikely for main jobs but good practice)
                    if (acc.id === currentJob.id) return;
                    selectorHtml += `<option value="${acc.id}">üöõ ${acc.name}</option>`;
                });
                HOME_SUB_ACCOUNTS.forEach(acc => {
                     // Skip if current user (e.g. if a home user is admin)
                    if (acc.id === currentJob.id) return;
                    selectorHtml += `<option value="${acc.id}">üè† ${acc.name}</option>`;
                });
                
                selectorHtml += `</select></div>`;
                
                // Check if we already added it to avoid duplicates
                if (!document.getElementById('dashboardAccountSelector')) {
                     const title = dashboardBody.querySelector('.modal-title');
                     // Insert after title/header
                     dashboardBody.insertAdjacentHTML('afterbegin', selectorHtml);
                }
            } else {
                // If not admin, ensure selector is removed if it exists (e.g. from previous login)
                const existingSelector = document.getElementById('dashboardAccountSelector');
                if (existingSelector) existingSelector.parentElement.remove();
            }

            // Load initial stats (current user)
            updateDashboardStats(currentJob.id);
        }

        function updateDashboardStats(accountId) {
            let targetId = accountId;
            if (targetId === 'current') targetId = currentJob.id;
            
            const stats = JSON.parse(localStorage.getItem('stats_' + targetId) || '{"income": 0, "expense": 0}');
            
            const dashboardBody = document.querySelector('#dashboardScreen .modal-body');
            // Find the summary cards container (it's the grid inside modal body, might have shifted due to selector insertion)
            // We look for the grid with 2 columns
            const summaryCardsContainer = Array.from(dashboardBody.children).find(child => child.style.display === 'grid');
            
            // Update Net Balance
            const netBalance = parseFloat(stats.income) - parseFloat(stats.expense);
            
            // Update specific IDs directly - much safer than index
            if (document.getElementById('dashTotalIncome')) {
                document.getElementById('dashTotalIncome').textContent = parseFloat(stats.income).toLocaleString();
            }
            if (document.getElementById('dashTotalExpense')) {
                // This is the new field for Total Business Expenses
                document.getElementById('dashTotalExpense').textContent = parseFloat(stats.expense).toLocaleString();
            }
            if (document.getElementById('dashNetProfit')) {
                document.getElementById('dashNetProfit').textContent = netBalance.toLocaleString();
                document.getElementById('dashNetProfit').style.color = netBalance >= 0 ? '#6ee7b7' : '#ef4444';
            }
            
            // The rest of the logic for Worth, Cash etc might be handled elsewhere or via other IDs
            // Existing logic for balance in data-row:
            const balanceEl = dashboardBody.querySelector('.data-row .data-value');
            if (balanceEl) {
                const currencyLabel = getCurrencyLabel();
                balanceEl.textContent = netBalance.toLocaleString() + ' ' + currencyLabel;
                balanceEl.style.color = netBalance >= 0 ? '#6ee7b7' : '#ef4444';
            }
        }

        function closeDashboard() {
            document.getElementById('dashboardScreen').classList.remove('active');
        }


        function openReport() { 
            // Removed restricted access check - now open for everyone
            document.getElementById('reportScreen').classList.add('active');
            
            // Check if user is an Admin
            const adminIds = ['home_saifullah', 'home_lalak', 'home_saeedullah', 'home_siddiqullah'];
            const isAdmin = adminIds.includes(currentJob.id);

            // Handle Delete Button Visibility based on User (Only Saifullah)
            const deleteBtn = document.getElementById('reportDeleteBtn');
            if (deleteBtn) {
                // Modified: Only Saifullah can see the delete button
                if (currentJob.name === 'ÿ≥€åŸÅ ÿßŸÑŸÑŸá') {
                    deleteBtn.style.display = 'block';
                } else {
                    deleteBtn.style.display = 'none';
                }
            }

            // Handle Admin Account Selector
            const adminSelectContainer = document.getElementById('adminAccountSelectContainer');
            const accountSelector = document.getElementById('reportAccountSelector');
            
            if (isAdmin && adminSelectContainer && accountSelector) {
                adminSelectContainer.style.display = 'block';
                
                // Populate selector if empty or just refresh it
                let optionsHtml = `<option value="current">ÿÆŸæŸÑ ÿ≠ÿ≥ÿßÿ® (${currentJob.name})</option>`;
                
                // Add all main accounts
                JOBS.forEach(job => {
                   // Skip current job if already added as first option
                   if (job.id === currentJob.id) return;

                   if (job.id !== 'saudi' && job.id !== 'home') { // Skip containers if they don't hold data directly, but mobile/boklyn do
                       optionsHtml += `<option value="${job.id}">${job.name}</option>`;
                   }
                });

                // Add Saudi Sub Accounts
                SAUDI_SUB_ACCOUNTS.forEach(acc => {
                    if (acc.id === currentJob.id) return;
                    optionsHtml += `<option value="${acc.id}">üöõ ${acc.name}</option>`;
                });

                 // Add Home Sub Accounts
                HOME_SUB_ACCOUNTS.forEach(acc => {
                    if (acc.id === currentJob.id) return;
                    optionsHtml += `<option value="${acc.id}">üè† ${acc.name}</option>`;
                });

                accountSelector.innerHTML = optionsHtml;
                accountSelector.value = 'current'; // Default to current
            } else if (adminSelectContainer) {
                adminSelectContainer.style.display = 'none';
            }
            
            // Reset filter to All and Render
            const durationSelect = document.getElementById('reportDuration');
            if (durationSelect) {
                durationSelect.value = 'all';
                filterReportByDuration();
            }
        }

        function getFilteredData() {
            const duration = document.getElementById('reportDuration').value;
            
            // Determine which account ID to use
            let targetAccountId = currentJob.id;
            const accountSelector = document.getElementById('reportAccountSelector');
            const adminSelectContainer = document.getElementById('adminAccountSelectContainer');
            
            // If admin selector is visible and has a value other than 'current', use it
            if (adminSelectContainer && adminSelectContainer.style.display !== 'none' && accountSelector && accountSelector.value !== 'current') {
                targetAccountId = accountSelector.value;
            }

            const history = JSON.parse(localStorage.getItem('history_' + targetAccountId) || '[]');
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            
            return history.filter(item => {
                // Check if timestamp exists, otherwise parse date string
                let itemTime;
                if (item.timestamp) {
                    itemTime = item.timestamp;
                } else {
                    itemTime = new Date(item.date).getTime();
                }
                
                if (duration === 'all') return true;
                if (duration === 'today') {
                    return itemTime >= startOfDay;
                }
                if (duration === 'week') {
                    const startOfWeek = startOfDay - (now.getDay() * 24 * 60 * 60 * 1000); // Simple week start (Sunday)
                    return itemTime >= startOfWeek;
                }
                if (duration === 'month') {
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                    return itemTime >= startOfMonth;
                }
                if (duration === 'year') {
                    const startOfYear = new Date(now.getFullYear(), 0, 1).getTime();
                    return itemTime >= startOfYear;
                }
                return true;
            });
        }

        function filterReportByDuration() {
            const data = getFilteredData();
            const container = document.querySelector('.report-list');
            
            const currencyLabel = getCurrencyLabel();
            
            if (data.length === 0) {
                 container.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 14px;">ŸæŸá ÿØ€ê ŸàÿÆÿ™ ⁄©€ê Ÿá€å⁄Ö ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÜÿ¥ÿ™Ÿá</div>';
                 return;
            }

            container.innerHTML = data.map(item => {
                const amount = parseFloat(item.expense) > 0 ? -parseFloat(item.expense) : parseFloat(item.income);
                const color = amount < 0 ? '#ef4444' : '#10b981';
                const sign = amount > 0 ? '+' : '';
                const desc = item.detail || item.category || 'ÿ®€å ÿ™ŸÅÿµ€åŸÑŸá';
                
                // Delete Button for Saifullah
                let deleteAction = '';
                if (currentJob.name === 'ÿ≥€åŸÅ ÿßŸÑŸÑŸá' && item.timestamp) {
                    deleteAction = `<button onclick="deleteTransaction(${item.timestamp})" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); cursor: pointer; color: #ef4444; border-radius: 8px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin-left: 10px;">üóëÔ∏è</button>`;
                }

                return `
                    <div class="data-row" style="margin-bottom: 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center;">
                            ${deleteAction}
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                <span style="font-size: 14px; font-weight: 700; color: #f8fafc;">${desc}</span>
                                <span style="font-size: 11px; color: #94a3b8;">${item.date}</span>
                            </div>
                        </div>
                        <span style="color: ${color}; font-weight: 700;">${sign}${Math.abs(amount).toLocaleString()} ${currencyLabel}</span>
                    </div>
                `;
            }).join('');
        }

        function printReport() {
            const data = getFilteredData();
            if (data.length === 0) {
                showToast('error', 'ÿ™€êÿ±Ÿàÿ™ŸÜŸá', 'ÿØ ⁄ÜÿßŸæ ŸÑŸæÿßÿ±Ÿá Ÿá€å⁄Ö ⁄â€åŸºÿß ŸÜÿ¥ÿ™Ÿá');
                return;
            }

            // Calculate totals
            let totalIncome = 0;
            let totalExpense = 0;
            data.forEach(item => {
                totalIncome += parseFloat(item.income || 0);
                totalExpense += parseFloat(item.expense || 0);
            });
            const balance = totalIncome - totalExpense;

            const printWindow = window.open('', '_blank');
            const durationText = document.getElementById('reportDuration').options[document.getElementById('reportDuration').selectedIndex].text;
            
            const currencyCode = getCurrencyCode();
            
            // Professional/Literary Pashto Date formatting
            const today = new Date();
            const dateStr = today.getFullYear() + '/' + (today.getMonth() + 1) + '/' + today.getDate();

            const html = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ps">
                <head>
                    <title>ŸÖÿßŸÑŸä ÿ±ÿßŸæŸàÿ± - ${currentJob.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        :root {
                            --primary: #1e293b;
                            --accent: #2563eb;
                            --border: #e2e8f0;
                            --text: #334155;
                            --bg-header: #f8fafc;
                        }
                        body { 
                            font-family: 'Noto Naskh Arabic', sans-serif; 
                            padding: 40px; 
                            direction: rtl; 
                            color: var(--text);
                            max-width: 210mm; /* A4 width */
                            margin: 0 auto;
                        }
                        .report-container {
                            border: 2px solid var(--primary);
                            padding: 30px;
                            border-radius: 4px;
                            position: relative;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 40px; 
                            border-bottom: 2px solid var(--primary); 
                            padding-bottom: 20px; 
                        }
                        .logo-text { 
                            font-size: 32px; 
                            font-weight: 800; 
                            color: var(--primary);
                            margin-bottom: 10px;
                        }
                        .sub-header {
                            font-size: 18px;
                            color: var(--accent);
                            font-weight: 600;
                        }
                        .meta-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-bottom: 30px;
                            background: var(--bg-header);
                            padding: 15px;
                            border-radius: 8px;
                            border: 1px solid var(--border);
                        }
                        .meta-item {
                            display: flex;
                            flex-direction: column;
                            gap: 5px;
                        }
                        .meta-label {
                            font-size: 12px;
                            color: #64748b;
                            font-weight: bold;
                        }
                        .meta-value {
                            font-size: 16px;
                            font-weight: 600;
                            color: var(--primary);
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 30px; 
                            font-size: 13px; 
                        }
                        th { 
                            background-color: var(--primary); 
                            color: white; 
                            padding: 12px 15px;
                            text-align: right;
                            font-weight: 600;
                            border: 1px solid var(--primary);
                        }
                        td { 
                            border: 1px solid var(--border); 
                            padding: 10px 15px; 
                        }
                        tr:nth-child(even) { background-color: #f1f5f9; }
                        
                        .totals-section {
                            display: flex;
                            justify-content: flex-end;
                            gap: 20px;
                            margin-top: 20px;
                            border-top: 2px solid var(--primary);
                            padding-top: 20px;
                        }
                        .total-card {
                            background: var(--bg-header);
                            border: 1px solid var(--border);
                            padding: 15px 25px;
                            border-radius: 8px;
                            text-align: center;
                            min-width: 120px;
                        }
                        .total-label {
                            font-size: 12px;
                            color: #64748b;
                            margin-bottom: 5px;
                        }
                        .total-amount {
                            font-size: 18px;
                            font-weight: 800;
                        }
                        .text-green { color: #059669; }
                        .text-red { color: #dc2626; }
                        .text-blue { color: #2563eb; }
                        
                        .footer {
                            margin-top: 60px;
                            text-align: center;
                            font-size: 11px;
                            color: #94a3b8;
                            border-top: 1px solid var(--border);
                            padding-top: 15px;
                        }

                        @media print {
                            body { padding: 0; background: white; }
                            .report-container { border: none; padding: 0; }
                            th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="report-container">
                        <div class="header">
                            <div class="logo-text">ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸá</div>
                            <div class="sub-header">ŸÖÿßŸÑŸä ÿ±ÿßŸæŸàÿ± ÿßŸà ÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸà ÿ™ŸÅÿµ€åŸÑ</div>
                        </div>
                        
                        <div class="meta-grid">
                            <div class="meta-item">
                                <span class="meta-label">ÿØ ÿ≠ÿ≥ÿßÿ® ŸÜŸàŸÖ</span>
                                <span class="meta-value">${currentJob.name}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">ÿØ ÿ±ÿßŸæŸàÿ± ŸÖŸàÿØŸá</span>
                                <span class="meta-value">${durationText}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">ÿØ ⁄ÜÿßŸæ ŸÜ€êŸºŸá</span>
                                <span class="meta-value">${dateStr}</span>
                            </div>
                             <div class="meta-item">
                                <span class="meta-label">ÿ≠ÿßŸÑÿ™</span>
                                <span class="meta-value">ÿ™ÿßÿ¶€åÿØ ÿ¥Ÿà€å</span>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 15%;">ŸÜ€êŸºŸá</th>
                                    <th style="width: 35%;">ÿ™ŸÅÿµ€åŸÑ / ⁄©Ÿº⁄´Ÿàÿ±Ÿä</th>
                                    <th style="width: 15%;">ÿπÿß€åÿØ (${currencyCode})</th>
                                    <th style="width: 15%;">ŸÑ⁄´⁄öÿ™ (${currencyCode})</th>
                                    <th style="width: 20%;">€åÿßÿØÿß⁄öÿ™</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(item => `
                                    <tr>
                                        <td style="font-family: sans-serif;">${item.date}</td>
                                        <td>${item.detail || item.category || '-'}</td>
                                        <td class="text-green" style="font-family: sans-serif;">${parseFloat(item.income || 0).toLocaleString()}</td>
                                        <td class="text-red" style="font-family: sans-serif;">${parseFloat(item.expense || 0).toLocaleString()}</td>
                                        <td>${item.note || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="totals-section">
                            <div class="total-card">
                                <div class="total-label">ŸÖÿ¨ŸÖŸàÿπ€å ÿπÿß€åÿØ</div>
                                <div class="total-amount text-green" style="font-family: sans-serif;">${totalIncome.toLocaleString()}</div>
                            </div>
                            <div class="total-card">
                                <div class="total-label">ŸÖÿ¨ŸÖŸàÿπ€å ŸÑ⁄´⁄öÿ™</div>
                                <div class="total-amount text-red" style="font-family: sans-serif;">${totalExpense.toLocaleString()}</div>
                            </div>
                            <div class="total-card">
                                <div class="total-label">ÿßŸàÿ≥ŸÜ€å ÿ®€åŸÑÿßŸÜÿ≥</div>
                                <div class="total-amount text-blue" style="font-family: sans-serif;">${balance.toLocaleString()}</div>
                            </div>
                        </div>

                        <div class="footer">
                            <p>ÿØÿß ÿ≥ŸÜÿØ ÿØ ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸà ÿØ ÿ≥€åÿ≥ÿ™ŸÖ ŸÑÿÆŸàÿß ŸæŸá ÿßÿ™ŸàŸÖÿßÿ™€å⁄© ⁄âŸàŸÑ ÿ™ÿ±ÿ™€åÿ® ÿ¥Ÿà€å ÿØ€å.</p>
                            <p>ÿØ ŸÜŸàÿ±Ÿà ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿà ŸÑŸæÿßÿ±Ÿá ŸÑŸá ÿ≥€åÿ≥ÿ™ŸÖ ÿ≥ÿ±Ÿá ÿß⁄ì€å⁄©Ÿá ŸàŸÜ€åÿ≥ÿ¶.</p>
                        </div>
                    </div>

                    <script>
                        window.onload = function() { setTimeout(function() { window.print(); }, 500); }
                    <\/script>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
        }

        function exportToCSV() {
            const data = getFilteredData();
            if (data.length === 0) {
                showToast('error', 'ÿ™€êÿ±Ÿàÿ™ŸÜŸá', 'ÿØ ⁄âÿßŸàŸÜŸÑŸà⁄â ŸÑŸæÿßÿ±Ÿá Ÿá€å⁄Ö ⁄â€åŸºÿß ŸÜÿ¥ÿ™Ÿá');
                return;
            }

            // Calculate Totals
            let totalIncome = 0;
            let totalExpense = 0;
            data.forEach(item => {
                totalIncome += parseFloat(item.income || 0);
                totalExpense += parseFloat(item.expense || 0);
            });
            const balance = totalIncome - totalExpense;

            // Current Date
            const today = new Date();
            const dateStr = today.getFullYear() + '/' + (today.getMonth() + 1) + '/' + today.getDate();

            // BOM for Excel to read UTF-8 correctly
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
            
            // Report Header Section in CSV (Professional Header)
            csvContent += `ÿØ ÿ¥€êÿ±ÿ≤ÿßÿØ ÿ≠ÿ≥ÿßÿ®ŸàŸÜŸà ÿπŸÖŸàŸÖŸä ŸÖÿßŸÑŸä ÿ±ÿßŸæŸàÿ±\n`;
            csvContent += `ÿØ ÿ≠ÿ≥ÿßÿ® ŸÜŸàŸÖ:,${currentJob.name}\n`;
            csvContent += `ÿØ ÿ±ÿßŸæŸàÿ± ŸÜ€êŸºŸá:,${dateStr}\n`;
            csvContent += `\n`; // Spacer

            // Column Headers
            csvContent += "ÿ¥ŸÖ€êÿ±Ÿá,ŸÜ€êŸºŸá,ÿ™ŸÅÿµ€åŸÑ / ⁄©Ÿº⁄´Ÿàÿ±Ÿä,ÿπÿß€åÿØ (AFN),ŸÑ⁄´⁄öÿ™ (AFN),€åÿßÿØÿß⁄öÿ™\n";

            // Data Rows
            data.forEach((item, index) => {
                // Sanitize content
                const detail = (item.detail || item.category || '').replace(/"/g, '""');
                const note = (item.note || '').replace(/"/g, '""');
                
                const row = [
                    index + 1, // Numbering
                    `"${item.date}"`,
                    `"${detail}"`,
                    `"${item.income || 0}"`,
                    `"${item.expense || 0}"`,
                    `"${note}"`
                ].join(",");
                csvContent += row + "\n";
            });

            // Footer Section (Totals)
            csvContent += `\n`;
            csvContent += `,,,ŸÖÿ¨ŸÖŸàÿπ€å ÿπÿß€åÿØ,${totalIncome}\n`;
            csvContent += `,,,ŸÖÿ¨ŸÖŸàÿπ€å ŸÑ⁄´⁄öÿ™,${totalExpense}\n`;
            csvContent += `,,,ÿÆÿßŸÑÿµ ÿ®€åŸÑÿßŸÜÿ≥,${balance}\n`;
            csvContent += `\n`;
            csvContent += `,,,ÿ™ÿß€å€åÿØ ÿ¥Ÿà€å ÿØ ÿ≥€åÿ≥ÿ™ŸÖ ŸÑÿÆŸàÿß\n`;

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Sherzad_Report_${currentJob.id}_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function closeReport() {
            document.getElementById('reportScreen').classList.remove('active');
        }
        function clearAllData() { 
            if (confirm("ÿ¢€åÿß ÿ™ÿßÿ≥Ÿà ⁄âÿß⁄âŸá €åÿßÿ≥ÿ™ ⁄Ü€ê ŸºŸàŸÑŸá Ÿá€åÿ≥Ÿºÿ±Ÿä ÿßŸà ⁄â€åŸºÿß Ÿæÿß⁄©ŸàŸÑ ÿ∫Ÿàÿß⁄ìÿ¶ÿü ÿØÿß ÿπŸÖŸÑ ÿØ ÿ®€åÿ±ÿ™Ÿá ÿ±ÿß⁄´ÿ±⁄Å€åÿØŸà Ÿà⁄ì ŸÜŸá ÿØ€å!")) { 
                
                // Determine which account's data to delete
                let targetAccountId = currentJob.id;
                
                // If in Report Screen (Admin might be viewing another account)
                if (document.getElementById('reportScreen').classList.contains('active')) {
                     const accountSelector = document.getElementById('reportAccountSelector');
                     const adminSelectContainer = document.getElementById('adminAccountSelectContainer');
                     
                     if (adminSelectContainer && adminSelectContainer.style.display !== 'none' && accountSelector && accountSelector.value !== 'current') {
                        targetAccountId = accountSelector.value;
                     }
                }
                
                // If in Dashboard Screen (Admin might be viewing another account)
                 if (document.getElementById('dashboardScreen').classList.contains('active')) {
                     const dashboardSelector = document.getElementById('dashboardAccountSelector');
                     if (dashboardSelector && dashboardSelector.value !== 'current') {
                        targetAccountId = dashboardSelector.value;
                     }
                }

                // Delete Data
                localStorage.removeItem("history_" + targetAccountId); 
                localStorage.removeItem("stats_" + targetAccountId); 
                localStorage.removeItem("lastSaveData_" + targetAccountId); 
                
                showToast("success", "Ÿæÿß⁄© ÿ¥Ÿà", "ŸºŸàŸÑŸá ⁄â€åŸºÿß ŸæŸá ÿ®ÿ±€åÿßŸÑ€åÿ™Ÿàÿ® ÿ≥ÿ±Ÿá Ÿæÿß⁄©Ÿá ÿ¥ŸàŸá"); 
                
                // Refresh the current view instead of closing
                if (document.getElementById('reportScreen').classList.contains('active')) {
                    filterReportByDuration(); // Refresh report list
                } else if (document.getElementById('dashboardScreen').classList.contains('active')) {
                    updateDashboardStats(targetAccountId === currentJob.id ? 'current' : targetAccountId); // Refresh dashboard stats
                }
            } 
        }

        // --- BACKUP & RESTORE ---
        function downloadBackup() {
            const data = JSON.stringify(localStorage);
            const blob = new Blob([data], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Sherzad_Backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('success', 'ÿ®€å⁄© ÿßŸæ', 'ŸÅÿß€åŸÑ ⁄âÿßŸàŸÜŸÑŸà⁄â ÿ¥Ÿà!');
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // Clear current data mostly or just overwrite? Overwrite is safer for restore.
                    // But we should probably ask confirmation
                    if(!confirm("ÿ¢€åÿß ÿ∫Ÿàÿß⁄ìÿ¶ ÿØÿß ÿ®€å⁄© ÿßŸæ ŸÅÿß€åŸÑ ŸæŸàÿ±ÿ™Ÿá ⁄©⁄ìÿ¶ÿü ÿßŸàÿ≥ŸÜ€ç ⁄â€åŸºÿß ÿ®Ÿá ŸÑŸá ÿØ€ê ÿ≥ÿ±Ÿá ÿ®ÿØŸÑŸá ÿ¥Ÿä.")) return;

                    Object.keys(data).forEach(key => {
                        localStorage.setItem(key, data[key]);
                    });
                    
                    showToast('success', 'ÿ±€å€åÿ≥ŸºŸàÿ±', '⁄â€åŸºÿß ŸæŸá ÿ®ÿ±€åÿßŸÑ€åÿ™Ÿàÿ® ŸæŸàÿ±ÿ™Ÿá ÿ¥ŸàŸá!');
                    setTimeout(() => location.reload(), 1500); // Reload to apply changes
                } catch (err) {
                    console.error(err);
                    showToast('error', 'ÿ™€êÿ±Ÿàÿ™ŸÜŸá', 'ŸÅÿß€åŸÑ ÿÆÿ±ÿßÿ® ÿØ€å €åÿß ÿ≥ŸÖ ŸÅÿßÿ±ŸÖ€åŸº ŸÜŸÑÿ±Ÿä');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }

        // --- DEBT TRACKER LOGIC ---
        let debtData = JSON.parse(localStorage.getItem('debt_data') || '[]');

        function loadDebtData() {
            debtData = JSON.parse(localStorage.getItem('debt_data') || '[]');
        }

        function saveDebtData() {
            localStorage.setItem('debt_data', JSON.stringify(debtData));
            updateGeneralDashboard(); // Update main dashboard stats immediately
        }

        function openDebtScreen() {
            document.getElementById('debtScreen').classList.add('active');
            loadDebtData();
            renderDebtList();
        }

        function closeDebtScreen() {
            document.getElementById('debtScreen').classList.remove('active');
        }

        function renderDebtList() {
            const list = document.getElementById('debtList');
            list.innerHTML = '';

            let totalRec = 0;
            let totalLiab = 0;

            // Sort by date desc
            const sorted = [...debtData].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sorted.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding: 20px; color: #94a3b8;">Ÿá€å⁄Ö ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÜÿ¥ÿ™Ÿá</div>';
            } else {
                sorted.forEach(item => {
                    const amount = parseFloat(item.amount);
                    if (item.type === 'receivable') totalRec += amount;
                    else totalLiab += amount;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'data-row';
                    itemDiv.style.marginBottom = '0';
                    itemDiv.style.display = 'flex';
                    itemDiv.style.justifyContent = 'space-between';
                    itemDiv.style.alignItems = 'center';
                    
                    const isRec = item.type === 'receivable';
                    const color = isRec ? '#10b981' : '#ef4444';
                    const icon = isRec ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';

                    itemDiv.innerHTML = `
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; font-size: 14px;">${icon}</div>
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span style="font-size: 14px; font-weight: 700; color: #f8fafc;">${item.name}</span>
                                <span style="font-size: 11px; color: #94a3b8;">${item.date} | ${item.desc || '---'}</span>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                            <span style="color: ${color}; font-weight: 700;">${amount.toLocaleString()} ÿã</span>
                            <button onclick="deleteDebtRecord('${item.id}')" style="background: none; border: none; color: #64748b; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                        </div>
                    `;
                    list.appendChild(itemDiv);
                });
            }

            document.getElementById('debtTotalReceivable').textContent = totalRec.toLocaleString();
            document.getElementById('debtTotalLiability').textContent = totalLiab.toLocaleString();
        }

        function openDebtForm() {
            document.getElementById('debtForm').reset();
            document.getElementById('debtId').value = ''; // New record
            document.getElementById('debtDate').valueAsDate = new Date();
            updateDebtTypeStyles();
            document.getElementById('debtFormModal').classList.add('active');
        }

        function closeDebtForm() {
            document.getElementById('debtFormModal').classList.remove('active');
        }

        function updateDebtTypeStyles() {
            const type = document.querySelector('input[name="debtType"]:checked').value;
            const btnRec = document.getElementById('btnReceivable');
            const btnLiab = document.getElementById('btnLiability');

            if (type === 'receivable') {
                btnRec.style.border = '1px solid #10b981';
                btnRec.style.background = 'rgba(16, 185, 129, 0.2)';
                btnRec.style.color = '#6ee7b7';
                
                btnLiab.style.border = '1px solid #334155';
                btnLiab.style.background = 'rgba(30, 41, 59, 0.5)';
                btnLiab.style.color = '#94a3b8';
            } else {
                btnRec.style.border = '1px solid #334155';
                btnRec.style.background = 'rgba(30, 41, 59, 0.5)';
                btnRec.style.color = '#94a3b8';

                btnLiab.style.border = '1px solid #ef4444';
                btnLiab.style.background = 'rgba(239, 68, 68, 0.2)';
                btnLiab.style.color = '#fca5a5';
            }
        }

        function handleDebtSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('debtName').value;
            const amount = parseFloat(document.getElementById('debtAmount').value);
            const date = document.getElementById('debtDate').value;
            const desc = document.getElementById('debtDesc').value;
            const type = document.querySelector('input[name="debtType"]:checked').value;
            const id = document.getElementById('debtId').value;

            if (name && amount && date) {
                if (id) {
                    // Edit existing (not implemented fully in UI but good to have logic)
                    // We need to find index
                } else {
                    // New
                    const newRecord = {
                        id: Date.now().toString(),
                        name,
                        amount,
                        date,
                        desc,
                        type
                    };
                    debtData.push(newRecord);
                }

                saveDebtData();
                renderDebtList();
                closeDebtForm();
                showToast('success', 'ÿ´ÿ®ÿ™ ÿ¥Ÿà', 'ÿØ ŸÇÿ±ÿ∂ ÿ±€å⁄©ÿßÿ±⁄â ÿßÿ∂ÿßŸÅŸá ÿ¥Ÿà');
                
                // Submit to Google Sheets
                const workType = type === 'receivable' ? 'debt_receivable' : 'debt_liability';
                const payload = {
                    workType,
                    date,
                    name,
                    detail: desc
                };
                
                fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).catch(err => console.error('Google Sheets error:', err));
            }
        }

        function deleteDebtRecord(id) {
            if(confirm('ÿ¢€åÿß ÿ∫Ÿàÿß⁄ìÿ¶ ÿØÿß ÿ±€å⁄©ÿßÿ±⁄â ÿ≠ÿ∞ŸÅ ⁄©⁄ìÿ¶ÿü')) {
                debtData = debtData.filter(d => d.id !== id);
                saveDebtData();
                renderDebtList();
                showToast('info', 'ÿ≠ÿ∞ŸÅ ÿ¥Ÿà');
            }
        }

        // OVERRIDE: Update General Dashboard to use Debt Data
        function updateGeneralDashboard() {
            // 1. Calculate Account Balances
            const accounts = [
                { id: 'boklyn', type: 'afn' },
                { id: 'mobile', type: 'afn' },
                { id: 'saudi_12module', type: 'sar' }, // SAR
                { id: 'saudi_14module', type: 'sar' }  // SAR
            ];
            
            let totalCashAFN = 0;
            let boklynTotal = 0;
            let mobileTotal = 0;
            let saudiTotals = [];

            // Helper to get balance
            const getBal = (id) => {
                const stats = JSON.parse(localStorage.getItem('stats_' + id) || '{"income": 0, "expense": 0}');
                return parseFloat(stats.income) - parseFloat(stats.expense);
            };

            // Boklyn
            boklynTotal = getBal('boklyn');
            totalCashAFN += boklynTotal;

            // Mobile
            mobileTotal = getBal('mobile');
            totalCashAFN += mobileTotal;

            // Saudi Accounts
            const SAR_TO_AFN = 18.5; 
            let totalSaudiSAR = 0;
            
            SAUDI_SUB_ACCOUNTS.forEach(acc => {
                const bal = getBal(acc.id);
                saudiTotals.push({ name: acc.name, balance: bal, icon: acc.icon });
                totalSaudiSAR += bal;
            });
            
            const saudiInAFN = totalSaudiSAR * SAR_TO_AFN;

            // 2. Loans (FROM DEBT BOOK)
            // Load debt data afresh to ensure accuracy
            const debts = JSON.parse(localStorage.getItem('debt_data') || '[]');
            let liability = 0;
            let receivable = 0;

            debts.forEach(d => {
                if(d.type === 'receivable') receivable += parseFloat(d.amount);
                else liability += parseFloat(d.amount);
            });

            // 3. Total Worth Calculation
            const totalCashCombined = totalCashAFN + saudiInAFN;
            const totalWorth = totalCashCombined + receivable - liability;

            // 4. Update UI
            document.getElementById('dashTotalWorth').textContent = totalWorth.toLocaleString();
            document.getElementById('dashTotalCash').textContent = totalCashCombined.toLocaleString();
            document.getElementById('dashLiability').textContent = liability.toLocaleString();
            document.getElementById('dashReceivable').textContent = receivable.toLocaleString();
            
            
            // New Dashboard Stats Update (Placeholders)
            if(document.getElementById('dashTotalWorth')) document.getElementById('dashTotalWorth').textContent = (totalWorth || 0).toLocaleString();
            if(document.getElementById('dashNetProfit')) document.getElementById('dashNetProfit').textContent = "0";
            if(document.getElementById('dashTotalCash')) document.getElementById('dashTotalCash').textContent = (totalCashCombined || 0).toLocaleString();
            if(document.getElementById('dashCapitalInUse')) document.getElementById('dashCapitalInUse').textContent = "0";
            if(document.getElementById('dashInventory')) document.getElementById('dashInventory').textContent = (inventory || 0).toLocaleString();
            if(document.getElementById('dashZakat')) document.getElementById('dashZakat').textContent = Math.floor(zakat || 0).toLocaleString();
            if(document.getElementById('dashGrowth')) document.getElementById('dashGrowth').textContent = (growth || 0).toFixed(1);
            if(document.getElementById('dashOpExp')) document.getElementById('dashOpExp').textContent = (opExp || 0).toLocaleString();
            if(document.getElementById('dashCapExp')) document.getElementById('dashCapExp').textContent = (capExp || 0).toLocaleString();
            if(document.getElementById('dashTotalIncome')) document.getElementById('dashTotalIncome').textContent = "0";
            if(document.getElementById('dashPersonalExpense')) document.getElementById('dashPersonalExpense').textContent = "0";
    
        }

        // OVERRIDE: Redirect edit to Debt Screen
        function editDashValue(key) {
             openDebtScreen(); 
             showToast('info', 'ÿØ ŸÇÿ±ÿ∂ŸàŸÜŸà ⁄©ÿ™ÿßÿ®⁄ÜŸá', 'ŸÖŸáÿ±ÿ®ÿßŸÜŸä Ÿà⁄©⁄ìÿ¶ ŸæŸàÿ±ŸàŸÜŸá ÿØŸÑÿ™Ÿá ÿ´ÿ®ÿ™ ⁄©⁄ìÿ¶');
        }
    </script>
    <script>
        // --- 1. PIE CHART LOGIC ---
        let expenseChartInstance = null;

        function renderChart(history) {
            const ctx = document.getElementById('expensePieChart');
            if (!ctx) return;

            // Aggregate expenses by category
            const categories = {};
            history.forEach(item => {
                if (parseFloat(item.expense) > 0) {
                    const cat = item.category || 'ŸÜŸàÿ±'; // Default to "Other"
                    categories[cat] = (categories[cat] || 0) + parseFloat(item.expense);
                }
            });

            const labels = Object.keys(categories);
            const data = Object.values(categories);
            const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#f472b6', '#9ca3af'];

            if (expenseChartInstance) {
                expenseChartInstance.destroy();
            }

            expenseChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#cbd5e1', font: { family: 'inherit' } }
                        }
                    }
                }
            });
        }

        // --- 2. SEARCH LOGIC ---
        document.getElementById('reportSearchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.report-list .data-row');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(term)) {
                    row.style.display = 'flex';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // --- 3. CURRENCY CONVERTER LOGIC ---
        let currentRates = {
            SAR: 18.5,
            USD: 70.0,
            PKR: 0.25
        };

        async function fetchRates() {
            try {
                // Using open.er-api.com which is free and supports CORS
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                
                if (data && data.rates) {
                    const usdToAfn = data.rates.AFN;
                    
                    // Calculate cross rates relative to AFN
                    currentRates.USD = parseFloat(usdToAfn.toFixed(2));
                    currentRates.SAR = parseFloat((usdToAfn / data.rates.SAR).toFixed(2));
                    currentRates.PKR = parseFloat((usdToAfn / data.rates.PKR).toFixed(2));

                    // Update UI
                    if (document.getElementById('rateUSD')) document.getElementById('rateUSD').textContent = currentRates.USD;
                    if (document.getElementById('rateSAR')) document.getElementById('rateSAR').textContent = currentRates.SAR;
                    if (document.getElementById('ratePKR')) document.getElementById('ratePKR').textContent = currentRates.PKR;
                    
                    const now = new Date();
                    if (document.getElementById('rateLastUpdated')) {
                        document.getElementById('rateLastUpdated').textContent = `Ÿàÿ±Ÿàÿ≥ÿ™€å ÿ™ÿßÿ≤Ÿá: ${now.toLocaleTimeString()}`;
                    }
                    
                    // Update UI based on currently selected currency
                    updateRatePlaceholder();
                    convertCurrency();
                }
            } catch (error) {
                console.error('Error fetching rates:', error);
                if (document.getElementById('rateLastUpdated')) {
                    document.getElementById('rateLastUpdated').textContent = 'ÿØ ÿ™ÿßÿ≤Ÿá ⁄©ŸàŸÑŸà Ÿæÿ±ŸÖŸáÿßŸÑ ÿ≥ÿ™ŸàŸÜÿ≤Ÿá';
                }
            }
        }

        // Auto update every 30 seconds
        setInterval(fetchRates, 30000);
        // Initial fetch
        fetchRates();

        function updateRatePlaceholder() {
            const currency = document.getElementById('currencySelect').value;
            const rateInput = document.getElementById('exchangeRate');
            
            // Set the rate input to the current rate for the selected currency
            if (currentRates[currency]) {
                rateInput.value = currentRates[currency].toFixed(2);
            }
        }

        function convertCurrency() {
            const rate = parseFloat(document.getElementById('exchangeRate').value) || 0;
            const amount = parseFloat(document.getElementById('currencyInput').value) || 0;
            
            if (rate > 0 && amount > 0) {
                const total = amount * rate;
                document.getElementById('afnResult').textContent = total.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' AFN';
            } else {
                document.getElementById('afnResult').textContent = '0 AFN';
            }
        }
        
        // Initial call to set placeholder correctly
        updateRatePlaceholder();

        // --- 4. BUDGET LIMIT WARNING LOGIC ---
        function checkBudgetLimit(totalExpense) {
            const limit = 50000;
            const warningThreshold = 45000;
            const warningBox = document.getElementById('budgetWarning');
            
            if (totalExpense >= warningThreshold) {
                warningBox.style.display = 'flex';
                warningBox.innerHTML = `‚ö†Ô∏è ŸæÿßŸÖ Ÿà⁄©⁄ìÿ¶! ŸÖÿµÿßÿ±ŸÅ ${totalExpense.toLocaleString()} ÿ™Ÿá Ÿàÿ±ÿ≥€åÿØŸÑ. (ÿ≠ÿØ: ${limit.toLocaleString()})`;
            } else {
                warningBox.style.display = 'none';
            }
        }

        // --- HOOKS INTO EXISTING FUNCTIONS ---

        // Hook into openReport (if it exists) or filterReportByDuration (which populates the list)
        // Since filterReportByDuration is called by onchange, and presumably initially, we should hook there.
        // Wait, looking at the code, filterReportByDuration() is the main render function for report list.
        // I need to intercept it.
        
        // Save original reference
        const originalFilterReportByDuration = window.filterReportByDuration || filterReportByDuration;

        // Override
        window.filterReportByDuration = function() {
            // Call original
            originalFilterReportByDuration();
            
            // After original runs, it presumably updates the DOM or gets data.
            // Let's get the data again to render the chart.
            // Note: The original function likely gets data from localStorage.
            // We'll wait a tick to ensure DOM is updated if needed, or just fetch data directly.
            
            setTimeout(() => {
                // Ensure getFilteredData exists, otherwise fallback or error handle
                if (typeof getFilteredData === 'function') {
                    const data = getFilteredData(); 
                    renderChart(data);
                }
            }, 50);
        };

        // Hook into updateDashboardStats for Budget Warning
        const originalUpdateDashboardStats = window.updateDashboardStats || updateDashboardStats;

        window.updateDashboardStats = function(accountId) {
            originalUpdateDashboardStats(accountId);
            
            // Fetch stats to check limit
            let stats = JSON.parse(localStorage.getItem('stats_' + accountId) || '{"income": 0, "expense": 0}');
            checkBudgetLimit(stats.expense);
        };

    </script>
</body>
</html>
