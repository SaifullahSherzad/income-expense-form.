<!doctype html>
<html lang="ps" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>د عاید او مصارفو حساب — 3D کامل نسخه</title>

<!-- فونټ -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;600;800&display=swap" rel="stylesheet">

<!-- CDN libraries: Three, GSAP, localForage -->
<script src="https://unpkg.com/three@0.154.0/build/three.min.js"></script>
<script src="https://unpkg.com/gsap@3.12.0/dist/gsap.min.js"></script>
<script src="https://unpkg.com/localforage@1.10.0/dist/localforage.min.js"></script>

<style>
  :root{
    --bg:#071022; --muted:#aebfe8; --glass: rgba(255,255,255,0.03);
    --accent1:#5aa2ff; --accent2:#a78bfa; --accent3:#34d399;
    --card-pad:28px; --radius:18px;
  }
  html,body{height:100%; margin:0; font-family:'Noto Naskh Arabic', system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--muted); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  /* Canvas background (Three.js) */
  #bgcanvas{ position:fixed; inset:0; width:100%; height:100%; z-index:0; display:block; }
  /* Light aurora overlay for depth */
  .aurora-overlay{ position:fixed; inset:0; pointer-events:none; z-index:1; mix-blend-mode:screen; opacity:0.6; filter:blur(60px); background:
    radial-gradient(800px 400px at 10% 15%, rgba(90,162,255,0.14), transparent 12%),
    radial-gradient(900px 450px at 85% 80%, rgba(167,139,250,0.12), transparent 12%),
    radial-gradient(700px 360px at 22% 78%, rgba(52,211,153,0.08), transparent 12%);
  }

  .wrap{ position:relative; z-index:5; max-width:1100px; margin:48px auto; padding:16px; }
  .card{
    border-radius:var(--radius); padding:var(--card-pad);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    backdrop-filter:blur(8px) saturate(120%);
    box-shadow: 0 18px 48px rgba(6,10,22,0.7);
    display:flex; gap:20px; align-items:flex-start;
  }

  .left{ flex:1; min-width:280px; }
  .right{ width:360px; }

  .title{ font-size:28px; font-weight:800; margin:0 0 6px 0; background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3)); -webkit-background-clip:text; color:transparent; }
  .subtitle{ color:rgba(190,205,255,0.6); font-size:13px; margin-bottom:12px; }

  form .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media(max-width:900px){ .card{flex-direction:column} .right{width:100%} .grid{grid-template-columns:1fr;} }

  label{ display:block; font-weight:700; color:#eaf2ff; margin-bottom:8px; }
  input[type="text"], input[type="number"], input[type="date"], textarea{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);
    background:rgba(255,255,255,0.02); color:var(--muted); outline:none; font-size:14px; box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);
  }
  textarea{ min-height:110px; resize:vertical; }

  .actions{ display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
  button{ padding:10px 14px; border-radius:12px; border:none; cursor:pointer; font-weight:800; min-width:120px; }
  .btn-primary{ background: linear-gradient(180deg,#6aa0ff 0%, #3a7bfd 60%); color:white; box-shadow:0 12px 30px rgba(40,90,240,0.28); }
  .btn-ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); }
  .btn-export{ background:linear-gradient(180deg,#34d399,#10b981); color:#042; }

  .status{ margin-top:10px; font-size:14px; min-height:20px; color:var(--muted); }
  .status.success{ color:#86efac; } .status.error{ color:#fda4af; } .status.warn{ color:#fbbf24; }

  .card-3d{
    border-radius:14px; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04);
    transform-style:preserve-3d; perspective:800px;
  }
  .preview-row{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
  .pill{ padding:8px 12px; border-radius:999px; background:rgba(255,255,255,0.02); color:var(--muted); font-weight:700; font-size:13px; }

  footer{ text-align:center; color:rgba(190,205,255,0.25); margin-top:18px; font-size:13px; }

  /* focus styles for accessibility */
  :focus{ outline:2px solid rgba(167,139,250,0.18); outline-offset:3px; border-radius:8px; }

  /* reduced motion */
  @media (prefers-reduced-motion: reduce){
    *{ animation-duration:0.001ms !important; transition-duration:0.001ms !important; scroll-behavior:auto !important; }
  }
</style>
</head>
<body>

<canvas id="bgcanvas" aria-hidden="true"></canvas>
<div class="aurora-overlay" aria-hidden="true"></div>

<div class="wrap" id="wrap">
  <div class="card" role="main" aria-label="د عاید او مصارفو اپلیکیشن">
    <div class="left">
      <h1 class="title">د عاید او مصارفو حساب — 3D</h1>
      <div class="subtitle">د ښکلا، لوستتیا او سرعت سره — مستقیم کاپي/پیست لپاره.</div>

      <div class="card-3d" id="formCard" aria-hidden="false">
        <form id="form" novalidate>
          <div class="grid">
            <div>
              <label for="date">نیټه</label>
              <input id="date" name="date" type="date" required />
            </div>
            <div>
              <label for="income">عایدات (ريال/افغانی)</label>
              <input id="income" name="income" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div>
              <label for="expense">مصارف</label>
              <input id="expense" name="expense" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div>
              <label for="detail">د کار تفصیل</label>
              <input id="detail" name="detail" type="text" placeholder="مثال: د ترمیم فیس" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="note">یادښت</label>
            <textarea id="note" name="note" placeholder="هر ډول یادونه…"></textarea>
          </div>

          <div class="actions">
            <button class="btn-primary" id="submitBtn" type="submit" aria-label="ثبت کړه">ثبت کړه</button>
            <button class="btn-ghost" id="saveLocal" type="button" aria-label="محلي ذخیره">محلي ذخیره</button>
            <button class="btn-export" id="exportCSV" type="button" aria-label="صادرات CSV">صادرات CSV</button>
            <button class="btn-ghost" id="resetBtn" type="reset" aria-label="پاک کړه">پاک کړه</button>
          </div>

          <div id="status" class="status" aria-live="polite"></div>
        </form>
      </div>

      <footer>© 2026 — ښکلا، لوستتیا او سرعت</footer>
    </div>

    <div class="right" aria-hidden="false">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div>
          <div style="font-weight:800;color:#eaf2ff;">خلاصه</div>
          <div style="color:rgba(190,205,255,0.6); font-size:13px;">محلي ثبتونه — اندازه، صادرات، او 3D شالید</div>
        </div>
        <div class="pill" id="countPill">0 ثبت</div>
      </div>

      <div class="card-3d" style="padding:12px;">
        <div class="preview-row">
          <div style="flex:1">
            <div style="font-size:13px;color:var(--muted)">وروستۍ ثبت شوې</div>
            <div id="lastEntry" style="margin-top:6px;color:#eaf2ff; font-weight:700;">---</div>
          </div>
        </div>

        <div style="margin-top:8px;">
          <button class="btn-ghost" id="showAll" type="button">ټول ثبتونه وښیه</button>
          <button class="btn-ghost" id="clearAll" type="button">ټول پاک کړه</button>
        </div>

        <div id="listBox" style="margin-top:10px; max-height:260px; overflow:auto; font-size:13px; color:var(--muted);"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================
   تاسیس / تنظیمات
   ============================ */

const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

/* localForage کانفیګ */
localforage.config({ name: 'finance_app_3d', storeName: 'entries' });

/* UI عناصر */
const form = document.getElementById('form');
const statusEl = document.getElementById('status');
const saveBtn = document.getElementById('saveLocal');
const exportBtn = document.getElementById('exportCSV');
const countPill = document.getElementById('countPill');
const lastEntry = document.getElementById('lastEntry');
const listBox = document.getElementById('listBox');
const showAllBtn = document.getElementById('showAll');
const clearAllBtn = document.getElementById('clearAll');
const submitBtn = document.getElementById('submitBtn');

/* د ننۍ نیټې ډیفالټ - که نغدي ته اړتیا وي */
(function setDefaultDate(){
  const d = new Date().toISOString().slice(0,10);
  const dateInp = document.getElementById('date');
  if(!dateInp.value) dateInp.value = d;
})();

/* UI بنسټیز helper */
function setStatus(msg, kind){
  statusEl.textContent = msg;
  statusEl.className = 'status' + (kind ? (' ' + kind) : '');
}

/* ============================
   Three.js شالید — ساده پارټیکل nebula
   ============================ */

const canvas = document.getElementById('bgcanvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(35, innerWidth/innerHeight, 0.1, 1000);
camera.position.z = 80;

/* نوریزر (ambient) */
const ambient = new THREE.AmbientLight(0xffffff, 0.6);
scene.add(ambient);

/* particles geometry */
const particleCount = 1600;
const positions = new Float32Array(particleCount * 3);
const colors = new Float32Array(particleCount * 3);
for(let i=0;i<particleCount;i++){
  const i3 = i*3;
  positions[i3] = (Math.random()-0.5) * 200;
  positions[i3+1] = (Math.random()-0.5) * 120;
  positions[i3+2] = (Math.random()-0.5) * 60;
  // color gradient: bluish -> purple -> greenish subtle
  colors[i3]   = 0.45 + Math.random()*0.4; // r
  colors[i3+1] = 0.55 + Math.random()*0.35; // g
  colors[i3+2] = 0.7 + Math.random()*0.3; // b
}
const geometry = new THREE.BufferGeometry();
geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

const material = new THREE.PointsMaterial({
  size: 1.6,
  vertexColors: true,
  transparent: true,
  opacity: 0.95,
  depthWrite: false,
  blending: THREE.AdditiveBlending
});

const points = new THREE.Points(geometry, material);
scene.add(points);

/* subtle moving lights */
const light1 = new THREE.PointLight(0x6aa2ff, 0.6, 300);
light1.position.set(-60,40,50);
scene.add(light1);
const light2 = new THREE.PointLight(0xa78bfa, 0.45, 300);
light2.position.set(60,-20,30);
scene.add(light2);

/* mouse parallax */
let mouseX = 0, mouseY = 0;
window.addEventListener('mousemove', (e)=>{
  mouseX = (e.clientX / window.innerWidth - 0.5);
  mouseY = (e.clientY / window.innerHeight - 0.5);
});

/* reduced-motion respect */
function animateScene(){
  if(prefersReduced){
    renderer.render(scene, camera);
    return;
  }
  requestAnimationFrame(animateScene);
  // camera gentle follow
  camera.position.x += (mouseX*18 - camera.position.x) * 0.06;
  camera.position.y += (-mouseY*12 - camera.position.y) * 0.06;
  camera.lookAt(0,0,0);
  points.rotation.y += 0.0009;
  points.rotation.x += 0.0004;
  // lights drift
  light1.position.x = -60 + Math.sin(Date.now()*0.0004)*20;
  light2.position.y = -20 + Math.cos(Date.now()*0.0003)*18;
  renderer.render(scene, camera);
}
animateScene();

window.addEventListener('resize', ()=>{
  renderer.setSize(innerWidth, innerHeight);
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
});

/* ============================
   UI انیمیشنونه (GSAP)
   ============================ */
if(!prefersReduced){
  gsap.from('.card', { duration:1.0, y:30, opacity:0, ease:'power3.out' });
  gsap.from('#formCard', { duration:1.2, scale:0.985, ease:'power3.out', delay:0.08 });
  // buttons micro hover
  const btns = document.querySelectorAll('button');
  btns.forEach(b=>{
    b.addEventListener('mouseenter', ()=> gsap.to(b, { scale:1.02, duration:0.16 }));
    b.addEventListener('mouseleave', ()=> gsap.to(b, { scale:1.0, duration:0.16 }));
    b.addEventListener('mousedown', ()=> gsap.to(b, { scale:0.98, duration:0.08 }));
    b.addEventListener('mouseup', ()=> gsap.to(b, { scale:1.02, duration:0.08 }));
  });
}

/* ============================
   محلي ذخیره (localForage) عملیات
   ============================ */

const STORE_KEY = 'entries_v1';

async function getAllEntries(){
  const arr = await localforage.getItem(STORE_KEY) || [];
  return arr;
}
async function saveEntry(entry){
  const arr = await getAllEntries();
  arr.push(entry);
  await localforage.setItem(STORE_KEY, arr);
  return arr;
}
async function setAllEntries(arr){
  await localforage.setItem(STORE_KEY, arr);
}
async function clearEntries(){
  await localforage.removeItem(STORE_KEY);
}

/* UI لایک اپډیټ */
async function refreshSummary(){
  const arr = await getAllEntries();
  countPill.textContent = arr.length + ' ثبت';
  if(arr.length){
    const last = arr[arr.length-1];
    lastEntry.textContent = `${last.date} — عاید:${Number(last.income).toLocaleString()}، مصارف:${Number(last.expense).toLocaleString()}`;
  }else{
    lastEntry.textContent = '---';
  }
  // listBox
  listBox.innerHTML = '';
  arr.slice().reverse().forEach((r, idx)=>{
    const div = document.createElement('div');
    div.style.padding = '8px 6px';
    div.style.borderBottom = '1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<div style="font-weight:700;color:#eaf2ff">${r.date} — ${r.detail || 'تفصیل نشته'}</div>
                     <div style="font-size:13px;color:var(--muted)">عاید: ${Number(r.income||0).toLocaleString()} | مصرف: ${Number(r.expense||0).toLocaleString()}</div>
                     <div style="font-size:12px;color:rgba(190,205,255,0.45)">${r.note ? r.note.slice(0,120) : ''}</div>`;
    listBox.appendChild(div);
  });
}

/* ابتدایي refresh */
refreshSummary();

/* ============================
   فورم لوژیک: validate - save - submit - export
   ============================ */

function readFormData(){
  const fd = new FormData(form);
  const payload = {
    date: fd.get('date') || '',
    income: Number(fd.get('income') || 0),
    expense: Number(fd.get('expense') || 0),
    detail: (fd.get('detail') || '').trim(),
    note: (fd.get('note') || '').trim(),
    createdAt: new Date().toISOString()
  };
  return payload;
}

function validate(p){
  if(!p.date) return 'مهرباني وکړئ نیټه داخل کړئ.';
  if(isNaN(p.income) || p.income < 0) return 'عاید باید غیر منفي عدد وي.';
  if(isNaN(p.expense) || p.expense < 0) return 'مصارف باید غیر منفي عدد وي.';
  return null;
}

/* submit (نمونې ته ورته: دلته به ستا ENDPOINT ته POST وشي که وغواړې) */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = readFormData();
  const err = validate(payload);
  if(err){ setStatus(err, 'warn'); return; }
  setStatus('لیږل کېږي…');

  // په رښتیا سرور ته واستوه — دلته نمونه کې موږ یوازې simulate کوو او محلي ذخیره کوو
  try{
    // دلته کولی شې fetch وکاروې: await fetch('/api/submit', {method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    await saveEntry(payload);
    await refreshSummary();
    setStatus('ستاسو معلومات بریالي ثبت شول.', 'success');
    form.reset();
    // reset date to today
    document.getElementById('date').value = new Date().toISOString().slice(0,10);
    if(!prefersReduced) {
      gsap.fromTo('#status',{scale:0.96},{scale:1,duration:0.36, ease:'elastic.out(1,0.6)'});
    }
  }catch(err){
    console.error(err);
    setStatus('خطا: ' + (err.message || err), 'error');
  }
});

/* save local button (فقط ذخیره محلي) */
saveBtn.addEventListener('click', async ()=>{
  const payload = readFormData();
  const err = validate(payload);
  if(err){ setStatus(err, 'warn'); return; }
  try{
    await saveEntry(payload);
    await refreshSummary();
    setStatus('په محلي ډول وساتل شو', 'success');
    if(!prefersReduced) gsap.fromTo('#status',{opacity:0},{opacity:1,duration:0.6});
    form.reset();
    document.getElementById('date').value = new Date().toISOString().slice(0,10);
  }catch(err){
    setStatus('د ذخیره کېدو ستونزه: ' + String(err), 'error');
  }
});

/* export CSV */
exportBtn.addEventListener('click', async ()=>{
  const arr = await getAllEntries();
  if(!arr.length){ setStatus('هیڅ ثبت شوي معلومات نشته', 'warn'); return; }
  const header = ['date','income','expense','detail','note','createdAt'];
  const rows = arr.map(r => header.map(h => `"${String(r[h]||'').replace(/"/g,'""')}"`).join(','));
  const csv = [header.join(',')].concat(rows).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `finance_export_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  setStatus('صادر شو (CSV)', 'success');
});

/* show all entries */
showAllBtn.addEventListener('click', async ()=>{
  const arr = await getAllEntries();
  if(!arr.length){ setStatus('ثبتونه خالي دي', 'warn'); return; }
  // ساده الماڼی: د ټولې لیست ښودل د موجوده listBox لخوا شوی
  setStatus(`ټول ${arr.length} ثبتونه ښکاره شول.`, 'success');
});

/* clear all */
clearAllBtn.addEventListener('click', async ()=>{
  if(!confirm('تاسو غواړئ ټول ثبتونه پاک کړئ؟ دا عمل بیرته نه ګرځېږي.')) return;
  await clearEntries();
  await refreshSummary();
  setStatus('ټول ثبتونه پاک شول', 'success');
});

/* reset button feedback */
document.getElementById('resetBtn').addEventListener('click', ()=>{
  setStatus('فورم پاک شو', 'warn');
});

/* ابتدایي load of stored data into UI */
(async ()=>{ await refreshSummary(); })();

/* ============================
   امنیتي یادښت او توضیحات (لنډ)
   ============================
   - دا فایل standalone دی: یوازې کاپي/پیست کوه او په براوزر کې خلاص یې کړه.
   - که غواړې چې فورم یې په حقیقي سرور ته واستوي، د form.submit handler کې fetch فعال کړه.
   - د ډیرو ډیټا لپاره localForage (IndexedDB) کارول شوی — خوندي او پرفورمنس.
   - د زیات دریځ، shader او نورې fancy اغیزې غواړې، زه کولی شم shader-based nebula او depth-of-field اضافه کړم.
*/

/* د کچې لا ښه کولو لپاره که وغواړې: shader particle, Lottie integration, service-worker (PWA) او Vite build pipeline. */

</script>

</body>
</html>
